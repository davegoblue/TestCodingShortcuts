---
title: "Three Card Poker"
author: "davegoblue"
date: "2023-10-20"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Background
Three Card Poker is a simple game in which the player and the dealer each receive 3 cards from a standard 52-card deck. Hand ranks from high to low are:
  
* Straight flush (AKQ is highest, 32A is lowest)  
* Three-of-a-kind (AAA is highest, 222 is lowest) 
* Straight (AKQ is highest, 32A is lowest)  
* Flush (AKJ is highest, 532 is lowest)  
* Pair (AAK is highest, 223 is lowest)  
* High card (AKJ is highest, 532 is lowest)  
  
Of note, a straight is better than a flush in Three Card Poker. The player makes an Ante wager and then looks at their cards. The player may either make a Play wager equal to their Ante or may fold and lose only their Ante. If the player makes the Play bet, the dealer reveals their cards, with bets resolved as follows:  
  
* Dealer hand is lower than Q32 - pays Ante 1:1 and pushes Play (even if player hand is worse than dealer hand)  
* Dealer hand is Q32 or better and player hand beats dealer hand - pays Ante 1:1 and pays Play 1:1  
* Dealer hand is Q32 or better and player hand ties dealer hand - Ante and Play push  
* Dealer hand is Q32 or better and player hand loses to dealer hand - Ante and Play lose  
  
In addition, the player receives an "Ante Bonus" for holding a very strong hand, regardless of whether the dealer qualifies (Q32 or better) or even beats the player. Typically, the Ante bonus is 1 for Straight, 4 for Three-of-a-Kind, and 5 for Straight Flush

This file explores hands and outcomes in Three Card Poker. Tidyverse and several custom functions are used throughout:  
```{r}

library(tidyverse)
source("./Generic_Added_Utility_Functions_202105_v001.R")

```


## Analysis
All possible combinations of 52 cards are gatheres in a matrix:

```{r}

# All combinations of 3 cards from a 52-card deck
aHands <- combn(1:52, 3) %>% t()
str(aHands)

# Suits (1-13 are 1, 14-26 are 2, 27-39 are 3, 40-52 are 4)
aSuits <- 1 + (aHands-1) %/% 13
str(aSuits)
table(aSuits)

# Ranks (1/14/27/40 are A stored as 1, ... , 13/26/39/52 are K stored as 13)
aRanks <- 1 + (aHands-1) %% 13
str(aRanks)
table(aRanks)

```
  
The combinations of suits (and therefore flushes) are explored:  
```{r}

tblSuits <- as.data.frame(sapply(1:4, 
                                 FUN=function(x) apply(aSuits[,], 
                                                       1, 
                                                       FUN=function(y) sum(y==x)
                                                       )
                                 )
                          ) %>% 
    tibble::as_tibble() %>%
    mutate(nMax=apply(., 1, FUN=function(x) max(x)), 
           isFlush=(nMax==3), 
           handNum=row_number()
           ) %>%
    select(handNum, everything())

# Sample of tibble
tblSuits

# Counts of suit distributions
tblSuits %>% 
    count(nMax, isFlush, V1, V2, V3, V4)

```

The combinations of ranks (and therefore trips and straights and pairs) is explored, and combined with the suits data to create overall hand types:  
```{r}

tblRanks <- as.data.frame(sapply(1:13, 
                                 FUN=function(x) apply(aRanks[,], 
                                                       1, 
                                                       FUN=function(y) sum(y==x)
                                                       )
                                 )
                          ) %>% 
    tibble::as_tibble() %>%
    mutate(nMax=apply(., 1, FUN=function(x) max(x)), 
           isTrips=(nMax==3),
           isPair=(nMax==2),
           handNum=row_number()
           ) %>%
    select(handNum, everything())

# Matrix of ranks that constitute a straight
mtxStrRanks <- matrix(data=0L, nrow=13, ncol=12)
for(idx in 1:11) mtxStrRanks[idx:(idx+2), idx] <- 1L
mtxStrRanks[c(1, 12, 13), 12] <- 1L
mtxStrRanks

# tblRanks converted to matrix of yes/no by rank
mtxBoolRanks <- tblRanks %>%
    select(V1:V13) %>%
    mutate(across(.cols=everything(), .fns=function(x) pmin(1L, x))) %>%
    as.matrix()
str(mtxBoolRanks)

# Check for each type of straight
tblRanks <- tblRanks %>%
    mutate(maxStr=mtxBoolRanks %*% mtxStrRanks %>% apply(., 1, FUN=max), 
           isStraight=(maxStr==3)
           )

# Example of tibble
tblRanks

# Counts of hand types based on rank
tblRanks %>% 
    count(nMax, isTrips, isPair, maxStr, isStraight)

# Counts by straight
tblRanks %>%
    filter(isStraight) %>%
    group_by(across(starts_with("V"))) %>%
    summarize(n=n(), .groups="drop")

# Create handTypes
tblHandTypes <- tblRanks %>%
    select(handNum, isTrips, isPair, isStraight) %>%
    full_join(select(tblSuits, handNum, isFlush), by="handNum") %>%
    mutate(handType=case_when(isStraight & isFlush ~ "01. SF", 
                              isTrips ~ "02. Trips", 
                              isStraight ~ "03. Straight", 
                              isFlush ~ "04. Flush", 
                              isPair ~ "05. Pair", 
                              TRUE ~ "06. High Card"
                              )
           )
tblHandTypes

tblHandTypes %>%
    count(handType, isTrips, isStraight, isFlush, isPair) %>%
    arrange(n) %>%
    mutate(pct=n/sum(n))

```

