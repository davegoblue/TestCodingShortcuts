---
title: 'Additional Coding HCF: Update #001'
author: "davegoblue"
date: "November 16, 2017"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Background
This document explores High Card Flush hands (see <https://wizardofodds.com/games/high-card-flush/>) to practice using techniques learned through multiple explorations.

## Analysis Approach
There are 52c7 potential hands in High Card Flush, though many of them are functionally equivalent to each other due to suits having no meaning in the game (spades and clubs have no inherent rank in comparison to the other).  There are several steps to the analysis approach:

1.  Compile the potential hands, suit independent, with their relative frequencies due to suits  
2.  Score each of the potential hands along the lines of a) Straight Flush, b) Flush, and c) Main Hand  
3.  Assess the degree that a given hand impacts the potential for the dealer hands (e.g., if a player has all 4 Aces then the dealer must not have any hand with an Ace)  
4.  Assess the expected value (EV) of each starting hand, and the overall game EV  
  
###_Step 1: Compile Potential Hands_  
####_Step 1a: Verify Hands and Weights_  
There are several flavors of potential hands depending on the length of the longest flush in the hand:  
  
1.  7-0-0-0 - each has a weight of 4 (any of the potential suits could be the 7)  
2.  6-1-0-0 - each has a weight of 12 (any of 4 suits as the 6 with any of 3 suits as the 1)  
3.  5-2-0-0 - each has a weight of 12 (any of the 4 suits as the 5 with any of the 3 suits as the 2)
4.  5-1-1-0 - each has a weight of 12 (any of the 4 suits as the 5 with any of the 3 suits as the 0)  
5.  4-3-0-0 - each has a weight of 12 (any of the 4 suits as the 4 with any of the 3 suits as the 3)  
6.  4-2-1-0 - each has a weight of 24 (all suits independent)  
7.  4-1-1-1 - each has a weight of 4 (any of the 4 suits as the 4)  
8.  3-3-1-0 - each has a weight of 12 (any of the 4 suits as the 1 with any of the 3 suits as the 0)  
9.  3-2-2-0 - each has a weight of 12 (any of the 4 suits as the 3 with any of the 3 suits as the 0)  
10.  3-2-1-1 - each has a weight of 12 (any of the 4 suits as the 3 with any of the 3 suits as the 2)  
11.  2-2-2-1 - each has a weight of 4 (any of the 4 suits as the 1)  
  
Assessing the total number of potential hands, we have:  
```{r}

hndTypes <- matrix(data=-1L, nrow=11, ncol=2)

hndTypes[1, ] <- c(choose(13, 7), 4)
hndTypes[2, ] <- c(choose(13, 6) * choose(13, 1), 12)
hndTypes[3, ] <- c(choose(13, 5) * choose(13, 2), 12)
hndTypes[4, ] <- c(choose(13, 5) * choose(13, 1) * choose(13, 1), 12)
hndTypes[5, ] <- c(choose(13, 4) * choose(13, 3), 12)
hndTypes[6, ] <- c(choose(13, 4) * choose(13, 2) * choose(13, 1), 24)
hndTypes[7, ] <- c(choose(13, 4) * choose(13, 1) * choose(13, 1) * choose(13, 1), 4)
hndTypes[8, ] <- c(choose(13, 3) * choose(13, 3) * choose(13, 1), 12)
hndTypes[9, ] <- c(choose(13, 3) * choose(13, 2) * choose(13, 2), 12)
hndTypes[10, ] <- c(choose(13, 3) * choose(13, 2) * choose(13, 1) * choose(13, 1), 12)
hndTypes[11, ] <- c(choose(13, 2) * choose(13, 2) * choose(13, 2) * choose(13, 1), 4)

rowMult <- hndTypes[, 1] * hndTypes[, 2]
hndName <- c(7000, 
             6100, 
             5200, 5110, 
             4300, 4210, 4111, 
             3310, 3220, 3211, 
             2221
             )
hndTypes <- cbind(hndTypes, rowMult, hndName)
colnames(hndTypes) <- c("# Hands", "Weight", "Total Hands", "Hand Class")

print(hndTypes)
print(colSums(hndTypes))
print(choose(52, 7))
print(choose(52, 7) / colSums(hndTypes)[1])

```
  
As expected, the sum-product of the number of hands and the weights is 52c7 (133,784,560).  Assessing this completely requires looking at 15,584,868 "unique" hands, a deflation of 8.6x compared to the full universe.  
  
####_Step 1b: First Order Approximation_  
As a further simplifying factor, all of the 2-card suits and 1-card suits in HCF are not germaine to the game at a first approximation (they are relevant to the extent they impact other people's potential hands from the same deck).  This is due to a 9-High 3-card qualifying rule and bonuses that depend on 3+ straight flushes.  As such, all flushes of length 2 and length 1 are identical to each other.

As such, updated weights include:  
```{r}

hndTypes <- matrix(data=-1L, nrow=11, ncol=2)

hndTypes[1, ] <- c(choose(13, 7), 4)
hndTypes[2, ] <- c(choose(13, 6), 4 * 39)  # Only the 6 cards matter, any of 4 suits, any of 39 kickers
hndTypes[3, ] <- c(choose(13, 5), 4 * 3 * choose(13, 2))  # Only the 5 cards matter, any of 4 suits, any of 13c2 kickers in any of 3 suits
hndTypes[4, ] <- c(choose(13, 5), 4 * 13 * 13 * choose(3, 2))  # Only the 5 cards matter, any of 4 suits, any of 13 kickers in each of 3c2 suits
hndTypes[5, ] <- c(choose(13, 4) * choose(13, 3), 12)  # All are of interest
hndTypes[6, ] <- c(choose(13, 4), 4 * choose(13, 2) * 3 * 13 * 2)  # Only the 4 cards matter, any of 4 suits, any of 13c2 kickers in any of 3 suits and then any of 13 kickers in any of the remaining 2 suits
hndTypes[7, ] <- c(choose(13, 4), 4 * 13 * 13 * 13)  # Only the 4 cards matter, any of 4 suits, any of 13 kickers in each of the 3 other suits
hndTypes[8, ] <- c(choose(13, 3) * choose(13, 3), choose(4, 2) * 26)  # Each of the 3 card triplets matter, available in any of 4c2 suits, with any of 26 additional cards for the kicker
hndTypes[9, ] <- c(choose(13, 3), 4 * choose(13, 2) * choose(13, 2) * choose(3, 2))  # Only the 3 cards matter, any of 4 suits, any of 13c2 kickers available in each of the 3c2 remaining suits
hndTypes[10, ] <- c(choose(13, 3), 4 * choose(13, 2) * 3 * 13 * 13)  # Only the 3 cards matter, any of 4 suits, any of 13c2 kickers in any of 3 suits, then any of 13 kickers in the other 2 suits
hndTypes[11, ] <- c(1, choose(13, 2) * choose(13, 2) * choose(13, 2) * choose(13, 1) * 4)  # No cards matter

rowMult <- hndTypes[, 1] * hndTypes[, 2]
hndName <- c(7000, 
             6100, 
             5200, 5110, 
             4300, 4210, 4111, 
             3310, 3220, 3211, 
             2221
             )
hndTypes <- cbind(hndTypes, rowMult, hndName)
colnames(hndTypes) <- c("# Hands", "Weight", "Total Hands", "Hand Class")

print(hndTypes)
print(colSums(hndTypes))
print(choose(52, 7))
print(choose(52, 7) / colSums(hndTypes)[1])

```
  
This will be a very helpful first-order approximation, since it reduces total hands for assessment to 294,295 (deflator of over 400x compared to the baseline 133.8 million hands).  Almost all of the key hands for assessment are the 4-3-0-0 and 3-3-1-0 where there is a double assessment to be made.
  
  
####_Step 1c: Create Hand Types by Number Per Suit_  
All of the possible hands by "number of cards in the suit" are created.  A full hand is simply the concatenation of one or more of these suited sub-hands in to a full 7-card hand.  For purposes of creating these hands, the following ranks will be used:  
  
* 2-10 will be given index 2-10 respectively  
* J will be given index 11  
* Q will be given index 12  
* K will be given index 13  
* A will be given index 14  
  
The Ace is a high card in this game, with the exception that the Ace can play low for a straight flush.  For example, A-2-3 is treated as an Ace-high hand with a 3-2 kicker in the main game, but is also treated as an A-2-3 3-card straight flush for the side bet.  Scoring hands that contain index 14 will require an extra steo for that side bet.  

Hands will be stored in descending order for easier comparisons.  For example, A-Q-T-9 will be stored as 14-12-10-9 and will out-kick a hand like A-J-T-9 (stored as 14-11-10-9)
  
The hand types include:  
```{r}

hndType7 <- t(combn(14:2, 7))
hndType6 <- t(combn(14:2, 6))
hndType5 <- t(combn(14:2, 5))
hndType4 <- t(combn(14:2, 4))
hndType3 <- t(combn(14:2, 3))
hndType2 <- t(combn(14:2, 2))
hndType1 <- t(combn(14:2, 1))

cat(paste0("The 7-card hands should have: ", choose(13, 7), " combinations\t\tACTUAL: ", nrow(hndType7)))
cat(paste0("The 6-card hands should have: ", choose(13, 6), " combinations\t\tACTUAL: ", nrow(hndType6)))
cat(paste0("The 5-card hands should have: ", choose(13, 5), " combinations\t\tACTUAL: ", nrow(hndType5)))
cat(paste0("The 4-card hands should have: ", choose(13, 4), " combinations\t\tACTUAL: ", nrow(hndType4)))
cat(paste0("The 3-card hands should have: ", choose(13, 3), " combinations\t\tACTUAL: ", nrow(hndType3)))
cat(paste0("The 2-card hands should have: ", choose(13, 2), " combinations\t\tACTUAL: ", nrow(hndType2)))
cat(paste0("The 1-card hands should have: ", choose(13, 1), " combinations\t\tACTUAL: ", nrow(hndType1)))

print(paste0("There are a total of ", nrow(hndType7) + nrow(hndType6) + nrow(hndType5) + nrow(hndType4) + nrow(hndType3) + nrow(hndType2) + nrow(hndType1), " hands to be scored"))

```
  
So, by scoring and saving the values for 5,811 hands, all of the potential 7-card hands can be created and provided with an aggregate score.  
  
###_Step 2: Score Hands_  
First, we double check that the hand types have been sorted properly, and assign ranks based on that:  
```{r}

hndChecker <- function(x) {
    hdRanks <- 1L
    firstHand <- TRUE
    for (eachRow in 1:nrow(x)) {
        eachHand <- x[eachRow, ]
        if (firstHand) { 
            prevHand <- eachHand 
            firstHand <- FALSE
        }
        else {
            curGTprev <- eachHand > prevHand
            prevGTcur <- prevHand > eachHand
            idxKey <- match(TRUE, prevGTcur)
            if (is.na(idxKey)) { stop("ERROR: Previous hand never greater than current hand")}
            if (idxKey == 1) {  }
            else {
                if (sum(curGTprev[1:(idxKey-1)]) > 0) { stop("ERROR: Current hand greater than previous hand")}
            }
            hdRanks <- c(hdRanks, eachRow)
            prevHand <- eachHand
        }
    }
    return(hdRanks)
}

rkType7 <- hndChecker(hndType7)
rkType6 <- hndChecker(hndType6)
rkType5 <- hndChecker(hndType5)
rkType4 <- hndChecker(hndType4)
rkType3 <- hndChecker(hndType3)
rkType2 <- hndChecker(hndType2)
rkType1 <- hndChecker(hndType1)

print(identical(rkType7, 1:nrow(hndType7)))
print(identical(rkType6, 1:nrow(hndType6)))
print(identical(rkType5, 1:nrow(hndType5)))
print(identical(rkType4, 1:nrow(hndType4)))
print(identical(rkType3, 1:nrow(hndType3)))
print(identical(rkType2, 1:nrow(hndType2)))
print(identical(rkType1, 1:nrow(hndType1)))

```
  
So, the hands are properly sorted and ranked "as is".  
  
Next, the hands of 3+ cards are checked for whether they contain a 3+ card straight flush.  For these purposes, the Ace (rank 14) needs to also be considered as an Ace low (rank 1).
```{r}

numSF <- function(x) {
    ckDummy <- paste0(1 + diff(x), collapse="")
    if (length(grep("000000", ckDummy)) > 0) { return(7L) }
    else if (length(grep("00000", ckDummy)) > 0) { return(6L) }
    else if (length(grep("0000", ckDummy)) > 0) { return(5L) }
    else if (length(grep("000", ckDummy)) > 0) { return(4L) }
    else if (length(grep("00", ckDummy)) > 0) { return(3L) }
    else if (length(grep("0", ckDummy)) > 0) { return(2L) }
    else { return(0L) }
}

sfCheck <- function(x) {
    sfType <- integer(0)
    for (eachRow in 1:nrow(x)) {
        eachHand <- x[eachRow, ]
        if (eachHand[1] == 14) { eachHand <- c(eachHand, 1) }
        sfType <- c(sfType, numSF(eachHand))
    }
    return(sfType)
}

sfType7 <- sfCheck(hndType7)
sfType6 <- sfCheck(hndType6)
sfType5 <- sfCheck(hndType5)
sfType4 <- sfCheck(hndType4)
sfType3 <- sfCheck(hndType3)
sfType2 <- sfCheck(hndType2)
sfType1 <- sfCheck(hndType1)

vecCount <- c(rep(7, length(sfType7)), rep(6, length(sfType6)), rep(5, length(sfType5)), 
              rep(4, length(sfType4)), rep(3, length(sfType3)), rep(2, length(sfType2)), 
              rep(1, length(sfType1))
             )
vecType <- c(sfType7, sfType6, sfType5, sfType4, sfType3, sfType2, sfType1)

table(vecCount, vecType)
round(prop.table(table(vecCount, vecType), 1), 3)

```
  
  
###_Step 3: Assess Cross-Hand Impact_  
Since multiple hands can be played from the same 52-card shoe, the cards present in one hand are by definition not present in any other hand.  So, for example, if a player holds all 4 Aces, then the dealer cannot have any hand that includes an Ace.  
  
First, the impact of a single hand on all the other hands is considered to modify the weights originally calculated in Step 1.  Notably, given the existence of a single 7-card hand, the remaining hands should have 45c7 possibilities (45.4 million).  
  
As a basic starting point, we give the player a randomly selected 4-2-1 hand:  
```{r}

set.seed(1711210734)

rnd4 <- sample(seq_len(nrow(hndType4)), 1)
rnd2 <- sample(seq_len(nrow(hndType2)), 1)
rnd1 <- sample(seq_len(nrow(hndType1)), 1)

hnd4 <- hndType4[rnd4, ]
hnd2 <- hndType2[rnd2, ]
hnd1 <- hndType1[rnd1, ]

cat("\nSuit 1: ", hnd4, "\t\tSuit2: ", hnd2, "\t\tSuit3: ", hnd1, "\n\n")

```
  
This hand includes K(1)-Q(1)-J(2)-9(3)-6(1)-6(2)-4(1), making each of these ranks (and especially the 6) less likely to be in the dealer hand.

Next, a routine is written to calculate the number of available hands, and to compare it to the baseline:  
```{r}

library(dplyr)

countHandCombos <- function(n1, n2, n3, n4, a1=13, a2=13, a3=13, a4=13, kF=keyFrame, nines=NULL) {
    hndCounts <- rep(NA_integer_, 24)
    egtCounts <- rep(NA_integer_, 24)
    
    keyMatrix <- t(apply(keyFrame, 1, FUN=function(x) { c(n1, n2, n3, n4)[x] }))
    useMatrix <- keyMatrix[!duplicated(keyMatrix), ]

    if (!(nrow(useMatrix) %in% c(4, 12, 24))) { stop("ERROR: Wrong Number of Rows!") }

    if (!is.null(nines)) {
        b1 = a1 - nines[1]
        b2 = a2 - nines[2]
        b3 = a3 - nines[3]
        b4 = a4 - nines[4]
    }
    
    for (intCtr in 1:nrow(useMatrix)) {
        rowData <- useMatrix[intCtr, ]
        hndCounts[intCtr] <- choose(a1, rowData[1]) * choose(a2, rowData[2]) * 
            choose(a3, rowData[3]) * choose(a4, rowData[4])
        if (!is.null(nines)) {
            if (max(n1, n2, n3, n4) > 3) {
                egtCounts[intCtr] <- 0
            } else if (max(n1, n2, n3, n4) == 2) { 
                egtCounts[intCtr] <- hndCounts[intCtr] 
            } else {
                egtCounts[intCtr] <- choose(ifelse(rowData[1] == 3, b1, a1), rowData[1]) * 
                    choose(ifelse(rowData[2] == 3, b2, a2), rowData[2]) * 
                    choose(ifelse(rowData[3] == 3, b3, a3), rowData[3]) * 
                    choose(ifelse(rowData[4] == 3, b4, a4), rowData[4])
            }
        }
    }
    
    if (is.null(nines)) { return(hndCounts) }
    else { return(c(hndCounts, egtCounts)) }
    
}

m1 <- integer(0)
m2 <- integer(0)
m3 <- integer(0)
m4 <- integer(0)

for (intCtr in 0:23) {
    pos1 <- 1 + (intCtr %/% 6)
    pos2 <- 1 + (intCtr %% 6) %/% 2
    pos3 <- 1 + (intCtr %% 2)
    # cat("\n", pos1, " ", pos2, " ", pos3)
    
    mod2 <- setdiff(1:4, pos1)[pos2]
    mod3 <- setdiff(1:4, c(pos1, mod2))[pos3]
    mod4 <- setdiff(1:4, c(pos1, mod2, mod3))
    # cat("\n", pos1, " ", mod2, " ", mod3, " ", mod4)
    
    m1 <- c(m1, pos1)
    m2 <- c(m2, mod2)
    m3 <- c(m3, mod3)
    m4 <- c(m4, mod4)
    
}

keyFrame <- data.frame(m1, m2, m3, m4)
print(keyFrame)

```
  
For comparison to the baseline, a list of potential (n1, n2, n3, n4) is created:  
```{r}

n1234List <- list(c(7, 0, 0, 0), 
                  c(6, 1, 0, 0), 
                  c(5, 2, 0, 0), c(5, 1, 1, 0), 
                  c(4, 3, 0, 0), c(4, 2, 1, 0), c(4, 1, 1, 1), 
                  c(3, 3, 1, 0), c(3, 2, 2, 0), c(3, 2, 1, 1), 
                  c(2, 2, 2, 1)
                  )

baseAvlData <- sapply(n1234List, FUN=function(x) { 
    countHandCombos(n1=x[1], n2=x[2], n3=x[3], n4=x[4], kF=keyFrame) 
    } 
)

baseTotals <- colSums(baseAvlData, na.rm=TRUE)
baseTotals

all.equal(sum(baseTotals), choose(52, 7))

```
  
And then, the sample hand from above is assessed:  
```{r}

cat("\nThe hand to be assessed is SUIT 1: ", hnd4, "\t\tSUIT 2: ", hnd2, "\t\tSUIT3: ", hnd1, "\n\n")
avNums <- 13 - c(length(hnd4), length(hnd2), length(hnd1), length(integer(0)))

newAvlData <- sapply(n1234List, FUN=function(x) { 
    countHandCombos(n1=x[1], n2=x[2], n3=x[3], n4=x[4], 
                    a1=avNums[1], a2=avNums[2], a3=avNums[3], a4=avNums[4], 
                    kF=keyFrame
                    ) 
    } 
)

newTotals <- colSums(newAvlData, na.rm=TRUE)
newTotals

all.equal(sum(newTotals), choose(45, 7))

```
  
Percentages and likelihoods can also be compared:  
```{r}

tmpFrame <- data.frame(baseTotals, newTotals)
tmpFrame <- tmpFrame %>% 
    mutate(basePct = baseTotals/sum(baseTotals), newPct = newTotals/sum(newTotals), relPct = newPct/basePct)
round(tmpFrame, 6)
round(colSums(tmpFrame %>% select(basePct, newPct)), 6)

```
  
As well, the likelihood of a qualifying hand (3-card 9-high or better) can be assessed:  
```{r}

baseNinesData <- sapply(n1234List, FUN=function(x) { 
    countHandCombos(n1=x[1], n2=x[2], n3=x[3], n4=x[4], 
                    kF=keyFrame, nines=c(6, 6, 6, 6)
                    ) 
    } 
)

baseNinesTotals <- colSums(baseNinesData[1:24, ], na.rm=TRUE)
names(baseNinesTotals) <- sapply(n1234List, FUN=paste0, collapse="-")
baseNinesTotals

all.equal(sum(baseNinesTotals), choose(52, 7))

colSums(baseNinesData[25:48, ], na.rm=TRUE)
colSums(baseNinesData[25:48, ], na.rm=TRUE) / baseNinesTotals

baseNinesQual <- baseNinesTotals - colSums(baseNinesData[25:48, ], na.rm=TRUE)
baseNinesQual
sum(baseNinesQual) / sum(baseNinesTotals)


cat("\nThe hand to be assessed is SUIT 1: ", hnd4, "\t\tSUIT 2: ", hnd2, "\t\tSUIT3: ", hnd1, "\n\n")
avNums <- 13 - c(length(hnd4), length(hnd2), length(hnd1), length(integer(0)))
ninePlus <- 6 - c(sum(hnd4 >= 9), sum(hnd2 >= 9), sum(hnd1 >= 9), 0)


newNinesData <- sapply(n1234List, FUN=function(x) { 
    countHandCombos(n1=x[1], n2=x[2], n3=x[3], n4=x[4], 
                    a1=avNums[1], a2=avNums[2], a3=avNums[3], a4=avNums[4], 
                    kF=keyFrame, nines=ninePlus
                    ) 
    } 
)

newNinesTotals <- colSums(newNinesData[1:24, ], na.rm=TRUE)
names(newNinesTotals) <- sapply(n1234List, FUN=paste0, collapse="-")
newNinesTotals

all.equal(sum(newNinesTotals), choose(45, 7))

colSums(newNinesData[25:48, ], na.rm=TRUE)
colSums(newNinesData[25:48, ], na.rm=TRUE) / newNinesTotals

newNinesQual <- newNinesTotals - colSums(newNinesData[25:48, ], na.rm=TRUE)
newNinesQual
sum(newNinesQual) / sum(newNinesTotals)

```
  
Further, hand likelihoods can be assessed based on many other hands having been eliminated:  
```{r}

hnd1 <- list(c(), c(14, 12, 10, 4, 3), c(14), c(14))
hnd2 <- list(c(12, 11, 10, 9), c(5), c(8), c(10))
hnd3 <- list(c(14, 13), c(13, 11), c(13, 12, 11), c())

hndTot <- vector("list", 4)
for (intCtr in 1:4) {
    fullCards <- c(hnd1[[intCtr]], hnd2[[intCtr]], hnd3[[intCtr]])
    if (!all.equal(fullCards, unique(fullCards))) { stop("Problem with duplicate cards") }
    hndTot[[intCtr]] <- fullCards
}

avNums <- 13 - sapply(hndTot, FUN=length)
ninePlus <- 6 - sapply(hndTot, FUN=function(x) { sum(x >= 9) })

testData <- sapply(n1234List, FUN=function(x) { 
    countHandCombos(n1=x[1], n2=x[2], n3=x[3], n4=x[4], 
                    a1=avNums[1], a2=avNums[2], a3=avNums[3], a4=avNums[4], 
                    kF=keyFrame, nines=ninePlus
                    ) 
    } 
)

testTotals <- colSums(testData[1:24, ], na.rm=TRUE)
names(testTotals) <- sapply(n1234List, FUN=paste0, collapse="-")
testTotals

all.equal(sum(testTotals), choose(31, 7))

colSums(testData[25:48, ], na.rm=TRUE)
colSums(testData[25:48, ], na.rm=TRUE) / testTotals

testQual <- testTotals - colSums(testData[25:48, ], na.rm=TRUE)
testQual
sum(testQual) / sum(testTotals)

```

  
