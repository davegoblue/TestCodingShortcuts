---
title: "Coronavirus US - All-Cause Death"
author: "davegoblue"
date: '2022-06-23'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Background  
This module extends code contained in Coronavirus_Statistics_v005.Rmd to include sourcing of updated functions and parameters.  This file includes the latest code for analyzing all-cause death data from [CDC Weekly Deaths by Jurisdiction](https://catalog.data.gov/dataset/weekly-counts-of-deaths-by-jurisdiction-and-age-group).  CDC maintains data on deaths by week, age cohort, and state in the US.  Downloaded data are unique by state, epidemiological week, year, age, and type (actual vs. predicted/projected).

These data are known to have a lag between death and reporting, and the CDC back-correct to report deaths at the time the death occurred even if the death is reported in following weeks.  This means totals for recent weeks tend to run low (lag), and the CDC run a projection of the expected total number of deaths given the historical lag times.  Per other analysts on the internet, there is currently significant supra-lag, with lag times much longer than historical averages causing CDC projected deaths for recent weeks to be low.

The code leverages tidyverse and sourced functions throughout:  
```{r}

# All functions assume that tidyverse and its components are loaded and available
library(tidyverse)

# If the same function is in both files, use the version from the more specific source
source("./Generic_Added_Utility_Functions_202105_v001.R")
source("./Coronavirus_CDC_Excess_Functions_v001.R")

```
  
The basic process includes three data update steps:  
```{r, fig.height=9, fig.width=9, cache=TRUE}

# STEP 0: Appropriate parameters for 2022 data
cdcExcessParams <- list(remapVars=c('Jurisdiction'='fullState', 
                                    'Week Ending Date'='weekEnding', 
                                    'State Abbreviation'='state', 
                                    'Age Group'='age', 
                                    'Number of Deaths'='deaths', 
                                    'Time Period'='period', 
                                    'Year'='year', 
                                    'Week'='week'
                                    ),
                        colTypes="ccciicdcccc",
                        ageLevels=c("Under 25 years", 
                                    "25-44 years", 
                                    "45-64 years", 
                                    "65-74 years", 
                                    "75-84 years", 
                                    "85 years and older"
                                    ),
                        periodLevels=c("2015-2019", "2020", "2021", "2022"),
                        periodKeep=c("2015-2019", "2020", "2021"),
                        yearLevels=2015:2022
                        )

# STEP 1: Latest CDC all-cause deaths data
cdcLoc <- "Weekly_counts_of_deaths_by_jurisdiction_and_age_group_downloaded_20220623.csv"
cdcList_20220623 <- readRunCDCAllCause(loc=cdcLoc, 
                                       weekThru=21, 
                                       lst=readFromRDS("cdc_daily_220602"), 
                                       stateNoCheck=c(), 
                                       pdfCluster=TRUE, 
                                       pdfAge=TRUE
                                       )
saveToRDS(cdcList_20220623, ovrWriteError=FALSE)

# STEP 2: Latest death bu location-cause data
allCause_220623 <- analyzeAllCause(loc="COvID_deaths_age_place_20220623.csv", 
                                   cdcDailyList=readFromRDS("cdc_daily_220602"), 
                                   compareThruDate="2022-05-31"
                                   )
saveToRDS(allCause_220623, ovrWriteError=FALSE)

# STEP 3: Facets for excess all-cause deaths
excessDeathFacets(lstCDC=cdcList_20220623, lstAll=allCause_220623, dateThru="2022-04-30", plotYLim=c(-200, 1200))

```
  
Updated with the latest data:  
```{r, fig.height=9, fig.width=9, cache=TRUE}

# STEP 1: Latest CDC all-cause deaths data
cdcLoc <- "Weekly_counts_of_deaths_by_jurisdiction_and_age_group_downloaded_20220713.csv"
cdcList_20220713 <- readRunCDCAllCause(loc=cdcLoc, 
                                       weekThru=24, 
                                       lst=readFromRDS("cdc_daily_220704"), 
                                       stateNoCheck=c(), 
                                       pdfCluster=TRUE, 
                                       pdfAge=TRUE
                                       )
saveToRDS(cdcList_20220713, ovrWriteError=FALSE)

# STEP 2: Latest death bu location-cause data
allCause_220713 <- analyzeAllCause(loc="COvID_deaths_age_place_20220713.csv", 
                                   cdcDailyList=readFromRDS("cdc_daily_220704"), 
                                   compareThruDate="2022-06-30"
                                   )
saveToRDS(allCause_220713, ovrWriteError=FALSE)

# STEP 3: Facets for excess all-cause deaths
excessDeathFacets(lstCDC=cdcList_20220713, lstAll=allCause_220713, dateThru="2022-05-31", plotYLim=c(-200, 1200))

```
  
There have been issues with US all-cause deaths data since a "systems upgrade" in mid-June. How much restatement of data has occurred?
```{r, fig.height=9, fig.width=9}

# Mapping file of epiweek and epiyear to date
mapEpi <- tibble::tibble(date=seq.Date(as.Date("2014-12-01"), as.Date("2031-01-31"), by=1)) %>%
    mutate(epiYear=as.integer(lubridate::epiyear(date)), epiWeek=as.integer(lubridate::epiweek(date)))

nameFile <- "ageAgg"
dfCheck <- bind_rows(readFromRDS("cdcList_20220713")[[nameFile]], 
                     readFromRDS("cdcList_20220623")[[nameFile]], 
                     readFromRDS("cdcList_20220105")[[nameFile]], 
                     .id="fileDate"
                     ) %>%
    mutate(fileDate=c("1"="2022-07-13", "2"="2022-06-23", "3"="2022-01-05")[fileDate])

mapEpi %>%
    arrange(date) %>%
    group_by(epiYear, epiWeek) %>%
    filter(row_number()==1) %>%
    ungroup() %>%
    rename(yearint=epiYear, week=epiWeek) %>%
    right_join(dfCheck, by=c("yearint", "week")) %>%
    ggplot(aes(x=date, y=deaths)) + 
    geom_line(aes(color=fileDate, group=fileDate)) + 
    lims(y=c(0, NA)) +
    labs(x=NULL, y="Reported all-cause US deaths", title="US all-cause deaths by report date") +
    facet_wrap(~age, scales="free_y")

```
  
Data appear anomalous, particularly 2022 deaths in "Under 25 years" and "25-44 years". Partly, this is incomplete reporting in the most recent weeks (normal), but partly this may be driven by data not yet re-entered after the upgrade. It is striking that there are fewer reported all-cause deaths in the 2022-07-13 data than in the 2022-06-23 data for any cohort, as all-cause data almost always increases as additional reports are received from vital statistics departments. Trends among "45-64 years" and senior citizens, at a glance, are the more commonly observed build over time
  
The process is converted to functional form:  
```{r, fig.height=9, fig.width=9}

makeRestatementData <- function(vecFiles, key, vecNames=NULL, epiRange=as.Date(c("2014-12-01", "2031-01-31"))) {
    
    # FUNCTION ARGUMENTS:
    # vecFiles: character vector of file names (will be extracted using readFromRDS)
    # key: the extract element from each of the lists
    # vecNames: names to be used in plot for each of the extracts (NULL means infer from ...)
    # epiRange: range for converting epiweek and epiyear to date (should be a larger range than data)

    # Add names to vecNames if not passed
    if(!is.null(vecNames) & is.null(names(vecNames))) 
        vecNames <- vecNames %>% purrr::set_names(as.character(1:length(vecFiles)))
    
    # Create keyNames if not provided
    if(is.null(vecNames)) {
        vecNames <- as.character(lubridate::ymd(stringr::str_remove(vecFiles, ".*_"))) %>%
            purrr::set_names(as.character(1:length(vecFiles)))
    }
    
    # Create epi mapping file
    dfEpi <- tibble::tibble(date=seq.Date(epiRange[1], epiRange[2], by=1)) %>%
        mutate(epiYear=as.integer(lubridate::epiyear(date)), 
               epiWeek=as.integer(lubridate::epiweek(date))
               )

    # Create single date for each epiWeek and epiYear
    mapEpi <- dfEpi %>%
        arrange(date) %>%
        group_by(epiYear, epiWeek) %>%
        filter(row_number()==1) %>%
        ungroup() %>%
        rename(yearint=epiYear, week=epiWeek)
    
    # Read and integrate file, add epiDate
    purrr::map_dfr(.x=vecFiles, 
                   .f=function(x) readFromRDS(x)[[key]], 
                   .id="fileDate"
                   ) %>%
        mutate(fileDate=vecNames[fileDate]) %>%
        left_join(mapEpi, by=c("yearint", "week"))
    
}

plotRestatementData <- function(df, wrapBy=NULL, asRatio=FALSE) {
    
    # FUNCTION ARGUMENTS:
    # df: data frame or tibble formatted for plotting
    # wrapBy: variable for facet_wrap (NULL means infer from file, FALSE means do not wrap)
    # asRatio: boolean, should ratios be plotted rather than values?

    # Create the appropriate wrapBy if passed as NULL
    if(is.null(wrapBy)) {
        if("age" %in% names(df)) wrapBy <- "age"
        else if ("state" %in% names(df)) wrapBy <- "state"
        else if ("cluster" %in% names(df)) wrapBy <- "cluster"
        else wrapBy <- FALSE
    }
    
    plotTitle <- "US all-cause deaths by report date"
    plotSubTitle <- NULL
    plotYAxis <- "Reported all-cause US deaths"
    
    # Create ratios if appropriate
    if(isTRUE(asRatio)) {
        groupVars <- c("date")
        if(!isFALSE(wrapBy)) groupVars <- c(groupVars, wrapBy)
        df <- df %>%
            rename(trueFileDate=fileDate, trueDeaths=deaths) %>%
            arrange(trueFileDate) %>%
            group_by_at(all_of(groupVars)) %>%
            mutate(n=n(), 
                   fileDate=ifelse(row_number()==1, trueFileDate, paste0(trueFileDate, " vs. ", lag(trueFileDate))), 
                   deaths=ifelse(row_number()==1, trueDeaths, trueDeaths/lag(trueDeaths))
                   ) %>%
            ungroup()
        plotTitle <- "Ratio of US all-cause deaths by report date"
        plotSubTitle <- "Ratios filtered to exclude NA and results greater than 3"
        plotYAxis <- "Ratio of reported all-cause US deaths"
    }
    
    # Create base plot
    p1 <- df %>%
        filter(if(isTRUE(asRatio)) fileDate != min(fileDate) else TRUE) %>%
        filter(if(isTRUE(asRatio)) !is.na(deaths) & deaths <= 3 else TRUE) %>%
        ggplot(aes(x=date, y=deaths)) + 
        geom_line(aes(color=fileDate, group=fileDate)) + 
        lims(y=c(0, NA)) +
        labs(x=NULL, y=plotYAxis, subtitle=plotSubTitle, title=plotTitle) +
        scale_color_discrete("File Date")
    
    # Add line at 1.0 if ratio
    if(isTRUE(asRatio)) p1 <- p1 + geom_hline(yintercept=1, lty=2)
    
    # Add facetting if appropriate
    if(!isFALSE(wrapBy)) p1 <- p1 + facet_wrap(~get(wrapBy), scales="free_y")
    
    # Print the plot
    print(p1)
    
}

makeRestatementData(c("cdcList_20220713", "cdcList_20220623", "cdcList_20220105"), key="ageAgg")
makeRestatementData(c("cdcList_20220713", "cdcList_20220623", "cdcList_20220105"), key="ageAgg") %>%
    plotRestatementData()
makeRestatementData(c("cdcList_20220713", "cdcList_20220623", "cdcList_20220105"), key="ageAgg") %>%
    plotRestatementData(asRatio=TRUE)
makeRestatementData(c("cdcList_20220713", "cdcList_20220623", "cdcList_20220105"), key="allUSAgg") %>%
    plotRestatementData()
makeRestatementData(c("cdcList_20220713", "cdcList_20220623", "cdcList_20220105"), key="allUSAgg") %>%
    plotRestatementData(asRatio=TRUE)

```
  
[Github user USMortality](https://github.com/USMortality/US-Mortality/tree/master/data/deaths) stores archived all-cause deaths data. The file from 2022 week 17 is downloaded and processed:  
```{r, fig.height=9, fig.width=9, cache=TRUE}

# STEP 1: Archived CDC all-cause deaths data
cdcLoc <- "Weekly_counts_of_deaths_by_jurisdiction_and_age_group_2022_17.txt"
cdcList_arch_2022w17 <- readRunCDCAllCause(loc=cdcLoc, 
                                           weekThru=16, 
                                           lst=readFromRDS("cdc_daily_220704"), 
                                           stateNoCheck=c(), 
                                           pdfCluster=TRUE, 
                                           pdfAge=TRUE
                                           )
saveToRDS(cdcList_arch_2022w17, ovrWriteError=FALSE)

```
  
Comparisons can be run among deaths in each dataset:  
```{r, fig.height=9, fig.width=9}

makeRestatementData(c("cdcList_20220713", "cdcList_arch_2022w17", "cdcList_20220105"), 
                    key="allUSAgg", 
                    vecNames=c("2022-07-13", "2022-04-25", "2022-01-05")
                    ) %>%
    plotRestatementData(asRatio=TRUE)

makeRestatementData(c("cdcList_20220713", "cdcList_arch_2022w17", "cdcList_20220105"), 
                    key="ageAgg", 
                    vecNames=c("2022-07-13", "2022-04-25", "2022-01-05")
                    ) %>%
    plotRestatementData(asRatio=TRUE)

makeRestatementData(c("cdcList_20220713", "cdcList_arch_2022w17", "cdcList_20220105"), 
                    key="clusterAgg", 
                    vecNames=c("2022-07-13", "2022-04-25", "2022-01-05")
                    ) %>%
    plotRestatementData(asRatio=TRUE)

```
  
The persistent gap between reported deaths in 2022-01-03 and later reports is the exclusion of several cluster 5 states from the 2022-01-03 processing due to data suppression issues. There continues to be an anomaly where deaths among people under age 45 decreased between 2022-04-25 and 2022-07-13. This trend of decreasing deaths is significantly reduced or not existent in data for ages 45+

Data prior to exclusions are examined for consistency:  
```{r, fig.height=9, fig.width=9}

dfCheck <- readFromRDS("cdcList_arch_2022w17")$cdc %>%
    select(state, weekEnding, age, deaths_220425=deaths) %>%
    full_join(readFromRDS("cdcList_20220713")$cdc %>% select(state, weekEnding, age, deaths_220713=deaths), 
              by=c("state", "weekEnding", "age")
              ) %>%
    mutate(delta=ifelse(is.na(deaths_220713), 0, deaths_220713)-ifelse(is.na(deaths_220425), 0, deaths_220425), 
           neg=(delta < 0)
           )
dfCheck
dfCheck %>% count(neg)

# Get counts of changes by state
dfCheck %>% 
    group_by(state) %>%
    summarize(nNeg=sum(neg), negDelta=sum(delta*neg), n=n(), .groups="drop") %>%
    ggplot(aes(x=fct_reorder(state, negDelta), y=negDelta)) + 
    geom_col(fill="lightblue") + 
    geom_text(aes(label=negDelta), hjust=1) + 
    coord_flip() + 
    labs(y="Sum of negative changes in weekly deaths by age group from 2022-04-25 to 2022-07-13", 
         x=NULL, 
         title="Negative change in weekly death by state summary"
         )

# Examples overall
dfCheck %>%
    select(-delta, -neg) %>%
    pivot_longer(starts_with("deaths")) %>%
    group_by(weekEnding, age, name) %>%
    summarize(deaths=specNA()(value), .groups="drop") %>%
    ggplot(aes(x=weekEnding, y=deaths)) + 
    geom_line(aes(group=name, color=name)) + 
    lims(y=c(0, NA)) +
    labs(x=NULL, y="Reported deaths", title="Reported deaths by age group and week in US") +
    facet_wrap(~age, scales="free_y")

# Examples from Florida (biggest change)
dfCheck %>%
    filter(state=="FL") %>%
    select(-delta, -neg) %>%
    pivot_longer(starts_with("deaths")) %>%
    ggplot(aes(x=weekEnding, y=value)) + 
    geom_line(aes(group=name, color=name)) + 
    lims(y=c(0, NA)) +
    labs(x=NULL, y="Reported deaths", title="Reported deaths by age group and week in Florida") +
    facet_wrap(~age, scales="free_y")

```
  
Florida data shows similarities to the national data, with negative restatements and negative recent trends primarily limited to the 0-44 years buckets.

Each state and age group is assessed for the total amount of negative delta relative to the average number of annual deaths in the group:  
```{r, fig.height=9, fig.width=9}

dfCheckAvg <- dfCheck %>%
    group_by(state, age) %>%
    summarize(across(starts_with("deaths"), specNA(mean)), 
              delta=specNA(sum)(ifelse(neg, delta, 0)),
              .groups="drop"
              ) %>%
    mutate(deltaRatio=delta/deaths_220425)

dfCheckAvg %>%
    ggplot(aes(x=fct_reorder(state, deltaRatio, min), y=deltaRatio)) + 
    geom_col(fill="lightblue") + 
    geom_text(aes(y=deltaRatio/2, label=round(deltaRatio, 1))) + 
    coord_flip() +
    facet_wrap(~age, nrow=1) + 
    labs(title="Total negative restatement", subtitle="Units are average number of weeks", y="Avg weeks", x=NULL)

bigDelta <- c("CO", "AZ", "SC", "FL", "OK", "VT")

dfCheck %>%
    mutate(type=ifelse(state %in% bigDelta, "big delta", "all other")) %>%
    group_by(weekEnding, type, age) %>%
    summarize(across(starts_with("deaths"), specNA(sum)), .groups="drop") %>%
    mutate(daynum=1L+7*as.integer(weekEnding-min(weekEnding))) %>% 
    mutate(pred=predict(lm(deaths_220425 ~ daynum*type*age, data=., subset=lubridate::year(weekEnding)<=2019), 
                        newdata=.
                        )
           ) %>%
    select(-daynum) %>%
    pivot_longer(-c(weekEnding, type, age, pred)) %>%
    ggplot(aes(x=weekEnding, y=value)) + 
    geom_line(aes(group=name, color=name)) +
    geom_line(aes(y=pred), lty=2, lwd=0.5) +
    lims(y=c(0, NA)) +
    labs(title="Weekly deaths by state type", 
         subtitle="Big delta states: CO, AZ, SC, FL, OK, VT\nDashed line is simple linear model using 2015-2019 data", 
         x=NULL, 
         y=NULL
         ) +
    facet_grid(type~age, scales="free_y")

```
  
Much of the negative restatement is driven by a handful of states. There remains a general pattern of deaths, especially among younger groups, falling below historical trends in the most recent data

Plots are created as ratios vs. expected (trend from 2015-2019):  
```{r, fig.height=9, fig.width=9}

dfCheck %>%
    mutate(type=ifelse(state %in% bigDelta, "big delta", "all other")) %>%
    group_by(weekEnding, type, age) %>%
    summarize(across(starts_with("deaths"), specNA(sum)), .groups="drop") %>%
    mutate(daynum=1L+7*as.integer(weekEnding-min(weekEnding))) %>% 
    mutate(pred=predict(lm(deaths_220425 ~ daynum*type*age, data=., subset=lubridate::year(weekEnding)<=2019), 
                        newdata=.
                        )
           ) %>%
    select(-daynum) %>%
    pivot_longer(-c(weekEnding, type, age, pred)) %>%
    ggplot(aes(x=weekEnding, y=value/pred)) + 
    geom_line(aes(group=name, color=name)) +
    geom_line(aes(y=1), lty=2, lwd=0.5) +
    lims(y=c(0, NA)) +
    labs(title="Ratio of weekly deaths vs. 2015-2019 trend by state type", 
         subtitle="Big delta states: CO, AZ, SC, FL, OK, VT", 
         x=NULL, 
         y=NULL
         ) +
    facet_grid(type~age, scales="free_y")


```
  
Reported deaths in recent weeks in the "Under 25 years" bucket are under 50% of trends using a simple linear model on 2015-2019 data. The "25-44 years" bucket is ~25% under trend, while the remaining buckets are near trend.

The process is converted to functional form:  
```{r, fig.height=9, fig.width=9}

calculateRestatementFromRaw <- function(lst1Name, 
                                        lst2Name,
                                        lstLabels, 
                                        labelBase=FALSE
                                        ) {

    # FUNCTION ARGUMENTS
    # lst1Name: character name (for readFromRDS) of first list that includes raw CDC data
    # lst2Name: character name (for readFromRDS) of second list that includes raw CDC data
    # lstLabels: labels to be used for list data (e.g., c("deaths_220425", "deaths_220713"))
    # labelBase: boolean, should a convenience column "base" be created from lst1Name for later summarization?
    
    # Create the data
    df <- readFromRDS(lst1Name)$cdc %>%
        select(state, weekEnding, age, deaths) %>%
        colRenamer(c("deaths"="deaths1")) %>%
        full_join(readFromRDS(lst2Name)$cdc %>% 
                      select(state, weekEnding, age, deaths) %>%
                      colRenamer(c("deaths"="deaths2")), 
                  by=c("state", "weekEnding", "age")
                  ) %>%
        mutate(delta=ifelse(is.na(deaths2), 0, deaths2)-ifelse(is.na(deaths1), 0, deaths1), 
               neg=(delta < 0)
               ) 
    
    # Add the base column if requested
    if(isTRUE(labelBase)) df <- df %>% mutate(base=deaths1)
    
    # Rename and return the data
    df %>%
        colRenamer(c("deaths1"=lstLabels[1], "deaths2"=lstLabels[2]))
    
}

identical(dfCheck, 
          calculateRestatementFromRaw("cdcList_arch_2022w17", 
                                      "cdcList_20220713", 
                                      lstLabels=c("deaths_220425", "deaths_220713")
                                      )
          )

plotRestatementFromRaw <- function(df, 
                                   varNegTotal=c(), 
                                   fnDateStack=NULL,
                                   timePeriod=NULL, 
                                   makeProp=FALSE, 
                                   makePropYears=NULL
                                   ) {
    
    # FUNCTION ARGUMENTS:
    # df: data frame from calculateRestatementFromRaw
    # varNegTotal: variables that should be plotted for sum of negative restatement
    # fnDateStack: function to apply to weekEnding for stacking data (NULL means none)
    # timePeriod: character vector of time period of two data sources (NULL means infer from variable names)
    # makeProp: boolean, should proportional deaths be shown?
    # makePropYears: integer vector of years to include in proportional chart (NULL means latest year in data)
    
    if(is.null(timePeriod)) {
        timePeriod <- df %>% 
            select(starts_with("deaths_")) %>% 
            names() %>%
            str_remove(pattern="deaths_") %>%
            lubridate::ymd() %>%
            as.character() %>%
            paste0(collapse=" data to ")
        timePeriod <- paste0("from ", timePeriod, " data")
    }
    
    # Get counts of changes by varNegTotal
    for (keyVar in varNegTotal) {
        
        # Set up data for stacking
        if(!is.null(fnDateStack)) {
            dfPlot <- df %>%
                mutate(stackVar=fnDateStack(weekEnding))
            keyVar <- c(keyVar, "stackVar")
        } else {
            dfPlot <- df
        }
        
        # Create the totals
        dfTot <- dfPlot %>%
            group_by_at(all_of(keyVar[keyVar != "stackVar"])) %>%
            summarize(negDelta=sum(delta*neg), .groups="drop")
        
        # Set up base plot and labels
        p1 <- dfPlot %>% 
            group_by_at(all_of(keyVar)) %>%
            summarize(nNeg=sum(neg), negDelta=sum(delta*neg), n=n(), .groups="drop") %>%
            ggplot(aes(x=fct_reorder(get(keyVar[keyVar != "stackVar"]), negDelta), y=negDelta)) + 
            geom_text(data=dfTot, aes(label=negDelta), hjust=1) +
            coord_flip() + 
            labs(y=paste0("Sum of negative changes in weekly deaths ", timePeriod), 
                 x=NULL, 
                 title=paste0("Negative change in weekly death by ", keyVar[keyVar != "stackVar"])
                 )
        
        # Add the columns (either basic or stacked)
        if(is.null(fnDateStack)) p1 <- p1 + geom_col(fill="lightblue")
        else p1 <- p1 + geom_col(aes(fill=stackVar), position="stack")
        
        # Print the plot
        print(p1)
        
        # Create proportional plot if requested
        if(isTRUE(makeProp)) {
            
            # Get the year if passed as NULL
            if(is.null(makePropYears)) makePropYears <- max(lubridate::year(dfPlot$weekEnding))
            
            # Create the plot
            p2 <- dfPlot %>% 
                filter(lubridate::year(weekEnding) %in% all_of(makePropYears)) %>% 
                mutate(deltaNeg=ifelse(neg, delta, 0)) %>% 
                group_by_at(all_of(keyVar[keyVar != "stackVar"])) %>% 
                summarize(across(where(is.numeric), sum, na.rm=TRUE)) %>% 
                mutate(pctNeg=deltaNeg/base) %>%
                ggplot(aes(x=fct_reorder(get(keyVar[keyVar != "stackVar"]), pctNeg), y=pctNeg)) + 
                geom_col(fill="lightblue") + 
                geom_text(aes(y=pctNeg/2, label=paste0(round(100*pctNeg, 1), "%"))) +
                coord_flip() +
                labs(title=paste0("Proportion of ", 
                                  paste0(makePropYears, collapse="-"), 
                                  " deaths negatively restated ", 
                                  timePeriod
                                  ), 
                     y=NULL, 
                     x=NULL
                     )
            
            # Print the plot
            print(p2)
            
        }
    }
    
}

calculateRestatementFromRaw("cdcList_20220105", 
                            "cdcList_arch_2022w17", 
                            lstLabels=c("deaths_220105", "deaths_220425"), 
                            labelBase=TRUE
                            ) %>%
    plotRestatementFromRaw(varNegTotal=c("state", "age"), makeProp=TRUE, makePropYears=2021)

calculateRestatementFromRaw("cdcList_arch_2022w17", 
                            "cdcList_20220713", 
                            lstLabels=c("deaths_220425", "deaths_220713"), 
                            labelBase=TRUE
                            ) %>%
    plotRestatementFromRaw(varNegTotal=c("state", "age"), makeProp=TRUE, makePropYears=2022)

# Create function for custom quarter-year
tmpCustomQuarter <- function(x) 
    ifelse(lubridate::year(x)==2022, paste0(lubridate::year(x), "-Q", lubridate::quarter(x)), lubridate::year(x))

calculateRestatementFromRaw("cdcList_arch_2022w17", 
                            "cdcList_20220713", 
                            lstLabels=c("deaths_220425", "deaths_220713")
                            ) %>%
    plotRestatementFromRaw(varNegTotal=c("state", "age"), 
                           fnDateStack=tmpCustomQuarter
                           )

```
  
Between the 2022-01-05 data and the 2022-04-25 data, negative restatements were 559 (104+455) among people under the age of 45. Between the 2022-04-25 data and the 2022-07-13 data, negative restatements were 11,236 (3,820 + 7,416) among people under the age of 45. The majority of the 2022-07-13 vs 2022-04-25 restatements are in 2022-Q1 data, and proportionally the younger population is much more heavily restated than the older population

Functions are run on data from previous years:  
```{r, fig.height=9, fig.width=9}

calculateRestatementFromRaw("cdcList_20210911", 
                            "cdcList_20211203", 
                            lstLabels=c("deaths_210911", "deaths_211203"), 
                            labelBase=TRUE
                            ) %>%
    plotRestatementFromRaw(varNegTotal=c("state", "age"), makeProp=TRUE, makePropYears=2021)

# Create function for custom quarter-year
tmpCustomQuarter <- function(x, keyYear=2022) 
    ifelse(lubridate::year(x) %in% all_of(keyYear), 
           paste0(lubridate::year(x), "-Q", lubridate::quarter(x)), 
           lubridate::year(x)
           )

calculateRestatementFromRaw("cdcList_20210911", 
                            "cdcList_20211203", 
                            lstLabels=c("deaths_210911", "deaths_211203")
                            ) %>%
    plotRestatementFromRaw(varNegTotal=c("state", "age"), 
                           fnDateStack=function(x) tmpCustomQuarter(x, keyYear=2021)
                           )

```

Negative restatement of data was much less common, particularly among people under age 45, during a 3-month time period selected from 2021

Plots are made for the percentage of negative restatement by state and week for a specified age group:  
```{r, fig.height=9, fig.width=9}

# Create the basic frame
df_u45 <- calculateRestatementFromRaw("cdcList_arch_2022w17", 
                            "cdcList_20220713", 
                            lstLabels=c("deaths_220425", "deaths_220713"), 
                            labelBase=TRUE
                            ) %>%
    filter(weekEnding >= as.Date("2021-12-01"),
           !is.na(deaths_220425)
           )

# Get the list of states in every week
u45States <- df_u45 %>% count(state) %>% filter(n>=max(n)-1) %>% pull(state)
u45States

# Create the plot (Under age 45)
df_u45 %>%
    filter(state %in% all_of(u45States), age %in% c("Under 25 years", "25-44 years")) %>%
    mutate(chg=delta/base) %>%
    ggplot(aes(x=fct_reorder(state, chg, .fun=function(x) sum(ifelse(x<=0, x, 0))), y=weekEnding)) + 
    geom_tile(aes(fill=chg)) + 
    coord_flip() + 
    scale_fill_gradient2("Pct Restated", low="red", high="green", midpoint=0) + 
    labs(y="Week", 
         x=NULL, 
         title="Restatement of deaths in 2022-07-13 data vs. 2022-04-25 data", 
         subtitle="States missing at most 2 weeks for Under 25 and 25-44 years in each data set"
         ) + 
    facet_wrap(~age)

# Create the plot (All ages)
df_u45 %>%
    filter(state %in% all_of(u45States)) %>%
    mutate(chg=delta/base) %>%
    ggplot(aes(x=fct_reorder(state, chg, .fun=function(x) sum(ifelse(x<=0, x, 0))), y=weekEnding)) + 
    geom_tile(aes(fill=chg)) + 
    coord_flip() + 
    scale_fill_gradient2("Pct Restated", low="red", high="green", midpoint=0) + 
    labs(y="Week", 
         x=NULL, 
         title="Restatement of deaths in 2022-07-13 data vs. 2022-04-25 data", 
         subtitle="States missing at most 2 weeks for any age group"
         ) + 
    facet_wrap(~age)

```
  
There are significant differences in the amount of negative restatement by state and week in 2022, driven by "Under 25" and "25-44". Restatements are generally modest to nonexistent in the December 2021 data and among people over age 45

Specific states are explored:  
```{r, fig.height=9, fig.width=9}

allAges <- unique(readFromRDS("cdcList_arch_2022w17")$cdc$age)
allWeeks <- seq.Date(as.Date("2015-01-10"), as.Date("2029-12-31"), by="7 days")
allAgeWeek <- tibble::tibble(date=rep(allWeeks, times=length(allAges)), age=rep(allAges, each=length(allWeeks)))
allAgeWeek

# Example for Florida from pre-update data
readFromRDS("cdcList_arch_2022w17")$cdc %>% 
    filter(state=="FL") %>% 
    full_join(allAgeWeek %>% filter(date <= "2022-04-23"), by=c("weekEnding"="date", "age")) %>% 
    mutate(deaths=ifelse(is.na(deaths), 0, deaths)) %>% 
    ggplot(aes(x=weekEnding, y=deaths)) + 
    geom_line() + 
    lims(y=c(0, NA)) + 
    geom_smooth(data=~filter(., weekEnding <= "2020-01-01"), method="lm", fullrange=TRUE) + 
    geom_smooth(color="red") + 
    facet_wrap(~age, scales="free_y") + 
    labs(x=NULL, 
         y="Weekly all-cause deaths", 
         title="Weekly all-cause deaths in FL (2022-04-23 data)", 
         subtitle="Blue smooth is linear model based on 2015-2019 data"
         )

# Example for Colorado from post-update data
readFromRDS("cdcList_20220713")$cdc %>% 
    filter(state=="CO") %>% 
    full_join(allAgeWeek %>% filter(date <= "2022-06-18"), by=c("weekEnding"="date", "age")) %>% 
    mutate(deaths=ifelse(is.na(deaths), 0, deaths)) %>% 
    ggplot(aes(x=weekEnding, y=deaths)) + 
    geom_line() + 
    lims(y=c(0, NA)) + 
    geom_smooth(data=~filter(., weekEnding <= "2020-01-01"), method="lm", fullrange=TRUE) + 
    geom_smooth(color="red") + 
    facet_wrap(~age, scales="free_y") + 
    labs(x=NULL, 
         y="Weekly all-cause deaths", 
         title="Weekly all-cause deaths in CO (2022-06-18 data)", 
         subtitle="Blue smooth is linear model based on 2015-2019 data"
         )

```
  
Slight downturns in the most recent weeks are normal, as there is a several-week build of deaths in the CDC database (lag in death reporting from states and counties). There are unexplained downturns in early-mid 2022 that were not observed in pre-update iterations of the data

The process is converted to functional form:  
```{r, fig.height=9, fig.width=9}

plotCDCRestatement <- function(lstOld, 
                               lstNew, 
                               lstLabels, 
                               minDate=NULL, 
                               maxDate=NULL, 
                               useStates=NULL,
                               maxMissingAllowed=2, 
                               lstFilter=list(), 
                               lstExclude=list(),
                               createStatePlot=TRUE,
                               restateYears=c(),
                               restateQuarterYears=c(),
                               returnData=!isTRUE(createStatePlot)
                               ) {
    
    # FUNCTION ARGUMENTS:
    # lstOld: name for the old CDC data list (character name of the list for readFromRDS)
    # lstNew: name for the new CDC data list (character name of the list for readFromRDS)
    # lstLabels: character vector of length 2 giving the plotting names for the lists
    # minDate: include only data on or after this date (NULL means include all)
    # maxDate: include only data on or before this date (NULL means include all)
    # useStates: states to be included in plotting (NULL means create from data and maxMissingAllowed)
    # maxMissingAllowed: maximum number of missing records allowed to include state
    # lstFilter: a list for filtering records, of form list("field"=c("allowed values"))
    # lstExclude: a list for filtering records, of form list("field"=c("disallowed values"))
    # createStatePlot: should the restatement plot be created?
    # restateYears: years for which restatement plots should be created
    # restateQuarterYears: years for which quarter should be broken out
    # returnData: boolean, should the plotting data frame be returned?
    
    # Create the basic frame
    df <- calculateRestatementFromRaw(lstOld, lstNew, lstLabels=lstLabels, labelBase=TRUE)
    if(!is.null(minDate)) df <- df %>% filter(weekEnding >= as.Date(minDate))
    if(!is.null(maxDate)) df <- df %>% filter(weekEnding <= as.Date(maxDate))

    # Get the list of states in every week
    if(is.null(useStates)) {
        useStates <- df %>% 
            filter(!is.na(get(lstLabels[1]))) %>% 
            count(state) %>% 
            filter(n>=max(n)-maxMissingAllowed) %>% 
            pull(state)
    }
    cat("\n", length(useStates), "states will be included:", paste0(useStates, collapse=", "), "\n")
    print(c(lstFilter, list("age"=useStates)))
    
    # Create the plot
    if(isTRUE(createStatePlot)) {
        p1 <- df %>%
            filter(!is.na(get(lstLabels[1]))) %>%
            rowFilter(lstFilter=c(lstFilter, list("state"=useStates)), lstExclude=lstExclude) %>%
            mutate(chg=delta/base) %>%
            ggplot(aes(x=fct_reorder(state, chg, .fun=function(x) sum(ifelse(x<=0, x, 0))), y=weekEnding)) +
            geom_tile(aes(fill=chg)) +
            coord_flip() +
            scale_fill_gradient2("Pct Restated", low="red", high="green", midpoint=0) +
            labs(y="Week",
                 x=NULL,
                 title=paste0("Restatement of deaths in ",
                              lubridate::ymd(stringr::str_extract(lstLabels[1], pattern="\\d{6}")),
                              " data vs. ",
                              lubridate::ymd(stringr::str_extract(lstLabels[2], pattern="\\d{6}")),
                              " data"
                              ),
                 subtitle="Select states meeting minimum data availability threshold"
                 ) +
            facet_wrap(~age)
        print(p1)
    }

    # Create restatement by year plots
    for(curYear in restateYears) {
        calculateRestatementFromRaw(lstOld, lstNew, lstLabels=lstLabels, labelBase=TRUE) %>%
            plotRestatementFromRaw(varNegTotal=c("state", "age"), makeProp=TRUE, makePropYears=curYear)
    }
    
    # Create restatement by quarter plots
    if(length(restateQuarterYears) > 0) {
        calculateRestatementFromRaw(lstOld, lstNew, lstLabels=lstLabels) %>%
            plotRestatementFromRaw(varNegTotal=c("state", "age"), 
                                   fnDateStack=function(x) tmpCustomQuarter(x, keyYear=restateQuarterYears)
                                   )
    }

    # Return the data if requested
    if(isTRUE(returnData)) return(df)
    
}

# Check that data are the same
all.equal(dfCheck, 
          plotCDCRestatement(lstOld="cdcList_arch_2022w17", 
                             lstNew="cdcList_20220713", 
                             lstLabels=c("deaths_220425", "deaths_220713"), 
                             createStatePlot=FALSE
                             ) %>%
              select(-base)
          )

# Plot for all ages
plotCDCRestatement(lstOld="cdcList_arch_2022w17", 
                   lstNew="cdcList_20220713", 
                   lstLabels=c("deaths_220425", "deaths_220713"), 
                   minDate="2021-12-01"
                   )

# Plot for under 45
plotCDCRestatement(lstOld="cdcList_arch_2022w17", 
                   lstNew="cdcList_20220713", 
                   lstLabels=c("deaths_220425", "deaths_220713"), 
                   lstFilter=list("age"=c("Under 25 years", "25-44 years")),
                   minDate="2021-12-01"
                   )

# Yearly and quarterly plots
plotCDCRestatement(lstOld="cdcList_arch_2022w17", 
                   lstNew="cdcList_20220713", 
                   lstLabels=c("deaths_220425", "deaths_220713"), 
                   createStatePlot=FALSE,
                   restateYears=2022, 
                   restateQuarterYears=2021:2022
                   )

```

The process is updated with the latest data:  
```{r, fig.height=9, fig.width=9, cache=TRUE}

# STEP 1: Latest CDC all-cause deaths data
cdcLoc <- "Weekly_counts_of_deaths_by_jurisdiction_and_age_group_downloaded_20220925.csv"
cdcList_20220925 <- readRunCDCAllCause(loc=cdcLoc, 
                                       weekThru=24, 
                                       lst=readFromRDS("cdc_daily_220902"), 
                                       stateNoCheck=c(), 
                                       pdfCluster=TRUE, 
                                       pdfAge=TRUE
                                       )
saveToRDS(cdcList_20220925, ovrWriteError=FALSE)

# STEP 2: Latest death by location-cause data
allCause_220925 <- analyzeAllCause(loc="COvID_deaths_age_place_20220925.csv", 
                                   cdcDailyList=readFromRDS("cdc_daily_220902"), 
                                   compareThruDate="2022-08-25"
                                   )
saveToRDS(allCause_220925, ovrWriteError=FALSE)

# STEP 3: Facets for excess all-cause deaths
excessDeathFacets(lstCDC=cdcList_20220925, lstAll=allCause_220925, dateThru="2022-08-31", plotYLim=c(-200, 1200))

```
  
Restatement is also assessed:  
```{r, fig.height=9, fig.width=9, cache=TRUE}

# Plot for all ages
plotCDCRestatement(lstOld="cdcList_arch_2022w17", 
                   lstNew="cdcList_20220925", 
                   lstLabels=c("deaths_220425", "deaths_220925"), 
                   minDate="2021-12-01"
                   )

# Plot for under 45
plotCDCRestatement(lstOld="cdcList_arch_2022w17", 
                   lstNew="cdcList_20220925", 
                   lstLabels=c("deaths_220425", "deaths_220925"), 
                   lstFilter=list("age"=c("Under 25 years", "25-44 years")),
                   minDate="2021-12-01"
                   )

# Yearly and quarterly plots
plotCDCRestatement(lstOld="cdcList_arch_2022w17", 
                   lstNew="cdcList_20220925", 
                   lstLabels=c("deaths_220425", "deaths_220925"), 
                   createStatePlot=FALSE,
                   restateYears=2022, 
                   restateQuarterYears=2021:2022
                   )

```
  
There are still some restatement issues relative to older data, though the very large percentage declines previously observed in persons under age 45 are no longer evident

The process is updated with the latest data:  
```{r, fig.height=9, fig.width=9, cache=TRUE}

# STEP 1: Latest CDC all-cause deaths data
cdcLoc <- "Weekly_counts_of_deaths_by_jurisdiction_and_age_group_downloaded_20221021.csv"
cdcList_20221021 <- readRunCDCAllCause(loc=cdcLoc, 
                                       weekThru=28, 
                                       lst=readFromRDS("cdc_daily_221002"), 
                                       stateNoCheck=c(), 
                                       pdfCluster=TRUE, 
                                       pdfAge=TRUE
                                       )
saveToRDS(cdcList_20221021, ovrWriteError=FALSE)

# STEP 2: Latest death by location-cause data
allCause_221021 <- analyzeAllCause(loc="COvID_deaths_age_place_20221021.csv", 
                                   cdcDailyList=readFromRDS("cdc_daily_221002"), 
                                   compareThruDate="2022-09-22"
                                   )
saveToRDS(allCause_221021, ovrWriteError=FALSE)

# STEP 3: Facets for excess all-cause deaths
excessDeathFacets(lstCDC=cdcList_20221021, lstAll=allCause_221021, dateThru="2022-09-30", plotYLim=c(-200, 1200))

```
  
Restatement is also assessed:  
```{r, fig.height=9, fig.width=9, cache=TRUE}

# Plot for all ages
plotCDCRestatement(lstOld="cdcList_arch_2022w17", 
                   lstNew="cdcList_20221021", 
                   lstLabels=c("deaths_220425", "deaths_221021"), 
                   minDate="2021-12-01"
                   )

# Plot for under 45
plotCDCRestatement(lstOld="cdcList_arch_2022w17", 
                   lstNew="cdcList_20221021", 
                   lstLabels=c("deaths_220425", "deaths_221021"), 
                   lstFilter=list("age"=c("Under 25 years", "25-44 years")),
                   minDate="2021-12-01"
                   )

# Yearly and quarterly plots
plotCDCRestatement(lstOld="cdcList_arch_2022w17", 
                   lstNew="cdcList_20221021", 
                   lstLabels=c("deaths_220425", "deaths_221021"), 
                   createStatePlot=FALSE,
                   restateYears=2022, 
                   restateQuarterYears=2021:2022
                   )

```
  
The process is updated with the latest data:  
```{r, fig.height=9, fig.width=9, cache=TRUE}

# STEP 1: Latest CDC all-cause deaths data
cdcLoc <- "Weekly_counts_of_deaths_by_jurisdiction_and_age_group_downloaded_20221112.csv"
cdcList_20221112 <- readRunCDCAllCause(loc=cdcLoc, 
                                       weekThru=31, 
                                       lst=readFromRDS("cdc_daily_221102"), 
                                       stateNoCheck=c(), 
                                       pdfCluster=TRUE, 
                                       pdfAge=TRUE
                                       )
saveToRDS(cdcList_20221112, ovrWriteError=FALSE)

# STEP 2: Latest death by location-cause data
allCause_221112 <- analyzeAllCause(loc="COvID_deaths_age_place_20221112.csv", 
                                   cdcDailyList=readFromRDS("cdc_daily_221102"), 
                                   compareThruDate="2022-10-13"
                                   )
saveToRDS(allCause_221112, ovrWriteError=FALSE)

# STEP 3: Facets for excess all-cause deaths
excessDeathFacets(lstCDC=cdcList_20221112, lstAll=allCause_221112, dateThru="2022-10-15", plotYLim=c(-200, 1200))

```
  
Restatement is also assessed:  
```{r, fig.height=9, fig.width=9, cache=TRUE}

# Plot for all ages
plotCDCRestatement(lstOld="cdcList_arch_2022w17", 
                   lstNew="cdcList_20221112", 
                   lstLabels=c("deaths_220425", "deaths_221112"), 
                   minDate="2021-12-01"
                   )

# Plot for under 45
plotCDCRestatement(lstOld="cdcList_arch_2022w17", 
                   lstNew="cdcList_20221112", 
                   lstLabels=c("deaths_220425", "deaths_221112"), 
                   lstFilter=list("age"=c("Under 25 years", "25-44 years")),
                   minDate="2021-12-01"
                   )

# Yearly and quarterly plots
plotCDCRestatement(lstOld="cdcList_arch_2022w17", 
                   lstNew="cdcList_20221112", 
                   lstLabels=c("deaths_220425", "deaths_221112"), 
                   createStatePlot=FALSE,
                   restateYears=2022, 
                   restateQuarterYears=2021:2022
                   )

```
  
The process is updated with the latest data:  
```{r, fig.height=9, fig.width=9, cache=TRUE}

# STEP 1: Latest CDC all-cause deaths data
cdcLoc <- "Weekly_counts_of_deaths_by_jurisdiction_and_age_group_downloaded_20221214.csv"
cdcList_20221214 <- readRunCDCAllCause(loc=cdcLoc, 
                                       weekThru=36, 
                                       lst=readFromRDS("cdc_daily_221202"), 
                                       stateNoCheck=c(), 
                                       pdfCluster=TRUE, 
                                       pdfAge=TRUE
                                       )
saveToRDS(cdcList_20221214, ovrWriteError=FALSE)

# STEP 2: Latest death by location-cause data
allCause_221214 <- analyzeAllCause(loc="COvID_deaths_age_place_20221214.csv", 
                                   cdcDailyList=readFromRDS("cdc_daily_221202"), 
                                   compareThruDate="2022-11-30"
                                   )
saveToRDS(allCause_221214, ovrWriteError=FALSE)

# STEP 3: Facets for excess all-cause deaths
excessDeathFacets(lstCDC=cdcList_20221214, lstAll=allCause_221214, dateThru="2022-11-30", plotYLim=c(-200, 1200))

```
  
Restatement is also assessed:  
```{r, fig.height=9, fig.width=9, cache=TRUE}

# Plot for all ages
plotCDCRestatement(lstOld="cdcList_arch_2022w17", 
                   lstNew="cdcList_20221214", 
                   lstLabels=c("deaths_220425", "deaths_221214"), 
                   minDate="2021-12-01"
                   )

# Plot for under 45
plotCDCRestatement(lstOld="cdcList_arch_2022w17", 
                   lstNew="cdcList_20221214", 
                   lstLabels=c("deaths_220425", "deaths_221214"), 
                   lstFilter=list("age"=c("Under 25 years", "25-44 years")),
                   minDate="2021-12-01"
                   )

# Yearly and quarterly plots
plotCDCRestatement(lstOld="cdcList_arch_2022w17", 
                   lstNew="cdcList_20221214", 
                   lstLabels=c("deaths_220425", "deaths_221214"), 
                   createStatePlot=FALSE,
                   restateYears=2022, 
                   restateQuarterYears=2021:2022
                   )

```
  
The process is updated with the latest data:  
```{r, fig.height=9, fig.width=9, cache=TRUE}

# STEP 1: Latest CDC all-cause deaths data
cdcLoc <- "Weekly_counts_of_deaths_by_jurisdiction_and_age_group_downloaded_20230113.csv"
cdcList_20230113 <- readRunCDCAllCause(loc=cdcLoc, 
                                       weekThru=41, 
                                       lst=readFromRDS("cdc_daily_230102"), 
                                       stateNoCheck=c(), 
                                       pdfCluster=TRUE, 
                                       pdfAge=TRUE
                                       )
saveToRDS(cdcList_20230113, ovrWriteError=FALSE)

# STEP 2: Latest death by location-cause data
allCause_230113 <- analyzeAllCause(loc="COvID_deaths_age_place_20230113.csv", 
                                   cdcDailyList=readFromRDS("cdc_daily_230102"), 
                                   compareThruDate="2022-12-31"
                                   )
saveToRDS(allCause_230113, ovrWriteError=FALSE)

# STEP 3: Facets for excess all-cause deaths
excessDeathFacets(lstCDC=cdcList_20230113, lstAll=allCause_230113, dateThru="2022-12-31", plotYLim=c(-200, 1200))

```
  
