---
title: "Coronavirus US - All-Cause Death"
author: "davegoblue"
date: '2022-06-23'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Background  
This module extends code contained in Coronavirus_Statistics_v005.Rmd to include sourcing of updated functions and parameters.  This file includes the latest code for analyzing all-cause death data from [CDC Weekly Deaths by Jurisdiction](https://catalog.data.gov/dataset/weekly-counts-of-deaths-by-jurisdiction-and-age-group).  CDC maintains data on deaths by week, age cohort, and state in the US.  Downloaded data are unique by state, epidemiological week, year, age, and type (actual vs. predicted/projected).

These data are known to have a lag between death and reporting, and the CDC back-correct to report deaths at the time the death occurred even if the death is reported in following weeks.  This means totals for recent weeks tend to run low (lag), and the CDC run a projection of the expected total number of deaths given the historical lag times.  Per other analysts on the internet, there is currently significant supra-lag, with lag times much longer than historical averages causing CDC projected deaths for recent weeks to be low.

The code leverages tidyverse and sourced functions throughout:  
```{r}

# All functions assume that tidyverse and its components are loaded and available
library(tidyverse)

# If the same function is in both files, use the version from the more specific source
source("./Generic_Added_Utility_Functions_202105_v001.R")
source("./Coronavirus_CDC_Excess_Functions_v001.R")

```
  
The basic process includes three data update steps:  
```{r, fig.height=9, fig.width=9, cache=TRUE}

# STEP 0: Appropriate parameters for 2022 data
cdcExcessParams <- list(remapVars=c('Jurisdiction'='fullState', 
                                    'Week Ending Date'='weekEnding', 
                                    'State Abbreviation'='state', 
                                    'Age Group'='age', 
                                    'Number of Deaths'='deaths', 
                                    'Time Period'='period', 
                                    'Year'='year', 
                                    'Week'='week'
                                    ),
                        colTypes="ccciicdcccc",
                        ageLevels=c("Under 25 years", 
                                    "25-44 years", 
                                    "45-64 years", 
                                    "65-74 years", 
                                    "75-84 years", 
                                    "85 years and older"
                                    ),
                        periodLevels=c("2015-2019", "2020", "2021", "2022"),
                        periodKeep=c("2015-2019", "2020", "2021"),
                        yearLevels=2015:2022
                        )

# STEP 1: Latest CDC all-cause deaths data
cdcLoc <- "Weekly_counts_of_deaths_by_jurisdiction_and_age_group_downloaded_20220623.csv"
cdcList_20220623 <- readRunCDCAllCause(loc=cdcLoc, 
                                       weekThru=21, 
                                       lst=readFromRDS("cdc_daily_220602"), 
                                       stateNoCheck=c(), 
                                       pdfCluster=TRUE, 
                                       pdfAge=TRUE
                                       )
saveToRDS(cdcList_20220623, ovrWriteError=FALSE)

# STEP 2: Latest death bu location-cause data
allCause_220623 <- analyzeAllCause(loc="COvID_deaths_age_place_20220623.csv", 
                                   cdcDailyList=readFromRDS("cdc_daily_220602"), 
                                   compareThruDate="2022-05-31"
                                   )
saveToRDS(allCause_220623, ovrWriteError=FALSE)

# STEP 3: Facets for excess all-cause deaths
excessDeathFacets(lstCDC=cdcList_20220623, lstAll=allCause_220623, dateThru="2022-04-30", plotYLim=c(-200, 1200))

```
  
Updated with the latest data:  
```{r, fig.height=9, fig.width=9, cache=TRUE}

# STEP 1: Latest CDC all-cause deaths data
cdcLoc <- "Weekly_counts_of_deaths_by_jurisdiction_and_age_group_downloaded_20220713.csv"
cdcList_20220713 <- readRunCDCAllCause(loc=cdcLoc, 
                                       weekThru=24, 
                                       lst=readFromRDS("cdc_daily_220704"), 
                                       stateNoCheck=c(), 
                                       pdfCluster=TRUE, 
                                       pdfAge=TRUE
                                       )
saveToRDS(cdcList_20220713, ovrWriteError=FALSE)

# STEP 2: Latest death bu location-cause data
allCause_220713 <- analyzeAllCause(loc="COvID_deaths_age_place_20220713.csv", 
                                   cdcDailyList=readFromRDS("cdc_daily_220704"), 
                                   compareThruDate="2022-06-30"
                                   )
saveToRDS(allCause_220713, ovrWriteError=FALSE)

# STEP 3: Facets for excess all-cause deaths
excessDeathFacets(lstCDC=cdcList_20220713, lstAll=allCause_220713, dateThru="2022-05-31", plotYLim=c(-200, 1200))

```
  
There have been issues with US all-cause deaths data since a "systems upgrade" in mid-June. How much restatement of data has occurred?
```{r, fig.height=9, fig.width=9}

# Mapping file of epiweek and epiyear to date
mapEpi <- tibble::tibble(date=seq.Date(as.Date("2014-12-01"), as.Date("2031-01-31"), by=1)) %>%
    mutate(epiYear=as.integer(lubridate::epiyear(date)), epiWeek=as.integer(lubridate::epiweek(date)))

nameFile <- "ageAgg"
dfCheck <- bind_rows(readFromRDS("cdcList_20220713")[[nameFile]], 
                     readFromRDS("cdcList_20220623")[[nameFile]], 
                     readFromRDS("cdcList_20220105")[[nameFile]], 
                     .id="fileDate"
                     ) %>%
    mutate(fileDate=c("1"="2022-07-13", "2"="2022-06-23", "3"="2022-01-05")[fileDate])

mapEpi %>%
    arrange(date) %>%
    group_by(epiYear, epiWeek) %>%
    filter(row_number()==1) %>%
    ungroup() %>%
    rename(yearint=epiYear, week=epiWeek) %>%
    right_join(dfCheck, by=c("yearint", "week")) %>%
    ggplot(aes(x=date, y=deaths)) + 
    geom_line(aes(color=fileDate, group=fileDate)) + 
    lims(y=c(0, NA)) +
    labs(x=NULL, y="Reported all-cause US deaths", title="US all-cause deaths by report date") +
    facet_wrap(~age, scales="free_y")

```
  
Data appear anomalous, particularly 2022 deaths in "Under 25 years" and "25-44 years". Partly, this is incomplete reporting in the most recent weeks (normal), but partly this may be driven by data not yet re-entered after the upgrade. It is striking that there are fewer reported all-cause deaths in the 2022-07-13 data than in the 2022-06-23 data for any cohort, as all-cause data almost always increases as additional reports are received from vital statistics departments. Trends among "45-64 years" and senior citizens, at a glance, are the more commonly observed build over time
  
The process is converted to functional form:  
```{r, fig.height=9, fig.width=9}

makeRestatementData <- function(vecFiles, key, vecNames=NULL, epiRange=as.Date(c("2014-12-01", "2031-01-31"))) {
    
    # FUNCTION ARGUMENTS:
    # vecFiles: character vector of file names (will be extracted using readFromRDS)
    # key: the extract element from each of the lists
    # vecNames: names to be used in plot for each of the extracts (NULL means infer from ...)
    # epiRange: range for converting epiweek and epiyear to date (should be a larger range than data)

    # Create keyNames if not provided
    if(is.null(vecNames)) {
        vecNames <- as.character(lubridate::ymd(stringr::str_remove(vecFiles, ".*_"))) %>%
            purrr::set_names(as.character(1:length(vecFiles)))
    }
    
    # Create epi mapping file
    dfEpi <- tibble::tibble(date=seq.Date(epiRange[1], epiRange[2], by=1)) %>%
        mutate(epiYear=as.integer(lubridate::epiyear(date)), 
               epiWeek=as.integer(lubridate::epiweek(date))
               )

    # Create single date for each epiWeek and epiYear
    mapEpi <- dfEpi %>%
        arrange(date) %>%
        group_by(epiYear, epiWeek) %>%
        filter(row_number()==1) %>%
        ungroup() %>%
        rename(yearint=epiYear, week=epiWeek)
    
    # Read and integrate file, add epiDate
    purrr::map_dfr(.x=vecFiles, 
                   .f=function(x) readFromRDS(x)[[key]], 
                   .id="fileDate"
                   ) %>%
        mutate(fileDate=vecNames[fileDate]) %>%
        left_join(mapEpi, by=c("yearint", "week"))
    
}

makeRestatementData(c("cdcList_20220713", "cdcList_20220623", "cdcList_20220105"), key="ageAgg")
makeRestatementData(c("cdcList_20220713", "cdcList_20220623", "cdcList_20220105"), key="stateAgg")
makeRestatementData(c("cdcList_20220713", "cdcList_20220623", "cdcList_20220105"), key="clusterAgg")
makeRestatementData(c("cdcList_20220713", "cdcList_20220623", "cdcList_20220105"), key="allUSAgg")

```
  
