---
title: "Open Meteo Weather Exploration"
author: "davegoblue"
date: "2024-12-01"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Background
Open-Meteo maintains an [API for historical weather](https://open-meteo.com/en/docs/historical-weather-api) that allows for non-commercial usage of historical weather data maintained by the website.

This file builds on _v001, _v002, _v003, and _v004 to run exploratory analysis on some historical weather data.

## Functions and Libraries
The exploration process uses tidyverse, ranger, several generic custom functions, and several functions specific to Open Meteo processing. First, tidyverse, ranger, and the generic functions are loaded:  
```{r}

library(tidyverse) # tidyverse functionality is included throughout
library(ranger) # predict() does not work on ranger objects unless ranger has been called

source("./Generic_Added_Utility_Functions_202105_v001.R") # Basic functions

```
  
Next, specific functions written in _v001, _v002, _v003, and _v004 are sourced:  
```{r}

source("./SimpleOneVar_Functions_202411_v001.R") # Functions for basic single variable analysis
source("./OpenMeteo_NextBest_202411_v001.R") # Functions for finding 'next best' predictor given existing model
source("./OpenMeteo_Functions_202411_v001.R") # Core functions for loading, processing, analysis of Open Meteo

```
  
Key mapping tables for available metrics are also copied:  
```{r}

hourlyMetrics <- "temperature_2m,relativehumidity_2m,dewpoint_2m,apparent_temperature,pressure_msl,surface_pressure,precipitation,rain,snowfall,cloudcover,cloudcover_low,cloudcover_mid,cloudcover_high,shortwave_radiation,direct_radiation,direct_normal_irradiance,diffuse_radiation,windspeed_10m,windspeed_100m,winddirection_10m,winddirection_100m,windgusts_10m,et0_fao_evapotranspiration,weathercode,vapor_pressure_deficit,soil_temperature_0_to_7cm,soil_temperature_7_to_28cm,soil_temperature_28_to_100cm,soil_temperature_100_to_255cm,soil_moisture_0_to_7cm,soil_moisture_7_to_28cm,soil_moisture_28_to_100cm,soil_moisture_100_to_255cm"
dailyMetrics <- "weathercode,temperature_2m_max,temperature_2m_min,apparent_temperature_max,apparent_temperature_min,precipitation_sum,rain_sum,snowfall_sum,precipitation_hours,sunrise,sunset,windspeed_10m_max,windgusts_10m_max,winddirection_10m_dominant,shortwave_radiation_sum,et0_fao_evapotranspiration"

hourlyDescription <- "Air temperature at 2 meters above ground\nRelative humidity at 2 meters above ground\nDew point temperature at 2 meters above ground\nApparent temperature is the perceived feels-like temperature combining wind chill factor, relative humidity and solar radiation\nAtmospheric air pressure reduced to mean sea level (msl) or pressure at surface. Typically pressure on mean sea level is used in meteorology. Surface pressure gets lower with increasing elevation.\nAtmospheric air pressure reduced to mean sea level (msl) or pressure at surface. Typically pressure on mean sea level is used in meteorology. Surface pressure gets lower with increasing elevation.\nTotal precipitation (rain, showers, snow) sum of the preceding hour. Data is stored with a 0.1 mm precision. If precipitation data is summed up to monthly sums, there might be small inconsistencies with the total precipitation amount.\nOnly liquid precipitation of the preceding hour including local showers and rain from large scale systems.\nSnowfall amount of the preceding hour in centimeters. For the water equivalent in millimeter, divide by 7. E.g. 7 cm snow = 10 mm precipitation water equivalent\nTotal cloud cover as an area fraction\nLow level clouds and fog up to 2 km altitude\nMid level clouds from 2 to 6 km altitude\nHigh level clouds from 6 km altitude\nShortwave solar radiation as average of the preceding hour. This is equal to the total global horizontal irradiation\nDirect solar radiation as average of the preceding hour on the horizontal plane and the normal plane (perpendicular to the sun)\nDirect solar radiation as average of the preceding hour on the horizontal plane and the normal plane (perpendicular to the sun)\nDiffuse solar radiation as average of the preceding hour\nWind speed at 10 or 100 meters above ground. Wind speed on 10 meters is the standard level.\nWind speed at 10 or 100 meters above ground. Wind speed on 10 meters is the standard level.\nWind direction at 10 or 100 meters above ground\nWind direction at 10 or 100 meters above ground\nGusts at 10 meters above ground of the indicated hour. Wind gusts in CERRA are defined as the maximum wind gusts of the preceding hour. Please consult the ECMWF IFS documentation for more information on how wind gusts are parameterized in weather models.\nET0 Reference Evapotranspiration of a well watered grass field. Based on FAO-56 Penman-Monteith equations ET0 is calculated from temperature, wind speed, humidity and solar radiation. Unlimited soil water is assumed. ET0 is commonly used to estimate the required irrigation for plants.\nWeather condition as a numeric code. Follow WMO weather interpretation codes. See table below for details. Weather code is calculated from cloud cover analysis, precipitation and snowfall. As barely no information about atmospheric stability is available, estimation about thunderstorms is not possible.\nVapor Pressure Deificit (VPD) in kilopascal (kPa). For high VPD (>1.6), water transpiration of plants increases. For low VPD (<0.4), transpiration decreases\nAverage temperature of different soil levels below ground.\nAverage temperature of different soil levels below ground.\nAverage temperature of different soil levels below ground.\nAverage temperature of different soil levels below ground.\nAverage soil water content as volumetric mixing ratio at 0-7, 7-28, 28-100 and 100-255 cm depths.\nAverage soil water content as volumetric mixing ratio at 0-7, 7-28, 28-100 and 100-255 cm depths.\nAverage soil water content as volumetric mixing ratio at 0-7, 7-28, 28-100 and 100-255 cm depths.\nAverage soil water content as volumetric mixing ratio at 0-7, 7-28, 28-100 and 100-255 cm depths."
dailyDescription <- "The most severe weather condition on a given day\nMaximum and minimum daily air temperature at 2 meters above ground\nMaximum and minimum daily air temperature at 2 meters above ground\nMaximum and minimum daily apparent temperature\nMaximum and minimum daily apparent temperature\nSum of daily precipitation (including rain, showers and snowfall)\nSum of daily rain\nSum of daily snowfall\nThe number of hours with rain\nSun rise and set times\nSun rise and set times\nMaximum wind speed and gusts on a day\nMaximum wind speed and gusts on a day\nDominant wind direction\nThe sum of solar radiaion on a given day in Megajoules\nDaily sum of ET0 Reference Evapotranspiration of a well watered grass field"

# Create tibble for hourly metrics
tblMetricsHourly <- tibble::tibble(metric=hourlyMetrics %>% str_split_1(","), 
                                   description=hourlyDescription %>% str_split_1("\n")
                                   )
tblMetricsHourly %>% 
    print(n=50)

# Create tibble for daily metrics
tblMetricsDaily <- tibble::tibble(metric=dailyMetrics %>% str_split_1(","), 
                                  description=dailyDescription %>% str_split_1("\n")
                                   )
tblMetricsDaily

```

A previously existing dataset is loaded, with key analysis variables defined in a vector:  
```{r}

# Load previous data
allCity <- readFromRDS("allCity_20241116")

# Get core training variables
varsTrain <- getVarsTrain(allCity)
varsTrain

# Assign default label
keyLabel <- genericKeyLabelOM()
keyLabel

```

The correlation heatmap is reproduced, with functions that borrowing from the recipe at [STHDA](http://www.sthda.com/english/wiki/ggplot2-quick-correlation-matrix-heatmap-r-software-and-data-visualization):
```{r, fig.height=9, fig.width=9}

# Default function
corVarsTrain <- makeHeatMap(allCity, vecSelect=varsTrain, returnData=TRUE)
corVarsTrain %>% filter(Var1!=Var2) %>% arrange(desc(value)) %>% print(n=20)

```

The correlation heatmap is produced for a single city:  
```{r, fig.height=9, fig.width=9}

corVarsTrainBOS <- makeHeatMap(allCity %>% filter(src=="Boston"), vecSelect=varsTrain, returnData=TRUE)
corVarsTrainBOS %>% filter(Var1!=Var2) %>% arrange(desc(value)) %>% print(n=20)

```

Some variables, such as surface pressure vs. MSL pressure, are much differently correlated if controlling for city. Differences are explored:  
```{r, fig.height=9, fig.width=9}

tstCorDelta <- corVarsTrain %>% 
    mutate(v1=pmin(as.character(Var1), as.character(Var2)), 
           v2=pmax(as.character(Var1), as.character(Var2))
           ) %>% 
    select(v1, v2, value_all=value) %>%
    full_join(corVarsTrainBOS %>% 
                  mutate(v1=pmin(as.character(Var1), as.character(Var2)), 
                         v2=pmax(as.character(Var1), as.character(Var2))
                         ) %>% 
                  select(v1, v2, value_bos=value), 
              by=c("v1", "v2")
              ) %>%
    mutate(delta=value_bos-value_all)

tstCorDelta
tstCorDelta %>% arrange(delta) %>% head(20)
tstCorDelta %>% arrange(desc(delta)) %>% head(20)

```

The process is repeated, using an aggregation of correlations in each of the seven cities:  
```{r, fig.height=9, fig.width=9}

keyCities <- allCity %>% pull(src) %>% unique()
keyCities

corVarsTrainEach <- keyCities %>% 
    map_dfr(.f=function(x) makeHeatMap(allCity %>% filter(src==x), 
                                       vecSelect=varsTrain[!varsTrain %in% ifelse(x=="Miami", "snowfall", "")],
                                       returnData=TRUE, 
                                       plotMap=FALSE
                                       ) %>% 
                mutate(v1=pmin(as.character(Var1), as.character(Var2)), 
                       v2=pmax(as.character(Var1), as.character(Var2))
                       ) %>% 
                select(v1, v2, value), .id="src") %>%
    mutate(city=keyCities[as.integer(src)]) %>%
    select(src, city, everything())

corVarsTrainEach
corVarsTrainEach %>% 
    arrange(desc(value)) %>% 
    filter(v1!=v2) %>% 
    slice(1:15, (nrow(.)-14):nrow(.)) %>%
    print(n=30)

```

Comparison of aggregated individual city correlations to the overall correlations:  
```{r, fig.height=9, fig.width=9}

corVarsTrainDelta <- corVarsTrain %>% 
    mutate(v1=pmin(as.character(Var1), as.character(Var2)), 
           v2=pmax(as.character(Var1), as.character(Var2))
    ) %>% 
    select(v1, v2, value_all=value) %>% 
    full_join(corVarsTrainEach %>% 
                  group_by(v1, v2) %>% 
                  summarize(value=mean(value), .groups="drop"), 
              by=c("v1", "v2")) %>% 
    mutate(delta=value-value_all) 

corVarsTrainDelta %>% 
    arrange(delta) %>% 
    slice(1:15, (nrow(.)-14):nrow(.)) %>%
    print(n=30)

```

Differences by variable are explored:  
```{r, fig.height=9, fig.width=9}

corVarsTrain %>% 
    mutate(v1=pmin(as.character(Var1), as.character(Var2)), 
           v2=pmax(as.character(Var1), as.character(Var2))
    ) %>% 
    select(v1, v2, value_all=value) %>% 
    full_join(corVarsTrainEach, by=c("v1", "v2")) %>% 
    mutate(delta=value-value_all) %>%
    filter(v1!=v2) %>%
    select(city, v1, v2, delta) %>%
    bind_rows(., ., .id="src") %>%
    mutate(vrbl=case_when(src=="1"~v1, src=="2"~v2, TRUE~NA)) %>%
    ggplot(aes(x=fct_reorder(vrbl, delta, .fun=function(x) diff(range(x))), y=delta)) + 
    geom_boxplot(fill="lightblue") + 
    coord_flip() + 
    geom_hline(yintercept=0, color="black", lty=2) +
    labs(title="Correlation delta (individual minus all-city aggregate)", 
         x=NULL, 
         y="Delta (individual minus all-city aggregate)", 
         subtitle="Calculated for each variable combination and city"
         )

```

Soil moisture, surface pressure, and dewpoint are among the variables with the highest changes in correlation when calculated n individual cities and the all-city aggregate

An example Simpson's paradox is MSL pressure vs. surface pressure:  
```{r, fig.height=9, fig.width=9}

allCity %>% 
    count(src, surface_pressure, pressure_msl) %>% 
    ggplot(aes(x=surface_pressure, pressure_msl)) + 
    geom_smooth(aes(weight=n, color=src), method="lm") + 
    geom_smooth(method="lm", lty=2, aes(weight=n), color="black") + 
    labs(title="Relationship between MSL pressure and surface pressure", 
         subtitle="Dashed black line is overall relationship"
         ) + 
    scale_color_discrete(NULL)

```

The process is converted to functional form:  
```{r, fig.height=9, fig.width=9}

tmpSmoothPlot <- function(df, x, y, xName=x, yName=y, printPlot=TRUE, returnPlot=!isTRUE(printPlot)) {
    
    # FUNCTION ARGUMENTS:
    # df: the data frame
    # x: x variable
    # y: y variable
    # xName: name to describe x variable
    # yName: name to describe y variable
    # printPlot: boolean, should plot be printed?
    # returnPlot: boolean, should plot object be returned?
    
    p1 <- df %>% 
        select(src, all_of(c(x, y))) %>%
        purrr::set_names(c("src", "x1", "y1")) %>%
        count(src, x1, y1) %>% 
        ggplot(aes(x=x1, y=y1)) + 
        geom_smooth(aes(weight=n, color=src), method="lm") + 
        geom_smooth(method="lm", lty=2, aes(weight=n), color="black") + 
        labs(title=paste0("Relationship between ", xName, " and ", yName), 
             subtitle="Dashed black line is overall relationship", 
             y=if(y!=yName) paste0(yName, "\n(", y, ")") else y,
             x=if(x!=xName) paste0(xName, "\n(", x, ")") else x
             ) + 
    scale_color_discrete(NULL)
    
    # Print plot if requested
    if(isTRUE(printPlot)) print(p1)
    
    # Return plot if requested
    if(isTRUE(returnPlot)) return(p1)
    
}

# Example function call
tmpSmoothPlot(allCity, 
              x="surface_pressure", 
              y="pressure_msl", 
              yName="MSL Pressure", 
              xName="Surface Pressure"
              )

```

The function is tested on two additional sets of metrics:  
```{r, fig.height=9, fig.width=9}

gridExtra::grid.arrange(tmpSmoothPlot(allCity %>% 
                                          mutate(across(c("apparent_temperature", "dewpoint_2m"), 
                                                        .fns=function(x) round(x)
                                                        )
                                                 ), 
                                      x="dewpoint_2m", 
                                      y="apparent_temperature", 
                                      xName="Dew Point", 
                                      yName="Apparent Temperature", 
                                      printPlot=FALSE
                                      ), 
                        tmpSmoothPlot(allCity %>% 
                                          mutate(across(c("surface_pressure", "dewpoint_2m"), 
                                                        .fns=function(x) round(x)
                                                        )
                                                 ), 
                                      x="dewpoint_2m", 
                                      y="surface_pressure", 
                                      xName="Dew Point", 
                                      yName="Surface Pressure", 
                                      printPlot=FALSE
                                      ), 
                        nrow=1
                        )

```

The function is updated to allow for rounding:  
```{r, fig.height=9, fig.width=9}

tmpSmoothPlot <- function(df, 
                          x, 
                          y, 
                          xRound=NULL, 
                          yRound=NULL,
                          xName=x, 
                          yName=y, 
                          printPlot=TRUE, 
                          returnPlot=!isTRUE(printPlot)
                          ) {
    
    # FUNCTION ARGUMENTS:
    # df: the data frame
    # x: x variable
    # y: y variable
    # {x,y}Round: rounding to apply to vector {x,y} using function autoRound()
    #             NULL means no rounding (default)
    #             -1L means make an estimate based on data (around 100 buckets created)
    #             a positive float or integer means round everything to the nearest multiple
    # xName: name to describe x variable
    # yName: name to describe y variable
    # printPlot: boolean, should plot be printed?
    # returnPlot: boolean, should plot object be returned?
    
    p1 <- df %>% 
        select(src, all_of(c(x, y))) %>%
        purrr::set_names(c("src", "x1", "y1")) %>%
        mutate(x1=autoRound(x1, rndTo=xRound), 
               y1=autoRound(y1, rndTo=yRound)
               ) %>%
        count(src, x1, y1) %>% 
        ggplot(aes(x=x1, y=y1)) + 
        geom_smooth(aes(weight=n, color=src), method="lm") + 
        geom_smooth(method="lm", lty=2, aes(weight=n), color="black") + 
        labs(title=paste0("Relationship between ", xName, " and ", yName), 
             subtitle="Dashed black line is overall relationship", 
             y=if(y!=yName) paste0(yName, "\n(", y, ")") else y,
             x=if(x!=xName) paste0(xName, "\n(", x, ")") else x
             ) + 
    scale_color_discrete(NULL)
    
    # Print plot if requested
    if(isTRUE(printPlot)) print(p1)
    
    # Return plot if requested
    if(isTRUE(returnPlot)) return(p1)
    
}

```

The updated function is tested on elements with many buckets:  
```{r, fig.height=9, fig.width=9}

# Example function call (no rounding)
t0 <- Sys.time()
system.time(
    tmpSmoothPlot(allCity, 
                  x="direct_normal_irradiance", 
                  y="shortwave_radiation", 
                  xName="Direct Solar Radiation", 
                  yName="Shortwave Solar Radiation"
                  )
    )
Sys.time() - t0

# Example function call (rounding)
t0 <- Sys.time()
system.time(
    tmpSmoothPlot(allCity, 
                  x="direct_normal_irradiance", 
                  y="shortwave_radiation", 
                  xRound=-1L, 
                  yRound=-1L,
                  xName="Direct Solar Radiation", 
                  yName="Shortwave Solar Radiation"
                  )
    )
Sys.time() - t0

```

A simple model is run to predict surface pressure as a function of dewpoint, without considering location:  
```{r, fig.height=9, fig.width=9}

# Create model
tstLM <- allCity %>%
    select(dewpoint_2m, surface_pressure) %>%
    lm(surface_pressure ~ dewpoint_2m, data=.)

# Summary
summary(tstLM)

# Review of predictions
allCity %>%
    select(src, dewpoint_2m, surface_pressure) %>%
    mutate(pred=predict(tstLM, newdata=.)) %>%
    mutate(across(c(surface_pressure, pred), .fns=function(x) autoRound(x))) %>%
    count(surface_pressure, pred) %>%
    ggplot(aes(x=pred, y=surface_pressure)) + 
    geom_point(aes(size=n), alpha=0.25) + 
    geom_smooth(aes(weight=n), method="lm") + 
    geom_abline(slope=1, intercept=0, lty=2, color="red") + 
    labs(x="Prediction", 
         y="Actual", 
         title="Predictions for Surface Pressure", 
         subtitle="Surface Pressure ~ Dewpoint"
         ) + 
    scale_size_continuous(NULL)

```

The model is updated to predict surface pressure as a function of dewpoint, considering location:  
```{r, fig.height=9, fig.width=9}

# Create model
tstLM_002 <- allCity %>%
    select(dewpoint_2m, surface_pressure, src) %>%
    lm(surface_pressure ~ dewpoint_2m:src + src, data=.)

# Summary
summary(tstLM_002)

# Review of predictions
allCity %>%
    select(src, dewpoint_2m, surface_pressure) %>%
    mutate(pred=predict(tstLM_002, newdata=.)) %>%
    mutate(across(c(surface_pressure, pred), .fns=function(x) autoRound(x))) %>%
    count(src, surface_pressure, pred) %>%
    ggplot(aes(x=pred, y=surface_pressure)) + 
    geom_point(aes(size=n, color=src), alpha=0.25) + 
    geom_smooth(aes(weight=n), method="lm") + 
    geom_abline(slope=1, intercept=0, lty=2, color="red") + 
    labs(x="Prediction", 
         y="Actual", 
         title="Predictions for Surface Pressure", 
         subtitle="Surface Pressure ~ Dewpoint:City + City"
         ) + 
    scale_size_continuous(NULL) + 
    scale_color_discrete(NULL)

```

Long term daily data is downloaded for Atlanta:  
```{r cache=TRUE}

# Daily data download for Atlanta, GA
testURLDaily <- helperOpenMeteoURL(cityName="Atlanta GA", 
                                   dailyIndices=1:nrow(tblMetricsDaily),
                                   startDate="1960-01-01", 
                                   endDate="2023-12-31", 
                                   tz="US/Eastern"
                                   )
testURLDaily

# Download file
if(!file.exists("testOM_daily_atl.json")) {
    fileDownload(fileName="testOM_daily_atl.json", url=testURLDaily)
} else {
    cat("\nFile testOM_daily_atl.json already exists, skipping download\n")
}

```

The daily dataset is loaded:  
```{r cache=TRUE}

# Read daily JSON file
atlOMDaily <- formatOpenMeteoJSON("testOM_daily_atl.json")

# Sample records of tibble
atlOMDaily$tblDaily %>% glimpse()

```

Variables are converted to proper data type:  
```{r}

dfDailyATL <- atlOMDaily$tblDaily %>%
    mutate(weathercode=factor(weathercode), 
           sunrise_chr=sunrise, 
           sunset_chr=sunset,
           sunrise=lubridate::ymd_hm(sunrise), 
           sunset=lubridate::ymd_hm(sunset), 
           fct_winddir=factor(winddirection_10m_dominant)
           )
glimpse(dfDailyATL)

```

Averages by month for select continuous variables are plotted:  
```{r, fig.height=9, fig.width=9}

tmpMapNames <- c("precipitation_sum"="3. Precipitation (mm)", 
                 "windspeed_10m_max"="4. Windspeed (kph)", 
                 "temperature_2m_max"="1. High Temperature (C)",
                 "temperature_2m_min"="2. Low Temperature (C)"
                 )

dfDailyATL %>%
    mutate(month=factor(month(date), levels=1:12, labels=month.abb), year=year(date)) %>%
    select(year, month, temperature_2m_max, temperature_2m_min, precipitation_sum, windspeed_10m_max) %>%
    group_by(year, month) %>%
    summarize(across(-c(precipitation_sum), .fns=mean), 
              across(c(precipitation_sum), .fns=sum), 
              .groups="drop"
              ) %>%
    group_by(month) %>%
    summarize(across(-c(year), .fns=mean)) %>%
    pivot_longer(-c(month)) %>%
    ggplot(aes(x=month, y=value)) + 
    geom_line(aes(group=1)) + 
    facet_wrap(~tmpMapNames[name], scales="free_y") + 
    labs(x=NULL, y=NULL, title="Monthly averages for key metrics (Atlanta 1960-2023)")

```

Averages by month for select categorical variables are plotted:  
```{r, fig.height=9, fig.width=9}

tmpMapNames <- c("wc"="1. Weather Type", 
                 "winddir"="2. Predominant Wind Direction"
                 )

tmpDFPlot <- dfDailyATL %>%
    mutate(month=factor(month(date), levels=1:12, labels=month.abb), 
           year=year(date), 
           winddir=case_when(winddirection_10m_dominant>360~"Invalid", 
                             winddirection_10m_dominant>=315~"1. N", 
                             winddirection_10m_dominant>=225~"2. W", 
                             winddirection_10m_dominant>=135~"3. S", 
                             winddirection_10m_dominant>=45~"4. E", 
                             winddirection_10m_dominant>=0~"1. N", 
                             TRUE~"Invalid"
                             ), 
           wc=case_when(weathercode==0~"1. Clear", 
                        weathercode %in% c(1, 2, 3)~"2. Dry", 
                        weathercode %in% c(51, 53, 55)~"3. Drizzle", 
                        weathercode %in% c(61, 63, 65)~"4. Rain", 
                        weathercode %in% c(71, 73, 75)~"5. Snow", 
                        TRUE~"Error"
                        )
           ) %>%
    select(month, wc, winddir) %>%
    pivot_longer(-c(month)) %>%
    count(month, name, value)

tmpPlotFN <- function(x) {
    p1 <- tmpDFPlot %>%
        filter(name==x) %>%
        ggplot(aes(x=month, y=n)) + 
        geom_line(aes(group=value, color=value), lwd=2) + 
        labs(x=NULL, 
             y=NULL, 
             title=paste0(tmpMapNames[x], " (Atlanta 1960-2023)")
             ) + 
        scale_color_discrete(NULL) + 
        theme(legend.position = "bottom")
    return(p1)
    }

gridExtra::grid.arrange(tmpPlotFN("wc"), tmpPlotFN("winddir"), nrow=1)

```

Averages by year for select variables are plotted:  
```{r, fig.height=9, fig.width=9}

tmpMapNames <- c("precipitation_sum"="3. Precipitation (mm)", 
                 "windspeed_10m_max"="4. Windspeed (kph)", 
                 "temperature_2m_max"="1. High Temperature (C)",
                 "temperature_2m_min"="2. Low Temperature (C)"
                 )

dfDailyATL %>%
    mutate(month=factor(month(date), levels=1:12, labels=month.abb), year=year(date)) %>%
    select(year, temperature_2m_max, temperature_2m_min, precipitation_sum, windspeed_10m_max) %>%
    group_by(year) %>%
    summarize(across(-c(precipitation_sum), .fns=mean), 
              across(c(precipitation_sum), .fns=sum), 
              .groups="drop"
              ) %>%
    pivot_longer(-c(year)) %>%
    ggplot(aes(x=year, y=value)) + 
    geom_line(aes(group=1)) + 
    facet_wrap(~tmpMapNames[name], scales="free_y") + 
    labs(x=NULL, y=NULL, title="Annual averages for key metrics (Atlanta 1960-2023)")

```

Averages by year for select categorical variables are plotted:  
```{r, fig.height=9, fig.width=9}

tmpMapNames <- c("wc"="1. Weather Type", 
                 "winddir"="2. Predominant Wind Direction"
                 )

tmpDFPlot <- dfDailyATL %>%
    mutate(month=factor(month(date), levels=1:12, labels=month.abb), 
           year=year(date), 
           winddir=case_when(winddirection_10m_dominant>360~"Invalid", 
                             winddirection_10m_dominant>=315~"1. N", 
                             winddirection_10m_dominant>=225~"2. W", 
                             winddirection_10m_dominant>=135~"3. S", 
                             winddirection_10m_dominant>=45~"4. E", 
                             winddirection_10m_dominant>=0~"1. N", 
                             TRUE~"Invalid"
                             ), 
           wc=case_when(weathercode==0~"1. Clear", 
                        weathercode %in% c(1, 2, 3)~"2. Dry", 
                        weathercode %in% c(51, 53, 55)~"3. Drizzle", 
                        weathercode %in% c(61, 63, 65)~"4. Rain", 
                        weathercode %in% c(71, 73, 75)~"5. Snow", 
                        TRUE~"Error"
                        )
           ) %>%
    select(year, wc, winddir) %>%
    pivot_longer(-c(year)) %>%
    count(year, name, value)

tmpPlotFN <- function(x) {
    p1 <- tmpDFPlot %>%
        filter(name==x) %>%
        ggplot(aes(x=year, y=n)) + 
        geom_line(aes(group=value, color=value), lwd=1) + 
        labs(x=NULL, 
             y=NULL, 
             title=paste0(tmpMapNames[x], " (Atlanta 1960-2023)")
             ) + 
        scale_color_discrete(NULL) + 
        theme(legend.position = "bottom")
    return(p1)
    }

gridExtra::grid.arrange(tmpPlotFN("wc"), tmpPlotFN("winddir"), nrow=1)

```

Boxplots for maximum windspeed are created:  
```{r, fig.height=9, fig.width=9}

dfDailyATL %>%
    mutate(month=factor(month(date), levels=1:12, labels=month.abb), year=year(date)) %>%
    select(month, windspeed_10m_max) %>%
    ggplot(aes(x=month, y=windspeed_10m_max)) + 
    geom_boxplot(fill="lightblue") + 
    lims(y=c(0, NA)) +
    labs(x=NULL, 
         y="Maximum daily wind speed (kph)", 
         title="Maximum daily windspeed by month (Atlanta 1960-2023)"
         )

```

Boxplots for precipitation are created:  
```{r, fig.height=9, fig.width=9}

dfDailyATL %>%
    mutate(month=factor(month(date), levels=1:12, labels=month.abb), year=year(date)) %>%
    select(month, precipitation_hours) %>%
    ggplot(aes(x=month, y=precipitation_hours)) + 
    geom_boxplot(fill="lightblue") + 
    lims(y=c(0, NA)) +
    labs(x=NULL, 
         y="Daily precipitation hours", 
         title="Daily precipitation hours by month (Atlanta 1960-2023)"
         )

dfDailyATL %>%
    mutate(month=factor(month(date), levels=1:12, labels=month.abb), year=year(date)) %>%
    select(month, precipitation_sum) %>%
    ggplot(aes(x=month, y=precipitation_sum)) + 
    geom_boxplot(fill="lightblue") + 
    lims(y=c(0, NA)) +
    labs(x=NULL, 
         y="Daily precipitation (mm)", 
         title="Daily precipitation by month (Atlanta 1960-2023)"
         )

```

Boxplots for temperature are created:  
```{r, fig.height=9, fig.width=9}

dfDailyATL %>%
    mutate(month=factor(month(date), levels=1:12, labels=month.abb), year=year(date)) %>%
    select(month, temperature_2m_max) %>%
    ggplot(aes(x=month, y=temperature_2m_max)) + 
    geom_boxplot(fill="lightblue") + 
    labs(x=NULL, 
         y="Daily high temperature (C)", 
         title="Daily high temperature by month (Atlanta 1960-2023)"
         )

dfDailyATL %>%
    mutate(month=factor(month(date), levels=1:12, labels=month.abb), year=year(date)) %>%
    select(month, temperature_2m_min) %>%
    ggplot(aes(x=month, y=temperature_2m_min)) + 
    geom_boxplot(fill="lightblue") + 
    labs(x=NULL, 
         y="Daily low temperature (C)", 
         title="Daily low temperature by month (Atlanta 1960-2023)"
         )

```

ACF and PACF are explored for maximum temperature:  
```{r, fig.height=9, fig.width=9}

acfTemp <- acf(dfDailyATL$temperature_2m_max, lag.max=1000)
as.vector(acfTemp$acf) %>% findPeaks(width=21) %>% which()
as.vector(acfTemp$acf) %>% findPeaks(width=21, FUN=min) %>% which()

pacfTemp <- pacf(dfDailyATL$temperature_2m_max, lag.max=1000)
pacf(dfDailyATL$temperature_2m_max, lag.max=50)

```

As expected, ACF has a sustained seasonal pattern, with peaks (at roughly intervals of 365) and valleys (at roughly intervals of 365 offset by roughly 185) corresponding to the 365-day year

ACF and PACF are explored for precipitation:  
```{r, fig.height=9, fig.width=9}

acfPrecip <- acf(dfDailyATL$precipitation_sum, lag.max=1000)
acf(dfDailyATL$precipitation_sum, lag.max=50)
as.vector(acfPrecip$acf) %>% findPeaks(width=21) %>% which()
as.vector(acfPrecip$acf) %>% findPeaks(width=21, FUN=min) %>% which()

pacfPrecip <- pacf(dfDailyATL$precipitation_sum, lag.max=1000)
pacf(dfDailyATL$precipitation_sum, lag.max=50)

```

Precipitation by contrast has little seasonality and mostly just a correlation to the previous day's value

ACF and PACF are explored for windspeed:  
```{r, fig.height=9, fig.width=9}

acfWind <- acf(dfDailyATL$windspeed_10m_max, lag.max=1000)
acf(dfDailyATL$windspeed_10m_max, lag.max=50)
as.vector(acfWind$acf) %>% findPeaks(width=21) %>% which()
as.vector(acfWind$acf) %>% findPeaks(width=21, FUN=min) %>% which()

pacfWind <- pacf(dfDailyATL$windspeed_10m_max, lag.max=1000)
pacf(dfDailyATL$windspeed_10m_max, lag.max=50)

```

Similar to temperature, wind speed appears to have a sustained seasonal component, though peak correlations are much lower in magnitude (~0.2 for wind speed vs. ~0.75 for temperature)

A boxplot for delta daily temperature is created:  
```{r, fig.height=9, fig.width=9}

dfDailyATL %>%
    mutate(month=factor(month.abb[month(date)], levels=month.abb), 
           chg=temperature_2m_max-lag(temperature_2m_max)
           ) %>%
    filter(!is.na(chg)) %>%
    ggplot(aes(x=month, y=chg)) + 
    geom_boxplot() + 
    labs(x=NULL, y="Daily change in maximum temperature")

```

Daily temperature changes are generally larger in magnitude during the colder season

A boxplot for delta daily wind speed is created:  
```{r, fig.height=9, fig.width=9}

dfDailyATL %>%
    mutate(month=factor(month.abb[month(date)], levels=month.abb), 
           chg=windspeed_10m_max-lag(windspeed_10m_max)
           ) %>%
    filter(!is.na(chg)) %>%
    ggplot(aes(x=month, y=chg)) + 
    geom_boxplot() + 
    labs(x=NULL, y="Daily change in maximum wind speed")

```

Daily wind speed changes are generally larger in magnitude during the colder season

A boxplot for delta daily precipitation is created:  
```{r, fig.height=9, fig.width=9}

dfDailyATL %>%
    mutate(month=factor(month.abb[month(date)], levels=month.abb), 
           chg=precipitation_sum-lag(precipitation_sum)
           ) %>%
    filter(!is.na(chg)) %>%
    ggplot(aes(x=month, y=chg)) + 
    geom_boxplot() + 
    labs(x=NULL, y="Daily change in precipitation")

```

Most days have no precipitation. The corresponding boxplot for precipitation change has small boxes and whiskers with many outliers

Averages for temperature, precipitation, and wind speed are calculated by day of year, using a 21-day rolling window:  
```{r, fig.height=9, fig.width=9}

df_r21 <- dfDailyATL %>%
    mutate(doy=pmin(yday(date), 365)) %>% 
    helperRollingAgg(origVar="temperature_2m_max", newName="temp_r21", k=21) %>% 
    helperRollingAgg(origVar="windspeed_10m_max", newName="wind_r21", k=21) %>% 
    helperRollingAgg(origVar="precipitation_sum", newName="precip_r21", k=21) %>%
    select(date, doy, contains("_r21"))

df_r21 %>%
    na.omit() %>%
    group_by(doy) %>%
    summarize(across(where(is.numeric), .fns=mean), n=n()) %>%
    pivot_longer(cols=-c(doy)) %>%
    ggplot(aes(x=doy, y=value)) + 
    geom_line(aes(group=name, color=name)) + 
    facet_wrap(~name, scales="free_y") +
    labs(x="Day of Year", y="Rolling-21 mean") + 
    theme(legend.position="none")

```
  
* The number of observations is lowest on days 1-10 and 356-365 due to inability to get a rolling-21 for the first/last years; and it is highest on day 365 due to day 366 being mapped there  
* Precipitation has seasonal patterns, though it is spiky even on a rolling-21-day basis averaged over 60 years  
* Temperature, on average with a 21-day window over 60 years,  has a smooth seasonal pattern  
* Wind speed is similar to temperature in showing a smooth pattern, though still with occasional spikiness  
  
Outliers are likely much more important in driving average precipitation than in driving average temperature  

Standard deviations for temperature, precipitation, and wind speed are calculated by day of year, using a 21-day rolling window:  
```{r, fig.height=9, fig.width=9}

df_r21_sd <- dfDailyATL %>%
    mutate(doy=pmin(yday(date), 365)) %>% 
    group_by(doy) %>%
    mutate(across(.cols=c(temperature_2m_max, windspeed_10m_max, precipitation_sum), .fns=sd)) %>%
    ungroup() %>%
    helperRollingAgg(origVar="temperature_2m_max", newName="temp_r21", k=21) %>% 
    helperRollingAgg(origVar="windspeed_10m_max", newName="wind_r21", k=21) %>% 
    helperRollingAgg(origVar="precipitation_sum", newName="precip_r21", k=21) %>%
    select(date, doy, contains("_r21"))

df_r21_sd %>%
    na.omit() %>%
    group_by(doy) %>%
    summarize(across(where(is.numeric), .fns=mean)) %>%
    pivot_longer(cols=-c(doy)) %>%
    ggplot(aes(x=doy, y=value)) + 
    geom_line(aes(group=name, color=name)) + 
    facet_wrap(~name, scales="free_y") +
    labs(x="Day of Year", y="Rolling-21 mean of daily standard deviation") + 
    theme(legend.position="none")

```
  
* The daily standard deviation of precipitation is, on average, larger than the mean  
* The daily standard deviation of temperature and wind speed are, on average, much lower than the seasonal variation in temperature and wind speed  
  
Means and standard deviations are plotted together:  
```{r, fig.height=9, fig.width=9}

df_r21 %>%
    bind_rows(df_r21_sd, .id="src") %>%
    na.omit() %>%
    mutate(musig=c("1"="Mean", "2"="SD")[src]) %>%
    group_by(doy, musig) %>%
    summarize(across(where(is.numeric), .fns=mean), .groups="drop") %>%
    pivot_longer(cols=-c(doy, musig)) %>%
    pivot_wider(id_cols=c(doy, name), names_from="musig") %>%
    ggplot(aes(x=doy)) + 
    geom_line(aes(y=Mean, group=name, color=name), lwd=2) + 
    geom_ribbon(aes(ymin=Mean-SD, ymax=Mean+SD, fill=name), alpha=0.5) +
    facet_wrap(~name, scales="free_y") +
    labs(x="Day of Year", 
         y="Rolling-21 mean +/- daily standard deviation", 
         title="Rolling 21-day mean +/- one rolling 21-day sd"
         ) + 
    theme(legend.position="none")

```

Means and approximate SEM are plotted together:  
```{r, fig.height=9, fig.width=9}

nYears <- length(unique(year(df_r21$date)))
nYears

df_r21 %>%
    bind_rows(df_r21_sd, .id="src") %>%
    na.omit() %>%
    mutate(musig=c("1"="Mean", "2"="SD")[src]) %>%
    group_by(doy, musig) %>%
    summarize(across(where(is.numeric), .fns=mean), .groups="drop") %>%
    pivot_longer(cols=-c(doy, musig)) %>%
    pivot_wider(id_cols=c(doy, name), names_from="musig") %>%
    ggplot(aes(x=doy)) + 
    geom_line(aes(y=Mean, group=name, color=name), lwd=2) + 
    geom_ribbon(aes(ymin=Mean-SD/sqrt(nYears-1), ymax=Mean+SD/sqrt(nYears-1), fill=name), alpha=0.5) +
    facet_wrap(~name, scales="free_y") +
    labs(x="Day of Year", 
         y="Rolling-21 mean +/- 1 SEM (approx)", 
         title="Rolling 21-day mean +/- 1 SEM (approx)"
         ) + 
    theme(legend.position="none")

```

Consistent with previous analyses, temperature has a strong seasonal pattern with differences in mean that vastly exceed the standard error of the mean. By contrast, while there is apparent seasonal spikiness to precipitation, rolling 21-day means are usually within one standard error of the mean of each other. Wind is more similar to temperature in having seasonal variations that meaningfully exceed SEM in magnitude.

Percentage of cumulative precipitation by volume of daily precipitation is explored:  
```{r, fig.height=9, fig.width=9}

tmpPlotData <- dfDailyATL %>%
    select(date, precipitation_sum) %>%
    group_by(precipitation_sum) %>%
    summarize(n=n(), precip=sum(precipitation_sum), .groups="drop") %>%
    mutate(csp=cumsum(precip), cpp=csp/sum(precip), csn=cumsum(n), cpn=csn/sum(n)) 

tmpPlotData %>%
    pivot_longer(cols=-c(precipitation_sum)) %>%
    ggplot(aes(x=precipitation_sum, y=value)) + 
    geom_line(data=~filter(., name %in% c("cpp", "cpn")), 
              aes(group=name, color=c("cpn"="# events", "cpp"="precip")[name])
              ) + 
    labs(x="Daily precipitation (mm)", y="% total (cumul)") + 
    scale_color_discrete("Metric")

```

Around half of days have no precipitation. Around 25% of total precipitation comes from the rare day with 25+ mm (about an inch) of precipitation

Total precipitation by decade is also explored, sorted by daily precipitation:  
```{r, fig.height=9, fig.width=9}

dfDailyATL %>%
    select(date, precipitation_sum) %>%
    mutate(year=year(date), decade=round(year(date)-4.5, -1)) %>%
    group_by(decade, precipitation_sum) %>%
    summarize(n=n(), precip=sum(precipitation_sum), .groups="drop") %>%
    group_by(decade) %>%
    mutate(csp=cumsum(precip), ntot=sum(n), meancsp=365*csp/ntot) %>%
    ungroup() %>%
    ggplot(aes(x=precipitation_sum, y=meancsp)) + 
    geom_line(aes(group=factor(decade), color=factor(decade)), lwd=1) + 
    labs(x="Daily precipitation (mm)", 
         y="Cumulative annual precipitation (mm)", 
         title="Average annual precipitation by decade", 
         subtitle="Cumulative, for daily precipitation amounts LTE x-axis"
         ) + 
    scale_color_discrete("Decade")

```

Trends look similar by decade for precipitation amounts under 0.5 inch (12.5 mm). Heavier precipitation amounts appear to be more prevalent in the 202s, driving overall precipitation totals ~50% higher

Precipitation appears to have broken trend starting in the late 2010s:  
```{r, fig.height=9, fig.width=9}

dfDailyATL %>%
    select(date, precipitation_sum) %>%
    mutate(year=year(date), decade=round(year(date)-4.5, -1)) %>% 
    group_by(decade, year) %>% 
    summarize(precip=sum(precipitation_sum), .groups="drop") %>% 
    ggplot(aes(x=year, y=precip)) + 
    geom_line(aes(color=ifelse(year>=2017, "2017-2023", "pre-2017")), lwd=1) + 
    geom_smooth(aes(color=ifelse(year>=2017, "2017-2023", "pre-2017")), method="lm", lty=2) + 
    geom_point() + 
    labs(x=NULL, y="Annual precipitation (mm)") + 
    scale_color_discrete(NULL) + 
    lims(y=c(0, NA))

```

Precipitation by month pre-2017 is explored:  
```{r, fig.height=9, fig.width=9}

yMax <- dfDailyATL %>%
    group_by(year=year(date), month=month(date)) %>%
    summarize(precip=sum(precipitation_sum), .groups="drop") %>%
    mutate(precip=ceiling(precip/50)*50) %>%
    pull() %>%
    max()
yMax

p1 <- dfDailyATL %>%
    select(date, precipitation_sum) %>%
    mutate(year=year(date), 
           decade=round(year(date)-4.5, -1), 
           month=factor(month.abb[month(date)], levels=month.abb), 
           tp=ifelse(year<2017, "pre", year)
           ) %>% 
    group_by(tp, year, month) %>% 
    summarize(precip=sum(precipitation_sum), .groups="drop") %>% 
    group_by(tp, month) %>% 
    summarize(mu=mean(precip), sd=sd(precip), .groups="drop") %>% 
    ggplot(aes(x=month)) + 
    geom_col(data=~filter(., tp=="pre"), aes(y=mu), fill="lightblue") + 
    geom_errorbar(data=~filter(., tp=="pre"), aes(ymin=mu-sd, ymax=mu+sd), width=0.2) +
    geom_hline(data=~filter(., tp=="pre"), color="red", lty=2, aes(yintercept=mean(mu))) + 
    labs(x=NULL, y="Monthly precipitation (mm)", title="Monthly precipitation +/- 1 SD\n(pre-2017)") + 
    lims(y=c(0, yMax))
p1

```

Precipitation by month post-2017 is explored:  
```{r, fig.height=9, fig.width=9}

p2 <- dfDailyATL %>%
    select(date, precipitation_sum) %>%
    mutate(year=year(date), 
           decade=round(year(date)-4.5, -1), 
           month=factor(month.abb[month(date)], levels=month.abb), 
           tp=ifelse(year<2017, "pre", year)
           ) %>% 
    group_by(tp, year, month) %>% 
    summarize(precip=sum(precipitation_sum), .groups="drop") %>% 
    filter(tp!="pre") %>%
    group_by(month) %>% 
    summarize(mu=mean(precip), mx=max(precip), mn=min(precip), .groups="drop") %>% 
    ggplot(aes(x=month)) + 
    geom_col(aes(y=mu), fill="lightblue") + 
    geom_errorbar(aes(ymin=mn, ymax=mx), width=0.2) +
    geom_hline(color="red", lty=2, aes(yintercept=mean(mu))) + 
    labs(x=NULL, y="Monthly precipitation (mm)", title="Monthly precipitation\nmax-mean-min (post-2017)") + 
    lims(y=c(0, yMax))
p2

```

The data are plotted on a single plot:  
```{r, fig.height=9, fig.width=9}

p3 <- dfDailyATL %>%
    select(date, precipitation_sum) %>%
    mutate(year=year(date), 
           decade=round(year(date)-4.5, -1), 
           month=factor(month.abb[month(date)], levels=month.abb), 
           tp=ifelse(year<2017, "pre", "post")
    ) %>% 
    group_by(tp, year, month) %>% 
    summarize(precip=sum(precipitation_sum), .groups="drop") %>% 
    group_by(tp, month) %>% 
    summarize(mu=mean(precip), sd=sd(precip), mx=max(precip), mn=min(precip), .groups="drop") %>% 
    ggplot(aes(x=month)) + 
    geom_tile(data=~filter(., tp=="pre"), aes(y=mu, height=2*sd), width=0.75, fill="lightblue") + 
    geom_hline(data=~filter(., tp=="pre"), color="red", lty=2, aes(yintercept=mean(mu))) + 
    geom_errorbar(data=~filter(., tp=="post"), aes(ymin=mn, ymax=mx), width=0) +
    geom_point(data=~filter(., tp=="post"), aes(y=mu)) +
    annotate("text", x=1, y=25, label="bars are pre-2017\nmean +/- 1 SD", size=2.5, hjust=0) + 
    annotate("text", x=1, y=300, label="lines/points are post-2017\nmax-mean-min", size=2.5, hjust=0) + 
    labs(x=NULL, y="Monthly precipitation (mm)", title="Monthly precipitation\n(pre/post-2017)") + 
    lims(y=c(0, yMax))
p3

```

The average number of days with precipitation by month is explored:  
```{r, fig.height=9, fig.width=9}

yMax <- dfDailyATL %>%
    group_by(year=year(date), month=month(date)) %>%
    summarize(precip=sum(precipitation_sum>0), .groups="drop") %>%
    mutate(precip=ceiling(precip/5)*5) %>%
    pull() %>%
    max()
yMax

p4 <- dfDailyATL %>%
    select(date, precipitation_sum) %>%
    mutate(year=year(date), 
           decade=round(year(date)-4.5, -1), 
           month=factor(month.abb[month(date)], levels=month.abb), 
           tp=ifelse(year<2017, "pre", "post")
    ) %>% 
    group_by(tp, year, month) %>% 
    summarize(precip=sum(precipitation_sum>0), .groups="drop") %>% 
    group_by(tp, month) %>% 
    summarize(mu=mean(precip), sd=sd(precip), mx=max(precip), mn=min(precip), .groups="drop") %>% 
    ggplot(aes(x=month)) + 
    geom_tile(data=~filter(., tp=="pre"), aes(y=mu, height=2*sd), width=0.75, fill="lightblue") + 
    geom_hline(data=~filter(., tp=="pre"), color="red", lty=2, aes(yintercept=mean(mu))) + 
    geom_errorbar(data=~filter(., tp=="post"), aes(ymin=mn, ymax=mx), width=0) +
    geom_point(data=~filter(., tp=="post"), aes(y=mu)) +
    annotate("text", x=1, y=5, label="bars are pre-2017\nmean +/- 1 SD", size=2.5, hjust=0) + 
    annotate("text", x=1, y=30, label="lines/points are post-2017\nmax-mean-min", size=2.5, hjust=0) + 
    labs(x=NULL, 
         y="Monthly precipitation (days greater than zero)", 
         title="Monthly days with precipitation\n(pre/post-2017)") + 
    lims(y=c(0, yMax))
p4

```

Median precipitation on days with precipitation > 0, by month, is explored:  
```{r, fig.height=9, fig.width=9}

p5 <- dfDailyATL %>%
    select(date, precipitation_sum) %>%
    mutate(year=year(date), 
           decade=round(year(date)-4.5, -1), 
           month=factor(month.abb[month(date)], levels=month.abb), 
           tp=ifelse(year<2017, "pre", "post")
    ) %>% 
    group_by(tp, month) %>% 
    summarize(nprecip=sum(precipitation_sum>0), 
              tprecip=sum(precipitation_sum),
              mdnprecip=median(ifelse(precipitation_sum>0, precipitation_sum, NA), na.rm=TRUE),
              muprecip=mean(ifelse(precipitation_sum>0, precipitation_sum, NA), na.rm=TRUE),
              .groups="drop"
              ) %>% 
    select(tp, month, mdnprecip, muprecip) %>%
    pivot_longer(-c(tp, month)) %>%
    ggplot(aes(x=month)) + 
    geom_line(aes(y=value, group=tp, color=c("pre"="pre-2017", "post"="post-2017")[tp])) +
    facet_wrap(~c("mdnprecip"="Median (mm) on days with precipitation", 
                  "muprecip"="Mean (mm) on days with precipitation"
                  )[name]
               ) +
    labs(x=NULL, 
         title="Monthly precipitation on days with precipitation greater than zero\n(pre/post-2017)", 
         y="Precipitation (mm)"
         ) + 
    ylim(c(0, NA)) + 
    scale_color_discrete(NULL)
p5

```

The heaviest 3-day precipitation by year is explored:  
```{r, fig.height=9, fig.width=9}

p6 <- dfDailyATL %>%
    select(date, precipitation_sum) %>%
    mutate(year=year(date), 
           decade=round(year(date)-4.5, -1), 
           month=factor(month.abb[month(date)], levels=month.abb), 
           tp=ifelse(year<2017, "pre", "post")
    ) %>% 
    group_by(tp, year) %>% 
    helperRollingAgg(origVar="precipitation_sum", newName="r3precip", func=zoo::rollsum, k=3) %>%
    summarize(r3max=max(r3precip, na.rm=TRUE), .groups="drop") %>%
    ggplot(aes(x=year)) + 
    geom_line(aes(y=r3max, group=tp, color=c("pre"="pre-2017", "post"="post-2017")[tp])) +
    labs(x=NULL, 
         title="Maximum 3-day precipitation by year", 
         y="rolling 3-day sum of precipitation (mm)"
         ) + 
    geom_smooth(method="lm", 
                se=TRUE, 
                aes(y=r3max, group=tp, color=c("pre"="pre-2017", "post"="post-2017")[tp])
                ) +
    ylim(c(0, NA)) + 
    scale_color_discrete(NULL)
p6

```

Long term daily data is downloaded for Detroit:  
```{r cache=TRUE}

# Daily data download for Detroit, MI
testURLDaily <- helperOpenMeteoURL(cityName="Detroit MI", 
                                   dailyIndices=1:nrow(tblMetricsDaily),
                                   startDate="1960-01-01", 
                                   endDate="2023-12-31", 
                                   tz="US/Eastern"
                                   )
testURLDaily

# Download file
if(!file.exists("testOM_daily_dtw.json")) {
    fileDownload(fileName="testOM_daily_dtw.json", url=testURLDaily)
} else {
    cat("\nFile testOM_daily_dtw.json already exists, skipping download\n")
}

```

The daily dataset is loaded:  
```{r cache=TRUE}

# Read daily JSON file
dtwOMDaily <- formatOpenMeteoJSON("testOM_daily_dtw.json")

# Sample records of tibble
dtwOMDaily$tblDaily %>% glimpse()

```

Variables are converted to proper data type:  
```{r}

dfDailyDTW <- dtwOMDaily$tblDaily %>%
    mutate(weathercode=factor(weathercode), 
           sunrise_chr=sunrise, 
           sunset_chr=sunset,
           sunrise=lubridate::ymd_hm(sunrise), 
           sunset=lubridate::ymd_hm(sunset), 
           fct_winddir=factor(winddirection_10m_dominant)
           )
glimpse(dfDailyDTW)

```

Averages by month for select continuous variables are plotted:  
```{r, fig.height=9, fig.width=9}

tmpMapNames <- c("precipitation_sum"="3. Precipitation (mm)", 
                 "windspeed_10m_max"="4. Windspeed (kph)", 
                 "temperature_2m_max"="1. High Temperature (C)",
                 "temperature_2m_min"="2. Low Temperature (C)"
                 )

dfDailyDTW %>%
    mutate(month=factor(month(date), levels=1:12, labels=month.abb), year=year(date)) %>%
    select(year, month, temperature_2m_max, temperature_2m_min, precipitation_sum, windspeed_10m_max) %>%
    group_by(year, month) %>%
    summarize(across(-c(precipitation_sum), .fns=mean), 
              across(c(precipitation_sum), .fns=sum), 
              .groups="drop"
              ) %>%
    group_by(month) %>%
    summarize(across(-c(year), .fns=mean)) %>%
    pivot_longer(-c(month)) %>%
    ggplot(aes(x=month, y=value)) + 
    geom_line(aes(group=1)) + 
    facet_wrap(~tmpMapNames[name], scales="free_y") + 
    labs(x=NULL, y=NULL, title="Monthly averages for key metrics (Detroit 1960-2023)")

```

Averages by month for select categorical variables are plotted:  
```{r, fig.height=9, fig.width=9}

tmpMapNames <- c("wc"="1. Weather Type", 
                 "winddir"="2. Predominant Wind Direction"
                 )

tmpDFPlot <- dfDailyDTW %>%
    mutate(month=factor(month(date), levels=1:12, labels=month.abb), 
           year=year(date), 
           winddir=case_when(winddirection_10m_dominant>360~"Invalid", 
                             winddirection_10m_dominant>=315~"1. N", 
                             winddirection_10m_dominant>=225~"2. W", 
                             winddirection_10m_dominant>=135~"3. S", 
                             winddirection_10m_dominant>=45~"4. E", 
                             winddirection_10m_dominant>=0~"1. N", 
                             TRUE~"Invalid"
                             ), 
           wc=case_when(weathercode==0~"1. Clear", 
                        weathercode %in% c(1, 2, 3)~"2. Dry", 
                        weathercode %in% c(51, 53, 55)~"3. Drizzle", 
                        weathercode %in% c(61, 63, 65)~"4. Rain", 
                        weathercode %in% c(71, 73, 75)~"5. Snow", 
                        TRUE~"Error"
                        )
           ) %>%
    select(month, wc, winddir) %>%
    pivot_longer(-c(month)) %>%
    count(month, name, value)

tmpPlotFN <- function(x) {
    p1 <- tmpDFPlot %>%
        filter(name==x) %>%
        ggplot(aes(x=month, y=n)) + 
        geom_line(aes(group=value, color=value), lwd=2) + 
        labs(x=NULL, 
             y=NULL, 
             title=paste0(tmpMapNames[x], " (Detroit 1960-2023)")
             ) + 
        scale_color_discrete(NULL) + 
        theme(legend.position = "bottom")
    return(p1)
    }

gridExtra::grid.arrange(tmpPlotFN("wc"), tmpPlotFN("winddir"), nrow=1)

```

Averages by year for select continuous variables are plotted:  
```{r, fig.height=9, fig.width=9}

tmpMapNames <- c("precipitation_sum"="3. Precipitation (mm)", 
                 "windspeed_10m_max"="4. Windspeed (kph)", 
                 "temperature_2m_max"="1. High Temperature (C)",
                 "temperature_2m_min"="2. Low Temperature (C)"
                 )

dfDailyDTW %>%
    mutate(month=factor(month(date), levels=1:12, labels=month.abb), year=year(date)) %>%
    select(year, temperature_2m_max, temperature_2m_min, precipitation_sum, windspeed_10m_max) %>%
    group_by(year) %>%
    summarize(across(-c(precipitation_sum), .fns=mean), 
              across(c(precipitation_sum), .fns=sum), 
              .groups="drop"
              ) %>%
    pivot_longer(-c(year)) %>%
    ggplot(aes(x=year, y=value)) + 
    geom_line(aes(group=1)) + 
    facet_wrap(~tmpMapNames[name], scales="free_y") + 
    labs(x=NULL, y=NULL, title="Annual averages for key metrics (Detroit 1960-2023)")

```

Averages by year for select categorical variables are plotted:  
```{r, fig.height=9, fig.width=9}

tmpMapNames <- c("wc"="1. Weather Type", 
                 "winddir"="2. Predominant Wind Direction"
                 )

tmpDFPlot <- dfDailyDTW %>%
    mutate(month=factor(month(date), levels=1:12, labels=month.abb), 
           year=year(date), 
           winddir=case_when(winddirection_10m_dominant>360~"Invalid", 
                             winddirection_10m_dominant>=315~"1. N", 
                             winddirection_10m_dominant>=225~"2. W", 
                             winddirection_10m_dominant>=135~"3. S", 
                             winddirection_10m_dominant>=45~"4. E", 
                             winddirection_10m_dominant>=0~"1. N", 
                             TRUE~"Invalid"
                             ), 
           wc=case_when(weathercode==0~"1. Clear", 
                        weathercode %in% c(1, 2, 3)~"2. Dry", 
                        weathercode %in% c(51, 53, 55)~"3. Drizzle", 
                        weathercode %in% c(61, 63, 65)~"4. Rain", 
                        weathercode %in% c(71, 73, 75)~"5. Snow", 
                        TRUE~"Error"
                        )
           ) %>%
    select(year, wc, winddir) %>%
    pivot_longer(-c(year)) %>%
    count(year, name, value)

tmpPlotFN <- function(x) {
    p1 <- tmpDFPlot %>%
        filter(name==x) %>%
        ggplot(aes(x=year, y=n)) + 
        geom_line(aes(group=value, color=value), lwd=1) + 
        labs(x=NULL, 
             y=NULL, 
             title=paste0(tmpMapNames[x], " (Detroit 1960-2023)")
             ) + 
        scale_color_discrete(NULL) + 
        theme(legend.position = "bottom")
    return(p1)
    }

gridExtra::grid.arrange(tmpPlotFN("wc"), tmpPlotFN("winddir"), nrow=1)

```

The apparent decrease in days with northerly winds is explored further:  
```{r, fig.height=9, fig.width=9}

dfDailyWind <- dfDailyDTW %>%
    mutate(month=factor(month(date), levels=1:12, labels=month.abb), 
           year=year(date), 
           winddir=case_when(winddirection_10m_dominant>360~"Invalid", 
                             winddirection_10m_dominant>=300~"1. N", 
                             winddirection_10m_dominant>240~"2. E/W", 
                             winddirection_10m_dominant>=120~"3. S", 
                             winddirection_10m_dominant>60~"2. E/W", 
                             winddirection_10m_dominant>=0~"1. N", 
                             TRUE~"Invalid"
                             )
           ) %>%
    select(year, month, date, winddir, winddirection_10m_dominant, windspeed_10m_max)
dfDailyWind

dfDailyWind %>%
    count(year, winddir) %>%
    group_by(year) %>%
    mutate(pct=n/sum(n)) %>%
    ungroup() %>%
    ggplot(aes(x=year, y=pct)) + 
    geom_line(aes(group=winddir, color=winddir), lwd=1) + 
    labs(x=NULL, 
         y="Percent of Days", 
         title=paste0("Predominant Wind Direction", " (Detroit 1960-2023)"), 
         caption="N (300-060)\nE/W (061-119, 241-299)\nS (120-240)"
         ) + 
    scale_color_discrete(NULL) + 
    geom_hline(data=~summarize(group_by(., winddir), pct=mean(pct)), 
               aes(color=winddir, group=winddir, yintercept=pct), 
               lty=2
               ) +
    lims(y=c(0, NA)) +
    theme(legend.position = "bottom")

```

Boxplots for maximum windspeed are created:  
```{r, fig.height=9, fig.width=9}

dfDailyDTW %>%
    mutate(month=factor(month(date), levels=1:12, labels=month.abb), year=year(date)) %>%
    select(month, windspeed_10m_max) %>%
    ggplot(aes(x=month, y=windspeed_10m_max)) + 
    geom_boxplot(fill="lightblue") + 
    lims(y=c(0, NA)) +
    labs(x=NULL, 
         y="Maximum daily wind speed (kph)", 
         title="Maximum daily windspeed by month (Detroit 1960-2023)"
         )

```

Boxplots for precipitation are created:  
```{r, fig.height=9, fig.width=9}

dfDailyDTW %>%
    mutate(month=factor(month(date), levels=1:12, labels=month.abb), year=year(date)) %>%
    select(month, precipitation_hours) %>%
    ggplot(aes(x=month, y=precipitation_hours)) + 
    geom_boxplot(fill="lightblue") + 
    lims(y=c(0, NA)) +
    labs(x=NULL, 
         y="Daily precipitation hours", 
         title="Daily precipitation hours by month (Detroit 1960-2023)"
         )

dfDailyDTW %>%
    mutate(month=factor(month(date), levels=1:12, labels=month.abb), year=year(date)) %>%
    select(month, precipitation_sum) %>%
    ggplot(aes(x=month, y=precipitation_sum)) + 
    geom_boxplot(fill="lightblue") + 
    lims(y=c(0, NA)) +
    labs(x=NULL, 
         y="Daily precipitation (mm)", 
         title="Daily precipitation by month (Detroit 1960-2023)"
         )

```

Boxplots for temperature are created:  
```{r, fig.height=9, fig.width=9}

dfDailyDTW %>%
    mutate(month=factor(month(date), levels=1:12, labels=month.abb), year=year(date)) %>%
    select(month, temperature_2m_max) %>%
    ggplot(aes(x=month, y=temperature_2m_max)) + 
    geom_boxplot(fill="lightblue") + 
    labs(x=NULL, 
         y="Daily high temperature (C)", 
         title="Daily high temperature by month (Detroit 1960-2023)"
         )

dfDailyDTW %>%
    mutate(month=factor(month(date), levels=1:12, labels=month.abb), year=year(date)) %>%
    select(month, temperature_2m_min) %>%
    ggplot(aes(x=month, y=temperature_2m_min)) + 
    geom_boxplot(fill="lightblue") + 
    labs(x=NULL, 
         y="Daily low temperature (C)", 
         title="Daily low temperature by month (Detroit 1960-2023)"
         )

```

ACF and PACF are explored for maximum temperature:  
```{r, fig.height=9, fig.width=9}

acfTemp <- acf(dfDailyDTW$temperature_2m_max, lag.max=1000)
as.vector(acfTemp$acf) %>% findPeaks(width=21) %>% which()
as.vector(acfTemp$acf) %>% findPeaks(width=21, FUN=min) %>% which()

pacfTemp <- pacf(dfDailyDTW$temperature_2m_max, lag.max=1000)
pacf(dfDailyDTW$temperature_2m_max, lag.max=50)

```

As expected, ACF has a sustained seasonal pattern, with peaks (at roughly intervals of 365) and valleys (at roughly intervals of 365 offset by roughly 185) corresponding to the 365-day year

ACF and PACF are explored for precipitation:  
```{r, fig.height=9, fig.width=9}

acfPrecip <- acf(dfDailyDTW$precipitation_sum, lag.max=1000)
acf(dfDailyDTW$precipitation_sum, lag.max=50)
as.vector(acfPrecip$acf) %>% findPeaks(width=21) %>% which()
as.vector(acfPrecip$acf) %>% findPeaks(width=21, FUN=min) %>% which()

pacfPrecip <- pacf(dfDailyDTW$precipitation_sum, lag.max=1000)
pacf(dfDailyDTW$precipitation_sum, lag.max=50)

```

Precipitation by contrast has little seasonality and mostly just a correlation to the previous day's value

ACF and PACF are explored for wind speed:  
```{r, fig.height=9, fig.width=9}

acfWind <- acf(dfDailyDTW$windspeed_10m_max, lag.max=1000)
acf(dfDailyDTW$windspeed_10m_max, lag.max=50)
as.vector(acfWind$acf) %>% findPeaks(width=21) %>% which()
as.vector(acfWind$acf) %>% findPeaks(width=21, FUN=min) %>% which()

pacfWind <- pacf(dfDailyDTW$windspeed_10m_max, lag.max=1000)
pacf(dfDailyDTW$windspeed_10m_max, lag.max=50)

```

Similar to temperature, wind speed appears to have a sustained seasonal component, though peak correlations are much lower in magnitude (~0.1 for wind speed vs. ~0.8 for temperature)

A boxplot for delta daily temperature is created:  
```{r, fig.height=9, fig.width=9}

dfDailyDTW %>%
    mutate(month=factor(month.abb[month(date)], levels=month.abb), 
           chg=temperature_2m_max-lag(temperature_2m_max)
           ) %>%
    filter(!is.na(chg)) %>%
    ggplot(aes(x=month, y=chg)) + 
    geom_boxplot() + 
    labs(x=NULL, y="Daily change in maximum temperature")

```

Daily temperature changes are generally larger in magnitude during the colder season

A boxplot for delta daily wind speed is created:  
```{r, fig.height=9, fig.width=9}

dfDailyDTW %>%
    mutate(month=factor(month.abb[month(date)], levels=month.abb), 
           chg=windspeed_10m_max-lag(windspeed_10m_max)
           ) %>%
    filter(!is.na(chg)) %>%
    ggplot(aes(x=month, y=chg)) + 
    geom_boxplot() + 
    labs(x=NULL, y="Daily change in maximum wind speed")

```

Daily wind speed changes are generally larger in magnitude during the colder season

A boxplot for delta daily precipitation is created:  
```{r, fig.height=9, fig.width=9}

dfDailyDTW %>%
    mutate(month=factor(month.abb[month(date)], levels=month.abb), 
           chg=precipitation_sum-lag(precipitation_sum)
           ) %>%
    filter(!is.na(chg)) %>%
    ggplot(aes(x=month, y=chg)) + 
    geom_boxplot() + 
    labs(x=NULL, y="Daily change in precipitation")

```

Most days have no precipitation. The corresponding boxplot for precipitation change has small boxes and whiskers with many outliers

Averages for temperature, precipitation, and wind speed are calculated by day of year, using a 21-day rolling window:  
```{r, fig.height=9, fig.width=9}

df_r21 <- dfDailyDTW %>%
    mutate(doy=pmin(yday(date), 365)) %>% 
    helperRollingAgg(origVar="temperature_2m_max", newName="temp_r21", k=21) %>% 
    helperRollingAgg(origVar="windspeed_10m_max", newName="wind_r21", k=21) %>% 
    helperRollingAgg(origVar="precipitation_sum", newName="precip_r21", k=21) %>%
    select(date, doy, contains("_r21"))

df_r21 %>%
    na.omit() %>%
    group_by(doy) %>%
    summarize(across(where(is.numeric), .fns=mean), n=n()) %>%
    pivot_longer(cols=-c(doy)) %>%
    ggplot(aes(x=doy, y=value)) + 
    geom_line(aes(group=name, color=name)) + 
    facet_wrap(~name, scales="free_y") +
    labs(x="Day of Year", y="Rolling-21 mean") + 
    theme(legend.position="none")

```
  
* The number of observations is lowest on days 1-10 and 356-365 due to inability to get a rolling-21 for the first/last years; and it is highest on day 365 due to day 366 being mapped there  
* Precipitation has seasonal patterns, though it is spiky even on a rolling-21-day basis averaged over 60 years  
* Temperature, on average with a 21-day window over 60 years, has a smooth seasonal pattern  
* Wind speed is similar to temperature in showing a smooth pattern, though with peaks and troughs reversed  
  
Outliers are likely much more important in driving average precipitation than in driving average temperature  

Standard deviations for temperature, precipitation, and wind speed are calculated by day of year, using a 21-day rolling window:  
```{r, fig.height=9, fig.width=9}

df_r21_sd <- dfDailyDTW %>%
    mutate(doy=pmin(yday(date), 365)) %>% 
    group_by(doy) %>%
    mutate(across(.cols=c(temperature_2m_max, windspeed_10m_max, precipitation_sum), .fns=sd)) %>%
    ungroup() %>%
    helperRollingAgg(origVar="temperature_2m_max", newName="temp_r21", k=21) %>% 
    helperRollingAgg(origVar="windspeed_10m_max", newName="wind_r21", k=21) %>% 
    helperRollingAgg(origVar="precipitation_sum", newName="precip_r21", k=21) %>%
    select(date, doy, contains("_r21"))

df_r21_sd %>%
    na.omit() %>%
    group_by(doy) %>%
    summarize(across(where(is.numeric), .fns=mean)) %>%
    pivot_longer(cols=-c(doy)) %>%
    ggplot(aes(x=doy, y=value)) + 
    geom_line(aes(group=name, color=name)) + 
    facet_wrap(~name, scales="free_y") +
    labs(x="Day of Year", y="Rolling-21 mean of daily standard deviation") + 
    theme(legend.position="none")

```
  
* The daily standard deviation of precipitation is, on average, larger than the mean  
* The daily standard deviation of temperature and wind speed are, on average, much lower than the seasonal variation in temperature and wind speed  
  
Means and standard deviations are plotted together:  
```{r, fig.height=9, fig.width=9}

df_r21 %>%
    bind_rows(df_r21_sd, .id="src") %>%
    na.omit() %>%
    mutate(musig=c("1"="Mean", "2"="SD")[src]) %>%
    group_by(doy, musig) %>%
    summarize(across(where(is.numeric), .fns=mean), .groups="drop") %>%
    pivot_longer(cols=-c(doy, musig)) %>%
    pivot_wider(id_cols=c(doy, name), names_from="musig") %>%
    ggplot(aes(x=doy)) + 
    geom_line(aes(y=Mean, group=name, color=name), lwd=2) + 
    geom_ribbon(aes(ymin=Mean-SD, ymax=Mean+SD, fill=name), alpha=0.5) +
    facet_wrap(~name, scales="free_y") +
    labs(x="Day of Year", 
         y="Rolling-21 mean +/- daily standard deviation", 
         title="Rolling 21-day mean +/- one rolling 21-day sd"
         ) + 
    theme(legend.position="none")

```

Means and approximate SEM are plotted together:  
```{r, fig.height=9, fig.width=9}

nYears <- length(unique(year(df_r21$date)))
nYears

df_r21 %>%
    bind_rows(df_r21_sd, .id="src") %>%
    na.omit() %>%
    mutate(musig=c("1"="Mean", "2"="SD")[src]) %>%
    group_by(doy, musig) %>%
    summarize(across(where(is.numeric), .fns=mean), .groups="drop") %>%
    pivot_longer(cols=-c(doy, musig)) %>%
    pivot_wider(id_cols=c(doy, name), names_from="musig") %>%
    ggplot(aes(x=doy)) + 
    geom_line(aes(y=Mean, group=name, color=name), lwd=2) + 
    geom_ribbon(aes(ymin=Mean-SD/sqrt(nYears-1), ymax=Mean+SD/sqrt(nYears-1), fill=name), alpha=0.5) +
    facet_wrap(~name, scales="free_y") +
    labs(x="Day of Year", 
         y="Rolling-21 mean +/- 1 SEM (approx)", 
         title="Rolling 21-day mean +/- 1 SEM (approx)"
         ) + 
    theme(legend.position="none")

```

Consistent with previous analyses, temperature has a strong seasonal pattern with differences in mean that vastly exceed the standard error of the mean. By contrast, while there is apparent seasonal spikiness to precipitation, rolling 21-day means are usually within one standard error of the mean of each other. Wind is more similar to temperature in having seasonal variations that meaningfully exceed SEM in magnitude.

Percentage of cumulative precipitation by volume of daily precipitation is explored:  
```{r, fig.height=9, fig.width=9}

tmpPlotData <- dfDailyDTW %>%
    select(date, precipitation_sum) %>%
    group_by(precipitation_sum) %>%
    summarize(n=n(), precip=sum(precipitation_sum), .groups="drop") %>%
    mutate(csp=cumsum(precip), cpp=csp/sum(precip), csn=cumsum(n), cpn=csn/sum(n)) 

tmpPlotData %>%
    pivot_longer(cols=-c(precipitation_sum)) %>%
    ggplot(aes(x=precipitation_sum, y=value)) + 
    geom_line(data=~filter(., name %in% c("cpp", "cpn")), 
              aes(group=name, color=c("cpn"="# events", "cpp"="precip")[name])
              ) + 
    labs(x="Daily precipitation (mm)", y="% total (cumul)") + 
    scale_color_discrete("Metric")

```

Around half of days have no precipitation. Around 25% of total precipitation comes from the rare day with 15+ mm (above about half an inch) of precipitation

Total precipitation by decade is also explored, sorted by daily precipitation:  
```{r, fig.height=9, fig.width=9}

dfDailyDTW %>%
    select(date, precipitation_sum) %>%
    mutate(year=year(date), decade=round(year(date)-4.5, -1)) %>%
    group_by(decade, precipitation_sum) %>%
    summarize(n=n(), precip=sum(precipitation_sum), .groups="drop") %>%
    group_by(decade) %>%
    mutate(csp=cumsum(precip), ntot=sum(n), meancsp=365*csp/ntot) %>%
    ungroup() %>%
    ggplot(aes(x=precipitation_sum, y=meancsp)) + 
    geom_line(aes(group=factor(decade), color=factor(decade)), lwd=1) + 
    labs(x="Daily precipitation (mm)", 
         y="Cumulative annual precipitation (mm)", 
         title="Average annual precipitation by decade", 
         subtitle="Cumulative, for daily precipitation amounts LTE x-axis"
         ) + 
    scale_color_discrete("Decade")

```

Trends look similar by decade for precipitation amounts under 0.5 inch (12.5 mm). Heavier precipitation amounts appear to be more prevalent in the 2020s and lightest in the 1960s, driving differences in annual precipitation

Long term daily data is downloaded for Chicago:  
```{r cache=TRUE}

# Daily data download for Chicago, IL
testURLDaily <- helperOpenMeteoURL(cityName="Chicago IL", 
                                   dailyIndices=1:nrow(tblMetricsDaily),
                                   startDate="1960-01-01", 
                                   endDate="2023-12-31", 
                                   tz="US/Central"
                                   )
testURLDaily

# Download file
if(!file.exists("testOM_daily_ord.json")) {
    fileDownload(fileName="testOM_daily_ord.json", url=testURLDaily)
} else {
    cat("\nFile testOM_daily_ord.json already exists, skipping download\n")
}

```

The daily dataset is loaded:  
```{r cache=TRUE}

# Read daily JSON file
ordOMDaily <- formatOpenMeteoJSON("testOM_daily_ord.json")

# Sample records of tibble
ordOMDaily$tblDaily %>% glimpse()

```

Variables are converted to proper data type:  
```{r}

dfDailyORD <- ordOMDaily$tblDaily %>%
    mutate(weathercode=factor(weathercode), 
           sunrise_chr=sunrise, 
           sunset_chr=sunset,
           sunrise=lubridate::ymd_hm(sunrise), 
           sunset=lubridate::ymd_hm(sunset), 
           fct_winddir=factor(winddirection_10m_dominant)
           )
glimpse(dfDailyORD)

```

Averages by month for select continuous variables are plotted:  
```{r, fig.height=9, fig.width=9}

tmpMapNames <- c("precipitation_sum"="3. Precipitation (mm)", 
                 "windspeed_10m_max"="4. Windspeed (kph)", 
                 "temperature_2m_max"="1. High Temperature (C)",
                 "temperature_2m_min"="2. Low Temperature (C)"
                 )

dfDailyORD %>%
    mutate(month=factor(month(date), levels=1:12, labels=month.abb), year=year(date)) %>%
    select(year, month, temperature_2m_max, temperature_2m_min, precipitation_sum, windspeed_10m_max) %>%
    group_by(year, month) %>%
    summarize(across(-c(precipitation_sum), .fns=mean), 
              across(c(precipitation_sum), .fns=sum), 
              .groups="drop"
              ) %>%
    group_by(month) %>%
    summarize(across(-c(year), .fns=mean)) %>%
    pivot_longer(-c(month)) %>%
    ggplot(aes(x=month, y=value)) + 
    geom_line(aes(group=1)) + 
    facet_wrap(~tmpMapNames[name], scales="free_y") + 
    labs(x=NULL, y=NULL, title="Monthly averages for key metrics (Chicago 1960-2023)")

```

Averages by month for select categorical variables are plotted:  
```{r, fig.height=9, fig.width=9}

tmpMapNames <- c("wc"="1. Weather Type", 
                 "winddir"="2. Predominant Wind Direction"
                 )

tmpDFPlot <- dfDailyORD %>%
    mutate(month=factor(month(date), levels=1:12, labels=month.abb), 
           year=year(date), 
           winddir=case_when(winddirection_10m_dominant>360~"Invalid", 
                             winddirection_10m_dominant>=315~"1. N", 
                             winddirection_10m_dominant>=225~"2. W", 
                             winddirection_10m_dominant>=135~"3. S", 
                             winddirection_10m_dominant>=45~"4. E", 
                             winddirection_10m_dominant>=0~"1. N", 
                             TRUE~"Invalid"
                             ), 
           wc=case_when(weathercode==0~"1. Clear", 
                        weathercode %in% c(1, 2, 3)~"2. Dry", 
                        weathercode %in% c(51, 53, 55)~"3. Drizzle", 
                        weathercode %in% c(61, 63, 65)~"4. Rain", 
                        weathercode %in% c(71, 73, 75)~"5. Snow", 
                        TRUE~"Error"
                        )
           ) %>%
    select(month, wc, winddir) %>%
    pivot_longer(-c(month)) %>%
    count(month, name, value)

tmpPlotFN <- function(x) {
    p1 <- tmpDFPlot %>%
        filter(name==x) %>%
        ggplot(aes(x=month, y=n)) + 
        geom_line(aes(group=value, color=value), lwd=2) + 
        labs(x=NULL, 
             y=NULL, 
             title=paste0(tmpMapNames[x], " (Chicago 1960-2023)")
             ) + 
        scale_color_discrete(NULL) + 
        theme(legend.position = "bottom")
    return(p1)
    }

gridExtra::grid.arrange(tmpPlotFN("wc"), tmpPlotFN("winddir"), nrow=1)

```

Averages by year for select continuous variables are plotted:  
```{r, fig.height=9, fig.width=9}

tmpMapNames <- c("precipitation_sum"="3. Precipitation (mm)", 
                 "windspeed_10m_max"="4. Windspeed (kph)", 
                 "temperature_2m_max"="1. High Temperature (C)",
                 "temperature_2m_min"="2. Low Temperature (C)"
                 )

dfDailyORD %>%
    mutate(month=factor(month(date), levels=1:12, labels=month.abb), year=year(date)) %>%
    select(year, temperature_2m_max, temperature_2m_min, precipitation_sum, windspeed_10m_max) %>%
    group_by(year) %>%
    summarize(across(-c(precipitation_sum), .fns=mean), 
              across(c(precipitation_sum), .fns=sum), 
              .groups="drop"
              ) %>%
    pivot_longer(-c(year)) %>%
    ggplot(aes(x=year, y=value)) + 
    geom_line(aes(group=1)) + 
    facet_wrap(~tmpMapNames[name], scales="free_y") + 
    labs(x=NULL, y=NULL, title="Annual averages for key metrics (Chicago 1960-2023)")

```

Averages by year for select categorical variables are plotted:  
```{r, fig.height=9, fig.width=9}

tmpMapNames <- c("wc"="1. Weather Type", 
                 "winddir"="2. Predominant Wind Direction"
                 )

tmpDFPlot <- dfDailyORD %>%
    mutate(month=factor(month(date), levels=1:12, labels=month.abb), 
           year=year(date), 
           winddir=case_when(winddirection_10m_dominant>360~"Invalid", 
                             winddirection_10m_dominant>=315~"1. N", 
                             winddirection_10m_dominant>=225~"2. W", 
                             winddirection_10m_dominant>=135~"3. S", 
                             winddirection_10m_dominant>=45~"4. E", 
                             winddirection_10m_dominant>=0~"1. N", 
                             TRUE~"Invalid"
                             ), 
           wc=case_when(weathercode==0~"1. Clear", 
                        weathercode %in% c(1, 2, 3)~"2. Dry", 
                        weathercode %in% c(51, 53, 55)~"3. Drizzle", 
                        weathercode %in% c(61, 63, 65)~"4. Rain", 
                        weathercode %in% c(71, 73, 75)~"5. Snow", 
                        TRUE~"Error"
                        )
           ) %>%
    select(year, wc, winddir) %>%
    pivot_longer(-c(year)) %>%
    count(year, name, value)

tmpPlotFN <- function(x) {
    p1 <- tmpDFPlot %>%
        filter(name==x) %>%
        ggplot(aes(x=year, y=n)) + 
        geom_line(aes(group=value, color=value), lwd=1) + 
        labs(x=NULL, 
             y=NULL, 
             title=paste0(tmpMapNames[x], " (Chicago 1960-2023)")
             ) + 
        scale_color_discrete(NULL) + 
        theme(legend.position = "bottom")
    return(p1)
    }

gridExtra::grid.arrange(tmpPlotFN("wc"), tmpPlotFN("winddir"), nrow=1)

```

Boxplots for maximum windspeed are created:  
```{r, fig.height=9, fig.width=9}

dfDailyORD %>%
    mutate(month=factor(month(date), levels=1:12, labels=month.abb), year=year(date)) %>%
    select(month, windspeed_10m_max) %>%
    ggplot(aes(x=month, y=windspeed_10m_max)) + 
    geom_boxplot(fill="lightblue") + 
    lims(y=c(0, NA)) +
    labs(x=NULL, 
         y="Maximum daily wind speed (kph)", 
         title="Maximum daily windspeed by month (Chicago 1960-2023)"
         )

```

Boxplots for precipitation are created:  
```{r, fig.height=9, fig.width=9}

dfDailyORD %>%
    mutate(month=factor(month(date), levels=1:12, labels=month.abb), year=year(date)) %>%
    select(month, precipitation_hours) %>%
    ggplot(aes(x=month, y=precipitation_hours)) + 
    geom_boxplot(fill="lightblue") + 
    lims(y=c(0, NA)) +
    labs(x=NULL, 
         y="Daily precipitation hours", 
         title="Daily precipitation hours by month (Chicago 1960-2023)"
         )

dfDailyORD %>%
    mutate(month=factor(month(date), levels=1:12, labels=month.abb), year=year(date)) %>%
    select(month, precipitation_sum) %>%
    ggplot(aes(x=month, y=precipitation_sum)) + 
    geom_boxplot(fill="lightblue") + 
    lims(y=c(0, NA)) +
    labs(x=NULL, 
         y="Daily precipitation (mm)", 
         title="Daily precipitation by month (Chicago 1960-2023)"
         )

```

Boxplots for snow are also created:  
```{r, fig.height=9, fig.width=9}

dfDailyORD %>%
    mutate(month=factor(month(date), levels=1:12, labels=month.abb), year=year(date)) %>%
    select(month, snowfall_sum) %>%
    ggplot(aes(x=month, y=snowfall_sum)) + 
    geom_boxplot(fill="lightblue") + 
    lims(y=c(0, NA)) +
    labs(x=NULL, 
         y="Daily snowfall (liquid equivalent mm)", 
         title="Daily snowfall by month (Chicago 1960-2023)"
         )

```

Boxplots for temperature are created:  
```{r, fig.height=9, fig.width=9}

dfDailyORD %>%
    mutate(month=factor(month(date), levels=1:12, labels=month.abb), year=year(date)) %>%
    select(month, temperature_2m_max) %>%
    ggplot(aes(x=month, y=temperature_2m_max)) + 
    geom_boxplot(fill="lightblue") + 
    labs(x=NULL, 
         y="Daily high temperature (C)", 
         title="Daily high temperature by month (Chicago 1960-2023)"
         )

dfDailyORD %>%
    mutate(month=factor(month(date), levels=1:12, labels=month.abb), year=year(date)) %>%
    select(month, temperature_2m_min) %>%
    ggplot(aes(x=month, y=temperature_2m_min)) + 
    geom_boxplot(fill="lightblue") + 
    labs(x=NULL, 
         y="Daily low temperature (C)", 
         title="Daily low temperature by month (Chicago 1960-2023)"
         )

```

ACF and PACF are explored for maximum temperature:  
```{r, fig.height=9, fig.width=9}

acfTemp <- acf(dfDailyORD$temperature_2m_max, lag.max=1000)
as.vector(acfTemp$acf) %>% findPeaks(width=21) %>% which()
as.vector(acfTemp$acf) %>% findPeaks(width=21, FUN=min) %>% which()

pacfTemp <- pacf(dfDailyORD$temperature_2m_max, lag.max=1000)
pacf(dfDailyORD$temperature_2m_max, lag.max=50)

```

As expected, ACF has a sustained seasonal pattern, with peaks (at roughly intervals of 365) and valleys (at roughly intervals of 365 offset by roughly 185) corresponding to the 365-day year

ACF and PACF are explored for precipitation:  
```{r, fig.height=9, fig.width=9}

acfPrecip <- acf(dfDailyORD$precipitation_sum, lag.max=1000)
acf(dfDailyORD$precipitation_sum, lag.max=50)
as.vector(acfPrecip$acf) %>% findPeaks(width=21) %>% which()
as.vector(acfPrecip$acf) %>% findPeaks(width=21, FUN=min) %>% which()

pacfPrecip <- pacf(dfDailyORD$precipitation_sum, lag.max=1000)
pacf(dfDailyORD$precipitation_sum, lag.max=50)

```

Precipitation by contrast has little seasonality and mostly just a slight correlation to the previous day's value

ACF and PACF are explored for wind speed:  
```{r, fig.height=9, fig.width=9}

acfWind <- acf(dfDailyORD$windspeed_10m_max, lag.max=1000)
acf(dfDailyORD$windspeed_10m_max, lag.max=50)
as.vector(acfWind$acf) %>% findPeaks(width=21) %>% which()
as.vector(acfWind$acf) %>% findPeaks(width=21, FUN=min) %>% which()

pacfWind <- pacf(dfDailyORD$windspeed_10m_max, lag.max=1000)
pacf(dfDailyORD$windspeed_10m_max, lag.max=50)

```

Similar to temperature, wind speed appears to have a sustained seasonal component, though peak correlations are much lower in magnitude (~0.1 for wind speed vs. ~0.8 for temperature)

A boxplot for delta daily temperature is created:  
```{r, fig.height=9, fig.width=9}

dfDailyORD %>%
    mutate(month=factor(month.abb[month(date)], levels=month.abb), 
           chg=temperature_2m_max-lag(temperature_2m_max)
           ) %>%
    filter(!is.na(chg)) %>%
    ggplot(aes(x=month, y=chg)) + 
    geom_boxplot() + 
    labs(x=NULL, y="Daily change in maximum temperature")

```

Daily temperature changes are generally larger in magnitude during the colder season

A boxplot for delta daily wind speed is created:  
```{r, fig.height=9, fig.width=9}

dfDailyORD %>%
    mutate(month=factor(month.abb[month(date)], levels=month.abb), 
           chg=windspeed_10m_max-lag(windspeed_10m_max)
           ) %>%
    filter(!is.na(chg)) %>%
    ggplot(aes(x=month, y=chg)) + 
    geom_boxplot() + 
    labs(x=NULL, y="Daily change in maximum wind speed")

```

Daily wind speed changes are generally similar in magnitude by season

A boxplot for delta daily precipitation is created:  
```{r, fig.height=9, fig.width=9}

dfDailyORD %>%
    mutate(month=factor(month.abb[month(date)], levels=month.abb), 
           chg=precipitation_sum-lag(precipitation_sum)
           ) %>%
    filter(!is.na(chg)) %>%
    ggplot(aes(x=month, y=chg)) + 
    geom_boxplot() + 
    labs(x=NULL, y="Daily change in precipitation")

```

Most days have no precipitation. The corresponding boxplot for precipitation change has small boxes and whiskers with many outliers

Averages for temperature, precipitation, and wind speed are calculated by day of year, using a 21-day rolling window:  
```{r, fig.height=9, fig.width=9}

df_r21 <- dfDailyORD %>%
    mutate(doy=pmin(yday(date), 365)) %>% 
    helperRollingAgg(origVar="temperature_2m_max", newName="temp_r21", k=21) %>% 
    helperRollingAgg(origVar="windspeed_10m_max", newName="wind_r21", k=21) %>% 
    helperRollingAgg(origVar="precipitation_sum", newName="precip_r21", k=21) %>%
    select(date, doy, contains("_r21"))

df_r21 %>%
    na.omit() %>%
    group_by(doy) %>%
    summarize(across(where(is.numeric), .fns=mean), n=n()) %>%
    pivot_longer(cols=-c(doy)) %>%
    ggplot(aes(x=doy, y=value)) + 
    geom_line(aes(group=name, color=name)) + 
    facet_wrap(~name, scales="free_y") +
    labs(x="Day of Year", y="Rolling-21 mean") + 
    theme(legend.position="none")

```
  
* The number of observations is lowest on days 1-10 and 356-365 due to inability to get a rolling-21 for the first/last years; and it is highest on day 365 due to day 366 being mapped there  
* Precipitation has seasonal patterns, though it is spiky even on a rolling-21-day basis averaged over 60 years  
* Temperature, on average with a 21-day window over 60 years, has a smooth seasonal pattern  
* Wind speed is similar to temperature in showing a smooth pattern, though with peaks and troughs reversed  
  
Outliers are likely much more important in driving average precipitation than in driving average temperature  

Standard deviations for temperature, precipitation, and wind speed are calculated by day of year, using a 21-day rolling window:  
```{r, fig.height=9, fig.width=9}

df_r21_sd <- dfDailyORD %>%
    mutate(doy=pmin(yday(date), 365)) %>% 
    group_by(doy) %>%
    mutate(across(.cols=c(temperature_2m_max, windspeed_10m_max, precipitation_sum), .fns=sd)) %>%
    ungroup() %>%
    helperRollingAgg(origVar="temperature_2m_max", newName="temp_r21", k=21) %>% 
    helperRollingAgg(origVar="windspeed_10m_max", newName="wind_r21", k=21) %>% 
    helperRollingAgg(origVar="precipitation_sum", newName="precip_r21", k=21) %>%
    select(date, doy, contains("_r21"))

df_r21_sd %>%
    na.omit() %>%
    group_by(doy) %>%
    summarize(across(where(is.numeric), .fns=mean)) %>%
    pivot_longer(cols=-c(doy)) %>%
    ggplot(aes(x=doy, y=value)) + 
    geom_line(aes(group=name, color=name)) + 
    facet_wrap(~name, scales="free_y") +
    labs(x="Day of Year", y="Rolling-21 mean of daily standard deviation") + 
    theme(legend.position="none")

```
  
* The daily standard deviation of precipitation is, on average, larger than the mean  
* The daily standard deviation of temperature is, on average, lower than the seasonal variation in temperature  
  
Means and standard deviations are plotted together:  
```{r, fig.height=9, fig.width=9}

df_r21 %>%
    bind_rows(df_r21_sd, .id="src") %>%
    na.omit() %>%
    mutate(musig=c("1"="Mean", "2"="SD")[src]) %>%
    group_by(doy, musig) %>%
    summarize(across(where(is.numeric), .fns=mean), .groups="drop") %>%
    pivot_longer(cols=-c(doy, musig)) %>%
    pivot_wider(id_cols=c(doy, name), names_from="musig") %>%
    ggplot(aes(x=doy)) + 
    geom_line(aes(y=Mean, group=name, color=name), lwd=2) + 
    geom_ribbon(aes(ymin=Mean-SD, ymax=Mean+SD, fill=name), alpha=0.5) +
    facet_wrap(~name, scales="free_y") +
    labs(x="Day of Year", 
         y="Rolling-21 mean +/- daily standard deviation", 
         title="Rolling 21-day mean +/- one rolling 21-day sd"
         ) + 
    theme(legend.position="none")

```

Means and approximate SEM are plotted together:  
```{r, fig.height=9, fig.width=9}

nYears <- length(unique(year(df_r21$date)))
nYears

df_r21 %>%
    bind_rows(df_r21_sd, .id="src") %>%
    na.omit() %>%
    mutate(musig=c("1"="Mean", "2"="SD")[src]) %>%
    group_by(doy, musig) %>%
    summarize(across(where(is.numeric), .fns=mean), .groups="drop") %>%
    pivot_longer(cols=-c(doy, musig)) %>%
    pivot_wider(id_cols=c(doy, name), names_from="musig") %>%
    ggplot(aes(x=doy)) + 
    geom_line(aes(y=Mean, group=name, color=name), lwd=2) + 
    geom_ribbon(aes(ymin=Mean-SD/sqrt(nYears-1), ymax=Mean+SD/sqrt(nYears-1), fill=name), alpha=0.5) +
    facet_wrap(~name, scales="free_y") +
    labs(x="Day of Year", 
         y="Rolling-21 mean +/- 1 SEM (approx)", 
         title="Rolling 21-day mean +/- 1 SEM (approx)"
         ) + 
    theme(legend.position="none")

```

Consistent with previous analyses, temperature has a strong seasonal pattern with differences in mean that vastly exceed the standard error of the mean. By contrast, while there is apparent seasonal spikiness to precipitation, rolling 21-day means are usually within one standard error of the mean of each other. Wind is more similar to temperature in having seasonal variations that meaningfully exceed SEM in magnitude.

Percentage of cumulative precipitation by volume of daily precipitation is explored:  
```{r, fig.height=9, fig.width=9}

tmpPlotData <- dfDailyORD %>%
    select(date, precipitation_sum) %>%
    group_by(precipitation_sum) %>%
    summarize(n=n(), precip=sum(precipitation_sum), .groups="drop") %>%
    mutate(csp=cumsum(precip), cpp=csp/sum(precip), csn=cumsum(n), cpn=csn/sum(n)) 

tmpPlotData %>%
    pivot_longer(cols=-c(precipitation_sum)) %>%
    ggplot(aes(x=precipitation_sum, y=value)) + 
    geom_line(data=~filter(., name %in% c("cpp", "cpn")), 
              aes(group=name, color=c("cpn"="# events", "cpp"="precip")[name])
              ) + 
    labs(x="Daily precipitation (mm)", y="% total (cumul)") + 
    scale_color_discrete("Metric")

```

Around half of days have no precipitation. Around 25% of total precipitation comes from the rare day with 20+ mm (nearly an inch) of precipitation

Total precipitation by decade is also explored, sorted by daily precipitation:  
```{r, fig.height=9, fig.width=9}

dfDailyORD %>%
    select(date, precipitation_sum) %>%
    mutate(year=year(date), decade=round(year(date)-4.5, -1)) %>%
    group_by(decade, precipitation_sum) %>%
    summarize(n=n(), precip=sum(precipitation_sum), .groups="drop") %>%
    group_by(decade) %>%
    mutate(csp=cumsum(precip), ntot=sum(n), meancsp=365*csp/ntot) %>%
    ungroup() %>%
    ggplot(aes(x=precipitation_sum, y=meancsp)) + 
    geom_line(aes(group=factor(decade), color=factor(decade)), lwd=1) + 
    labs(x="Daily precipitation (mm)", 
         y="Cumulative annual precipitation (mm)", 
         title="Average annual precipitation by decade", 
         subtitle="Cumulative, for daily precipitation amounts LTE x-axis"
         ) + 
    scale_color_discrete("Decade")

```

Trends look similar by decade for precipitation amounts under 0.5 inch (12.5 mm). Heavier precipitation amounts appear to be more prevalent in the 2010s/2020s and lightest in the 1960s, driving differences in annual precipitation

Averages for temperature, precipitation, and wind speed are calculated by day of year, using a 21-day rolling window, for Atlanta, Detroit, and Chicago:  
```{r, fig.height=9, fig.width=9}

df_r21 <- bind_rows(dfDailyATL, dfDailyORD, dfDailyDTW, .id="src") %>%
    mutate(doy=pmin(yday(date), 365), 
           src=c("1"="Atlanta", "2"="Chicago", "3"="Detroit")[src]
           ) %>% 
    group_by(src) %>%
    helperRollingAgg(origVar="temperature_2m_max", newName="temp_r21", k=21) %>% 
    helperRollingAgg(origVar="windspeed_10m_max", newName="wind_r21", k=21) %>% 
    helperRollingAgg(origVar="precipitation_sum", newName="precip_r21", k=21) %>%
    select(src, date, doy, contains("_r21")) %>%
    ungroup()

df_r21 %>%
    na.omit() %>%
    group_by(src, doy) %>%
    summarize(across(where(is.numeric), .fns=mean), n=n(), .groups="drop") %>%
    pivot_longer(cols=-c(src, doy)) %>%
    ggplot(aes(x=doy, y=value)) + 
    geom_line(aes(group=src, color=src), lwd=1) + 
    facet_wrap(~name, scales="free_y") +
    labs(x="Day of Year", y="Rolling-21 mean") + 
    theme(legend.position="bottom") + 
    scale_color_discrete(NULL)

```
  
Standard deviations for temperature, precipitation, and wind speed are calculated by day of year, using a 21-day rolling window:  
```{r, fig.height=9, fig.width=9}

df_r21_sd <- bind_rows(dfDailyATL, dfDailyORD, dfDailyDTW, .id="src") %>%
    mutate(doy=pmin(yday(date), 365), 
           src=c("1"="Atlanta", "2"="Chicago", "3"="Detroit")[src]
           ) %>% 
    group_by(src, doy) %>%
    mutate(across(.cols=c(temperature_2m_max, windspeed_10m_max, precipitation_sum), .fns=sd)) %>%
    group_by(src) %>%
    helperRollingAgg(origVar="temperature_2m_max", newName="temp_r21", k=21) %>% 
    helperRollingAgg(origVar="windspeed_10m_max", newName="wind_r21", k=21) %>% 
    helperRollingAgg(origVar="precipitation_sum", newName="precip_r21", k=21) %>%
    select(src, date, doy, contains("_r21")) %>%
    ungroup()

df_r21_sd %>%
    na.omit() %>%
    group_by(src, doy) %>%
    summarize(across(where(is.numeric), .fns=mean), .groups="drop") %>%
    pivot_longer(cols=-c(src, doy)) %>%
    ggplot(aes(x=doy, y=value)) + 
    geom_line(aes(group=src, color=src), lwd=1) + 
    facet_wrap(~name, scales="free_y") +
    labs(x="Day of Year", y="Rolling-21 mean of daily standard deviation") + 
    theme(legend.position="bottom")

```
  
Means and approximate SEM are plotted together:  
```{r, fig.height=9, fig.width=9}

nYears <- length(unique(year(df_r21$date)))
nYears

df_r21 %>%
    bind_rows(df_r21_sd, .id="typ") %>%
    na.omit() %>%
    mutate(musig=c("1"="Mean", "2"="SD")[typ]) %>%
    group_by(src, doy, musig) %>%
    summarize(across(where(is.numeric), .fns=mean), .groups="drop") %>%
    pivot_longer(cols=-c(src, doy, musig)) %>%
    pivot_wider(id_cols=c(src, doy, name), names_from="musig") %>%
    ggplot(aes(x=doy)) + 
    geom_line(aes(y=Mean, group=src, color=src), lty=2) + 
    geom_ribbon(aes(ymin=Mean-SD/sqrt(nYears-1), ymax=Mean+SD/sqrt(nYears-1), fill=src), alpha=0.5) +
    facet_wrap(~name, scales="free_y") +
    labs(x="Day of Year", 
         y="Rolling-21 mean +/- 1 SEM (approx)", 
         title="Rolling 21-day mean +/- 1 SEM (approx)"
         ) + 
    theme(legend.position="bottom")

```
  
* Atlanta is wetter, on average, during the cold season, though SEM for precipitation is very large relative to difference in means for precipitation  
* Atlanta is warmest, on average, while Chicago and Detroit have very similar temperatures  
* Chicago is the most windy, on average, while Atlanta is least windy  
  
Percentage of cumulative precipitation by volume of daily precipitation is explored, for three cities:  
```{r, fig.height=9, fig.width=9}

tmpPlotData <- bind_rows(dfDailyATL, dfDailyORD, dfDailyDTW, .id="src") %>%
    mutate(src=c("1"="Atlanta", "2"="Chicago", "3"="Detroit")[src]) %>% 
    select(src, date, precipitation_sum) %>%
    group_by(src, precipitation_sum) %>%
    summarize(n=n(), precip=sum(precipitation_sum), .groups="drop") %>%
    group_by(src) %>%
    mutate(csp=cumsum(precip), cpp=csp/sum(precip), csn=cumsum(n), cpn=csn/sum(n)) %>%
    ungroup()

tmpPlotData %>%
    pivot_longer(cols=-c(src, precipitation_sum)) %>%
    filter(name %in% c("cpp", "cpn")) %>%
    ggplot(aes(x=precipitation_sum, y=value)) + 
    geom_line(aes(group=src, color=src)) + 
    labs(x="Daily precipitation (mm)", y="% total (cumul)") + 
    scale_color_discrete("Metric") + 
    facet_wrap(~c("cpn"="# events", "cpp"="precip")[name])

```

Around half of days have no precipitation. In all three cities, around 25% of total precipitation comes from the rare day with 15-20+ mm (half inch to nearly an inch) of precipitation

Frequency of precipitation by change in temperature is explored:  
```{r, fig.height=9, fig.width=9}

bind_rows(dfDailyATL, dfDailyORD, dfDailyDTW, .id="src") %>%
    mutate(src=c("1"="Atlanta", "2"="Chicago", "3"="Detroit")[src]) %>%
    select(src, date, precipitation_sum, temperature_2m_max) %>%
    group_by(src) %>%
    mutate(isPrecip=precipitation_sum>0, 
           dTemp=temperature_2m_max-lag(temperature_2m_max), 
           month=factor(month.abb[month(date)], levels=month.abb)
           ) %>%
    ungroup() %>%
    filter(complete.cases(.)) %>%
    mutate(dTempRound=autoRound(dTemp, rndTo=2.5), dTempRound=pmax(-10, pmin(10, dTempRound))) %>%
    group_by(src, dTempRound) %>%
    summarize(pctPrecip=mean(isPrecip), muPrecip=mean(precipitation_sum), n=n(), .groups="drop") %>%
    mutate(sdpctPrecip=sqrt(pctPrecip*(1-pctPrecip)/n)) %>%
    ggplot(aes(x=dTempRound)) + 
    geom_line(aes(y=pctPrecip, color=src, group=src)) + 
    geom_ribbon(aes(ymin=pctPrecip-sdpctPrecip, ymax=pctPrecip+sdpctPrecip, fill=src, group=src), alpha=0.5) +
    labs(x="Temperature Change from Yesterday (C)\n(rounded to nearest 2.5, capped at +/- 10)", 
         y="% Days with Precipitation > 0\n(mean +/- 1 SE)", 
         title="Frequency of precipitation by change in temperature"
         ) +
    lims(y=c(0, 1)) + 
    scale_fill_discrete(NULL) + 
    scale_color_discrete(guide="none")

```

Month is a possible confounder, since temperature change and precipitation both vary by season:  
```{r, fig.height=9, fig.width=9}

bind_rows(dfDailyATL, dfDailyORD, dfDailyDTW, .id="src") %>%
    mutate(src=c("1"="Atlanta", "2"="Chicago", "3"="Detroit")[src]) %>%
    select(src, date, precipitation_sum, temperature_2m_max) %>%
    group_by(src) %>%
    mutate(isPrecip=precipitation_sum>0, 
           dTemp=temperature_2m_max-lag(temperature_2m_max), 
           month=factor(month.abb[month(date)], levels=month.abb)
           ) %>%
    ungroup() %>%
    filter(complete.cases(.)) %>%
    mutate(dTempRound=autoRound(dTemp, rndTo=2.5), dTempRound=pmax(-10, pmin(10, dTempRound))) %>%
    group_by(src, month, dTempRound) %>%
    summarize(pctPrecip=mean(isPrecip), muPrecip=mean(precipitation_sum), n=n(), .groups="drop") %>%
    mutate(sdpctPrecip=sqrt(pctPrecip*(1-pctPrecip)/n)) %>%
    filter(n>=5) %>%
    ggplot(aes(x=dTempRound)) + 
    geom_line(aes(y=pctPrecip, color=src, group=src)) + 
    geom_ribbon(aes(ymin=pctPrecip-sdpctPrecip, ymax=pctPrecip+sdpctPrecip, fill=src, group=src), alpha=0.5) +
    facet_wrap(~month) +
    labs(x="Temperature Change from Yesterday (C)\n(rounded to nearest 2.5, capped at +/- 10)", 
         y="% Days with Precipitation > 0\n(mean +/- 1 SE)", 
         title="Frequency of precipitation by change in temperature"
         ) +
    lims(y=c(0, 1)) + 
    scale_fill_discrete(NULL) + 
    scale_color_discrete(guide="none")

```
  
At a glance, there appears to be some association between temperature change and frequency of precipitation, even after controlling for city and month

Long term daily data is downloaded for New Orleans:  
```{r cache=TRUE}

# Daily data download for New Orleans, LA
testURLDaily <- helperOpenMeteoURL(cityName="New Orleans LA", 
                                   dailyIndices=1:nrow(tblMetricsDaily),
                                   startDate="1960-01-01", 
                                   endDate="2023-12-31", 
                                   tz="US/Central"
                                   )
testURLDaily

# Download file
if(!file.exists("testOM_daily_msy.json")) {
    fileDownload(fileName="testOM_daily_msy.json", url=testURLDaily)
} else {
    cat("\nFile testOM_daily_msy.json already exists, skipping download\n")
}

```

The daily dataset is loaded:  
```{r cache=TRUE}

# Read daily JSON file
msyOMDaily <- formatOpenMeteoJSON("testOM_daily_msy.json")

# Sample records of tibble
msyOMDaily$tblDaily %>% glimpse()

```

Variables are converted to proper data type:  
```{r}

dfDailyMSY <- msyOMDaily$tblDaily %>%
    mutate(weathercode=factor(weathercode), 
           sunrise_chr=sunrise, 
           sunset_chr=sunset,
           sunrise=lubridate::ymd_hm(sunrise), 
           sunset=lubridate::ymd_hm(sunset), 
           fct_winddir=factor(winddirection_10m_dominant)
           )
glimpse(dfDailyMSY)

```
  
Averages by month for select continuous variables are plotted:  
```{r, fig.height=9, fig.width=9}

tmpMapNames <- c("precipitation_sum"="3. Precipitation (mm)", 
                 "windspeed_10m_max"="4. Windspeed (kph)", 
                 "temperature_2m_max"="1. High Temperature (C)",
                 "temperature_2m_min"="2. Low Temperature (C)"
                 )

dfDailyMSY %>%
    mutate(month=factor(month(date), levels=1:12, labels=month.abb), year=year(date)) %>%
    select(year, month, temperature_2m_max, temperature_2m_min, precipitation_sum, windspeed_10m_max) %>%
    group_by(year, month) %>%
    summarize(across(-c(precipitation_sum), .fns=mean), 
              across(c(precipitation_sum), .fns=sum), 
              .groups="drop"
              ) %>%
    group_by(month) %>%
    summarize(across(-c(year), .fns=mean)) %>%
    pivot_longer(-c(month)) %>%
    ggplot(aes(x=month, y=value)) + 
    geom_line(aes(group=1)) + 
    facet_wrap(~tmpMapNames[name], scales="free_y") + 
    labs(x=NULL, y=NULL, title="Monthly averages for key metrics (New Orleans 1960-2023)")

```
  
Averages by month for select categorical variables are plotted:  
```{r, fig.height=9, fig.width=9}

tmpMapNames <- c("wc"="1. Weather Type", 
                 "winddir"="2. Predominant Wind Direction"
                 )

tmpDFPlot <- dfDailyMSY %>%
    mutate(month=factor(month(date), levels=1:12, labels=month.abb), 
           year=year(date), 
           winddir=case_when(winddirection_10m_dominant>360~"Invalid", 
                             winddirection_10m_dominant>=315~"1. N", 
                             winddirection_10m_dominant>=225~"2. W", 
                             winddirection_10m_dominant>=135~"3. S", 
                             winddirection_10m_dominant>=45~"4. E", 
                             winddirection_10m_dominant>=0~"1. N", 
                             TRUE~"Invalid"
                             ), 
           wc=case_when(weathercode==0~"1. Clear", 
                        weathercode %in% c(1, 2, 3)~"2. Dry", 
                        weathercode %in% c(51, 53, 55)~"3. Drizzle", 
                        weathercode %in% c(61, 63, 65)~"4. Rain", 
                        weathercode %in% c(71, 73, 75)~"5. Snow", 
                        TRUE~"Error"
                        )
           ) %>%
    select(month, wc, winddir) %>%
    pivot_longer(-c(month)) %>%
    count(month, name, value)

tmpPlotFN <- function(x) {
    p1 <- tmpDFPlot %>%
        filter(name==x) %>%
        ggplot(aes(x=month, y=n)) + 
        geom_line(aes(group=value, color=value), lwd=2) + 
        labs(x=NULL, 
             y=NULL, 
             title=paste0(tmpMapNames[x], " (New Orleans 1960-2023)")
             ) + 
        scale_color_discrete(NULL) + 
        theme(legend.position = "bottom")
    return(p1)
    }

gridExtra::grid.arrange(tmpPlotFN("wc"), tmpPlotFN("winddir"), nrow=1)

```

Averages by year for select continuous variables are plotted:  
```{r, fig.height=9, fig.width=9}

tmpMapNames <- c("precipitation_sum"="3. Precipitation (mm)", 
                 "windspeed_10m_max"="4. Windspeed (kph)", 
                 "temperature_2m_max"="1. High Temperature (C)",
                 "temperature_2m_min"="2. Low Temperature (C)"
                 )

dfDailyMSY %>%
    mutate(month=factor(month(date), levels=1:12, labels=month.abb), year=year(date)) %>%
    select(year, temperature_2m_max, temperature_2m_min, precipitation_sum, windspeed_10m_max) %>%
    group_by(year) %>%
    summarize(across(-c(precipitation_sum), .fns=mean), 
              across(c(precipitation_sum), .fns=sum), 
              .groups="drop"
              ) %>%
    pivot_longer(-c(year)) %>%
    ggplot(aes(x=year, y=value)) + 
    geom_line(aes(group=1)) + 
    facet_wrap(~tmpMapNames[name], scales="free_y") + 
    labs(x=NULL, y=NULL, title="Annual averages for key metrics (New Orleans 1960-2023)")

```

Averages by year for select categorical variables are plotted:  
```{r, fig.height=9, fig.width=9}

tmpMapNames <- c("wc"="1. Weather Type", 
                 "winddir"="2. Predominant Wind Direction"
                 )

tmpDFPlot <- dfDailyMSY %>%
    mutate(month=factor(month(date), levels=1:12, labels=month.abb), 
           year=year(date), 
           winddir=case_when(winddirection_10m_dominant>360~"Invalid", 
                             winddirection_10m_dominant>=315~"1. N", 
                             winddirection_10m_dominant>=225~"2. W", 
                             winddirection_10m_dominant>=135~"3. S", 
                             winddirection_10m_dominant>=45~"4. E", 
                             winddirection_10m_dominant>=0~"1. N", 
                             TRUE~"Invalid"
                             ), 
           wc=case_when(weathercode==0~"1. Clear", 
                        weathercode %in% c(1, 2, 3)~"2. Dry", 
                        weathercode %in% c(51, 53, 55)~"3. Drizzle", 
                        weathercode %in% c(61, 63, 65)~"4. Rain", 
                        weathercode %in% c(71, 73, 75)~"5. Snow", 
                        TRUE~"Error"
                        )
           ) %>%
    select(year, wc, winddir) %>%
    pivot_longer(-c(year)) %>%
    count(year, name, value)

tmpPlotFN <- function(x) {
    p1 <- tmpDFPlot %>%
        filter(name==x) %>%
        ggplot(aes(x=year, y=n)) + 
        geom_line(aes(group=value, color=value), lwd=1) + 
        labs(x=NULL, 
             y=NULL, 
             title=paste0(tmpMapNames[x], " (New Orleans 1960-2023)")
             ) + 
        scale_color_discrete(NULL) + 
        theme(legend.position = "bottom")
    return(p1)
    }

gridExtra::grid.arrange(tmpPlotFN("wc"), tmpPlotFN("winddir"), nrow=1)

```

Boxplots for maximum windspeed are created:  
```{r, fig.height=9, fig.width=9}

dfDailyMSY %>%
    mutate(month=factor(month(date), levels=1:12, labels=month.abb), year=year(date)) %>%
    select(month, windspeed_10m_max) %>%
    ggplot(aes(x=month, y=windspeed_10m_max)) + 
    geom_boxplot(fill="lightblue") + 
    lims(y=c(0, NA)) +
    labs(x=NULL, 
         y="Maximum daily wind speed (kph)", 
         title="Maximum daily windspeed by month (New Orleans 1960-2023)"
         )

```

Boxplots for precipitation are created:  
```{r, fig.height=9, fig.width=9}

dfDailyMSY %>%
    mutate(month=factor(month(date), levels=1:12, labels=month.abb), year=year(date)) %>%
    select(month, precipitation_hours) %>%
    ggplot(aes(x=month, y=precipitation_hours)) + 
    geom_boxplot(fill="lightblue") + 
    lims(y=c(0, NA)) +
    labs(x=NULL, 
         y="Daily precipitation hours", 
         title="Daily precipitation hours by month (New Orleans 1960-2023)"
         )

dfDailyMSY %>%
    mutate(month=factor(month(date), levels=1:12, labels=month.abb), year=year(date)) %>%
    select(month, precipitation_sum) %>%
    ggplot(aes(x=month, y=precipitation_sum)) + 
    geom_boxplot(fill="lightblue") + 
    lims(y=c(0, NA)) +
    labs(x=NULL, 
         y="Daily precipitation (mm)", 
         title="Daily precipitation by month (New Orleans 1960-2023)"
         )

```

Boxplots for temperature are created:  
```{r, fig.height=9, fig.width=9}

dfDailyMSY %>%
    mutate(month=factor(month(date), levels=1:12, labels=month.abb), year=year(date)) %>%
    select(month, temperature_2m_max) %>%
    ggplot(aes(x=month, y=temperature_2m_max)) + 
    geom_boxplot(fill="lightblue") + 
    labs(x=NULL, 
         y="Daily high temperature (C)", 
         title="Daily high temperature by month (New Orleans 1960-2023)"
         )

dfDailyMSY %>%
    mutate(month=factor(month(date), levels=1:12, labels=month.abb), year=year(date)) %>%
    select(month, temperature_2m_min) %>%
    ggplot(aes(x=month, y=temperature_2m_min)) + 
    geom_boxplot(fill="lightblue") + 
    labs(x=NULL, 
         y="Daily low temperature (C)", 
         title="Daily low temperature by month (New Orleans 1960-2023)"
         )

```

ACF and PACF are explored for maximum temperature:  
```{r, fig.height=9, fig.width=9}

acfTemp <- acf(dfDailyMSY$temperature_2m_max, lag.max=1000)
as.vector(acfTemp$acf) %>% findPeaks(width=21) %>% which()
as.vector(acfTemp$acf) %>% findPeaks(width=21, FUN=min) %>% which()

pacfTemp <- pacf(dfDailyMSY$temperature_2m_max, lag.max=1000)
pacf(dfDailyMSY$temperature_2m_max, lag.max=50)

```

As expected, ACF has a sustained seasonal pattern, with peaks (at roughly intervals of 365) and valleys (at roughly intervals of 365 offset by roughly 185) corresponding to the 365-day year

ACF and PACF are explored for precipitation:  
```{r, fig.height=9, fig.width=9}

acfPrecip <- acf(dfDailyMSY$precipitation_sum, lag.max=1000)
acf(dfDailyMSY$precipitation_sum, lag.max=50)
as.vector(acfPrecip$acf) %>% findPeaks(width=21) %>% which()
as.vector(acfPrecip$acf) %>% findPeaks(width=21, FUN=min) %>% which()

pacfPrecip <- pacf(dfDailyMSY$precipitation_sum, lag.max=1000)
pacf(dfDailyMSY$precipitation_sum, lag.max=50)

```

Precipitation by contrast has little seasonality and mostly just a slight correlation to the previous day's value

ACF and PACF are explored for wind speed:  
```{r, fig.height=9, fig.width=9}

acfWind <- acf(dfDailyMSY$windspeed_10m_max, lag.max=1000)
acf(dfDailyMSY$windspeed_10m_max, lag.max=50)
as.vector(acfWind$acf) %>% findPeaks(width=21) %>% which()
as.vector(acfWind$acf) %>% findPeaks(width=21, FUN=min) %>% which()

pacfWind <- pacf(dfDailyMSY$windspeed_10m_max, lag.max=1000)
pacf(dfDailyMSY$windspeed_10m_max, lag.max=50)

```

Similar to temperature, wind speed appears to have a sustained seasonal component, though peak correlations are much lower in magnitude (~0.2 for wind speed vs. ~0.8 for temperature)

A boxplot for delta daily temperature is created:  
```{r, fig.height=9, fig.width=9}

dfDailyMSY %>%
    mutate(month=factor(month.abb[month(date)], levels=month.abb), 
           chg=temperature_2m_max-lag(temperature_2m_max)
           ) %>%
    filter(!is.na(chg)) %>%
    ggplot(aes(x=month, y=chg)) + 
    geom_boxplot() + 
    labs(x=NULL, y="Daily change in maximum temperature")

```

Daily temperature changes are generally larger in magnitude during the colder season

A boxplot for delta daily wind speed is created:  
```{r, fig.height=9, fig.width=9}

dfDailyMSY %>%
    mutate(month=factor(month.abb[month(date)], levels=month.abb), 
           chg=windspeed_10m_max-lag(windspeed_10m_max)
           ) %>%
    filter(!is.na(chg)) %>%
    ggplot(aes(x=month, y=chg)) + 
    geom_boxplot() + 
    labs(x=NULL, y="Daily change in maximum wind speed")

```

Daily wind speed changes are generally similar in magnitude by season, though with more outliers in Aug-Oct

A boxplot for delta daily precipitation is created:  
```{r, fig.height=9, fig.width=9}

dfDailyMSY %>%
    mutate(month=factor(month.abb[month(date)], levels=month.abb), 
           chg=precipitation_sum-lag(precipitation_sum)
           ) %>%
    filter(!is.na(chg)) %>%
    ggplot(aes(x=month, y=chg)) + 
    geom_boxplot() + 
    labs(x=NULL, y="Daily change in precipitation")

```

Most days have no precipitation. The corresponding boxplot for precipitation change has small boxes and whiskers with many outliers

Averages for temperature, precipitation, and wind speed are calculated by day of year, using a 21-day rolling window:  
```{r, fig.height=9, fig.width=9}

df_r21 <- dfDailyMSY %>%
    mutate(doy=pmin(yday(date), 365)) %>% 
    helperRollingAgg(origVar="temperature_2m_max", newName="temp_r21", k=21) %>% 
    helperRollingAgg(origVar="windspeed_10m_max", newName="wind_r21", k=21) %>% 
    helperRollingAgg(origVar="precipitation_sum", newName="precip_r21", k=21) %>%
    select(date, doy, contains("_r21"))

df_r21 %>%
    na.omit() %>%
    group_by(doy) %>%
    summarize(across(where(is.numeric), .fns=mean), n=n()) %>%
    pivot_longer(cols=-c(doy)) %>%
    ggplot(aes(x=doy, y=value)) + 
    geom_line(aes(group=name, color=name)) + 
    facet_wrap(~name, scales="free_y") +
    labs(x="Day of Year", y="Rolling-21 mean") + 
    theme(legend.position="none")

```
  
* The number of observations is lowest on days 1-10 and 356-365 due to inability to get a rolling-21 for the first/last years; and it is highest on day 365 due to day 366 being mapped there  
* Precipitation has seasonal patterns, though it is spiky even on a rolling-21-day basis averaged over 60 years  
* Temperature, on average with a 21-day window over 60 years, has a smooth seasonal pattern  
* Wind speed is similar to temperature in showing a smooth pattern, though with peaks and troughs reversed  
  
Outliers are likely much more important in driving average precipitation than in driving average temperature  

Standard deviations for temperature, precipitation, and wind speed are calculated by day of year, using a 21-day rolling window:  
```{r, fig.height=9, fig.width=9}

df_r21_sd <- dfDailyMSY %>%
    mutate(doy=pmin(yday(date), 365)) %>% 
    group_by(doy) %>%
    mutate(across(.cols=c(temperature_2m_max, windspeed_10m_max, precipitation_sum), .fns=sd)) %>%
    ungroup() %>%
    helperRollingAgg(origVar="temperature_2m_max", newName="temp_r21", k=21) %>% 
    helperRollingAgg(origVar="windspeed_10m_max", newName="wind_r21", k=21) %>% 
    helperRollingAgg(origVar="precipitation_sum", newName="precip_r21", k=21) %>%
    select(date, doy, contains("_r21"))

df_r21_sd %>%
    na.omit() %>%
    group_by(doy) %>%
    summarize(across(where(is.numeric), .fns=mean)) %>%
    pivot_longer(cols=-c(doy)) %>%
    ggplot(aes(x=doy, y=value)) + 
    geom_line(aes(group=name, color=name)) + 
    facet_wrap(~name, scales="free_y") +
    labs(x="Day of Year", y="Rolling-21 mean of daily standard deviation") + 
    theme(legend.position="none")

```
  
* The daily standard deviation of precipitation is, on average, larger than the mean  
* The daily standard deviation of temperature is, on average, lower than the seasonal variation in temperature  
  
Means and standard deviations are plotted together:  
```{r, fig.height=9, fig.width=9}

df_r21 %>%
    bind_rows(df_r21_sd, .id="src") %>%
    na.omit() %>%
    mutate(musig=c("1"="Mean", "2"="SD")[src]) %>%
    group_by(doy, musig) %>%
    summarize(across(where(is.numeric), .fns=mean), .groups="drop") %>%
    pivot_longer(cols=-c(doy, musig)) %>%
    pivot_wider(id_cols=c(doy, name), names_from="musig") %>%
    ggplot(aes(x=doy)) + 
    geom_line(aes(y=Mean, group=name, color=name), lwd=2) + 
    geom_ribbon(aes(ymin=Mean-SD, ymax=Mean+SD, fill=name), alpha=0.5) +
    facet_wrap(~name, scales="free_y") +
    labs(x="Day of Year", 
         y="Rolling-21 mean +/- daily standard deviation", 
         title="Rolling 21-day mean +/- one rolling 21-day sd"
         ) + 
    theme(legend.position="none")

```

Means and approximate SEM are plotted together:  
```{r, fig.height=9, fig.width=9}

nYears <- length(unique(year(df_r21$date)))
nYears

df_r21 %>%
    bind_rows(df_r21_sd, .id="src") %>%
    na.omit() %>%
    mutate(musig=c("1"="Mean", "2"="SD")[src]) %>%
    group_by(doy, musig) %>%
    summarize(across(where(is.numeric), .fns=mean), .groups="drop") %>%
    pivot_longer(cols=-c(doy, musig)) %>%
    pivot_wider(id_cols=c(doy, name), names_from="musig") %>%
    ggplot(aes(x=doy)) + 
    geom_line(aes(y=Mean, group=name, color=name), lwd=2) + 
    geom_ribbon(aes(ymin=Mean-SD/sqrt(nYears-1), ymax=Mean+SD/sqrt(nYears-1), fill=name), alpha=0.5) +
    facet_wrap(~name, scales="free_y") +
    labs(x="Day of Year", 
         y="Rolling-21 mean +/- 1 SEM (approx)", 
         title="Rolling 21-day mean +/- 1 SEM (approx)"
         ) + 
    theme(legend.position="none")

```

Consistent with previous analyses, temperature has a strong seasonal pattern with differences in mean that vastly exceed the standard error of the mean. By contrast, while there is apparent seasonal spikiness to precipitation, rolling 21-day means are usually within one standard error of the mean of each other. Wind is more similar to temperature in having seasonal variations that meaningfully exceed SEM in magnitude.

Long term daily data is downloaded for Denver:  
```{r cache=TRUE}

# Daily data download for Denver, CO
testURLDaily <- helperOpenMeteoURL(cityName="Denver CO", 
                                   dailyIndices=1:nrow(tblMetricsDaily),
                                   startDate="1960-01-01", 
                                   endDate="2023-12-31", 
                                   tz="US/Mountain"
                                   )
testURLDaily

# Download file
if(!file.exists("testOM_daily_den.json")) {
    fileDownload(fileName="testOM_daily_den.json", url=testURLDaily)
} else {
    cat("\nFile testOM_daily_den.json already exists, skipping download\n")
}

```

The daily dataset is loaded:  
```{r cache=TRUE}

# Read daily JSON file
denOMDaily <- formatOpenMeteoJSON("testOM_daily_den.json")

# Sample records of tibble
denOMDaily$tblDaily %>% glimpse()

```

Variables are converted to proper data type:  
```{r}

dfDailyDEN <- denOMDaily$tblDaily %>%
    mutate(weathercode=factor(weathercode), 
           sunrise_chr=sunrise, 
           sunset_chr=sunset,
           sunrise=lubridate::ymd_hm(sunrise), 
           sunset=lubridate::ymd_hm(sunset), 
           fct_winddir=factor(winddirection_10m_dominant)
           )
glimpse(dfDailyDEN)

```
  
Averages by month for select continuous variables are plotted:  
```{r, fig.height=9, fig.width=9}

tmpMapNames <- c("precipitation_sum"="3. Precipitation (mm)", 
                 "windspeed_10m_max"="4. Windspeed (kph)", 
                 "temperature_2m_max"="1. High Temperature (C)",
                 "temperature_2m_min"="2. Low Temperature (C)"
                 )

dfDailyDEN %>%
    mutate(month=factor(month(date), levels=1:12, labels=month.abb), year=year(date)) %>%
    select(year, month, temperature_2m_max, temperature_2m_min, precipitation_sum, windspeed_10m_max) %>%
    group_by(year, month) %>%
    summarize(across(-c(precipitation_sum), .fns=mean), 
              across(c(precipitation_sum), .fns=sum), 
              .groups="drop"
              ) %>%
    group_by(month) %>%
    summarize(across(-c(year), .fns=mean)) %>%
    pivot_longer(-c(month)) %>%
    ggplot(aes(x=month, y=value)) + 
    geom_line(aes(group=1)) + 
    facet_wrap(~tmpMapNames[name], scales="free_y") + 
    labs(x=NULL, y=NULL, title="Monthly averages for key metrics (Denver 1960-2023)")

```
  
Averages by month for select categorical variables are plotted:  
```{r, fig.height=9, fig.width=9}

tmpMapNames <- c("wc"="1. Weather Type", 
                 "winddir"="2. Predominant Wind Direction"
                 )

tmpDFPlot <- dfDailyDEN %>%
    mutate(month=factor(month(date), levels=1:12, labels=month.abb), 
           year=year(date), 
           winddir=case_when(winddirection_10m_dominant>360~"Invalid", 
                             winddirection_10m_dominant>=315~"1. N", 
                             winddirection_10m_dominant>=225~"2. W", 
                             winddirection_10m_dominant>=135~"3. S", 
                             winddirection_10m_dominant>=45~"4. E", 
                             winddirection_10m_dominant>=0~"1. N", 
                             TRUE~"Invalid"
                             ), 
           wc=case_when(weathercode==0~"1. Clear", 
                        weathercode %in% c(1, 2, 3)~"2. Dry", 
                        weathercode %in% c(51, 53, 55)~"3. Drizzle", 
                        weathercode %in% c(61, 63, 65)~"4. Rain", 
                        weathercode %in% c(71, 73, 75)~"5. Snow", 
                        TRUE~"Error"
                        )
           ) %>%
    select(month, wc, winddir) %>%
    pivot_longer(-c(month)) %>%
    count(month, name, value)

tmpPlotFN <- function(x) {
    p1 <- tmpDFPlot %>%
        filter(name==x) %>%
        ggplot(aes(x=month, y=n)) + 
        geom_line(aes(group=value, color=value), lwd=2) + 
        labs(x=NULL, 
             y=NULL, 
             title=paste0(tmpMapNames[x], " (Denver 1960-2023)")
             ) + 
        scale_color_discrete(NULL) + 
        theme(legend.position = "bottom")
    return(p1)
    }

gridExtra::grid.arrange(tmpPlotFN("wc"), tmpPlotFN("winddir"), nrow=1)

```

Averages by year for select continuous variables are plotted:  
```{r, fig.height=9, fig.width=9}

tmpMapNames <- c("precipitation_sum"="3. Precipitation (mm)", 
                 "windspeed_10m_max"="4. Windspeed (kph)", 
                 "temperature_2m_max"="1. High Temperature (C)",
                 "temperature_2m_min"="2. Low Temperature (C)"
                 )

dfDailyDEN %>%
    mutate(month=factor(month(date), levels=1:12, labels=month.abb), year=year(date)) %>%
    select(year, temperature_2m_max, temperature_2m_min, precipitation_sum, windspeed_10m_max) %>%
    group_by(year) %>%
    summarize(across(-c(precipitation_sum), .fns=mean), 
              across(c(precipitation_sum), .fns=sum), 
              .groups="drop"
              ) %>%
    pivot_longer(-c(year)) %>%
    ggplot(aes(x=year, y=value)) + 
    geom_line(aes(group=1)) + 
    facet_wrap(~tmpMapNames[name], scales="free_y") + 
    labs(x=NULL, y=NULL, title="Annual averages for key metrics (Denver 1960-2023)")

```

Averages by year for select categorical variables are plotted:  
```{r, fig.height=9, fig.width=9}

tmpMapNames <- c("wc"="1. Weather Type", 
                 "winddir"="2. Predominant Wind Direction"
                 )

tmpDFPlot <- dfDailyDEN %>%
    mutate(month=factor(month(date), levels=1:12, labels=month.abb), 
           year=year(date), 
           winddir=case_when(winddirection_10m_dominant>360~"Invalid", 
                             winddirection_10m_dominant>=315~"1. N", 
                             winddirection_10m_dominant>=225~"2. W", 
                             winddirection_10m_dominant>=135~"3. S", 
                             winddirection_10m_dominant>=45~"4. E", 
                             winddirection_10m_dominant>=0~"1. N", 
                             TRUE~"Invalid"
                             ), 
           wc=case_when(weathercode==0~"1. Clear", 
                        weathercode %in% c(1, 2, 3)~"2. Dry", 
                        weathercode %in% c(51, 53, 55)~"3. Drizzle", 
                        weathercode %in% c(61, 63, 65)~"4. Rain", 
                        weathercode %in% c(71, 73, 75)~"5. Snow", 
                        TRUE~"Error"
                        )
           ) %>%
    select(year, wc, winddir) %>%
    pivot_longer(-c(year)) %>%
    count(year, name, value)

tmpPlotFN <- function(x) {
    p1 <- tmpDFPlot %>%
        filter(name==x) %>%
        ggplot(aes(x=year, y=n)) + 
        geom_line(aes(group=value, color=value), lwd=1) + 
        labs(x=NULL, 
             y=NULL, 
             title=paste0(tmpMapNames[x], " (Denver 1960-2023)")
             ) + 
        scale_color_discrete(NULL) + 
        theme(legend.position = "bottom")
    return(p1)
    }

gridExtra::grid.arrange(tmpPlotFN("wc"), tmpPlotFN("winddir"), nrow=1)

```

Boxplots for maximum windspeed are created:  
```{r, fig.height=9, fig.width=9}

dfDailyDEN %>%
    mutate(month=factor(month(date), levels=1:12, labels=month.abb), year=year(date)) %>%
    select(month, windspeed_10m_max) %>%
    ggplot(aes(x=month, y=windspeed_10m_max)) + 
    geom_boxplot(fill="lightblue") + 
    lims(y=c(0, NA)) +
    labs(x=NULL, 
         y="Maximum daily wind speed (kph)", 
         title="Maximum daily windspeed by month (Denver 1960-2023)"
         )

```

Boxplots for precipitation are created:  
```{r, fig.height=9, fig.width=9}

dfDailyDEN %>%
    mutate(month=factor(month(date), levels=1:12, labels=month.abb), year=year(date)) %>%
    select(month, precipitation_hours) %>%
    ggplot(aes(x=month, y=precipitation_hours)) + 
    geom_boxplot(fill="lightblue") + 
    lims(y=c(0, NA)) +
    labs(x=NULL, 
         y="Daily precipitation hours", 
         title="Daily precipitation hours by month (Denver 1960-2023)"
         )

dfDailyDEN %>%
    mutate(month=factor(month(date), levels=1:12, labels=month.abb), year=year(date)) %>%
    select(month, precipitation_sum) %>%
    ggplot(aes(x=month, y=precipitation_sum)) + 
    geom_boxplot(fill="lightblue") + 
    lims(y=c(0, NA)) +
    labs(x=NULL, 
         y="Daily precipitation (mm)", 
         title="Daily precipitation by month (Denver 1960-2023)"
         )

```

Boxplots for snow are also created:  
```{r, fig.height=9, fig.width=9}

dfDailyDEN %>%
    mutate(month=factor(month(date), levels=1:12, labels=month.abb), year=year(date)) %>%
    select(month, snowfall_sum) %>%
    ggplot(aes(x=month, y=snowfall_sum)) + 
    geom_boxplot(fill="lightblue") + 
    lims(y=c(0, NA)) +
    labs(x=NULL, 
         y="Daily snowfall (liquid equivalent mm)", 
         title="Daily snowfall by month (Denver 1960-2023)"
         )

```

Boxplots for temperature are created:  
```{r, fig.height=9, fig.width=9}

dfDailyDEN %>%
    mutate(month=factor(month(date), levels=1:12, labels=month.abb), year=year(date)) %>%
    select(month, temperature_2m_max) %>%
    ggplot(aes(x=month, y=temperature_2m_max)) + 
    geom_boxplot(fill="lightblue") + 
    labs(x=NULL, 
         y="Daily high temperature (C)", 
         title="Daily high temperature by month (Denver 1960-2023)"
         )

dfDailyDEN %>%
    mutate(month=factor(month(date), levels=1:12, labels=month.abb), year=year(date)) %>%
    select(month, temperature_2m_min) %>%
    ggplot(aes(x=month, y=temperature_2m_min)) + 
    geom_boxplot(fill="lightblue") + 
    labs(x=NULL, 
         y="Daily low temperature (C)", 
         title="Daily low temperature by month (Denver 1960-2023)"
         )

```

ACF and PACF are explored for maximum temperature:  
```{r, fig.height=9, fig.width=9}

acfTemp <- acf(dfDailyDEN$temperature_2m_max, lag.max=1000)
as.vector(acfTemp$acf) %>% findPeaks(width=21) %>% which()
as.vector(acfTemp$acf) %>% findPeaks(width=21, FUN=min) %>% which()

pacfTemp <- pacf(dfDailyDEN$temperature_2m_max, lag.max=1000)
pacf(dfDailyDEN$temperature_2m_max, lag.max=50)

```

As expected, ACF has a sustained seasonal pattern, with peaks (at roughly intervals of 365) and valleys (at roughly intervals of 365 offset by roughly 185) corresponding to the 365-day year

ACF and PACF are explored for precipitation:  
```{r, fig.height=9, fig.width=9}

acfPrecip <- acf(dfDailyDEN$precipitation_sum, lag.max=1000)
acf(dfDailyDEN$precipitation_sum, lag.max=50)
as.vector(acfPrecip$acf) %>% findPeaks(width=21) %>% which()
as.vector(acfPrecip$acf) %>% findPeaks(width=21, FUN=min) %>% which()

pacfPrecip <- pacf(dfDailyDEN$precipitation_sum, lag.max=1000)
pacf(dfDailyDEN$precipitation_sum, lag.max=50)

```

Precipitation by contrast has little seasonality and mostly just a slight correlation to the previous day's value

ACF and PACF are explored for wind speed:  
```{r, fig.height=9, fig.width=9}

acfWind <- acf(dfDailyDEN$windspeed_10m_max, lag.max=1000)
acf(dfDailyDEN$windspeed_10m_max, lag.max=50)
as.vector(acfWind$acf) %>% findPeaks(width=21) %>% which()
as.vector(acfWind$acf) %>% findPeaks(width=21, FUN=min) %>% which()

pacfWind <- pacf(dfDailyDEN$windspeed_10m_max, lag.max=1000)
pacf(dfDailyDEN$windspeed_10m_max, lag.max=50)

```

Similar to temperature, wind speed appears to have a sustained seasonal component, though peak correlations are very low in magnitude (~0.05 for wind speed vs. ~0.75 for temperature)

A boxplot for delta daily temperature is created:  
```{r, fig.height=9, fig.width=9}

dfDailyDEN %>%
    mutate(month=factor(month.abb[month(date)], levels=month.abb), 
           chg=temperature_2m_max-lag(temperature_2m_max)
           ) %>%
    filter(!is.na(chg)) %>%
    ggplot(aes(x=month, y=chg)) + 
    geom_boxplot() + 
    labs(x=NULL, y="Daily change in maximum temperature")

```

Daily temperature changes are generally larger in magnitude during the colder season

A boxplot for delta daily wind speed is created:  
```{r, fig.height=9, fig.width=9}

dfDailyDEN %>%
    mutate(month=factor(month.abb[month(date)], levels=month.abb), 
           chg=windspeed_10m_max-lag(windspeed_10m_max)
           ) %>%
    filter(!is.na(chg)) %>%
    ggplot(aes(x=month, y=chg)) + 
    geom_boxplot() + 
    labs(x=NULL, y="Daily change in maximum wind speed")

```

Daily wind speed changes are generally similar in magnitude by season

A boxplot for delta daily precipitation is created:  
```{r, fig.height=9, fig.width=9}

dfDailyDEN %>%
    mutate(month=factor(month.abb[month(date)], levels=month.abb), 
           chg=precipitation_sum-lag(precipitation_sum)
           ) %>%
    filter(!is.na(chg)) %>%
    ggplot(aes(x=month, y=chg)) + 
    geom_boxplot() + 
    labs(x=NULL, y="Daily change in precipitation")

```

Most days have no precipitation. The corresponding boxplot for precipitation change has small boxes and whiskers with many outliers

Averages for temperature, precipitation, and wind speed are calculated by day of year, using a 21-day rolling window:  
```{r, fig.height=9, fig.width=9}

df_r21 <- dfDailyDEN %>%
    mutate(doy=pmin(yday(date), 365)) %>% 
    helperRollingAgg(origVar="temperature_2m_max", newName="temp_r21", k=21) %>% 
    helperRollingAgg(origVar="windspeed_10m_max", newName="wind_r21", k=21) %>% 
    helperRollingAgg(origVar="precipitation_sum", newName="precip_r21", k=21) %>%
    select(date, doy, contains("_r21"))

df_r21 %>%
    na.omit() %>%
    group_by(doy) %>%
    summarize(across(where(is.numeric), .fns=mean), n=n()) %>%
    pivot_longer(cols=-c(doy)) %>%
    ggplot(aes(x=doy, y=value)) + 
    geom_line(aes(group=name, color=name)) + 
    facet_wrap(~name, scales="free_y") +
    labs(x="Day of Year", y="Rolling-21 mean") + 
    theme(legend.position="none")

```
  
* The number of observations is lowest on days 1-10 and 356-365 due to inability to get a rolling-21 for the first/last years; and it is highest on day 365 due to day 366 being mapped there  
* Precipitation has seasonal patterns, though it is spiky even on a rolling-21-day basis averaged over 60 years  
* Temperature, on average with a 21-day window over 60 years, has a smooth seasonal pattern  
* Wind speed is similar to temperature in showing a smooth pattern, though with differences in peaks and troughs timing  
  
Outliers are likely much more important in driving average precipitation than in driving average temperature  

Standard deviations for temperature, precipitation, and wind speed are calculated by day of year, using a 21-day rolling window:  
```{r, fig.height=9, fig.width=9}

df_r21_sd <- dfDailyDEN %>%
    mutate(doy=pmin(yday(date), 365)) %>% 
    group_by(doy) %>%
    mutate(across(.cols=c(temperature_2m_max, windspeed_10m_max, precipitation_sum), .fns=sd)) %>%
    ungroup() %>%
    helperRollingAgg(origVar="temperature_2m_max", newName="temp_r21", k=21) %>% 
    helperRollingAgg(origVar="windspeed_10m_max", newName="wind_r21", k=21) %>% 
    helperRollingAgg(origVar="precipitation_sum", newName="precip_r21", k=21) %>%
    select(date, doy, contains("_r21"))

df_r21_sd %>%
    na.omit() %>%
    group_by(doy) %>%
    summarize(across(where(is.numeric), .fns=mean)) %>%
    pivot_longer(cols=-c(doy)) %>%
    ggplot(aes(x=doy, y=value)) + 
    geom_line(aes(group=name, color=name)) + 
    facet_wrap(~name, scales="free_y") +
    labs(x="Day of Year", y="Rolling-21 mean of daily standard deviation") + 
    theme(legend.position="none")

```
  
* The daily standard deviation of precipitation is, on average, larger than the mean  
* The daily standard deviation of temperature is, on average, lower than the seasonal variation in temperature  
  
Means and standard deviations are plotted together:  
```{r, fig.height=9, fig.width=9}

df_r21 %>%
    bind_rows(df_r21_sd, .id="src") %>%
    na.omit() %>%
    mutate(musig=c("1"="Mean", "2"="SD")[src]) %>%
    group_by(doy, musig) %>%
    summarize(across(where(is.numeric), .fns=mean), .groups="drop") %>%
    pivot_longer(cols=-c(doy, musig)) %>%
    pivot_wider(id_cols=c(doy, name), names_from="musig") %>%
    ggplot(aes(x=doy)) + 
    geom_line(aes(y=Mean, group=name, color=name), lwd=2) + 
    geom_ribbon(aes(ymin=Mean-SD, ymax=Mean+SD, fill=name), alpha=0.5) +
    facet_wrap(~name, scales="free_y") +
    labs(x="Day of Year", 
         y="Rolling-21 mean +/- daily standard deviation", 
         title="Rolling 21-day mean +/- one rolling 21-day sd"
         ) + 
    theme(legend.position="none")

```

Means and approximate SEM are plotted together:  
```{r, fig.height=9, fig.width=9}

nYears <- length(unique(year(df_r21$date)))
nYears

df_r21 %>%
    bind_rows(df_r21_sd, .id="src") %>%
    na.omit() %>%
    mutate(musig=c("1"="Mean", "2"="SD")[src]) %>%
    group_by(doy, musig) %>%
    summarize(across(where(is.numeric), .fns=mean), .groups="drop") %>%
    pivot_longer(cols=-c(doy, musig)) %>%
    pivot_wider(id_cols=c(doy, name), names_from="musig") %>%
    ggplot(aes(x=doy)) + 
    geom_line(aes(y=Mean, group=name, color=name), lwd=2) + 
    geom_ribbon(aes(ymin=Mean-SD/sqrt(nYears-1), ymax=Mean+SD/sqrt(nYears-1), fill=name), alpha=0.5) +
    facet_wrap(~name, scales="free_y") +
    labs(x="Day of Year", 
         y="Rolling-21 mean +/- 1 SEM (approx)", 
         title="Rolling 21-day mean +/- 1 SEM (approx)"
         ) + 
    theme(legend.position="none")

```

Consistent with previous analyses, temperature has a strong seasonal pattern with differences in mean that vastly exceed the standard error of the mean. Wind is more similar to temperature in having seasonal variations that meaningfully exceed SEM in magnitude. Of interest, the seasonal spikiness in precipitationresults in many times of the year that are outside of one standard error of the mean of each other. This is in contrast to cities explored previously where SEM is typically greater than change in means by time of year

Long term daily data is downloaded for Phoenix, AZ:  
```{r cache=TRUE}

# Daily data download for Phoenix, AZ
testURLDaily <- helperOpenMeteoURL(cityName="Phoenix AZ", 
                                   dailyIndices=1:nrow(tblMetricsDaily),
                                   startDate="1960-01-01", 
                                   endDate="2023-12-31", 
                                   tz="US/Arizona"
                                   )
testURLDaily

# Download file
if(!file.exists("testOM_daily_phx.json")) {
    fileDownload(fileName="testOM_daily_phx.json", url=testURLDaily)
} else {
    cat("\nFile testOM_daily_phx.json already exists, skipping download\n")
}

```

The daily dataset is loaded:  
```{r cache=TRUE}

# Read daily JSON file
phxOMDaily <- formatOpenMeteoJSON("testOM_daily_phx.json")

# Sample records of tibble
phxOMDaily$tblDaily %>% glimpse()

```

Variables are converted to proper data type:  
```{r}

dfDailyPHX <- phxOMDaily$tblDaily %>%
    mutate(weathercode=factor(weathercode), 
           sunrise_chr=sunrise, 
           sunset_chr=sunset,
           sunrise=lubridate::ymd_hm(sunrise), 
           sunset=lubridate::ymd_hm(sunset), 
           fct_winddir=factor(winddirection_10m_dominant)
           )
glimpse(dfDailyPHX)

```
  
Averages by month for select continuous variables are plotted:  
```{r, fig.height=9, fig.width=9}

tmpMapNames <- c("precipitation_sum"="3. Precipitation (mm)", 
                 "windspeed_10m_max"="4. Windspeed (kph)", 
                 "temperature_2m_max"="1. High Temperature (C)",
                 "temperature_2m_min"="2. Low Temperature (C)"
                 )

dfDailyPHX %>%
    mutate(month=factor(month(date), levels=1:12, labels=month.abb), year=year(date)) %>%
    select(year, month, temperature_2m_max, temperature_2m_min, precipitation_sum, windspeed_10m_max) %>%
    group_by(year, month) %>%
    summarize(across(-c(precipitation_sum), .fns=mean), 
              across(c(precipitation_sum), .fns=sum), 
              .groups="drop"
              ) %>%
    group_by(month) %>%
    summarize(across(-c(year), .fns=mean)) %>%
    pivot_longer(-c(month)) %>%
    ggplot(aes(x=month, y=value)) + 
    geom_line(aes(group=1)) + 
    facet_wrap(~tmpMapNames[name], scales="free_y") + 
    labs(x=NULL, y=NULL, title="Monthly averages for key metrics (Phoenix 1960-2023)")

```
  
Averages by month for select categorical variables are plotted:  
```{r, fig.height=9, fig.width=9}

tmpMapNames <- c("wc"="1. Weather Type", 
                 "winddir"="2. Predominant Wind Direction"
                 )

tmpDFPlot <- dfDailyPHX %>%
    mutate(month=factor(month(date), levels=1:12, labels=month.abb), 
           year=year(date), 
           winddir=case_when(winddirection_10m_dominant>360~"Invalid", 
                             winddirection_10m_dominant>=315~"1. N", 
                             winddirection_10m_dominant>=225~"2. W", 
                             winddirection_10m_dominant>=135~"3. S", 
                             winddirection_10m_dominant>=45~"4. E", 
                             winddirection_10m_dominant>=0~"1. N", 
                             TRUE~"Invalid"
                             ), 
           wc=case_when(weathercode==0~"1. Clear", 
                        weathercode %in% c(1, 2, 3)~"2. Dry", 
                        weathercode %in% c(51, 53, 55)~"3. Drizzle", 
                        weathercode %in% c(61, 63, 65)~"4. Rain", 
                        weathercode %in% c(71, 73, 75)~"5. Snow", 
                        TRUE~"Error"
                        )
           ) %>%
    select(month, wc, winddir) %>%
    pivot_longer(-c(month)) %>%
    count(month, name, value)

tmpPlotFN <- function(x) {
    p1 <- tmpDFPlot %>%
        filter(name==x) %>%
        ggplot(aes(x=month, y=n)) + 
        geom_line(aes(group=value, color=value), lwd=2) + 
        labs(x=NULL, 
             y=NULL, 
             title=paste0(tmpMapNames[x], " (Phoenix 1960-2023)")
             ) + 
        scale_color_discrete(NULL) + 
        theme(legend.position = "bottom")
    return(p1)
    }

gridExtra::grid.arrange(tmpPlotFN("wc"), tmpPlotFN("winddir"), nrow=1)

```

Averages by year for select continuous variables are plotted:  
```{r, fig.height=9, fig.width=9}

tmpMapNames <- c("precipitation_sum"="3. Precipitation (mm)", 
                 "windspeed_10m_max"="4. Windspeed (kph)", 
                 "temperature_2m_max"="1. High Temperature (C)",
                 "temperature_2m_min"="2. Low Temperature (C)"
                 )

dfDailyPHX %>%
    mutate(month=factor(month(date), levels=1:12, labels=month.abb), year=year(date)) %>%
    select(year, temperature_2m_max, temperature_2m_min, precipitation_sum, windspeed_10m_max) %>%
    group_by(year) %>%
    summarize(across(-c(precipitation_sum), .fns=mean), 
              across(c(precipitation_sum), .fns=sum), 
              .groups="drop"
              ) %>%
    pivot_longer(-c(year)) %>%
    ggplot(aes(x=year, y=value)) + 
    geom_line(aes(group=1)) + 
    facet_wrap(~tmpMapNames[name], scales="free_y") + 
    labs(x=NULL, y=NULL, title="Annual averages for key metrics (Phoenix 1960-2023)")

```

Averages by year for select categorical variables are plotted:  
```{r, fig.height=9, fig.width=9}

tmpMapNames <- c("wc"="1. Weather Type", 
                 "winddir"="2. Predominant Wind Direction"
                 )

tmpDFPlot <- dfDailyPHX %>%
    mutate(month=factor(month(date), levels=1:12, labels=month.abb), 
           year=year(date), 
           winddir=case_when(winddirection_10m_dominant>360~"Invalid", 
                             winddirection_10m_dominant>=315~"1. N", 
                             winddirection_10m_dominant>=225~"2. W", 
                             winddirection_10m_dominant>=135~"3. S", 
                             winddirection_10m_dominant>=45~"4. E", 
                             winddirection_10m_dominant>=0~"1. N", 
                             TRUE~"Invalid"
                             ), 
           wc=case_when(weathercode==0~"1. Clear", 
                        weathercode %in% c(1, 2, 3)~"2. Dry", 
                        weathercode %in% c(51, 53, 55)~"3. Drizzle", 
                        weathercode %in% c(61, 63, 65)~"4. Rain", 
                        weathercode %in% c(71, 73, 75)~"5. Snow", 
                        TRUE~"Error"
                        )
           ) %>%
    select(year, wc, winddir) %>%
    pivot_longer(-c(year)) %>%
    count(year, name, value)

tmpPlotFN <- function(x) {
    p1 <- tmpDFPlot %>%
        filter(name==x) %>%
        ggplot(aes(x=year, y=n)) + 
        geom_line(aes(group=value, color=value), lwd=1) + 
        labs(x=NULL, 
             y=NULL, 
             title=paste0(tmpMapNames[x], " (Phoenix 1960-2023)")
             ) + 
        scale_color_discrete(NULL) + 
        theme(legend.position = "bottom")
    return(p1)
    }

gridExtra::grid.arrange(tmpPlotFN("wc"), tmpPlotFN("winddir"), nrow=1)

```

Boxplots for maximum windspeed are created:  
```{r, fig.height=9, fig.width=9}

dfDailyPHX %>%
    mutate(month=factor(month(date), levels=1:12, labels=month.abb), year=year(date)) %>%
    select(month, windspeed_10m_max) %>%
    ggplot(aes(x=month, y=windspeed_10m_max)) + 
    geom_boxplot(fill="lightblue") + 
    lims(y=c(0, NA)) +
    labs(x=NULL, 
         y="Maximum daily wind speed (kph)", 
         title="Maximum daily windspeed by month (Phoenix 1960-2023)"
         )

```

Boxplots for precipitation are created:  
```{r, fig.height=9, fig.width=9}

dfDailyPHX %>%
    mutate(month=factor(month(date), levels=1:12, labels=month.abb), year=year(date)) %>%
    select(month, precipitation_hours) %>%
    ggplot(aes(x=month, y=precipitation_hours)) + 
    geom_boxplot(fill="lightblue") + 
    lims(y=c(0, NA)) +
    labs(x=NULL, 
         y="Daily precipitation hours", 
         title="Daily precipitation hours by month (Phoenix 1960-2023)"
         )

dfDailyPHX %>%
    mutate(month=factor(month(date), levels=1:12, labels=month.abb), year=year(date)) %>%
    select(month, precipitation_sum) %>%
    ggplot(aes(x=month, y=precipitation_sum)) + 
    geom_boxplot(fill="lightblue") + 
    lims(y=c(0, NA)) +
    labs(x=NULL, 
         y="Daily precipitation (mm)", 
         title="Daily precipitation by month (Phoenix 1960-2023)"
         )

```

Boxplots for temperature are created:  
```{r, fig.height=9, fig.width=9}

dfDailyPHX %>%
    mutate(month=factor(month(date), levels=1:12, labels=month.abb), year=year(date)) %>%
    select(month, temperature_2m_max) %>%
    ggplot(aes(x=month, y=temperature_2m_max)) + 
    geom_boxplot(fill="lightblue") + 
    labs(x=NULL, 
         y="Daily high temperature (C)", 
         title="Daily high temperature by month (Phoenix 1960-2023)"
         )

dfDailyPHX %>%
    mutate(month=factor(month(date), levels=1:12, labels=month.abb), year=year(date)) %>%
    select(month, temperature_2m_min) %>%
    ggplot(aes(x=month, y=temperature_2m_min)) + 
    geom_boxplot(fill="lightblue") + 
    labs(x=NULL, 
         y="Daily low temperature (C)", 
         title="Daily low temperature by month (Phoenix 1960-2023)"
         )

```

ACF and PACF are explored for maximum temperature:  
```{r, fig.height=9, fig.width=9}

acfTemp <- acf(dfDailyPHX$temperature_2m_max, lag.max=1000)
as.vector(acfTemp$acf) %>% findPeaks(width=21) %>% which()
as.vector(acfTemp$acf) %>% findPeaks(width=21, FUN=min) %>% which()

pacfTemp <- pacf(dfDailyPHX$temperature_2m_max, lag.max=1000)
pacf(dfDailyPHX$temperature_2m_max, lag.max=50)

```

As expected, ACF has a sustained seasonal pattern, with peaks (at roughly intervals of 365) and valleys (at roughly intervals of 365 offset by roughly 185) corresponding to the 365-day year

ACF and PACF are explored for precipitation:  
```{r, fig.height=9, fig.width=9}

acfPrecip <- acf(dfDailyPHX$precipitation_sum, lag.max=1000)
acf(dfDailyPHX$precipitation_sum, lag.max=50)
as.vector(acfPrecip$acf) %>% findPeaks(width=21) %>% which()
as.vector(acfPrecip$acf) %>% findPeaks(width=21, FUN=min) %>% which()

pacfPrecip <- pacf(dfDailyPHX$precipitation_sum, lag.max=1000)
pacf(dfDailyPHX$precipitation_sum, lag.max=50)

```

Precipitation by contrast has little seasonality and mostly just a slight correlation to the previous day's value

ACF and PACF are explored for wind speed:  
```{r, fig.height=9, fig.width=9}

acfWind <- acf(dfDailyPHX$windspeed_10m_max, lag.max=1000)
acf(dfDailyPHX$windspeed_10m_max, lag.max=50)
as.vector(acfWind$acf) %>% findPeaks(width=21) %>% which()
as.vector(acfWind$acf) %>% findPeaks(width=21, FUN=min) %>% which()

pacfWind <- pacf(dfDailyPHX$windspeed_10m_max, lag.max=1000)
pacf(dfDailyPHX$windspeed_10m_max, lag.max=50)

```

Similar to temperature, wind speed appears to have a sustained seasonal component, though peak correlations are lower in magnitude (~0.20 for wind speed vs. ~0.75 for temperature)

A boxplot for delta daily temperature is created:  
```{r, fig.height=9, fig.width=9}

dfDailyPHX %>%
    mutate(month=factor(month.abb[month(date)], levels=month.abb), 
           chg=temperature_2m_max-lag(temperature_2m_max)
           ) %>%
    filter(!is.na(chg)) %>%
    ggplot(aes(x=month, y=chg)) + 
    geom_boxplot() + 
    labs(x=NULL, y="Daily change in maximum temperature")

```

Daily temperature changes are generally larger in magnitude during Spring

A boxplot for delta daily wind speed is created:  
```{r, fig.height=9, fig.width=9}

dfDailyPHX %>%
    mutate(month=factor(month.abb[month(date)], levels=month.abb), 
           chg=windspeed_10m_max-lag(windspeed_10m_max)
           ) %>%
    filter(!is.na(chg)) %>%
    ggplot(aes(x=month, y=chg)) + 
    geom_boxplot() + 
    labs(x=NULL, y="Daily change in maximum wind speed")

```

Daily wind speed changes are generally similar in magnitude by season

A boxplot for delta daily precipitation is created:  
```{r, fig.height=9, fig.width=9}

dfDailyPHX %>%
    mutate(month=factor(month.abb[month(date)], levels=month.abb), 
           chg=precipitation_sum-lag(precipitation_sum)
           ) %>%
    filter(!is.na(chg)) %>%
    ggplot(aes(x=month, y=chg)) + 
    geom_boxplot() + 
    labs(x=NULL, y="Daily change in precipitation")

```

Most days have no precipitation. The corresponding boxplot for precipitation change has small boxes and whiskers with many outliers

Averages for temperature, precipitation, and wind speed are calculated by day of year, using a 21-day rolling window:  
```{r, fig.height=9, fig.width=9}

df_r21 <- dfDailyPHX %>%
    mutate(doy=pmin(yday(date), 365)) %>% 
    helperRollingAgg(origVar="temperature_2m_max", newName="temp_r21", k=21) %>% 
    helperRollingAgg(origVar="windspeed_10m_max", newName="wind_r21", k=21) %>% 
    helperRollingAgg(origVar="precipitation_sum", newName="precip_r21", k=21) %>%
    select(date, doy, contains("_r21"))

df_r21 %>%
    na.omit() %>%
    group_by(doy) %>%
    summarize(across(where(is.numeric), .fns=mean), n=n()) %>%
    pivot_longer(cols=-c(doy)) %>%
    ggplot(aes(x=doy, y=value)) + 
    geom_line(aes(group=name, color=name)) + 
    facet_wrap(~name, scales="free_y") +
    labs(x="Day of Year", y="Rolling-21 mean") + 
    theme(legend.position="none")

```
  
* The number of observations is lowest on days 1-10 and 356-365 due to inability to get a rolling-21 for the first/last years; and it is highest on day 365 due to day 366 being mapped there  
* Precipitation has seasonal patterns, though it is spiky even on a rolling-21-day basis averaged over 60 years  
* Temperature, on average with a 21-day window over 60 years, has a smooth seasonal pattern  
* Wind speed is similar to temperature in showing a smooth pattern, though with differences in peaks and troughs timing  
  
Outliers are likely much more important in driving average precipitation than in driving average temperature  

Standard deviations for temperature, precipitation, and wind speed are calculated by day of year, using a 21-day rolling window:  
```{r, fig.height=9, fig.width=9}

df_r21_sd <- dfDailyPHX %>%
    mutate(doy=pmin(yday(date), 365)) %>% 
    group_by(doy) %>%
    mutate(across(.cols=c(temperature_2m_max, windspeed_10m_max, precipitation_sum), .fns=sd)) %>%
    ungroup() %>%
    helperRollingAgg(origVar="temperature_2m_max", newName="temp_r21", k=21) %>% 
    helperRollingAgg(origVar="windspeed_10m_max", newName="wind_r21", k=21) %>% 
    helperRollingAgg(origVar="precipitation_sum", newName="precip_r21", k=21) %>%
    select(date, doy, contains("_r21"))

df_r21_sd %>%
    na.omit() %>%
    group_by(doy) %>%
    summarize(across(where(is.numeric), .fns=mean)) %>%
    pivot_longer(cols=-c(doy)) %>%
    ggplot(aes(x=doy, y=value)) + 
    geom_line(aes(group=name, color=name)) + 
    facet_wrap(~name, scales="free_y") +
    labs(x="Day of Year", y="Rolling-21 mean of daily standard deviation") + 
    theme(legend.position="none")

```
  
* The daily standard deviation of precipitation is, on average, larger than the mean  
* The daily standard deviation of temperature is, on average, lower than the seasonal variation in temperature  
  
Means and standard deviations are plotted together:  
```{r, fig.height=9, fig.width=9}

df_r21 %>%
    bind_rows(df_r21_sd, .id="src") %>%
    na.omit() %>%
    mutate(musig=c("1"="Mean", "2"="SD")[src]) %>%
    group_by(doy, musig) %>%
    summarize(across(where(is.numeric), .fns=mean), .groups="drop") %>%
    pivot_longer(cols=-c(doy, musig)) %>%
    pivot_wider(id_cols=c(doy, name), names_from="musig") %>%
    ggplot(aes(x=doy)) + 
    geom_line(aes(y=Mean, group=name, color=name), lwd=2) + 
    geom_ribbon(aes(ymin=Mean-SD, ymax=Mean+SD, fill=name), alpha=0.5) +
    facet_wrap(~name, scales="free_y") +
    labs(x="Day of Year", 
         y="Rolling-21 mean +/- daily standard deviation", 
         title="Rolling 21-day mean +/- one rolling 21-day sd"
         ) + 
    theme(legend.position="none")

```

Means and approximate SEM are plotted together:  
```{r, fig.height=9, fig.width=9}

nYears <- length(unique(year(df_r21$date)))
nYears

df_r21 %>%
    bind_rows(df_r21_sd, .id="src") %>%
    na.omit() %>%
    mutate(musig=c("1"="Mean", "2"="SD")[src]) %>%
    group_by(doy, musig) %>%
    summarize(across(where(is.numeric), .fns=mean), .groups="drop") %>%
    pivot_longer(cols=-c(doy, musig)) %>%
    pivot_wider(id_cols=c(doy, name), names_from="musig") %>%
    ggplot(aes(x=doy)) + 
    geom_line(aes(y=Mean, group=name, color=name), lwd=2) + 
    geom_ribbon(aes(ymin=Mean-SD/sqrt(nYears-1), ymax=Mean+SD/sqrt(nYears-1), fill=name), alpha=0.5) +
    facet_wrap(~name, scales="free_y") +
    labs(x="Day of Year", 
         y="Rolling-21 mean +/- 1 SEM (approx)", 
         title="Rolling 21-day mean +/- 1 SEM (approx)"
         ) + 
    theme(legend.position="none")

```

Consistent with previous analyses, temperature has a strong seasonal pattern with differences in mean that vastly exceed the standard error of the mean. Wind is more similar to temperature in having seasonal variations that meaningfully exceed SEM in magnitude. Of interest, the seasonal spikiness in precipitation results in many times of the year that are outside of one standard error of the mean of each other. This is in contrast to cities explored previously where SEM is typically greater than change in means by time of year

The download process is converted to functional form:  
```{r}

helperNewCityDailyDownload <- function(cityName, 
                                       tz, 
                                       abb,
                                       fName=paste0("testOM_daily_", abb, ".json"),
                                       idx=1:nrow(tblMetricsDaily), 
                                       startDate="1960-01-01", 
                                       endDate="2023-12-31"
                                       ) {

    testURLDaily <- helperOpenMeteoURL(cityName=cityName, 
                                       dailyIndices=idx,
                                       startDate=startDate, 
                                       endDate=endDate, 
                                       tz=tz
                                       )
    cat("\nDownload URL:\n")
    print(testURLDaily)

    # Download file
    if(!file.exists(fName)) {
        fileDownload(fileName=fName, url=testURLDaily)
    } else {
        cat("\nFile", fName, "already exists, skipping download\n")
    }

}

```

The function is run for a new city:  
```{r cache=TRUE}

helperNewCityDailyDownload(cityName="Kansas City MO", tz = "US/Central", abb="mci")

```

Creation of an analysis file is converted to functional form:  
```{r}

createDailyDF <- function(fName=NULL, abb=NULL, glimpseFOMJ=FALSE, glimpseList=FALSE, glimpseDF=TRUE) {
    
    # Create fName from abb if fName not passed
    if(is.null(fName)) {
        if(is.null(abb)) stop("\nMust provide abb or fName to function createDailyDF()\n")
        else fName <- paste0("testOM_daily_", abb, ".json")
    }
    
    # Read daily JSON file
    lstDaily <- formatOpenMeteoJSON(fName, glimpseData=glimpseFOMJ)

    # Sample records of tibble inside list
    if(isTRUE(glimpseList)) lstDaily$tblDaily %>% glimpse()

    # Convert variables to proper type
    dfDaily <- lstDaily$tblDaily %>%
        mutate(weathercode=factor(weathercode), 
               sunrise_chr=sunrise, 
               sunset_chr=sunset,
               sunrise=lubridate::ymd_hm(sunrise), 
               sunset=lubridate::ymd_hm(sunset), 
               fct_winddir=factor(winddirection_10m_dominant)
               )
    
    # Sample records of final tibble
    if(isTRUE(glimpseDF)) glimpse(dfDaily)

    # Return final tibble
    dfDaily
    
}

```
  
The function is tested:  
```{r}

dfDaily <- createDailyDF(abb="mci")
dfDaily

```

A function is written to plot continuous variable averages by month:  
```{r}

plotContVarMean <- function(df, 
                            tmpMapNames=c("precipitation_sum"="3. Precipitation (mm)", 
                                          "windspeed_10m_max"="4. Windspeed (kph)", 
                                          "temperature_2m_max"="1. High Temperature (C)",
                                          "temperature_2m_min"="2. Low Temperature (C)"
                                          ), 
                            idxMapSum=c(1),
                            isMonthly=TRUE,
                            titleStarter=if(isTRUE(isMonthly)) "Monthly" else "Annual",
                            titleLoc="",
                            titleEnder=paste0("(", titleLoc, if(str_length(titleLoc)>0) " ", "1960-2023)"),
                            printPlot=TRUE, 
                            returnPlot=!isTRUE(printPlot)
                            ) {

    # FUNCTION ARGUMENTS:
    # df: tibble or data frame from createDailyDF()
    # tmpMapNames: variables to summarize in format c("variablename"="variable description")
    # idxMapSum: indices of the variables in tmpMapNames thatshould be summed rather than averaged
    # isMonthly: boolean with TRUE being monthly and FALSE being annual
    # titleStarter: opening phrase for title
    # titleLoc: location to be used in parentheses at end of title ("" means just show year range)
    # titleEnder: ending phrase for title
    # printPlot: boolean, should the plot be printed?
    # returnPlot: boolean, should the plot be returned?
    
    p1 <- df %>%
        mutate(month=factor(month(date), levels=1:12, labels=month.abb), year=year(date)) %>%
        select(all_of(c("year", if(isTRUE(isMonthly)) "month", names(tmpMapNames)))) %>%
        group_by(pick(if(isTRUE(isMonthly)) c("year", "month") else c("year"))) %>%
        summarize(across(-all_of(names(tmpMapNames)[idxMapSum]), .fns=mean), 
                  across(all_of(names(tmpMapNames)[idxMapSum]), .fns=sum), 
                  .groups="drop"
                  ) 
    
    if(isTRUE(isMonthly)) {
        p1 <- p1 %>%
            group_by(month) %>%
            summarize(across(-c(year), .fns=mean)) %>%
            pivot_longer(-c(month))
    } else {
        p1 <- p1 %>%
            pivot_longer(-c(year))
    }
    
    p1 <- p1 %>%
        ggplot(aes(x=.data[[if(isTRUE(isMonthly)) "month" else "year"]], y=value)) + 
        geom_line(aes(group=1)) + 
        facet_wrap(~tmpMapNames[name], scales="free_y") + 
        labs(x=NULL, 
             y=NULL, 
             title=paste0(titleStarter, " averages for key metrics ", titleEnder)
             )
    
    if(isTRUE(printPlot)) print(p1)
    if(isTRUE(returnPlot)) p1
    
}

```

The function is tested for select continuous variables:  
```{r, fig.height=9, fig.width=9}

plotContVarMean(dfDaily, isMonthly=TRUE, titleLoc="Kansas City, MO")
plotContVarMean(dfDaily, isMonthly=FALSE, titleLoc="Kansas City, MO")

```

A function is written to plot continuous variable averages by month:  
```{r, fig.height=9, fig.width=9}

plotCatVarMean <- function(df, 
                           tmpMapNames=c("wc"="1. Weather Type", 
                                         "winddir"="2. Predominant Wind Direction"
                                         ), 
                           idxMapSum=c(1),
                           isMonthly=TRUE,
                           titleStarter=if(isTRUE(isMonthly)) "Monthly" else "Annual",
                           titleLoc="",
                           titleEnder=paste0("(", titleLoc, if(str_length(titleLoc)>0) " ", "1960-2023)"),
                           printPlot=TRUE, 
                           returnPlot=!isTRUE(printPlot)
                           ) {

    tmpDFPlot <- df %>%
        mutate(month=factor(month(date), levels=1:12, labels=month.abb), 
               year=year(date), 
               winddir=case_when(winddirection_10m_dominant>360~"Invalid", 
                                 winddirection_10m_dominant>=315~"1. N", 
                                 winddirection_10m_dominant>=225~"2. W", 
                                 winddirection_10m_dominant>=135~"3. S", 
                                 winddirection_10m_dominant>=45~"4. E", 
                                 winddirection_10m_dominant>=0~"1. N", 
                                 TRUE~"Invalid"
                                 ), 
               wc=case_when(weathercode==0~"1. Clear", 
                            weathercode %in% c(1, 2, 3)~"2. Dry", 
                            weathercode %in% c(51, 53, 55)~"3. Drizzle", 
                            weathercode %in% c(61, 63, 65)~"4. Rain", 
                            weathercode %in% c(71, 73, 75)~"5. Snow", 
                            TRUE~"Error"
                            )
               ) %>%
        select(all_of(c(if(isTRUE(isMonthly)) "month" else "year", names(tmpMapNames))))

    if(isTRUE(isMonthly)) {
        tmpDFPlot <- tmpDFPlot %>%
            pivot_longer(-c(month)) %>%
            count(month, name, value)
    } else {
        tmpDFPlot <- tmpDFPlot %>%
            pivot_longer(-c(year)) %>%
            count(year, name, value)
    }
        
    tmpPlotFN <- function(x) {
        p1 <- tmpDFPlot %>%
            filter(name==x) %>%
            ggplot(aes(x=.data[[if(isTRUE(isMonthly)) "month" else "year"]], y=n)) + 
            geom_line(aes(group=value, color=value), lwd=2) + 
            labs(x=NULL, 
                 y=NULL, 
                 title=paste0(titleStarter, " average for ", tmpMapNames[x], " ", titleEnder)
                 ) + 
            scale_color_discrete(NULL) + 
            theme(legend.position = "bottom")
        return(p1)
    }

    # Update to be more flexible
    grid::grid.newpage()
    p1 <- gridExtra::arrangeGrob(tmpPlotFN("wc"), tmpPlotFN("winddir"), nrow=1)

    if(isTRUE(printPlot)) grid::grid.draw(p1)
    if(isTRUE(returnPlot)) p1
    
}

```

The function is tested for select categorical variables:  
```{r, fig.height=9, fig.width=9}

plotCatVarMean(dfDaily, isMonthly=TRUE, titleLoc="Kansas City, MO")
plotCatVarMean(dfDaily, isMonthly=FALSE, titleLoc="Kansas City, MO")

```

A function is written for creating weather boxplots:  
```{r}

omCreateBoxPlot <- function(df, 
                            keyVar, 
                            ymin=NA, 
                            ymax=NA, 
                            mapDesc=c("windspeed_10m_max"="Maximum wind speed (kph)", 
                                      "precipitation_hours"="Precipitation (hours)", 
                                      "precipitation_sum"="Precipitation (mm)", 
                                      "temperature_2m_max"="Maximum Temperature (C)", 
                                      "temperature_2m_min"="Minimum Temperature (C)"
                                      ),
                            keyVarDesc=if(keyVar %in% names(mapDesc)) mapDesc[keyVar] else "Key Variable",
                            titleLoc="",
                            titleEnder=paste0("(", titleLoc, if(str_length(titleLoc)>0) " ", "1960-2023)")
                            ) {

    p1 <- df %>%
        mutate(month=factor(month(date), levels=1:12, labels=month.abb), year=year(date)) %>%
        select(all_of(c("month", keyVar))) %>%
        ggplot(aes(x=month, y=.data[[keyVar]])) + 
        geom_boxplot(fill="lightblue") + 
        labs(x=NULL, 
             y=keyVarDesc, 
             title=paste0(keyVarDesc, " by month ", titleEnder)
             )
    if(!is.na(ymin) | !is.na(ymax)) p1 <- p1 + lims(y=c(ymin, ymax))
    print(p1)
    
}

```

The function is tested for select variables:  
```{r, fig.height=9, fig.width=9, cache=TRUE}

omCreateBoxPlot(dfDaily, keyVar="windspeed_10m_max", ymin=0, titleLoc="Kansas City, MO")
omCreateBoxPlot(dfDaily, keyVar="precipitation_hours", ymin=0, titleLoc="Kansas City, MO")
omCreateBoxPlot(dfDaily, keyVar="precipitation_sum", ymin=0, titleLoc="Kansas City, MO")
omCreateBoxPlot(dfDaily, keyVar="temperature_2m_max", titleLoc="Kansas City, MO")
omCreateBoxPlot(dfDaily, keyVar="temperature_2m_min", titleLoc="Kansas City, MO")

```

A function is created for running ACF/PACF:  
```{r}

omACFPACF <- function(df, keyVar, bigLag=1000, smallLag=50, smallACF=FALSE, smallPACF=TRUE) {

    # Big lag for ACF
    acfTemp <- acf(df %>% pull(keyVar), lag.max=bigLag, main=paste0("ACF: ", keyVar))

    # Peaks for ACF
    cat("\nACF peaks\n")
    as.vector(acfTemp$acf) %>% findPeaks(width=21) %>% which() %>% print()

    # Troughs for ACF
    cat("\nACF troughs\n")
    as.vector(acfTemp$acf) %>% findPeaks(width=21, FUN=min) %>% which() %>% print()

    # Small lag for ACF (if requested)
    if(isTRUE(smallACF)) acfTemp <- acf(df %>% pull(keyVar), lag.max=smallLag, main=paste0("ACF: ", keyVar))
    
    # Big lag for PACF
    pacfTemp <- pacf(df %>% pull(keyVar), lag.max=bigLag, main=paste0("PACF: ", keyVar))
    
    # Small lag for PACF (if requested)
    if(isTRUE(smallPACF)) pacfTemp <- pacf(df %>% pull(keyVar), lag.max=smallLag, main=paste0("PACF: ", keyVar))
    
}

```

The function is tested for select variables:  
```{r, fig.height=9, fig.width=9, cache=TRUE}

omACFPACF(dfDaily, keyVar="temperature_2m_max")
omACFPACF(dfDaily, keyVar="precipitation_sum", smallACF=TRUE)
omACFPACF(dfDaily, keyVar="windspeed_10m_max", smallACF=TRUE)

```

Function omCreateBoxPlot() is updated to allow for converting a variable to a change:  
```{r}

omCreateBoxPlot <- function(df, 
                            keyVar, 
                            chgLag=NULL,
                            ymin=NA, 
                            ymax=NA, 
                            mapDesc=c("windspeed_10m_max"="Maximum wind speed (kph)", 
                                      "precipitation_hours"="Precipitation (hours)", 
                                      "precipitation_sum"="Precipitation (mm)", 
                                      "temperature_2m_max"="Maximum Temperature (C)", 
                                      "temperature_2m_min"="Minimum Temperature (C)"
                                      ),
                            keyVarDesc=if(keyVar %in% names(mapDesc)) mapDesc[keyVar] else "Key Variable",
                            titleLoc="",
                            titleEnder=paste0("(", titleLoc, if(str_length(titleLoc)>0) " ", "1960-2023)")
                            ) {

    p1 <- df %>%
        mutate(month=factor(month(date), levels=1:12, labels=month.abb), year=year(date)) %>%
        select(all_of(c("month", keyVar)))
    
    if(!is.null(chgLag)) 
        p1 <- p1 %>%
            mutate(across(all_of(keyVar), .fns=function(x) x - lag(x, chgLag))) %>%
            filter(if_all(all_of(keyVar), .fns=function(x) !is.na(x)))
    
    p1 <- p1 %>%
        ggplot(aes(x=month, y=.data[[keyVar]])) + 
        geom_boxplot(fill="lightblue") + 
        labs(x=NULL, 
             y=keyVarDesc, 
             title=paste0(if(is.null(chgLag)) "" else "Change in ", keyVarDesc, " by month ", titleEnder)
             )
    if(!is.na(ymin) | !is.na(ymax)) p1 <- p1 + lims(y=c(ymin, ymax))
    print(p1)
    
}

```

The updated function is tested for select variables:  
```{r, fig.height=9, fig.width=9}

omCreateBoxPlot(dfDaily, keyVar="temperature_2m_max", chgLag=1, titleLoc="Kansas City, MO")
omCreateBoxPlot(dfDaily, keyVar="windspeed_10m_max", chgLag=1, titleLoc="Kansas City, MO")
omCreateBoxPlot(dfDaily, keyVar="precipitation_sum", chgLag=1, titleLoc="Kansas City, MO")

```

A function is written to calculate means and standard deviations:  
```{r, fig.height=9, fig.width=9}

omDailyMeanSD <- function(df, 
                          rollVars, 
                          rollK,                             
                          mapDesc=c("windspeed_10m_max"="windMax", 
                                    "precipitation_hours"="precipHours", 
                                    "precipitation_sum"="precipSum", 
                                    "temperature_2m_max"="tempMax", 
                                    "temperature_2m_min"="tempMin"
                                    ), 
                          addSuffix=TRUE, 
                          makeSEM=FALSE, 
                          printPlot=TRUE, 
                          returnPlot=!isTRUE(printPlot)
                          ) {
    
    if(isTRUE(addSuffix)) for(x in names(mapDesc)) mapDesc[x] <- paste0(mapDesc[x], "_r", rollK)
    
    # Calculate means
    df_r21 <- df %>% mutate(doy=pmin(yday(date), 365))
    
    for(x in rollVars) {
        df_r21 <- df_r21 %>% 
            helperRollingAgg(origVar=x, newName=unname(mapDesc[x]), k=rollK)
    }
    
    df_r21 <- df_r21 %>% select(all_of(c("date", "doy", unname(mapDesc[rollVars]))))

    # Calculate standard deviations
    df_r21_sd <- df %>%
        mutate(doy=pmin(yday(date), 365)) %>% 
        group_by(doy) %>%
        mutate(across(.cols=all_of(rollVars), .fns=sd)) %>%
        ungroup()
    
    for(x in rollVars) { 
        df_r21_sd <- df_r21_sd %>% 
            helperRollingAgg(origVar=x, newName=unname(mapDesc[x]), k=rollK)
    }
    
    df_r21_sd <- df_r21_sd %>% select(all_of(c("date", "doy", unname(mapDesc[rollVars]))))
    
    
    # Create plot of means and standard deviations or standard errors of the mean
    if(isTRUE(makeSEM)) divBy <- sqrt(length(unique(year(df_r21$date)))-1)
    else divBy <- 1
    
    p1 <- df_r21 %>%
        bind_rows(df_r21_sd, .id="src") %>%
        na.omit() %>%
        mutate(musig=c("1"="Mean", "2"="SD")[src]) %>%
        group_by(doy, musig) %>%
        summarize(across(where(is.numeric), .fns=mean), .groups="drop") %>%
        pivot_longer(cols=-c(doy, musig)) %>%
        pivot_wider(id_cols=c(doy, name), names_from="musig") %>%
        ggplot(aes(x=doy)) + 
        geom_line(aes(y=Mean, group=name, color=name), lwd=2) + 
        geom_ribbon(aes(ymin=Mean-SD/divBy, ymax=Mean+SD/divBy, fill=name), alpha=0.5) +
        facet_wrap(~name, scales="free_y") +
        labs(x="Day of Year", 
             y=paste0("Rolling ", 
                      rollK, 
                      "-day mean +/- 1 ", 
                      if(isTRUE(makeSEM)) "SEM (approx)" else "sd"
                      ), 
             title=paste0("Rolling ", 
                          rollK, 
                          "-day mean +/- 1 rolling ", 
                          rollK, 
                          "-day ", 
                          if(isTRUE(makeSEM)) "SEM (approx)" else "sd"
                          )
             ) + 
        theme(legend.position="none")
    
    if(isTRUE(printPlot)) print(p1)
    if(isTRUE(returnPlot)) return(p1)

}

```
  
The new function is tested for select variables:  
```{r, fig.height=9, fig.width=9}

# Standard deviation only
omDailyMeanSD(dfDaily, 
              rollK=21, 
              rollVars=c("temperature_2m_max", "windspeed_10m_max", "precipitation_sum")
              )

# SEM (approx)
omDailyMeanSD(dfDaily, 
              rollK=21, 
              rollVars=c("temperature_2m_max", "windspeed_10m_max", "precipitation_sum"), 
              makeSEM=TRUE
              )

```

The functions are run in combination for a new city:  
```{r, fig.height=9, fig.width=9, cache=TRUE}

# 0. Declare abbreviation and city name to be downloaded
abbCity <- "bna"
tzCity <- "US/Central"
dbNameCity <- "Nashville TN"
useNameCity <- dbNameCity

# 1. Download data
helperNewCityDailyDownload(cityName=dbNameCity, tz = tzCity, abb=abbCity)

# 2. Load and process data
dfDaily <- createDailyDF(abb=abbCity)
dfDaily

# 3. Plot means for continuous variables
plotContVarMean(dfDaily, isMonthly=TRUE, titleLoc=useNameCity)
plotContVarMean(dfDaily, isMonthly=FALSE, titleLoc=useNameCity)

# 4. Plot means for categorical variables
plotCatVarMean(dfDaily, isMonthly=TRUE, titleLoc=useNameCity)
plotCatVarMean(dfDaily, isMonthly=FALSE, titleLoc=useNameCity)

# 5. Create boxplots for select variables
omCreateBoxPlot(dfDaily, keyVar="windspeed_10m_max", ymin=0, titleLoc=useNameCity)
omCreateBoxPlot(dfDaily, keyVar="precipitation_hours", ymin=0, titleLoc=useNameCity)
omCreateBoxPlot(dfDaily, keyVar="precipitation_sum", ymin=0, titleLoc=useNameCity)
omCreateBoxPlot(dfDaily, keyVar="temperature_2m_max", titleLoc=useNameCity)
omCreateBoxPlot(dfDaily, keyVar="temperature_2m_min", titleLoc=useNameCity)

# 6. Analyze ACF/PACF for select variables
omACFPACF(dfDaily, keyVar="temperature_2m_max")
omACFPACF(dfDaily, keyVar="precipitation_sum", smallACF=TRUE)
omACFPACF(dfDaily, keyVar="windspeed_10m_max", smallACF=TRUE)

# 7. Create boxplots for select variables (with lag-1, daily difference)
omCreateBoxPlot(dfDaily, keyVar="temperature_2m_max", chgLag=1, titleLoc=useNameCity)
omCreateBoxPlot(dfDaily, keyVar="windspeed_10m_max", chgLag=1, titleLoc=useNameCity)
omCreateBoxPlot(dfDaily, keyVar="precipitation_sum", chgLag=1, titleLoc=useNameCity)

# 8. Create daily mean +/- 1 SD and/or SEM for select variables
omDailyMeanSD(dfDaily, rollK=21, rollVars=c("temperature_2m_max", "windspeed_10m_max", "precipitation_sum"))
omDailyMeanSD(dfDaily, rollK=21, rollVars=c("temperature_2m_max", 
                                            "windspeed_10m_max", 
                                            "precipitation_sum"
                                            ), 
              makeSEM=TRUE
              )

```

A function is written to run all steps for a new city:  
```{r}

omRunAllSteps <- function(dfDaily=NULL, 
                          dlData=FALSE, 
                          abbCity=NULL, 
                          tzCity=NULL, 
                          useNameCity="New city", 
                          dbNameCity=useNameCity, 
                          returnDF=FALSE,
                          runStats=TRUE, 
                          mainStatVars=c("temperature_2m_max", "windspeed_10m_max", "precipitation_sum"), 
                          xtraStatVars=c("temperature_2m_min", "precipitation_hours"),
                          minZeroVars=c("windspeed_10m_max", "precipitation_sum", "precipitation_hours")
                          ) {
    
    # 1. Download data (if requested)
    if(isTRUE(dlData)) helperNewCityDailyDownload(cityName=dbNameCity, tz=tzCity, abb=abbCity)
    
    # 2. Load and process data (if not passed)
    if(is.null(dfDaily)) dfDaily <- createDailyDF(abb=abbCity)
    
    # Stop processing if requested
    if(!isTRUE(runStats)) {
        if(isTRUE(returnDF)) {
            return(dfDaily)
        } else {
            return(NULL)
        }
    }
    
    # 3. Plot means for continuous variables
    plotContVarMean(dfDaily, isMonthly=TRUE, titleLoc=useNameCity)
    plotContVarMean(dfDaily, isMonthly=FALSE, titleLoc=useNameCity)

    # 4. Plot means for categorical variables
    plotCatVarMean(dfDaily, isMonthly=TRUE, titleLoc=useNameCity)
    plotCatVarMean(dfDaily, isMonthly=FALSE, titleLoc=useNameCity)

    # 5. Create boxplots for select variables
    purrr::walk(.x=c(mainStatVars, xtraStatVars), 
                .f=function(x) omCreateBoxPlot(dfDaily, 
                                               keyVar=x, 
                                               ymin=if(x %in% minZeroVars) 0 else NA, 
                                               titleLoc=useNameCity
                                               )
                )
    
    # 6. Analyze ACF/PACF for select variables
    purrr::walk(.x=mainStatVars, 
                .f=function(x) omACFPACF(dfDaily, keyVar=x, smallACF=TRUE)
                )

    # 7. Create boxplots for select variables (with lag-1, daily difference)
    purrr::walk(.x=mainStatVars, 
                .f=function(x) omCreateBoxPlot(dfDaily, keyVar=x, chgLag=1, titleLoc=useNameCity)
                )
        
    # 8. Create daily mean +/- 1 SD and/or SEM for select variables
    omDailyMeanSD(dfDaily, rollK=21, rollVars=mainStatVars)
    omDailyMeanSD(dfDaily, rollK=21, rollVars=mainStatVars, makeSEM=TRUE)
    
    # Return file if requested
    if(isTRUE(returnDF)) return(dfDaily)
    
}

```

The function is tested solely for loading a dataset:  
```{r}

dfDailyMCI <- omRunAllSteps(abbCity="mci", returnDF=TRUE, runStats=FALSE)

```

The function is tested solely for plots on an existing dataset:  
```{r, fig.height=9, fig.width=9}

omRunAllSteps(dfDaily=dfDailyMCI, useNameCity="Kansas City MO")

```

The function is tested solely for downloading new data:  
```{r, fig.height=9, fig.width=9, cache=TRUE}

omRunAllSteps(dlData=TRUE, 
              abbCity="msp", 
              tzCity="US/Central", 
              useNameCity="Minneapolis MN", 
              runStats=FALSE
              )

```

The function is tested for creating a dataset from multiple previously processed cities:  
```{r}

omCityMap <- c("atl"="Atlanta GA", 
               "ord"="Chicago IL", 
               "dtw"="Detroit MI", 
               "msy"="New Orleans LA", 
               "den"="Denver CO"
               )

dfMultiCity <- map_dfr(.x=names(omCityMap), 
                       .f=function(x) omRunAllSteps(dlData=FALSE,runStats=FALSE, abbCity=x, returnDF=TRUE), 
                       .id="src"
                       ) %>%
    mutate(cityName=unname(omCityMap)[as.integer(src)])

dfMultiCity %>% count(cityName)

```

Mean and SEM are plotted for temperature for each city, as well as the total:  
```{r, fig.height=9, fig.width=9}

nYears <- length(unique(year(dfMultiCity$date)))
divBy <- sqrt(nYears-1)

dfMultiCity %>%
    select(date, temperature_2m_max, cityName) %>%
    bind_rows(mutate(., cityName="Overall")) %>%
    group_by(cityName, date) %>%
    summarize(across(where(is.numeric), .fns=mean), .groups="drop") %>%
    arrange(cityName, date) %>%
    mutate(doy=pmin(yday(date), 365)) %>%
    group_by(cityName) %>%
    helperRollingAgg(origVar="temperature_2m_max", newName="mu_r21", k=21) %>%
    group_by(cityName, doy) %>%
    mutate(sd=sd(temperature_2m_max)) %>%
    group_by(cityName) %>%
    helperRollingAgg(origVar="sd", newName="sd_r21", k=21) %>%
    ungroup() %>%
    select(cityName, doy, mu_r21, sd_r21) %>%
    pivot_longer(cols=-c(cityName, doy)) %>%
    na.omit() %>%
    group_by(cityName, doy, name) %>%
    summarize(across(where(is.numeric), .fns=mean), .groups="drop") %>%
    pivot_wider(id_cols=c(cityName, doy), names_from="name") %>%
    ggplot(aes(x=doy)) + 
    geom_line(data=~filter(., cityName!="Overall"), 
              aes(y=mu_r21, group=cityName, color=cityName), 
              lwd=2
              ) + 
    geom_ribbon(data=~filter(., cityName!="Overall"), 
                aes(ymin=mu_r21-sd_r21/divBy, ymax=mu_r21+sd_r21/divBy, fill=cityName), 
                alpha=0.5
                ) +
    labs(x="Day of Year", 
         y=paste0("Rolling ", 21, "-day mean +/- 1 ", if(isTRUE(TRUE)) "SEM (approx)" else "sd"), 
         title=paste0("Rolling ", 
                      21, 
                      "-day mean +/- 1 rolling ", 
                      21, 
                      "-day ", 
                      if(isTRUE(TRUE)) "SEM (approx)" else "sd", "\nTemperature Max (C)")
         ) + 
    scale_color_discrete(NULL) + 
    scale_fill_discrete(NULL) + 
    geom_line(data=~filter(., cityName=="Overall"), aes(y=mu_r21, group=cityName), lwd=1, lty=2)

```

Mean and SEM are plotted for precipitation for each city, as well as the total:  
```{r, fig.height=9, fig.width=9}

nYears <- length(unique(year(dfMultiCity$date)))
divBy <- sqrt(nYears-1)

dfMultiCity %>%
    select(date, precipitation_sum, cityName) %>%
    bind_rows(mutate(., cityName="Overall")) %>%
    group_by(cityName, date) %>%
    summarize(across(where(is.numeric), .fns=mean), .groups="drop") %>%
    arrange(cityName, date) %>%
    mutate(doy=pmin(yday(date), 365)) %>%
    group_by(cityName) %>%
    helperRollingAgg(origVar="precipitation_sum", newName="mu_r21", k=21) %>%
    group_by(cityName, doy) %>%
    mutate(sd=sd(precipitation_sum)) %>%
    group_by(cityName) %>%
    helperRollingAgg(origVar="sd", newName="sd_r21", k=21) %>%
    ungroup() %>%
    select(cityName, doy, mu_r21, sd_r21) %>%
    pivot_longer(cols=-c(cityName, doy)) %>%
    na.omit() %>%
    group_by(cityName, doy, name) %>%
    summarize(across(where(is.numeric), .fns=mean), .groups="drop") %>%
    pivot_wider(id_cols=c(cityName, doy), names_from="name") %>%
    ggplot(aes(x=doy)) + 
    geom_line(data=~filter(., cityName!="Overall"), 
              aes(y=mu_r21, group=cityName, color=cityName), 
              lwd=2
              ) + 
    geom_ribbon(data=~filter(., cityName!="Overall"), 
                aes(ymin=mu_r21-sd_r21/divBy, ymax=mu_r21+sd_r21/divBy, fill=cityName), 
                alpha=0.5
                ) +
    labs(x="Day of Year", 
         y=paste0("Rolling ", 21, "-day mean +/- 1 ", if(isTRUE(TRUE)) "SEM (approx)" else "sd"), 
         title=paste0("Rolling ", 
                      21, 
                      "-day mean +/- 1 rolling ", 
                      21, 
                      "-day ", 
                      if(isTRUE(TRUE)) "SEM (approx)" else "sd", "\nPrecipitation (mm)")
         ) + 
    scale_color_discrete(NULL) + 
    scale_fill_discrete(NULL) + 
    geom_line(data=~filter(., cityName=="Overall"), aes(y=mu_r21, group=cityName), lwd=1, lty=2)

```

Mean and SEM are plotted for wind speed for each city, as well as the total:  
```{r, fig.height=9, fig.width=9}

nYears <- length(unique(year(dfMultiCity$date)))
divBy <- sqrt(nYears-1)

dfMultiCity %>%
    select(date, windspeed_10m_max, cityName) %>%
    bind_rows(mutate(., cityName="Overall")) %>%
    group_by(cityName, date) %>%
    summarize(across(where(is.numeric), .fns=mean), .groups="drop") %>%
    arrange(cityName, date) %>%
    mutate(doy=pmin(yday(date), 365)) %>%
    group_by(cityName) %>%
    helperRollingAgg(origVar="windspeed_10m_max", newName="mu_r21", k=21) %>%
    group_by(cityName, doy) %>%
    mutate(sd=sd(windspeed_10m_max)) %>%
    group_by(cityName) %>%
    helperRollingAgg(origVar="sd", newName="sd_r21", k=21) %>%
    ungroup() %>%
    select(cityName, doy, mu_r21, sd_r21) %>%
    pivot_longer(cols=-c(cityName, doy)) %>%
    na.omit() %>%
    group_by(cityName, doy, name) %>%
    summarize(across(where(is.numeric), .fns=mean), .groups="drop") %>%
    pivot_wider(id_cols=c(cityName, doy), names_from="name") %>%
    ggplot(aes(x=doy)) + 
    geom_line(data=~filter(., cityName!="Overall"), 
              aes(y=mu_r21, group=cityName, color=cityName), 
              lwd=2
              ) + 
    geom_ribbon(data=~filter(., cityName!="Overall"), 
                aes(ymin=mu_r21-sd_r21/divBy, ymax=mu_r21+sd_r21/divBy, fill=cityName), 
                alpha=0.5
                ) +
    labs(x="Day of Year", 
         y=paste0("Rolling ", 21, "-day mean +/- 1 ", if(isTRUE(TRUE)) "SEM (approx)" else "sd"), 
         title=paste0("Rolling ", 
                      21, 
                      "-day mean +/- 1 rolling ", 
                      21, 
                      "-day ", 
                      if(isTRUE(TRUE)) "SEM (approx)" else "sd", "\nMax Wind Speed (kph)")
         ) + 
    scale_color_discrete(NULL) + 
    scale_fill_discrete(NULL) + 
    geom_line(data=~filter(., cityName=="Overall"), aes(y=mu_r21, group=cityName), lwd=1, lty=2)

```

A function is written to create plots of continuous variables across cities:  
```{r}

omMultiCityCont <- function(df, varName, varDesc, divBy) {

    p1 <- df %>%
        select(all_of(c("date", varName, "cityName"))) %>%
        bind_rows(mutate(., cityName="Overall")) %>%
        group_by(cityName, date) %>%
        summarize(across(where(is.numeric), .fns=mean), .groups="drop") %>%
        arrange(cityName, date) %>%
        mutate(doy=pmin(yday(date), 365)) %>%
        group_by(cityName) %>%
        helperRollingAgg(origVar=varName, newName="mu_r21", k=21) %>%
        group_by(cityName, doy) %>%
        mutate(sd=sd(get(varName))) %>%
        group_by(cityName) %>%
        helperRollingAgg(origVar="sd", newName="sd_r21", k=21) %>%
        ungroup() %>%
        select(cityName, doy, mu_r21, sd_r21) %>%
        pivot_longer(cols=-c(cityName, doy)) %>%
        na.omit() %>%
        group_by(cityName, doy, name) %>%
        summarize(across(where(is.numeric), .fns=mean), .groups="drop") %>%
        pivot_wider(id_cols=c(cityName, doy), names_from="name") %>%
        ggplot(aes(x=doy)) + 
        geom_line(data=~filter(., cityName!="Overall"), 
                  aes(y=mu_r21, group=cityName, color=cityName), 
                  lwd=2
                  ) + 
        geom_ribbon(data=~filter(., cityName!="Overall"), 
                    aes(ymin=mu_r21-sd_r21/divBy, ymax=mu_r21+sd_r21/divBy, fill=cityName), 
                    alpha=0.5
                    ) +
        labs(x="Day of Year", 
             y=paste0("Rolling ", 21, "-day mean +/- 1 ", if(isTRUE(TRUE)) "SEM (approx)" else "sd"), 
             title=paste0("Rolling ", 
                          21, 
                          "-day mean +/- 1 rolling ", 
                          21, 
                          "-day ", 
                          if(isTRUE(TRUE)) "SEM (approx)" else "sd", "\n", varDesc)
             ) + 
        scale_color_discrete(NULL) + 
        scale_fill_discrete(NULL) + 
        geom_line(data=~filter(., cityName=="Overall"), aes(y=mu_r21, group=cityName), lwd=1, lty=2)
    
    p1
    
}

```

The function is tested on a new variable:  
```{r, fig.height=9, fig.width=9}

omMultiCityCont(dfMultiCity, 
                varName="shortwave_radiation_sum", 
                varDesc="Daily solar radiation (MJ)", 
                divBy=sqrt(length(unique(year(dfMultiCity$date)))-1)
                )

```

The function is tested on evapotranspiration:  
```{r, fig.height=9, fig.width=9}

omMultiCityCont(dfMultiCity, 
                varName="et0_fao_evapotranspiration", 
                varDesc="Daily sum of ET0 Reference Evapotranspiration", 
                divBy=sqrt(length(unique(year(dfMultiCity$date)))-1)
                )

```

The function is tested on snowfall:  
```{r, fig.height=9, fig.width=9}

omMultiCityCont(dfMultiCity, 
                varName="snowfall_sum", 
                varDesc="Daily average snowfall (cm)", 
                divBy=sqrt(length(unique(year(dfMultiCity$date)))-1)
                )

```

The function is tested on apparent temperature:  
```{r, fig.height=9, fig.width=9}

omMultiCityCont(dfMultiCity, 
                varName="apparent_temperature_max", 
                varDesc="Maximum Apparent Temperature (C)", 
                divBy=sqrt(length(unique(year(dfMultiCity$date)))-1)
                )

```

