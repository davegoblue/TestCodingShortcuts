---
title: "CDC Daily by State"
author: "davegoblue"
date: "2/20/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Background
This file is designed to use CDC data to assess coronavirus disease burden by state, including creating and analyzing state-level clusters.

Through March 7, 2021, [The COVID Tracking Project](https://covidtracking.com/) collected and integrated data on tests, cases, hospitalizations, deaths, and the like by state and date.  The latest code for using this data is available in Coronavirus_Statistics_CTP_v004.Rmd.

The COVID Tracking Project suggest that [US federal data sources](https://covidtracking.com/analysis-updates/federal-covid-data-101-how-to-find-data) are now sufficiently robust to be used for analyses that previously relied on COVID Tracking Project.  This code is an attempt to update modules in Coronavirus_Statistics_CTP_v004.Rmd to leverage US federal data.

The code in this module builds on code available in _v003, with function and mapping files updated:  
  
* Generic_Added_Utility_Functions_202105_v001.R - generic functions that can be used in other areas  
* Coronavirus_CDC_Daily_Functions_v001.R - functions specific to coronavirus daily data  
  
Broadly, the CDC data analyzed by this module includes:  
  
* CDC case and death data by state and date are available for download on the [CDC website](https://data.cdc.gov/api/views/9mfq-cb36/rows.csv?accessType=DOWNLOAD)  
* CDC hospital data are available for download on the [healthdata.gov website](https://beta.healthdata.gov/api/views/g62h-syeh/rows.csv?accessType=DOWNLOAD)  
* CDC vaccines data are also available for download on the [CDC website](https://data.cdc.gov/api/views/unsk-b7fc/rows.csv?accessType=DOWNLOAD):  
  
## Functions and Mapping Files
The tidyverse package is loaded and functions are sourced:  
```{r}

# The tidyverse functions are routinely used without package::function format
library(tidyverse)
library(geofacet)

# Functions are available in source file
source("./Generic_Added_Utility_Functions_202105_v001.R")
source("./Coronavirus_CDC_Daily_Functions_v001.R")

```

A series of mapping files are also available to allow for parameterized processing.  Mappings include:  
  
* urlMapper - mapping file for urlType and url location to download data  
* renMapper - mapping file for renaming of variables in the raw data file  
* selfListMapper - mapping file for transformations by variable type  
* fullListMapper - mapping file for transformations across variable types  
* lstComboMapper - mapping file for elements to be combined by data type (most common is to combine NYC and NYS data to NY if the file provides them separately)  
* uqMapper - mapping file for fields that should combine to be unique keys for processed files  
* lstFilterMapper - mapping file for filtering to subset (most common is to keep 50 states and DC)  
* vecSelectMapper - mapping file for variables to keep  
* checkControlGroupMapper - mapping file for group_by() of control total checks  
* checkControlAggMapper - mapping file for numeric variables for control total checks  
* checkSimilarityMapper - mapping file for similarity checks to perform  
* plotSimilarityMaooer - mapping file for fields where differences in universe should be plotted
* keyAggMapper - mapping file for the aggregate-level control total checks to perform  
* perCapMapper - named vector that drives conversion from original field name to per capita field name  
* hhsMapper - named vector that drivers numerical variables to keep (and renaming) from HHS capacity data file
  
These default parameters are maintained in a separate .R file and can be sourced:  
```{r}

source("./Coronavirus_CDC_Daily_Default_Mappings_v002.R")

```

## Example Code Processing
The function is run to download and process the latest CDC case, hospitalization, and death data:  
```{r, fig.height=9, fig.width=9, cache=TRUE}

readList <- list("cdcDaily"="./RInputFiles/Coronavirus/CDC_dc_downloaded_220220.csv", 
                 "cdcHosp"="./RInputFiles/Coronavirus/CDC_h_downloaded_220220.csv", 
                 "vax"="./RInputFiles/Coronavirus/vaxData_downloaded_220220.csv"
                 )
compareList <- list("cdcDaily"=readFromRDS("cdc_daily_220206")$dfRaw$cdcDaily, 
                    "cdcHosp"=readFromRDS("cdc_daily_220206")$dfRaw$cdcHosp, 
                    "vax"=readFromRDS("cdc_daily_220206")$dfRaw$vax
                    )

cdc_daily_220220 <- readRunCDCDaily(thruLabel="Feb 18, 2022", 
                                    downloadTo=lapply(readList, FUN=function(x) if(file.exists(x)) NA else x), 
                                    readFrom=readList,
                                    compareFile=compareList, 
                                    writeLog=NULL, 
                                    useClusters=readFromRDS("cdc_daily_210528")$useClusters, 
                                    weightedMeanAggs=c("tcpm7", "tdpm7", "cpm7", "dpm7", "hpm7", 
                                                       "vxcpm7", "vxcgte65pct"
                                                       ),
                                    skipAssessmentPlots=FALSE, 
                                    brewPalette="Paired"
                                    )

saveToRDS(cdc_daily_220220, ovrWriteError=FALSE)

```
  
The latest hospital data are downloaded:  
```{r, fig.height=9, fig.width=9, cache=TRUE}

# Run for latest data, save as RDS
indivHosp_20220221 <- downloadReadHospitalData(loc="./RInputFiles/Coronavirus/HHS_Hospital_20220221.csv")
saveToRDS(indivHosp_20220221, ovrWriteError=FALSE)

```
  
The post-processing capabilities are included:  
```{r, fig.height=9, fig.width=9}

# Create pivoted burden data
burdenPivotList_220220 <- postProcessCDCDaily(cdc_daily_220220, 
                                              dataThruLabel="Jan 2022", 
                                              keyDatesBurden=c("2022-01-31", "2021-07-31", 
                                                               "2021-01-31", "2020-07-31"
                                                               ),
                                              keyDatesVaccine=c("2021-12-31", "2021-09-30", 
                                                                "2021-06-30", "2021-03-31"
                                                                ), 
                                              returnData=TRUE
                                              )

```

The hospital summaries are also added:  
```{r, fig.height=9, fig.width=9}

# Can be run only as-needed
dfStateAgeBucket2019 <- readPopStateAge("./RInputFiles/sc-est2019-agesex-civ.csv") %>%
    filterPopStateAge(keyCol="POPEST2019_CIV", keyColName="pop2019") %>%
    bucketPopStateAge(popVar="pop2019")

# Create hospitalized per capita data
hospPerCap_220220 <- hospAgePerCapita(dfStateAgeBucket2019, 
                                      lst=burdenPivotList_220220, 
                                      popVar="pop2019", 
                                      excludeState=c(), 
                                      cumStartDate="2020-07-15"
                                      )

```

The one-page CFR plot capability is included:  
```{r, fig.height=9, fig.width=9}

# Create CFR plots for select states
cfrStates <- list("FL"=list(keyState="FL", minDate="2020-08-01", multDeath=70), 
                  "LA"=list(keyState="LA", minDate="2020-08-01", multDeath=80), 
                  "CA"=list(keyState="CA", minDate="2020-08-01", multDeath=100), 
                  "IL"=list(keyState="IL", minDate="2020-08-01", multDeath=100)
                  )
purrr::walk(cfrStates, .f=function(x) onePageCFRPlot(burdenPivotList_220220$dfPivot, 
                                                     keyState=x$keyState, 
                                                     minDate=x$minDate, 
                                                     multDeath=x$multDeath
                                                     )
            )

```

The peaks and valleys plots are included:  
```{r, fig.height=9, fig.width=9}

# Burden data
cdc_daily_220220$dfPerCapita %>%
    mutate(regn=c(as.character(state.region), "South")[match(state, c(state.abb, "DC"))]) %>%
    makePeakValley(numVar=c("new_deaths", "new_cases", "inp"), 
                   windowWidth = 71, 
                   rollMean=7, 
                   facetVar=c("regn"), 
                   fnNumVar=list("new_deaths"=function(x) x, 
                                 "new_cases"=function(x) x/1000,
                                 "inp"=function(x) x/1000
                                 ), 
                   fnPeak=list("new_deaths"=function(x) x+100, 
                               "new_cases"=function(x) x+10, 
                               "inp"=function(x) x+10
                               ),
                   fnValley=list("new_deaths"=function(x) x-100, 
                                 "new_cases"=function(x) x-5, 
                                 "inp"=function(x) x-5
                                 ),
                   useTitle=c("new_deaths"="US coronavirus deaths", 
                              "new_cases"="US coronavirus cases", 
                              "inp"="US coronavirus total hospitalized"
                              ), 
                   yLab=c("new_deaths"="Rolling 7-day mean deaths", 
                          "new_cases"="Rolling 7-day mean cases (000)", 
                          "inp"="Rolling 7-day mean in hospital (000)"
                          )
                   )


# Vaccinations data for states with 8+ million population
cdc_daily_220220$dfPerCapita %>%
    inner_join(getStateData(), by=c("state")) %>%
    filter(pop >= 8000000) %>%
    select(date, state, vxa, vxc) %>%
    arrange(date, state) %>%
    group_by(state) %>%
    mutate(across(c(vxa, vxc), .fns=function(x) x-lag(x))) %>%
    ungroup() %>%
    mutate(regn=c(as.character(state.region), "South")[match(state, c(state.abb, "DC"))]) %>%
    filter(date >= "2020-12-01") %>%
    makePeakValley(numVar=c("vxc", "vxa"), 
                   windowWidth = 29, 
                   rollMean=21, 
                   facetVar=c("state"), 
                   fnNumVar=list("vxa"=function(x) x/1000, 
                                 "vxc"=function(x) x/1000
                                 ), 
                   fnPeak=list("vxa"=function(x) x+25*max(x, na.rm=TRUE)/400, 
                               "vxc"=function(x) x+25*max(x, na.rm=TRUE)/400
                               ),
                   fnValley=list("vxa"=function(x) x-25*max(x, na.rm=TRUE)/400, 
                                 "vxc"=function(x) x-25*max(x, na.rm=TRUE)/400
                                 ),
                   fnGroupFacet=TRUE,
                   useTitle=c("vxa"="Vaccines adminsitered (US)", 
                              "vxc"="Became fully vaccinated (US)"
                              ), 
                   yLab=c("vxa"="Rolling 21-day mean administered (000)",
                          "vxc"="Rolling 21-day mean completed (000)"
                          )
                   )

```

The hospital utlization plots are included:  
```{r, fig.height=9, fig.width=9}

indivHosp_20220221 %>% 
    filter(state %in% c(state.abb, "DC"), 
           collection_week==max(collection_week)
    ) %>% 
    pull(hospital_pk) %>%
    plotHospitalUtilization(df=indivHosp_20220221, keyHosp=., plotTitle="US Hospitals Summed")

```

Imputed hospital utilization data are also created, using functional form:  
```{r, fig.height=9, fig.width=9}

# Impute values for hospital capacity
imputeNACapacity <- function(df, 
                             keyStates=c(state.abb, "DC"), 
                             varMapper=hhsMapper, 
                             varsToImpute=c("total_beds", "adult_beds"), 
                             varUsedToImpute=c("inpatient_beds")
                             ) {
    
    # FUNCTION ARGUMENTS:
    # df: the initial data frame
    # keyState: states to include for filtering
    # varMapper: variables to include and output names (named vector of form c("original name"="modified name"))
    # varsToImpute: variables to be imputed
    # varUsedToImpute: percent changes in this variable assumed to drive percent changes in varsToImpute if NA
    
    df %>%
        filter(state %in% all_of(keyStates)) %>%
        colSelector(c("state", "collection_week", "hospital_pk", names(varMapper))) %>%
        colRenamer(varMapper) %>%
        mutate(across(where(is.numeric), .fns=function(x) ifelse(is.na(x), NA, ifelse(x==-999999, NA, x)))) %>%
        arrange(hospital_pk, collection_week) %>%
        group_by(hospital_pk) %>%
        mutate(across(all_of(varsToImpute), 
                      .fns=function(x) testImputeNA(x=x, y=get(varUsedToImpute), naValues=-999999)
                      )
               ) %>%
        group_by(state, collection_week) %>%
        summarize(across(where(is.numeric), .fns=sum, na.rm=TRUE), n=n(),.groups="drop")
}

modStateHosp_20220221 <- imputeNACapacity(indivHosp_20220221)

```

The function is split so that it is more generic:  
```{r, fig.height=9, fig.width=9}

# Select and filter as needed
skinnyHHS <- function(df, 
                      keyStates=c(state.abb, "DC"), 
                      idCols=c("state", "collection_week", "hospital_pk"),
                      varMapper=hhsMapper
                      ) {

    # FUNCTION ARGUMENTS:
    # df: the initial data frame
    # keyState: states to include for filtering
    # varMapper: variables to include and output names (named vector of form c("original name"="modified name"))
    
    df %>%
        filter(state %in% all_of(keyStates)) %>%
        colSelector(c(all_of(idCols), names(varMapper))) %>%
        colRenamer(varMapper)
        
}

# Impute values for hospital capacity
imputeNACapacity <- function(df, 
                             extraNA=c(-999999),
                             convertAllNA=TRUE,
                             idVars=c("hospital_pk"), 
                             sortVars=c("collection_week"),
                             varsToImpute=c("total_beds", "adult_beds"), 
                             varUsedToImpute=c("inpatient_beds")
                             ) {
    
    # FUNCTION ARGUMENTS:
    # df: the initial data frame
    # extraNA: values that should be treated as NA
    # convertAllNA: boolean, should all extraNA values be converted in all numeric columns?
    #               if FALSE, extraNA values will not be converted, though imputing will treat as NA
    # varsToImpute: variables to be imputed
    # varUsedToImpute: percent changes in this variable assumed to drive percent changes in varsToImpute if NA
    
    # Convert NA if requested
    if(isTRUE(convertAllNA)) {
        df <- df %>%
            mutate(across(where(is.numeric), 
                          .fns=function(x) ifelse(is.na(x), NA, ifelse(x %in% all_of(extraNA), NA, x))
                          )
                   )
    }
    
    # Impute values and return data
    df %>%
        arrange(across(all_of(c(idVars, sortVars)))) %>%
        group_by(across(all_of(idVars))) %>%
        mutate(across(all_of(varsToImpute), 
                      .fns=function(x) testImputeNA(x=x, y=get(varUsedToImpute), naValues=extraNA)
                      )
               ) %>%
        ungroup()
    
}

sumImputedHHS <- function(df, 
                          groupVars=c("state", "collection_week")) {
    
    # FUNCTION ARGUMENTS:
    # df: the initial data frame
    # groupVars: variables for summing the data to

    df %>%
        group_by(across(all_of(groupVars))) %>%
        summarize(across(where(is.numeric), .fns=sum, na.rm=TRUE), n=n(),.groups="drop")
    
}

identical(skinnyHHS(indivHosp_20220221) %>%
              imputeNACapacity() %>%
              sumImputedHHS(), 
          modStateHosp_20220221
          )

```

Updated maps with imputed capacity are created:  
```{r, fig.height=9, fig.width=9}

modStateHosp_20220221 <- skinnyHHS(indivHosp_20220221) %>%
    imputeNACapacity() %>%
    sumImputedHHS()

# ICU summary
createGeoMap(modStateHosp_20220221, 
             yVars=list("pctCovidICU"=c("label"="Covid", "color"="red"), 
                        "pctICU"=c("label"="Total", "color"="black")
                        ), 
             fullList=list("pctICU"=expression(icu_beds_occupied/icu_beds), 
                           "pctCovidICU"=expression(adult_icu_covid/icu_beds)
                           ), 
             plotTitle="Average % ICU Capacity Filled by Week", 
             plotSubtitle="August 2020 to January 2022", 
             plotScaleLabel="% ICU\nUsed", 
             returnData=FALSE
             )

# Adult beds summary
createGeoMap(modStateHosp_20220221 %>% filter(!(state %in% c("CT", "DE", "SD", "AK"))), 
             yVars=list("pctCovidAdult"=c("label"="Covid", "color"="red"), 
                        "pctAdult"=c("label"="Total", "color"="black")
                        ), 
             fullList=list("pctAdult"=expression(adult_beds_occupied/adult_beds), 
                           "pctCovidAdult"=expression(adult_beds_covid/adult_beds)
                           ), 
             plotTitle="Average % Adult Beds Capacity Filled by Week", 
             plotSubtitle="August 2020 to January 2022\n(AK, CT, DE, and SD data excluded)", 
             plotScaleLabel="% Adult\nBeds\nUsed", 
             returnData=FALSE
             )

```
  
## Example Data Update
The function is run to download and process the latest data:  
```{r, fig.height=9, fig.width=9, cache=TRUE}

readList <- list("cdcDaily"="./RInputFiles/Coronavirus/CDC_dc_downloaded_220304.csv", 
                 "cdcHosp"="./RInputFiles/Coronavirus/CDC_h_downloaded_220304.csv", 
                 "vax"="./RInputFiles/Coronavirus/vaxData_downloaded_220304.csv"
                 )
compareList <- list("cdcDaily"=readFromRDS("cdc_daily_220220")$dfRaw$cdcDaily, 
                    "cdcHosp"=readFromRDS("cdc_daily_220220")$dfRaw$cdcHosp, 
                    "vax"=readFromRDS("cdc_daily_220220")$dfRaw$vax
                    )

cdc_daily_220304 <- readRunCDCDaily(thruLabel="Mar 2, 2022", 
                                    downloadTo=lapply(readList, FUN=function(x) if(file.exists(x)) NA else x), 
                                    readFrom=readList,
                                    compareFile=compareList, 
                                    writeLog=NULL, 
                                    useClusters=readFromRDS("cdc_daily_210528")$useClusters, 
                                    weightedMeanAggs=c("tcpm7", "tdpm7", "cpm7", "dpm7", "hpm7", 
                                                       "vxcpm7", "vxcgte65pct"
                                                       ),
                                    skipAssessmentPlots=FALSE, 
                                    brewPalette="Paired"
                                    )
saveToRDS(cdc_daily_220304, ovrWriteError=FALSE)

# Run for latest data, save as RDS
indivHosp_20220304 <- downloadReadHospitalData(loc="./RInputFiles/Coronavirus/HHS_Hospital_20220304.csv")
saveToRDS(indivHosp_20220304, ovrWriteError=FALSE)

```
  
Post-processing is run, including hospital summaries:  
```{r, fig.height=9, fig.width=9}

# Create pivoted burden data
burdenPivotList_220304 <- postProcessCDCDaily(cdc_daily_220304, 
                                              dataThruLabel="Feb 2022", 
                                              keyDatesBurden=c("2022-02-28", "2021-08-31", 
                                                               "2021-02-28", "2020-08-31"
                                                               ),
                                              keyDatesVaccine=c("2022-02-28", "2021-10-31", 
                                                                "2021-06-30", "2021-02-28"
                                                                ), 
                                              returnData=TRUE
                                              )

# Create hospitalized per capita data
hospPerCap_220304 <- hospAgePerCapita(readFromRDS("dfStateAgeBucket2019"), 
                                      lst=burdenPivotList_220304, 
                                      popVar="pop2019", 
                                      excludeState=c(), 
                                      cumStartDate="2020-07-15"
                                      )

```

Peaks and valleys are converted to functional form:  
```{r, fig.height=9, fig.width=9}

peakValleyCDCDaily <- function(df, 
                               burdenVars=c("new_deaths", "new_cases", "inp"), 
                               burdenWidth=71, 
                               burdenRollMean=7,
                               minPopVax=8000000, 
                               vaxVars=c("vxa", "vxc"), 
                               minDateVax="2020-12-01", 
                               vaxWidth=71, 
                               vaxRollMean=21
                               ) {
    
    # FUNCTION ARGUMENTS
    # df: data frame (can also pass a list that contains data frame "dfPerCapita")
    # burdenVars: variables to be used for burden peaks and valleys
    # burdenWidth: window size to be used for burden data
    # burdenRollMean: rolling mean to use for smoothing burden data
    # minPopVax: minimum population for state vaccines to be plotted
    # vaxVars: variables to be used for vaccines peaks and valleys
    # minDateVax: earliest day to use for vaccines plotting
    # vaxWidth: window size to be used for vaccines data
    # vaxRollMean: rolling mean to use for smoothing vaccines data

    # Only works for specified burdenVars and vaxVars (fix)
    if(!all.equal(sort(burdenVars), sort(c("new_deaths", "new_cases", "inp")))) stop("\nNot yet enabled - burden\n")
    if(!all.equal(sort(vaxVars), sort(c("vxa", "vxc")))) stop("\nNot yet enabled - vaccines\n")
    
    # Extract data frame from df if needed
    if("list" %in% class(df)) df <- df[["dfPerCapita"]]

    # Burden data
    df %>%
        mutate(regn=c(as.character(state.region), "South")[match(state, c(state.abb, "DC"))]) %>%
        makePeakValley(numVar=burdenVars, 
                       windowWidth = burdenWidth, 
                       rollMean=burdenRollMean, 
                       facetVar=c("regn"), 
                       fnNumVar=list("new_deaths"=function(x) x, 
                                     "new_cases"=function(x) x/1000,
                                     "inp"=function(x) x/1000
                                     ), 
                       fnPeak=list("new_deaths"=function(x) x+100, 
                                   "new_cases"=function(x) x+10, 
                                   "inp"=function(x) x+10
                                   ),
                       fnValley=list("new_deaths"=function(x) x-100, 
                                     "new_cases"=function(x) x-5, 
                                     "inp"=function(x) x-5
                                     ),
                       useTitle=c("new_deaths"="US coronavirus deaths", 
                                  "new_cases"="US coronavirus cases", 
                                  "inp"="US coronavirus total hospitalized"
                                  ), 
                       yLab=c("new_deaths"=paste0("Rolling ", burdenRollMean, "-day mean deaths"), 
                              "new_cases"=paste0("Rolling ", burdenRollMean, "-day mean cases (000)"), 
                              "inp"=paste0("Rolling ", burdenRollMean, "-day mean in hospital (000)")
                              )
                       )

    # Vaccinations data for states with at least threshold population
    df %>%
        inner_join(getStateData(), by=c("state")) %>%
        filter(pop >= minPopVax) %>%
        select(c("state", "date", all_of(vaxVars))) %>%
        arrange(date, state) %>%
        group_by(state) %>%
        mutate(across(c(vxa, vxc), .fns=function(x) x-lag(x))) %>%
        ungroup() %>%
        mutate(regn=c(as.character(state.region), "South")[match(state, c(state.abb, "DC"))]) %>%
        filter(date >= minDateVax) %>%
        makePeakValley(numVar=vaxVars, 
                       windowWidth = vaxWidth, 
                       rollMean=vaxRollMean, 
                       facetVar=c("state"), 
                       fnNumVar=list("vxa"=function(x) x/1000, 
                                     "vxc"=function(x) x/1000
                                     ), 
                       fnPeak=list("vxa"=function(x) x+25*max(x, na.rm=TRUE)/400, 
                                   "vxc"=function(x) x+25*max(x, na.rm=TRUE)/400
                                   ),
                       fnValley=list("vxa"=function(x) x-25*max(x, na.rm=TRUE)/400, 
                                     "vxc"=function(x) x-25*max(x, na.rm=TRUE)/400
                                     ),
                       fnGroupFacet=TRUE,
                       useTitle=c("vxa"=paste0("Vaccines adminsitered (states with population >= ", minPopVax, ")"), 
                                  "vxc"=paste0("Became fully vaccinated (states with population >= ", minPopVax, ")")
                                  ), 
                       yLab=c("vxa"=paste0("Rolling ", vaxRollMean, "-day mean administered (000)"),
                              "vxc"=paste0("Rolling ", vaxRollMean,"-day mean completed (000)")
                              )
                       )
    
}

peakValleyCDCDaily(cdc_daily_220304)

```

Hospital capacity maps with imputed capacity are created:  
```{r, fig.height=9, fig.width=9}

modStateHosp_20220304 <- skinnyHHS(indivHosp_20220304) %>%
    imputeNACapacity() %>%
    sumImputedHHS()

# ICU summary
createGeoMap(modStateHosp_20220304, 
             yVars=list("pctCovidICU"=c("label"="Covid", "color"="red"), 
                        "pctICU"=c("label"="Total", "color"="black")
                        ), 
             fullList=list("pctICU"=expression(icu_beds_occupied/icu_beds), 
                           "pctCovidICU"=expression(adult_icu_covid/icu_beds)
                           ), 
             plotTitle="Average % ICU Capacity Filled by Week", 
             plotSubtitle="August 2020 to February 2022", 
             plotScaleLabel="% ICU\nUsed", 
             returnData=FALSE
             )

# Adult beds summary
createGeoMap(modStateHosp_20220304 %>% filter(!(state %in% c("CT", "DE", "SD", "AK"))), 
             yVars=list("pctCovidAdult"=c("label"="Covid", "color"="red"), 
                        "pctAdult"=c("label"="Total", "color"="black")
                        ), 
             fullList=list("pctAdult"=expression(adult_beds_occupied/adult_beds), 
                           "pctCovidAdult"=expression(adult_beds_covid/adult_beds)
                           ), 
             plotTitle="Average % Adult Beds Capacity Filled by Week", 
             plotSubtitle="August 2020 to February 2022\n(AK, CT, DE, and SD data excluded)", 
             plotScaleLabel="% Adult\nBeds\nUsed", 
             returnData=FALSE
             )

```
  
The latest data are downloaded and processed:  
```{r, fig.height=9, fig.width=9, cache=TRUE}

readList <- list("cdcDaily"="./RInputFiles/Coronavirus/CDC_dc_downloaded_220416.csv", 
                 "cdcHosp"="./RInputFiles/Coronavirus/CDC_h_downloaded_220416.csv", 
                 "vax"="./RInputFiles/Coronavirus/vaxData_downloaded_220416.csv"
                 )
compareList <- list("cdcDaily"=readFromRDS("cdc_daily_220304")$dfRaw$cdcDaily, 
                    "cdcHosp"=readFromRDS("cdc_daily_220304")$dfRaw$cdcHosp, 
                    "vax"=readFromRDS("cdc_daily_220304")$dfRaw$vax
                    )

cdc_daily_220416 <- readRunCDCDaily(thruLabel="Apr 14, 2022", 
                                    downloadTo=lapply(readList, FUN=function(x) if(file.exists(x)) NA else x), 
                                    readFrom=readList,
                                    compareFile=compareList, 
                                    writeLog=NULL, 
                                    useClusters=readFromRDS("cdc_daily_210528")$useClusters, 
                                    weightedMeanAggs=c("tcpm7", "tdpm7", "cpm7", "dpm7", "hpm7", 
                                                       "vxcpm7", "vxcgte65pct"
                                                       ),
                                    skipAssessmentPlots=FALSE, 
                                    brewPalette="Paired"
                                    )
saveToRDS(cdc_daily_220416, ovrWriteError=FALSE)

# Run for latest data, save as RDS
indivHosp_20220416 <- downloadReadHospitalData(loc="./RInputFiles/Coronavirus/HHS_Hospital_20220416.csv")
saveToRDS(indivHosp_20220416, ovrWriteError=FALSE)

```
  
Post-processing is run, including hospital summaries:  
```{r, fig.height=9, fig.width=9}

# Create pivoted burden data
burdenPivotList_220416 <- postProcessCDCDaily(cdc_daily_220416, 
                                              dataThruLabel="Mar 2022", 
                                              keyDatesBurden=c("2022-03-31", "2021-09-30", 
                                                               "2021-03-31", "2020-09-30"
                                                               ),
                                              keyDatesVaccine=c("2022-03-31", "2021-11-30", 
                                                                "2021-07-31", "2021-03-31"
                                                                ), 
                                              returnData=TRUE
                                              )

# Create hospitalized per capita data
hospPerCap_220416 <- hospAgePerCapita(readFromRDS("dfStateAgeBucket2019"), 
                                      lst=burdenPivotList_220416, 
                                      popVar="pop2019", 
                                      excludeState=c(), 
                                      cumStartDate="2020-07-15"
                                      )

```

Peaks and valleys of key metrics are also plotted:  
```{r, fig.height=9, fig.width=9}

peakValleyCDCDaily(cdc_daily_220416)

```
  
Hospital capacity maps with imputed capacity are created:  
```{r, fig.height=9, fig.width=9}

modStateHosp_20220416 <- skinnyHHS(indivHosp_20220416) %>%
    imputeNACapacity() %>%
    sumImputedHHS()

# ICU summary
createGeoMap(modStateHosp_20220416, 
             yVars=list("pctCovidICU"=c("label"="Covid", "color"="red"), 
                        "pctICU"=c("label"="Total", "color"="black")
                        ), 
             fullList=list("pctICU"=expression(icu_beds_occupied/icu_beds), 
                           "pctCovidICU"=expression(adult_icu_covid/icu_beds)
                           ), 
             plotTitle="Average % ICU Capacity Filled by Week", 
             plotSubtitle="August 2020 to mid-April 2022", 
             plotScaleLabel="% ICU\nUsed", 
             returnData=FALSE
             )

# Adult beds summary
# createGeoMap(modStateHosp_20220416 %>% filter(!(state %in% c("CT", "DE", "SD", "AK"))), 
createGeoMap(modStateHosp_20220416 %>% filter(!(state %in% c("CT", "DE", "SD", "AK"))), 
             yVars=list("pctCovidAdult"=c("label"="Covid", "color"="red"), 
                        "pctAdult"=c("label"="Total", "color"="black")
                        ), 
             fullList=list("pctAdult"=expression(adult_beds_occupied/adult_beds), 
                           "pctCovidAdult"=expression(adult_beds_covid/adult_beds)
                           ), 
             plotTitle="Average % Adult Beds Capacity Filled by Week", 
             plotSubtitle="August 2020 to mid-April 2022\n(AK, CT, DE, and SD data excluded)", 
             plotScaleLabel="% Adult\nBeds\nUsed", 
             returnData=FALSE
             )

```
  
The latest data are downloaded and processed:  
```{r, fig.height=9, fig.width=9, cache=TRUE}

readList <- list("cdcDaily"="./RInputFiles/Coronavirus/CDC_dc_downloaded_220501.csv", 
                 "cdcHosp"="./RInputFiles/Coronavirus/CDC_h_downloaded_220501.csv", 
                 "vax"="./RInputFiles/Coronavirus/vaxData_downloaded_220501.csv"
                 )
compareList <- list("cdcDaily"=readFromRDS("cdc_daily_220416")$dfRaw$cdcDaily, 
                    "cdcHosp"=readFromRDS("cdc_daily_220416")$dfRaw$cdcHosp, 
                    "vax"=readFromRDS("cdc_daily_220416")$dfRaw$vax
                    )

cdc_daily_220501 <- readRunCDCDaily(thruLabel="Apr 30, 2022", 
                                    downloadTo=lapply(readList, FUN=function(x) if(file.exists(x)) NA else x), 
                                    readFrom=readList,
                                    compareFile=compareList, 
                                    writeLog=NULL, 
                                    useClusters=readFromRDS("cdc_daily_210528")$useClusters, 
                                    weightedMeanAggs=c("tcpm7", "tdpm7", "cpm7", "dpm7", "hpm7", 
                                                       "vxcpm7", "vxcgte65pct"
                                                       ),
                                    skipAssessmentPlots=FALSE, 
                                    brewPalette="Paired"
                                    )
saveToRDS(cdc_daily_220501, ovrWriteError=FALSE)

# Run for latest data, save as RDS
indivHosp_20220501 <- downloadReadHospitalData(loc="./RInputFiles/Coronavirus/HHS_Hospital_20220501.csv")
saveToRDS(indivHosp_20220501, ovrWriteError=FALSE)

```
  
Post-processing is run, including hospital summaries:  
```{r, fig.height=9, fig.width=9, cache=TRUE}

# Create pivoted burden data
burdenPivotList_220501 <- postProcessCDCDaily(cdc_daily_220501, 
                                              dataThruLabel="Apr 2022", 
                                              keyDatesBurden=c("2022-04-29", "2021-10-31", 
                                                               "2021-04-30", "2020-10-31"
                                                               ),
                                              keyDatesVaccine=c("2022-04-29", "2021-12-31", 
                                                                "2021-08-31", "2021-04-30"
                                                                ), 
                                              returnData=TRUE
                                              )

# Create hospitalized per capita data
hospPerCap_220501 <- hospAgePerCapita(readFromRDS("dfStateAgeBucket2019"), 
                                      lst=burdenPivotList_220501, 
                                      popVar="pop2019", 
                                      excludeState=c(), 
                                      cumStartDate="2020-07-15"
                                      )

```
  
The post-process function is working incorrectly on the pediatric data. It appears that a few category labels changed syntax. Function createBurdenPivot() is updated to a better formed grep sequence for the latest data:  
```{r, fig.height=9, fig.width=9}

burdenPivotList_220501$hospAge %>%
    group_by(adultPed, confSusp, age, name) %>%
    summarize(value=sum(value, na.rm=TRUE), n=n())

# Create pivoted burden data
createBurdenPivot <- function(lst, 
                              dataThru,
                              minDatePlot="2020-08-01", 
                              plotByState=c(state.abb, "DC")
                              ) {
    
    # FUNCTION ARGUMENTS:
    # lst: a processed list that includes sub-component $dfRaw$cdcHosp
    # dataThru: character string to be used for 'data through'; most commonly MMM-YY
    # minDatePlot: starting date for plots
    # plotByState: states to be facetted for plot of hospitaliztions by age (FALSE means do not create plot)
    
    # Convert minDatePlot to Date if passed as character
    if ("character" %in% class(minDatePlot)) minDatePlot <- as.Date(minDatePlot)
    
    # Create the hospitalized by age data
    hospAge <- lst[["dfRaw"]][["cdcHosp"]] %>%
        select(state, 
               date, 
               grep(x=names(.), pattern="previous_.*ed_\\d.*[9+]$", value=TRUE), 
               grep(x=names(.), pattern="previous_.*pediatric.*[tm]ed$", value=TRUE)
        ) %>% 
        pivot_longer(-c(state, date)) %>% 
        mutate(confSusp=ifelse(grepl(x=name, pattern="confirmed"), "confirmed", "suspected"), 
               adultPed=ifelse(grepl(x=name, pattern="adult"), "adult", "ped"), 
               age=ifelse(adultPed=="ped", 
                          "0-17", 
                          stringr::str_replace_all(string=name, pattern=".*_", replacement="")
               ), 
               age=ifelse(age %in% c("0-17", "18-19"), "0-19", age), 
               div=as.character(state.division)[match(state, state.abb)]
        )
    
    # Create the pivoted burden data
    dfPivot <- makeCaseHospDeath(dfHosp=hospAge, dfCaseDeath=lst[["dfPerCapita"]])
    
    # Plot for overall trends by age group
    p1 <- hospAge %>% 
        filter(state %in% c(state.abb, "DC"), !is.na(value)) %>% 
        mutate(ageBucket=age) %>% 
        group_by(date, ageBucket) %>% 
        summarize(value=sum(value), .groups="drop") %>% 
        arrange(date) %>%
        group_by(ageBucket) %>% 
        mutate(value7=zoo::rollmean(value, k=7, fill=NA)) %>% 
        filter(date >= minDatePlot) %>% 
        ggplot(aes(x=date, y=value7)) + 
        labs(x=NULL, 
             y="Confirmed or suspected COVID admissions (rolling-7 mean)", 
             title=paste0("Hospital admissions for COVID by age bucket (Aug 2020 - ", dataThru, ")"), 
             subtitle="50 states and DC (includes confirmed and suspected from CDC data)"
        ) + 
        lims(y=c(0, NA))
    
    # Create three main plots of hospitalized by age data
    print(p1 + geom_line(aes(group=ageBucket, color=ageBucket), size=1) + scale_color_discrete("Age\nbucket"))
    print(p1 + geom_col(aes(fill=ageBucket), position="stack") + scale_color_discrete("Age\nbucket"))
    print(p1 + geom_col(aes(fill=ageBucket), position="fill") + scale_color_discrete("Age\nbucket"))
    
    # Plot for trends by state and age group
    if (!isFALSE(plotByState)) {
        p2 <- hospAge %>% 
            filter(state %in% plotByState, !is.na(value)) %>% 
            mutate(ageBucket=ifelse(age >= "60", "60+", ifelse(age=="0-19", "0-19", "20-59"))) %>% 
            group_by(date, state, ageBucket) %>% 
            summarize(value=sum(value), .groups="drop") %>% 
            group_by(ageBucket, state) %>% 
            mutate(value7=zoo::rollmean(value, k=7, fill=NA)) %>% 
            filter(date >= minDatePlot) %>% 
            ggplot(aes(x=date, y=value7)) + 
            geom_line(aes(color=ageBucket, group=ageBucket)) + 
            scale_color_discrete("Age\nbucket") + 
            labs(x=NULL, 
                 y="Confirmed or suspected COVID admissions (rolling-7 mean)", 
                 title=paste0("Hospital admissions for COVID by age bucket (Aug 2020 - ", dataThru, ")")
            ) + 
            lims(y=c(0, NA)) + 
            facet_wrap(~state, scales="free_y")
        print(p2)
    }
    
    # Return key data (do not return plot objects)
    list(hospAge=hospAge, dfPivot=dfPivot)
    
}

# Create pivoted burden data
burdenPivotList_220501 <- postProcessCDCDaily(cdc_daily_220501, 
                                              dataThruLabel="Apr 2022", 
                                              keyDatesBurden=c("2022-04-29", "2021-10-31", 
                                                               "2021-04-30", "2020-10-31"
                                                               ),
                                              keyDatesVaccine=c("2022-04-29", "2021-12-31", 
                                                                "2021-08-31", "2021-04-30"
                                                                ), 
                                              returnData=TRUE
                                              )

# Create hospitalized per capita data
hospPerCap_220501 <- hospAgePerCapita(readFromRDS("dfStateAgeBucket2019"), 
                                      lst=burdenPivotList_220501, 
                                      popVar="pop2019", 
                                      excludeState=c(), 
                                      cumStartDate="2020-07-15"
                                      )

burdenPivotList_220501$hospAge %>%
    group_by(adultPed, confSusp, age, name) %>%
    summarize(value=sum(value, na.rm=TRUE), n=n())

```
  
Peaks and valleys of key metrics are also updated:  
```{r, fig.height=9, fig.width=9}

peakValleyCDCDaily(cdc_daily_220501)

```
  
Hospital capacity maps with imputed capacity are created:  
```{r, fig.height=9, fig.width=9}

modStateHosp_20220501 <- skinnyHHS(indivHosp_20220501) %>%
    imputeNACapacity() %>%
    sumImputedHHS()

# ICU summary
createGeoMap(modStateHosp_20220501, 
             yVars=list("pctCovidICU"=c("label"="Covid", "color"="red"), 
                        "pctICU"=c("label"="Total", "color"="black")
                        ), 
             fullList=list("pctICU"=expression(icu_beds_occupied/icu_beds), 
                           "pctCovidICU"=expression(adult_icu_covid/icu_beds)
                           ), 
             plotTitle="Average % ICU Capacity Filled by Week", 
             plotSubtitle="August 2020 to April 2022", 
             plotScaleLabel="% ICU\nUsed", 
             returnData=FALSE
             )

# Adult beds summary
# createGeoMap(modStateHosp_20220416 %>% filter(!(state %in% c("CT", "DE", "SD", "AK"))), 
createGeoMap(modStateHosp_20220501 %>% filter(!(state %in% c("CT", "DE", "SD", "AK"))), 
             yVars=list("pctCovidAdult"=c("label"="Covid", "color"="red"), 
                        "pctAdult"=c("label"="Total", "color"="black")
                        ), 
             fullList=list("pctAdult"=expression(adult_beds_occupied/adult_beds), 
                           "pctCovidAdult"=expression(adult_beds_covid/adult_beds)
                           ), 
             plotTitle="Average % Adult Beds Capacity Filled by Week", 
             plotSubtitle="August 2020 to April 2022\n(AK, CT, DE, and SD data excluded)", 
             plotScaleLabel="% Adult\nBeds\nUsed", 
             returnData=FALSE
             )

```
  
A function is created for hospital post-processing:  
```{r, fig.height=9, fig.width=9}

hospitalCapacityCDCDaily <- function(df, 
                                     createData=TRUE, 
                                     returnData=createData,
                                     maxCapacity=1.2,
                                     plotSub="start to finish"
                                     ) {
    
    # FUNCTION ARGUMENTS:
    # df: the key data frame
    # createData: boolean, if TRUE then convert df for use in processing
    #                      if FALSE, use df as-is
    # returnData: boolean, should df be returned (defaults to TRUE is modified, FALSE otherwise)
    # maxCapacity: states that exceed this capacity level will not be plotted (explore separately)
    # plotSub: subtitle to use for plots
    
    # Convert data if requested
    if(isTRUE(createData)) df <- skinnyHHS(df) %>% imputeNACapacity() %>% sumImputedHHS()

    # Create ICU summary
    createGeoMap(df, 
                 yVars=list("pctCovidICU"=c("label"="Covid", "color"="red"), 
                            "pctICU"=c("label"="Total", "color"="black")
                            ), 
                 fullList=list("pctICU"=expression(icu_beds_occupied/icu_beds), 
                               "pctCovidICU"=expression(adult_icu_covid/icu_beds)
                               ), 
                 plotTitle="Average % ICU Capacity Filled by Week", 
                 plotSubtitle=plotSub, 
                 plotScaleLabel="% ICU\nUsed", 
                 returnData=FALSE
                 )

    # Get list of states that may complicate map
    pctState <- df %>% 
        mutate(pctAdult=adult_beds_occupied/adult_beds, pctCovidAdult=adult_beds_covid/adult_beds)
    exclStates <- pctState %>% filter(pctAdult > maxCapacity) %>% count(state) %>% pull(state)
    if(length(exclStates) > 0) plotSub <- paste0(plotSub, "\n(", paste(exclStates, collapse=", "), " data excluded)")

    # Create the adult beds summary    
    createGeoMap(df %>% filter(!(state %in% all_of(exclStates))), 
                 yVars=list("pctCovidAdult"=c("label"="Covid", "color"="red"), 
                            "pctAdult"=c("label"="Total", "color"="black")
                            ), 
                 fullList=list("pctAdult"=expression(adult_beds_occupied/adult_beds), 
                               "pctCovidAdult"=expression(adult_beds_covid/adult_beds)
                               ), 
                 plotTitle="Average % Adult Beds Capacity Filled by Week", 
                 plotSubtitle=plotSub, 
                 plotScaleLabel="% Adult\nBeds\nUsed", 
                 returnData=FALSE
                 )
    
    # Return the data if requested (defaults to only if createData is TRUE)
    if(isTRUE(returnData)) return(df)
    
}

hospitalCapacityCDCDaily(modStateHosp_20220501, createData=FALSE, plotSub="August 2020 to April 2022")

```
  
The latest data are downloaded and processed:  
```{r, fig.height=9, fig.width=9, cache=TRUE}

readList <- list("cdcDaily"="./RInputFiles/Coronavirus/CDC_dc_downloaded_220602.csv", 
                 "cdcHosp"="./RInputFiles/Coronavirus/CDC_h_downloaded_220602.csv", 
                 "vax"="./RInputFiles/Coronavirus/vaxData_downloaded_220602.csv"
                 )
compareList <- list("cdcDaily"=readFromRDS("cdc_daily_220501")$dfRaw$cdcDaily, 
                    "cdcHosp"=readFromRDS("cdc_daily_220501")$dfRaw$cdcHosp, 
                    "vax"=readFromRDS("cdc_daily_220501")$dfRaw$vax
                    )

cdc_daily_220602 <- readRunCDCDaily(thruLabel="May 31, 2022", 
                                    downloadTo=lapply(readList, FUN=function(x) if(file.exists(x)) NA else x), 
                                    readFrom=readList,
                                    compareFile=compareList, 
                                    writeLog=NULL, 
                                    useClusters=readFromRDS("cdc_daily_210528")$useClusters, 
                                    weightedMeanAggs=c("tcpm7", "tdpm7", "cpm7", "dpm7", "hpm7", 
                                                       "vxcpm7", "vxcgte65pct"
                                                       ),
                                    skipAssessmentPlots=FALSE, 
                                    brewPalette="Paired"
                                    )
saveToRDS(cdc_daily_220602, ovrWriteError=FALSE)

# Run for latest data, save as RDS
indivHosp_20220602 <- downloadReadHospitalData(loc="./RInputFiles/Coronavirus/HHS_Hospital_20220602.csv")
saveToRDS(indivHosp_20220602, ovrWriteError=FALSE)

```
  
Post-processing is run, including hospital summaries:  
```{r, fig.height=9, fig.width=9, cache=TRUE}

# Create pivoted burden data
burdenPivotList_220602 <- postProcessCDCDaily(cdc_daily_220602, 
                                              dataThruLabel="May 2022", 
                                              keyDatesBurden=c("2022-05-31", "2021-11-30", 
                                                               "2021-05-31", "2020-11-30"
                                                               ),
                                              keyDatesVaccine=c("2022-05-31", "2022-01-31", 
                                                                "2021-09-30", "2021-05-31"
                                                                ), 
                                              returnData=TRUE
                                              )

# Create hospitalized per capita data
hospPerCap_220602 <- hospAgePerCapita(readFromRDS("dfStateAgeBucket2019"), 
                                      lst=burdenPivotList_220602, 
                                      popVar="pop2019", 
                                      excludeState=c(), 
                                      cumStartDate="2020-07-15"
                                      )

burdenPivotList_220602$hospAge %>%
    group_by(adultPed, confSusp, age, name) %>%
    summarize(value=sum(value, na.rm=TRUE), n=n())

```
  
Peaks and valleys of key metrics are also updated:  
```{r, fig.height=9, fig.width=9}

peakValleyCDCDaily(cdc_daily_220602)

```
  
Hospital capacity plots are also updated:  
```{r, fig.height=9, fig.width=9}

modStateHosp_20220602 <- hospitalCapacityCDCDaily(indivHosp_20220602, plotSub="August 2020 to May 2022")

```
  
The latest data are downloaded and processed:  
```{r, fig.height=9, fig.width=9, cache=TRUE}

readList <- list("cdcDaily"="./RInputFiles/Coronavirus/CDC_dc_downloaded_220704.csv", 
                 "cdcHosp"="./RInputFiles/Coronavirus/CDC_h_downloaded_220704.csv", 
                 "vax"="./RInputFiles/Coronavirus/vaxData_downloaded_220704.csv"
                 )
compareList <- list("cdcDaily"=readFromRDS("cdc_daily_220602")$dfRaw$cdcDaily, 
                    "cdcHosp"=readFromRDS("cdc_daily_220602")$dfRaw$cdcHosp, 
                    "vax"=readFromRDS("cdc_daily_220602")$dfRaw$vax
                    )

cdc_daily_220704 <- readRunCDCDaily(thruLabel="Jul 2, 2022", 
                                    downloadTo=lapply(readList, FUN=function(x) if(file.exists(x)) NA else x), 
                                    readFrom=readList,
                                    compareFile=compareList, 
                                    writeLog=NULL, 
                                    useClusters=readFromRDS("cdc_daily_210528")$useClusters, 
                                    weightedMeanAggs=c("tcpm7", "tdpm7", "cpm7", "dpm7", "hpm7", 
                                                       "vxcpm7", "vxcgte65pct"
                                                       ),
                                    skipAssessmentPlots=FALSE, 
                                    brewPalette="Paired"
                                    )
saveToRDS(cdc_daily_220704, ovrWriteError=FALSE)

# Run for latest data, save as RDS
indivHosp_20220704 <- downloadReadHospitalData(loc="./RInputFiles/Coronavirus/HHS_Hospital_20220704.csv")
saveToRDS(indivHosp_20220704, ovrWriteError=FALSE)

```
  
Post-processing is run, including hospital summaries:  
```{r, fig.height=9, fig.width=9, cache=TRUE}

# Create pivoted burden data
burdenPivotList_220704 <- postProcessCDCDaily(cdc_daily_220704, 
                                              dataThruLabel="Jun 2022", 
                                              keyDatesBurden=c("2022-06-30", "2021-12-31", 
                                                               "2021-06-30", "2020-12-31"
                                                               ),
                                              keyDatesVaccine=c("2022-06-29", "2022-02-28", 
                                                                "2021-10-31", "2021-06-30"
                                                                ), 
                                              returnData=TRUE
                                              )

# Create hospitalized per capita data
hospPerCap_220704 <- hospAgePerCapita(readFromRDS("dfStateAgeBucket2019"), 
                                      lst=burdenPivotList_220704, 
                                      popVar="pop2019", 
                                      excludeState=c(), 
                                      cumStartDate="2020-07-15"
                                      )

burdenPivotList_220704$hospAge %>%
    group_by(adultPed, confSusp, age, name) %>%
    summarize(value=sum(value, na.rm=TRUE), n=n(), .groups="drop")

```
  
Peaks and valleys of key metrics are also updated:  
```{r, fig.height=9, fig.width=9}

peakValleyCDCDaily(cdc_daily_220704)

```
  
Hospital capacity plots are also updated:  
```{r, fig.height=9, fig.width=9}

modStateHosp_20220704 <- hospitalCapacityCDCDaily(indivHosp_20220704, plotSub="August 2020 to June 2022")

```
  
The latest data are downloaded and processed:  
```{r, fig.height=9, fig.width=9, cache=TRUE}

# Update to helperSummaryMap for updated usmap::usmap_transform
helperSummaryMap <- function(df, 
                             mapLevel="states", 
                             keyCol="state",
                             values="cluster",
                             discreteValues=NULL,
                             legend.position="right",
                             labelScale=TRUE,
                             extraArgs=list(),
                             countOnly=FALSE,
                             textLabel=c(),
                             ...
                             ) {
    
    # FUNCTION ARGUMENTS:
    # df: a data frame containing a level of geography and an associated cluster
    # mapLevel: a parameter for whether the map is "states" or "counties"
    # keyCol: the key column for plotting (usmap::plot_usmap is particular, and this must be 'state' or 'fips')
    # values: the character name of the field containing the data to be plotted
    # discreteValues: boolean for whether the values are discrete (if not, use continuous)
    #                 NULL means infer from data
    # legend.position: character for the location of the legend in the plot
    # labelScale: boolean, should an scale_fill_ be created?  Use FALSE if contained in extraArgs
    # extraArgs: list of other arguments that will be appended as '+' to the end of the usmap::plot_usmap call
    # countOnly: should a bar plot of counts only be produced?
    # textLabel: a list of elements that should be labelled as text on the plot (too small to see)
    # ...: other parameters to be passed to usmap::plot_usmap (e.g., labels, include, exclude, etc.)
    
    # Modify the data frame to contain only the relevant data
    df <- df %>%
        select(all_of(c(keyCol, values))) %>%
        distinct()
    
    # Determine the type of data being plotted
    if (is.null(discreteValues)) discreteValues <- !is.numeric(df[[values]])
    
    # Convert data type if needed
    if (isTRUE(discreteValues) & is.numeric(df[[values]])) 
        df[[values]] <- factor(df[[values]])
    
    # If count only is needed, create a count map; otherwise create a map
    if (isTRUE(countOnly)) { 
        gg <- df %>%
            ggplot(aes(x=fct_rev(get(values)))) + 
            geom_bar(aes_string(fill=values)) + 
            stat_count(aes(label=..count.., y=..count../2), 
                       geom="text", 
                       position="identity", 
                       fontface="bold"
                       ) +
            coord_flip() + 
            labs(y="Number of members", x="")
    } else {
        gg <- usmap::plot_usmap(regions=mapLevel, data=df, values=values, ...)
        if (length(textLabel) > 0) {
            labDF <- df %>% 
                filter(get(keyCol) %in% textLabel) %>%
                mutate(rk=match(get(keyCol), textLabel)) %>%
                arrange(rk) %>%
                mutate(lon=-70.1-seq(0, 0.8*length(textLabel)-0.8, by=0.8), 
                       lat=40.1-seq(0, 1.5*length(textLabel)-1.5, by=1.5)
                       ) %>%
                select(lon, lat, everything()) %>%
                usmap::usmap_transform(output_names=c("lon.1", "lat.1"))
            gg <- gg + geom_text(data=labDF, 
                                 aes(x=lon.1, y=lat.1, label=paste(get(keyCol), get(values))), 
                                 size=3.25
                                 )
        }
    }
    
    # Position the legend as requested
    gg <- gg + theme(legend.position=legend.position)
    
    # Create the scale if appropriate
    if (isTRUE(labelScale)) gg <- gg + 
        if(isTRUE(discreteValues)) scale_fill_discrete(values) else scale_fill_continuous(values)
    
    # Apply extra arguments
    for (ctr in seq_along(extraArgs)) gg <- gg + extraArgs[[ctr]]
    
    # Return the map object
    gg
    
}

readList <- list("cdcDaily"="./RInputFiles/Coronavirus/CDC_dc_downloaded_220805.csv", 
                 "cdcHosp"="./RInputFiles/Coronavirus/CDC_h_downloaded_220805.csv", 
                 "vax"="./RInputFiles/Coronavirus/vaxData_downloaded_220805.csv"
                 )
compareList <- list("cdcDaily"=readFromRDS("cdc_daily_220704")$dfRaw$cdcDaily, 
                    "cdcHosp"=readFromRDS("cdc_daily_220704")$dfRaw$cdcHosp, 
                    "vax"=readFromRDS("cdc_daily_220704")$dfRaw$vax
                    )

cdc_daily_220805 <- readRunCDCDaily(thruLabel="Aug 3, 2022", 
                                    downloadTo=lapply(readList, FUN=function(x) if(file.exists(x)) NA else x), 
                                    readFrom=readList,
                                    compareFile=compareList, 
                                    writeLog=NULL, 
                                    useClusters=readFromRDS("cdc_daily_210528")$useClusters, 
                                    weightedMeanAggs=c("tcpm7", "tdpm7", "cpm7", "dpm7", "hpm7", 
                                                       "vxcpm7", "vxcgte65pct"
                                                       ),
                                    skipAssessmentPlots=FALSE, 
                                    brewPalette="Paired"
                                    )
saveToRDS(cdc_daily_220805, ovrWriteError=FALSE)

# Run for latest data, save as RDS
indivHosp_20220805 <- downloadReadHospitalData(loc="./RInputFiles/Coronavirus/HHS_Hospital_20220805.csv")
saveToRDS(indivHosp_20220805, ovrWriteError=FALSE)

```
  
Post-processing is run, including hospital summaries:  
```{r, fig.height=9, fig.width=9, cache=TRUE}

# Create pivoted burden data
burdenPivotList_220805 <- postProcessCDCDaily(cdc_daily_220805, 
                                              dataThruLabel="Jul 2022", 
                                              keyDatesBurden=c("2022-07-31", "2022-01-31", 
                                                               "2021-07-31", "2021-01-31"
                                                               ),
                                              keyDatesVaccine=c("2022-07-27", "2022-03-31", 
                                                                "2021-11-30", "2021-07-31"
                                                                ), 
                                              returnData=TRUE
                                              )

# Create hospitalized per capita data
hospPerCap_220805 <- hospAgePerCapita(readFromRDS("dfStateAgeBucket2019"), 
                                      lst=burdenPivotList_220805, 
                                      popVar="pop2019", 
                                      excludeState=c(), 
                                      cumStartDate="2020-07-15"
                                      )

burdenPivotList_220805$hospAge %>%
    group_by(adultPed, confSusp, age, name) %>%
    summarize(value=sum(value, na.rm=TRUE), n=n(), .groups="drop")

```
  
Peaks and valleys of key metrics are also updated:  
```{r, fig.height=9, fig.width=9}

peakValleyCDCDaily(cdc_daily_220805)

```
  
Hospital capacity plots are also updated:  
```{r, fig.height=9, fig.width=9}

modStateHosp_20220805 <- hospitalCapacityCDCDaily(indivHosp_20220805, plotSub="August 2020 to July 2022")

```
  
Hospital data appear to be anomalous prior to mid-2021. Record counts are compared:  
```{r, fig.height=9, fig.width=9}

dfTemp <- indivHosp_20220805 %>%
    count(state, collection_week) %>%
    bind_rows(count(readFromRDS("indivHosp_20220704"), state, collection_week), .id="source") %>%
    mutate(source=c("1"="Aug 2022", "2"="Jul 2022")[source]) %>%
    pivot_wider(c(state, collection_week), names_from="source", values_from="n") %>%
    mutate(across(where(is.numeric), .fns=function(x) ifelse(is.na(x), 0, x))) %>%
    pivot_longer(-c(state, collection_week), names_to="source", values_to="n")
dfTemp

dfTemp %>%
    ggplot(aes(x=collection_week, y=n)) + 
    geom_line(aes(group=source, color=source)) + 
    facet_wrap(~state, scales="free_y") + 
    labs(title="Number of hospitals with CDC-reported hospital records", 
         subtitle="August 2020 to July 2022",
         x=NULL, 
         y="Hospitals reporting in CDC data"
         ) + 
    scale_color_discrete("Data pulled in:")

```
  
