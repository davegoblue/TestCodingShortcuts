---
title: "CDC Daily by State"
author: "davegoblue"
date: "2/20/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Background
This file is designed to use CDC data to assess coronavirus disease burden by state, including creating and analyzing state-level clusters.

Through March 7, 2021, [The COVID Tracking Project](https://covidtracking.com/) collected and integrated data on tests, cases, hospitalizations, deaths, and the like by state and date.  The latest code for using this data is available in Coronavirus_Statistics_CTP_v004.Rmd.

The COVID Tracking Project suggest that [US federal data sources](https://covidtracking.com/analysis-updates/federal-covid-data-101-how-to-find-data) are now sufficiently robust to be used for analyses that previously relied on COVID Tracking Project.  This code is an attempt to update modules in Coronavirus_Statistics_CTP_v004.Rmd to leverage US federal data.

The code in this module builds on code available in _v003, with function and mapping files updated:  
  
* Generic_Added_Utility_Functions_202105_v001.R - generic functions that can be used in other areas  
* Coronavirus_CDC_Daily_Functions_v001.R - functions specific to coronavirus daily data  
  
Broadly, the CDC data analyzed by this module includes:  
  
* CDC case and death data by state and date are available for download on the [CDC website](https://data.cdc.gov/api/views/9mfq-cb36/rows.csv?accessType=DOWNLOAD)  
* CDC hospital data are available for download on the [healthdata.gov website](https://beta.healthdata.gov/api/views/g62h-syeh/rows.csv?accessType=DOWNLOAD)  
* CDC vaccines data are also available for download on the [CDC website](https://data.cdc.gov/api/views/unsk-b7fc/rows.csv?accessType=DOWNLOAD):  
  
## Functions and Mapping Files
The tidyverse package is loaded and functions are sourced:  
```{r}

# The tidyverse functions are routinely used without package::function format
library(tidyverse)

# Functions are available in source file
source("./Generic_Added_Utility_Functions_202105_v001.R")
source("./Coronavirus_CDC_Daily_Functions_v001.R")

```

A series of mapping files are also available to allow for parameterized processing.  Mappings include:  
  
* urlMapper - mapping file for urlType and url location to download data  
* renMapper - mapping file for renaming of variables in the raw data file  
* selfListMapper - mapping file for transformations by variable type  
* fullListMapper - mapping file for transformations across variable types  
* lstComboMapper - mapping file for elements to be combined by data type (most common is to combine NYC and NYS data to NY if the file provides them separately)  
* uqMapper - mapping file for fields that should combine to be unique keys for processed files  
* lstFilterMapper - mapping file for filtering to subset (most common is to keep 50 states and DC)  
* vecSelectMapper - mapping file for variables to keep  
* checkControlGroupMapper - mapping file for group_by() of control total checks  
* checkControlAggMapper - mapping file for numeric variables for control total checks  
* checkSimilarityMapper - mapping file for similarity checks to perform  
* plotSimilarityMaooer - mapping file for fields where differences in universe should be plotted
* keyAggMapper - mapping file for the aggregate-level control total checks to perform  
* perCapMapper - named vector that drives conversion from original field name to per capita field name  
* hhsMapper - named vector that drivers numerical variables to keep (and renaming) from HHS capacity data file
  
These default parameters are maintained in a separate .R file and can be sourced:  
```{r}

source("./Coronavirus_CDC_Daily_Default_Mappings_v002.R")

```

## Example Code Processing
The function is run to download and process the latest CDC case, hospitalization, and death data:  
```{r, fig.height=9, fig.width=9, cache=TRUE}

readList <- list("cdcDaily"="./RInputFiles/Coronavirus/CDC_dc_downloaded_220220.csv", 
                 "cdcHosp"="./RInputFiles/Coronavirus/CDC_h_downloaded_220220.csv", 
                 "vax"="./RInputFiles/Coronavirus/vaxData_downloaded_220220.csv"
                 )
compareList <- list("cdcDaily"=readFromRDS("cdc_daily_220206")$dfRaw$cdcDaily, 
                    "cdcHosp"=readFromRDS("cdc_daily_220206")$dfRaw$cdcHosp, 
                    "vax"=readFromRDS("cdc_daily_220206")$dfRaw$vax
                    )

cdc_daily_220220 <- readRunCDCDaily(thruLabel="Feb 18, 2022", 
                                    downloadTo=lapply(readList, FUN=function(x) if(file.exists(x)) NA else x), 
                                    readFrom=readList,
                                    compareFile=compareList, 
                                    writeLog=NULL, 
                                    useClusters=readFromRDS("cdc_daily_210528")$useClusters, 
                                    weightedMeanAggs=c("tcpm7", "tdpm7", "cpm7", "dpm7", "hpm7", 
                                                       "vxcpm7", "vxcgte65pct"
                                                       ),
                                    skipAssessmentPlots=FALSE, 
                                    brewPalette="Paired"
                                    )

saveToRDS(cdc_daily_220220, ovrWriteError=FALSE)

```
  
The latest hospital data are downloaded:  
```{r, fig.height=9, fig.width=9, cache=TRUE}

# Run for latest data, save as RDS
indivHosp_20220221 <- downloadReadHospitalData(loc="./RInputFiles/Coronavirus/HHS_Hospital_20220221.csv")
saveToRDS(indivHosp_20220221, ovrWriteError=FALSE)

```
  
The post-processing capabilities are included:  
```{r, fig.height=9, fig.width=9}

# Create pivoted burden data
burdenPivotList_220220 <- postProcessCDCDaily(cdc_daily_220220, 
                                              dataThruLabel="Jan 2022", 
                                              keyDatesBurden=c("2022-01-31", "2021-07-31", 
                                                               "2021-01-31", "2020-07-31"
                                                               ),
                                              keyDatesVaccine=c("2021-12-31", "2021-09-30", 
                                                                "2021-06-30", "2021-03-31"
                                                                ), 
                                              returnData=TRUE
                                              )

```

The hospital summaries are also added:  
```{r, fig.height=9, fig.width=9}

# Can be run only as-needed
dfStateAgeBucket2019 <- readPopStateAge("./RInputFiles/sc-est2019-agesex-civ.csv") %>%
    filterPopStateAge(keyCol="POPEST2019_CIV", keyColName="pop2019") %>%
    bucketPopStateAge(popVar="pop2019")

# Create hospitalized per capita data
hospPerCap_220220 <- hospAgePerCapita(dfStateAgeBucket2019, 
                                      lst=burdenPivotList_220220, 
                                      popVar="pop2019", 
                                      excludeState=c(), 
                                      cumStartDate="2020-07-15"
                                      )

```

The one-page CFR plot capability is included:  
```{r, fig.height=9, fig.width=9}

# Create CFR plots for select states
cfrStates <- list("FL"=list(keyState="FL", minDate="2020-08-01", multDeath=70), 
                  "LA"=list(keyState="LA", minDate="2020-08-01", multDeath=80), 
                  "CA"=list(keyState="CA", minDate="2020-08-01", multDeath=100), 
                  "IL"=list(keyState="IL", minDate="2020-08-01", multDeath=100)
                  )
purrr::walk(cfrStates, .f=function(x) onePageCFRPlot(burdenPivotList_220220$dfPivot, 
                                                     keyState=x$keyState, 
                                                     minDate=x$minDate, 
                                                     multDeath=x$multDeath
                                                     )
            )

```

The peaks and valleys plots are included:  
```{r, fig.height=9, fig.width=9}

# Burden data
cdc_daily_220220$dfPerCapita %>%
    mutate(regn=c(as.character(state.region), "South")[match(state, c(state.abb, "DC"))]) %>%
    makePeakValley(numVar=c("new_deaths", "new_cases", "inp"), 
                   windowWidth = 71, 
                   rollMean=7, 
                   facetVar=c("regn"), 
                   fnNumVar=list("new_deaths"=function(x) x, 
                                 "new_cases"=function(x) x/1000,
                                 "inp"=function(x) x/1000
                                 ), 
                   fnPeak=list("new_deaths"=function(x) x+100, 
                               "new_cases"=function(x) x+10, 
                               "inp"=function(x) x+10
                               ),
                   fnValley=list("new_deaths"=function(x) x-100, 
                                 "new_cases"=function(x) x-5, 
                                 "inp"=function(x) x-5
                                 ),
                   useTitle=c("new_deaths"="US coronavirus deaths", 
                              "new_cases"="US coronavirus cases", 
                              "inp"="US coronavirus total hospitalized"
                              ), 
                   yLab=c("new_deaths"="Rolling 7-day mean deaths", 
                          "new_cases"="Rolling 7-day mean cases (000)", 
                          "inp"="Rolling 7-day mean in hospital (000)"
                          )
                   )


# Vaccinations data for states with 8+ million population
cdc_daily_220220$dfPerCapita %>%
    inner_join(getStateData(), by=c("state")) %>%
    filter(pop >= 8000000) %>%
    select(date, state, vxa, vxc) %>%
    arrange(date, state) %>%
    group_by(state) %>%
    mutate(across(c(vxa, vxc), .fns=function(x) x-lag(x))) %>%
    ungroup() %>%
    mutate(regn=c(as.character(state.region), "South")[match(state, c(state.abb, "DC"))]) %>%
    filter(date >= "2020-12-01") %>%
    makePeakValley(numVar=c("vxc", "vxa"), 
                   windowWidth = 29, 
                   rollMean=21, 
                   facetVar=c("state"), 
                   fnNumVar=list("vxa"=function(x) x/1000, 
                                 "vxc"=function(x) x/1000
                                 ), 
                   fnPeak=list("vxa"=function(x) x+25*max(x, na.rm=TRUE)/400, 
                               "vxc"=function(x) x+25*max(x, na.rm=TRUE)/400
                               ),
                   fnValley=list("vxa"=function(x) x-25*max(x, na.rm=TRUE)/400, 
                                 "vxc"=function(x) x-25*max(x, na.rm=TRUE)/400
                                 ),
                   fnGroupFacet=TRUE,
                   useTitle=c("vxa"="Vaccines adminsitered (US)", 
                              "vxc"="Became fully vaccinated (US)"
                              ), 
                   yLab=c("vxa"="Rolling 21-day mean administered (000)",
                          "vxc"="Rolling 21-day mean completed (000)"
                          )
                   )

```

The hospital utlization plots are included:  
```{r, fig.height=9, fig.width=9}

indivHosp_20220221 %>% 
    filter(state %in% c(state.abb, "DC"), 
           collection_week==max(collection_week)
    ) %>% 
    pull(hospital_pk) %>%
    plotHospitalUtilization(df=indivHosp_20220221, keyHosp=., plotTitle="US Hospitals Summed")

```

