---
title: "CDC Daily by State"
author: "davegoblue"
date: "2022-09-07"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Background
This file is designed to use CDC data to assess coronavirus disease burden by state, including creating and analyzing state-level clusters.

Through March 7, 2021, [The COVID Tracking Project](https://covidtracking.com/) collected and integrated data on tests, cases, hospitalizations, deaths, and the like by state and date.  The latest code for using this data is available in Coronavirus_Statistics_CTP_v004.Rmd.

The COVID Tracking Project suggest that [US federal data sources](https://covidtracking.com/analysis-updates/federal-covid-data-101-how-to-find-data) are now sufficiently robust to be used for analyses that previously relied on COVID Tracking Project.  This code is an attempt to update modules in Coronavirus_Statistics_CTP_v004.Rmd to leverage US federal data.

The code in this module builds on code available in _v004, with function and mapping files updated:  
  
* Generic_Added_Utility_Functions_202105_v001.R - generic functions that can be used in other areas  
* Coronavirus_CDC_Daily_Functions_v001.R - functions specific to coronavirus daily data  
  
Broadly, the CDC data analyzed by this module includes:  
  
* CDC case and death data by state and date are available for download on the [CDC website](https://data.cdc.gov/api/views/9mfq-cb36/rows.csv?accessType=DOWNLOAD)  
* CDC hospital data are available for download on the [healthdata.gov website](https://beta.healthdata.gov/api/views/g62h-syeh/rows.csv?accessType=DOWNLOAD)  
* CDC vaccines data are also available for download on the [CDC website](https://data.cdc.gov/api/views/unsk-b7fc/rows.csv?accessType=DOWNLOAD):  
  
## Functions and Mapping Files
The tidyverse package is loaded and functions are sourced:  
```{r}

# The tidyverse functions are routinely used without package::function format
library(tidyverse)
library(geofacet)

# Functions are available in source file
source("./Generic_Added_Utility_Functions_202105_v001.R")
source("./Coronavirus_CDC_Daily_Functions_v002.R")

```

A series of mapping files are also available to allow for parameterized processing.  Mappings include:  
  
* urlMapper - mapping file for urlType and url location to download data  
* renMapper - mapping file for renaming of variables in the raw data file  
* selfListMapper - mapping file for transformations by variable type  
* fullListMapper - mapping file for transformations across variable types  
* lstComboMapper - mapping file for elements to be combined by data type (most common is to combine NYC and NYS data to NY if the file provides them separately)  
* uqMapper - mapping file for fields that should combine to be unique keys for processed files  
* lstFilterMapper - mapping file for filtering to subset (most common is to keep 50 states and DC)  
* vecSelectMapper - mapping file for variables to keep  
* checkControlGroupMapper - mapping file for group_by() of control total checks  
* checkControlAggMapper - mapping file for numeric variables for control total checks  
* checkSimilarityMapper - mapping file for similarity checks to perform  
* plotSimilarityMaooer - mapping file for fields where differences in universe should be plotted
* keyAggMapper - mapping file for the aggregate-level control total checks to perform  
* perCapMapper - named vector that drives conversion from original field name to per capita field name  
* hhsMapper - named vector that drivers numerical variables to keep (and renaming) from HHS capacity data file
  
These default parameters are maintained in a separate .R file and can be sourced:  
```{r}

source("./Coronavirus_CDC_Daily_Default_Mappings_v002.R")

```

## Example Code Processing
The function is run to download and process the latest CDC case, hospitalization, and death data:  
```{r, fig.height=9, fig.width=9, cache=TRUE}

readList <- list("cdcDaily"="./RInputFiles/Coronavirus/CDC_dc_downloaded_220907.csv", 
                 "cdcHosp"="./RInputFiles/Coronavirus/CDC_h_downloaded_220907.csv", 
                 "vax"="./RInputFiles/Coronavirus/vaxData_downloaded_220907.csv"
                 )
compareList <- list("cdcDaily"=readFromRDS("cdc_daily_220805")$dfRaw$cdcDaily, 
                    "cdcHosp"=readFromRDS("cdc_daily_220805")$dfRaw$cdcHosp, 
                    "vax"=readFromRDS("cdc_daily_220805")$dfRaw$vax
                    )

cdc_daily_220907 <- readRunCDCDaily(thruLabel="Sep 05, 2022", 
                                    downloadTo=lapply(readList, FUN=function(x) if(file.exists(x)) NA else x), 
                                    readFrom=readList,
                                    compareFile=compareList, 
                                    writeLog=NULL, 
                                    useClusters=readFromRDS("cdc_daily_210528")$useClusters, 
                                    weightedMeanAggs=c("tcpm7", "tdpm7", "cpm7", "dpm7", "hpm7", 
                                                       "vxcpm7", "vxcgte65pct"
                                                       ),
                                    skipAssessmentPlots=FALSE, 
                                    brewPalette="Paired"
                                    )
saveToRDS(cdc_daily_220907, ovrWriteError=FALSE)

```
  
The function is run to download and process the latest hospitalization data:  
```{r, fig.height=9, fig.width=9, cache=TRUE}

# Run for latest data, save as RDS
indivHosp_20220907 <- downloadReadHospitalData(loc="./RInputFiles/Coronavirus/HHS_Hospital_20220907.csv")
saveToRDS(indivHosp_20220907, ovrWriteError=FALSE)

```
  
Post-processing is run, including hospital summaries:  
```{r, fig.height=9, fig.width=9, cache=TRUE}

# Create pivoted burden data
burdenPivotList_220907 <- postProcessCDCDaily(cdc_daily_220907, 
                                              dataThruLabel="Aug 2022", 
                                              keyDatesBurden=c("2022-08-31", "2022-02-28", 
                                                               "2021-08-31", "2021-02-28"
                                                               ),
                                              keyDatesVaccine=c("2022-08-31", "2022-03-31", 
                                                                "2021-10-31", "2021-05-31"
                                                                ), 
                                              returnData=TRUE
                                              )

# Create hospitalized per capita data
hospPerCap_220907 <- hospAgePerCapita(readFromRDS("dfStateAgeBucket2019"), 
                                      lst=burdenPivotList_220907, 
                                      popVar="pop2019", 
                                      excludeState=c(), 
                                      cumStartDate="2020-07-15"
                                      )

burdenPivotList_220907$hospAge %>%
    group_by(adultPed, confSusp, age, name) %>%
    summarize(value=sum(value, na.rm=TRUE), n=n(), .groups="drop")

saveToRDS(burdenPivotList_220907, ovrWriteError=FALSE)
saveToRDS(hospPerCap_220907, ovrWriteError=FALSE)

```
  
Peaks and valleys of key metrics are also updated:  
```{r, fig.height=9, fig.width=9, cache=TRUE}

peakValleyCDCDaily(cdc_daily_220907)

```
  
Hospital capacity is updated using a mix of old data (for 2021) and new data:  
```{r, fig.height=9, fig.width=9}

identical(names(indivHosp_20220907), names(readFromRDS("indivHosp_20220704")))

modHospData <- bind_rows(filter(readFromRDS("indivHosp_20220704"), lubridate::year(collection_week)<2022), 
                         filter(indivHosp_20220907, lubridate::year(collection_week)>=2022), 
                         .id="src"
                         )
updated_modStateHosp_20220907 <- hospitalCapacityCDCDaily(modHospData, 
                                                          plotSub="Aug 2020 to Aug 2022\nOld data used pre-2022"
                                                          )

```
  
Data availability by source and time is assessed:  
```{r, fig.height=9, fig.width=9}

# Temporary function to aggregate data
tempCounter <- function(df) {
    df %>%
        select(hospital_pk, collection_week, all_of(names(hhsMapper))) %>%
        colRenamer(vecRename=hhsMapper) %>%
        pivot_longer(-c(hospital_pk, collection_week)) %>%
        filter(!is.na(value), value>0) %>%
        count(collection_week, name)
}

dfTemp <- bind_rows(tempCounter(indivHosp_20220907), tempCounter(readFromRDS("indivHosp_20220704")), .id="src")

dfTemp %>%
    select(collection_week, name) %>%
    unique() %>%
    bind_rows(., ., .id="src")  %>%
    full_join(dfTemp, by=c("src", "collection_week", "name")) %>%
    mutate(src=c("1"="SEP-2022", "2"="JUL-2022")[src]) %>%
    mutate(n=ifelse(is.na(n), 0, n)) %>%
    ggplot(aes(x=collection_week, y=n)) +
    geom_line(aes(group=src, color=src)) + 
    facet_wrap(~name) + 
    labs(title="Number of hospitals in US reporting >0 on metric by week", x=NULL, y="# Hospitals Reporting > 0") + 
    scale_color_discrete("Data Source:")

dfTemp %>%
    select(collection_week, name) %>%
    unique() %>%
    bind_rows(., ., .id="src")  %>%
    full_join(dfTemp, by=c("src", "collection_week", "name")) %>%
    mutate(src=c("1"="SEP-2022", "2"="JUL-2022")[src]) %>%
    mutate(n=ifelse(is.na(n), 0, n)) %>% 
    group_by(collection_week, name) %>% 
    summarize(delta=sum(ifelse(src=="SEP-2022", n, 0)-ifelse(src!="SEP-2022", n, 0)), .groups="drop") %>%
    ggplot(aes(x=collection_week, y=delta)) +
    geom_line(aes(color=case_when(delta>=0 ~ "darkgreen", TRUE ~ "red"))) +
    geom_hline(yintercept=0, lty=2) +
    geom_vline(xintercept=c(as.Date("2021-08-20"), as.Date("2022-06-24")), lty=2) +
    scale_color_identity(NULL) +
    facet_wrap(~name) + 
    labs(title="Delta in Number of hospitals in US reporting >0 on metric by week", 
         subtitle="Trend break dashed lines at 2021-08-20 and 2022-06-24",
         x=NULL, 
         y="Delta in # Hospitals Reporting > 0"
         )
    
```
  
The process is converted to functional form:  
```{r, fig.height=9, fig.width=9}

multiSourceDataCombine <- function(lst, timeVec, keyVar="collection_week", idName="src") {
    
    # FUNCTION ARGUMENTS:
    # lst: list of data frames to be combined
    # timeVec: vector of time cut points (data before timeVec[1] taken from lst[[1]], etc.)
    # keyVar: variable describing time in the data
    # idName: name of column for .id when files combined
    
    # Check list lengths
    if(length(lst)==0) {
        cat("\nEmpty list passed, returning 0x0 tibble\n")
        return(tibble::tibble())
    } else if (length(lst)==1) {
        cat("\nList of length 1 passed, returning item in list as-is")
        return(lst[[1]])
    }
    
    # Check that timeVec matches
    if(length(lst) != length(timeVec) + 1) stop("\nMismatch of lst and timeVec\n")
    
    # Check that all data frames have the same column names in the same order
    vecNames <- names(lst[[1]])
    for(n in 2:length(lst)) if(!isTRUE(identical(names(lst[[n]]), vecNames))) stop("\nName mismatch in files\n")
    
    # Combine data
    bind_rows(lst, .id=idName) %>%
        mutate(srcNum=as.integer(get(idName)), 
               dateMin=ifelse(srcNum==1, NA, timeVec[srcNum-1]), 
               dateMax=ifelse(srcNum==max(srcNum), NA, timeVec[srcNum])
               ) %>%
        filter(is.na(dateMin) | get(keyVar) >= dateMin, 
               is.na(dateMax) | get(keyVar) < dateMax
               ) %>%
        select(-srcNum, -dateMin, -dateMax)
    
}

# Create modified hospital data
multiSourceHosp_20220902 <- multiSourceDataCombine(list(readFromRDS("indivHosp_20220704"), 
                                                        indivHosp_20220907
                                                        ), 
                                                   timeVec=as.Date("2022-01-01")
                                                   )

# Confirm that function produces expected output
multiSourceHosp_20220902 %>%
    select(-src) %>%
    identical(modHospData %>% select(-src))

```
  
The updated hospital data are then plotted:
```{r, fig.height=9, fig.width=9, cache=TRUE}

# Run hospital plots
modStateHosp_20220902 <- hospitalCapacityCDCDaily(multiSourceHosp_20220902, 
                                                  plotSub="Aug 2020 to Aug 2022\nOld data used pre-2022"
                                                  )

```
  
## Data Refreshes
### _Data From 2022-10-02_
The latest CDC case, hospitalization, and death data are downloaded and processed:  
```{r, fig.height=9, fig.width=9, cache=TRUE}

readList <- list("cdcDaily"="./RInputFiles/Coronavirus/CDC_dc_downloaded_221002.csv", 
                 "cdcHosp"="./RInputFiles/Coronavirus/CDC_h_downloaded_221002.csv", 
                 "vax"="./RInputFiles/Coronavirus/vaxData_downloaded_221002.csv"
                 )
compareList <- list("cdcDaily"=readFromRDS("cdc_daily_220907")$dfRaw$cdcDaily, 
                    "cdcHosp"=readFromRDS("cdc_daily_220907")$dfRaw$cdcHosp, 
                    "vax"=readFromRDS("cdc_daily_220907")$dfRaw$vax
                    )

cdc_daily_221002 <- readRunCDCDaily(thruLabel="Sep 30, 2022", 
                                    downloadTo=lapply(readList, FUN=function(x) if(file.exists(x)) NA else x), 
                                    readFrom=readList,
                                    compareFile=compareList, 
                                    writeLog=NULL, 
                                    useClusters=readFromRDS("cdc_daily_210528")$useClusters, 
                                    weightedMeanAggs=c("tcpm7", "tdpm7", "cpm7", "dpm7", "hpm7", 
                                                       "vxcpm7", "vxcgte65pct"
                                                       ),
                                    skipAssessmentPlots=FALSE, 
                                    brewPalette="Paired"
                                    )
saveToRDS(cdc_daily_221002, ovrWriteError=FALSE)

```
  
The function is run to download and process the latest hospitalization data:  
```{r, fig.height=9, fig.width=9, cache=TRUE}

# Run for latest data, save as RDS
indivHosp_20221003 <- downloadReadHospitalData(loc="./RInputFiles/Coronavirus/HHS_Hospital_20221003.csv")
saveToRDS(indivHosp_20221003, ovrWriteError=FALSE)

```
  
Post-processing is run, including hospital summaries:  
```{r, fig.height=9, fig.width=9, cache=TRUE}

# Create pivoted burden data
burdenPivotList_221002 <- postProcessCDCDaily(cdc_daily_221002, 
                                              dataThruLabel="Sep 2022", 
                                              keyDatesBurden=c("2022-09-30", "2022-03-31", 
                                                               "2021-09-30", "2021-03-31"
                                                               ),
                                              keyDatesVaccine=c("2022-09-28", "2022-03-31", 
                                                                "2021-09-30", "2021-03-31"
                                                                ), 
                                              returnData=TRUE
                                              )

# Create hospitalized per capita data
hospPerCap_221002 <- hospAgePerCapita(readFromRDS("dfStateAgeBucket2019"), 
                                      lst=burdenPivotList_221002, 
                                      popVar="pop2019", 
                                      excludeState=c(), 
                                      cumStartDate="2020-07-15"
                                      )

burdenPivotList_221002$hospAge %>%
    group_by(adultPed, confSusp, age, name) %>%
    summarize(value=sum(value, na.rm=TRUE), n=n(), .groups="drop")

saveToRDS(burdenPivotList_221002, ovrWriteError=FALSE)
saveToRDS(hospPerCap_221002, ovrWriteError=FALSE)

```
  
