---
title: "Coronavirus US - Data Updates"
author: "davegoblue"
date: "11/8/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Background
This file is designed to analyze coronavirus data from a single state using three data sources:  
  
* [The COVID Tracking Project](https://covidtracking.com/) contains state-level data for cases, deaths, tests, and hospitalizations  
* [USA Facts](https://usafacts.org/visualizations/coronavirus-covid-19-spread-map/) contains county-level data for cases, deaths, and population  
* [CDC Weekly Deaths by Jurisdiction](https://catalog.data.gov/dataset/weekly-counts-of-deaths-by-jurisdiction-and-age-group) contains state-level data for total deaths by age cohort  
  
Code for processing data from each of these sources is available in:  
  
* Coronavirus_Statistics_CTP_v003  
* Coronavirus_Statistics_USAF_v003  
* Coronavirus_Statistics_CDC_v003  
  
The goal of this file is to download updated data for the three main data sources, and to explore the performance of the segments as measured against the new data.

Functions are sourced and a variable mapping file is created:  
```{r}

# All functions assume that tidyverse and its components are loaded and available
# Other functions are declared in the sourcing files or use library::function()
library(tidyverse)

# If the same function is in both files, use the version from the more specific source
source("./Coronavirus_Statistics_Functions_Shared_v003.R")
source("./Coronavirus_Statistics_Functions_CTP_v003.R")
source("./Coronavirus_Statistics_Functions_USAF_v003.R")
source("./Coronavirus_Statistics_Functions_CDC_v003.R")

# Create a variable mapping file
varMapper <- c("cases"="Cases", 
               "newCases"="Increase in cases, most recent 30 days",
               "casesroll7"="Rolling 7-day mean cases", 
               "deaths"="Deaths", 
               "newDeaths"="Increase in deaths, most recent 30 days",
               "deathsroll7"="Rolling 7-day mean deaths", 
               "cpm"="Cases per million",
               "cpm7"="Cases per day (7-day rolling mean) per million", 
               "newcpm"="Increase in cases, most recent 30 days, per million",
               "dpm"="Deaths per million", 
               "dpm7"="Deaths per day (7-day rolling mean) per million", 
               "newdpm"="Increase in deaths, most recent 30 days, per million", 
               "hpm7"="Currently Hospitalized per million (7-day rolling mean)", 
               "tpm"="Tests per million", 
               "tpm7"="Tests per million per day (7-day rolling mean)"
               )

```
  
#### _Data Updates (early November)_  
New data from COVID Tracking Project are downloaded and assessed against the existing state-level segments:  
```{r cache=TRUE}

# Use existing segments with updated data
locDownload <- "./RInputFiles/Coronavirus/CV_downloaded_201108.csv"
test_old_201108 <- readRunCOVIDTrackingProject(thruLabel="Nov 7, 2020", 
                                               downloadTo=if (file.exists(locDownload)) NULL else locDownload,
                                               readFrom=locDownload, 
                                               compareFile=readFromRDS("test_hier5_201025")$dfRaw,
                                               useClusters=readFromRDS("test_hier5_201025")$useClusters
                                               )
saveToRDS(test_old_201108, ovrWriteError=FALSE)

```
  
Cases appear to be spiking in some of the states in the segment that had previously been less impacted.  Hospitalizations in aggregate in this segment are starting to slope upwards, though not yet at the same rate as the increase in cases.

New data from USA Facts are downloaded and assessed against the existing county-level segments:  
```{r cache=TRUE}

# Locations for the population, case, and death file
popLoc <- "./RInputFiles/Coronavirus/covid_county_population_usafacts.csv"
caseLoc <- "./RInputFiles/Coronavirus/covid_confirmed_usafacts_downloaded_20201109.csv"
deathLoc <- "./RInputFiles/Coronavirus/covid_deaths_usafacts_downloaded_20201109.csv"

# Run old segments against new data
cty_old_20201109 <- readRunUSAFacts(maxDate="2020-11-07", 
                                    popLoc=popLoc, 
                                    caseLoc=caseLoc, 
                                    deathLoc=deathLoc, 
                                    dlCaseDeath=!(file.exists(caseLoc) & file.exists(deathLoc)),
                                    oldFile=readFromRDS("cty_20201026")$dfBurden, 
                                    existingCountyClusters=readFromRDS("cty_20201026")$clustVec
                                    )
saveToRDS(cty_old_20201109, ovrWriteError=FALSE)

```

Cases appear to be growing in many of the county clusters, though deaths per million per day remain well below the peaks observed in April in the earlier-hit counties.

Next, all-cause death data from the CDC are downloaded and assessed:  
```{r cache=TRUE}

# Use data that have previously been downloaded
cdcLoc <- "Weekly_counts_of_deaths_by_jurisdiction_and_age_group_downloaded_20201110.csv"
cdcList_20201110 <- readRunCDCAllCause(loc=cdcLoc, 
                                       startYear=2015, 
                                       curYear=2020,
                                       weekThru=36, 
                                       startWeek=9, 
                                       lst=readFromRDS("test_old_201108"), 
                                       epiMap=readFromRDS("epiMonth"), 
                                       agePopData=readFromRDS("usPopBucket2020"), 
                                       cvDeathThru="2020-09-05", 
                                       cdcPlotStartWeek=10, 
                                       dlData=!file.exists(paste0("./RInputFiles/Coronavirus/", cdcLoc))
                                       )

saveToRDS(cdcList_20201110, ovrWriteError=FALSE)

```

