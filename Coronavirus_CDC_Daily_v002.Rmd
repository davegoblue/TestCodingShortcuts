---
title: "CDC Daily by State"
author: "davegoblue"
date: "5/27/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Background
This file is designed to use CDC data to assess coronavirus disease burden by state, including creating and analyzing state-level cluters.

Through March 7, 2021, [The COVID Tracking Project](https://covidtracking.com/) collected and integrated data on tests, cases, hospitalizations, deaths, and the like by state and date.  The latest code for using this data is available in Coronavirus_Statistics_CTP_v004.Rmd.

The COVID Tracking Project suggest that [US federal data sources](https://covidtracking.com/analysis-updates/federal-covid-data-101-how-to-find-data) are now sufficiently robust to be used for analyses that previously relied on COVID Tracking Project.  This code is an attempt to update modules in Coronavirus_Statistics_CTP_v004.Rmd to leverage US federal data.

The code in this module builds on code available in _v001, and splits many functions in to two main .R files that can be sourced:  
  
* Generic_Added_Utility_Functions_202105_v001.R - generic functions that can be used in other areas  
* Coronavirus_CDC_Daily_Functions_v001.R - functions specific to coronavirus daily data  
  
Broadly, the CDC data analyzed by this module includes:  
  
* CDC case and death data by state and date are available for download on the [CDC website](https://data.cdc.gov/api/views/9mfq-cb36/rows.csv?accessType=DOWNLOAD)  
* CDC hospital data are available for download on the [healthdata.gov website](https://beta.healthdata.gov/api/views/g62h-syeh/rows.csv?accessType=DOWNLOAD)  
  
## Functions and Mapping Files
The tidyverse package is loaded and functions are sourced:  
```{r}

# The tidyverse functions are routinely used without package::function format
library(tidyverse)

# Functions are available in source file
source("./Generic_Added_Utility_Functions_202105_v001.R")
source("./Coronavirus_CDC_Daily_Functions_v001.R")

```

A series of mapping files are also available to allow for parameterized processing.  Mappings include:  
  
* urlMapper - mapping file for urlType and url location to download data  
* renMapper - mapping file for renaming of variables in the raw data file  
* selfListMapper - mapping file for transformations by variable type  
* fullListMapper - mapping file for transformations across variable types  
* lstComboMapper - mapping file for elements to be combined by data type (most common is to combine NYC and NYS data to NY if the file provides them separately)  
* uqMapper - mapping file for fields that should combine to be unique keys for processed files  
* lstFilterMapper - mapping file for filtering to subset (most common is to keep 50 states and DC)  
* vecSelectMapper - mapping file for variables to keep  
* checkControlGroupMapper - mapping file for group_by() of control total checks  
* checkControlAggMapper - mapping file for numeric variables for control total checks  
* checkSimilarityMapper - mapping file for similarity checks to perform  
* plotSimilarityMaooer - mapping file for fields where differences in universe should be plotted
* keyAggMapper - mapping file for the aggregate-level control total checks to perform  
* perCapMapper - named vector that drives conversion from original field name to per capita field name  
  
These default parameters are maintained in a separate .R file and can be sourced:  
```{r}

source("./Coronavirus_CDC_Daily_Default_Mappings_v002.R")

```

Additionally, a mapping file could be maintained to give default plotting labels to variables.  This is currently not used by any of the sourced functions:  
```{r}

# Create a variable mapping file - this is currently redundant
varMapper <- c()

```

## Example for Comparison to Previous
Code from the previous model is run, with results compared to previous results:  
```{r, fig.height=9, fig.width=9}

readList <- list("cdcDaily"="./RInputFiles/Coronavirus/CDC_dc_downloaded_210502.csv", 
                 "cdcHosp"="./RInputFiles/Coronavirus/CDC_h_downloaded_210509.csv"
                 )

cdc_daily_compare <- readRunCDCDaily(thruLabel="May 2, 2021", 
                                     readFrom=readList, 
                                     compareFile=list("cdcDaily"=colRenamer(readFromRDS("dfRaw_dc_210414"),
                                                                            c('new_case'='new_cases', 
                                                                              'tot_death'='tot_deaths',
                                                                              'new_death'='new_deaths'
                                                                              )
                                                                            ), 
                                                      "cdcHosp"=readFromRDS("dfHosp_old")
                                                      ), 
                                     writeLog="./RInputFiles/Coronavirus/Coronavirus_CDC_Daily_v002.log", 
                                     ovrwriteLog=TRUE, 
                                     dfPerCapita=NULL, 
                                     useClusters=readFromRDS("cdc_daily_test_v2")$useClusters, 
                                     skipAssessmentPlots=FALSE, 
                                     brewPalette="Paired"
                                     )

identical(cdc_daily_compare[c("stateData", "dfRaw", "dfProcess", "dfPerCapita", "useClusters")],
          readFromRDS("cdc_daily_test_v3")[c("stateData", "dfRaw", "dfProcess", "dfPerCapita", "useClusters")]
          )
identical(cdc_daily_compare$plotDataList[c("dfFull", "dfAgg", "plotClusters")],
          readFromRDS("cdc_daily_test_v3")$plotDataList[c("dfFull", "dfAgg", "plotClusters")]
          )

```

The core data elements are identical, and the plots appear to convey the same information.  Next steps are to download the latest data and process with existing clusters.

Updated data are downloaded and processed, using existing segments.  The downloadTo argument is edited using lapply to avoid downloading data if it has previously been downloaded:  
```{r, fig.height=9, fig.width=9, cache=TRUE}

readList <- list("cdcDaily"="./RInputFiles/Coronavirus/CDC_dc_downloaded_210528.csv", 
                 "cdcHosp"="./RInputFiles/Coronavirus/CDC_h_downloaded_210528.csv"
                 )
compareList <- list("cdcDaily"=readFromRDS("cdc_daily_test_v3")$dfRaw$cdcDaily, 
                    "cdcHosp"=readFromRDS("cdc_daily_test_v3")$dfRaw$cdcHosp
                    )

cdc_daily_210528 <- readRunCDCDaily(thruLabel="May 28, 2021", 
                                    downloadTo=lapply(readList, FUN=function(x) if(file.exists(x)) NA else x), 
                                    readFrom=readList,
                                    compareFile=compareList, 
                                    writeLog="./RInputFiles/Coronavirus/Coronavirus_CDC_Daily_210528.log", 
                                    useClusters=readFromRDS("cdc_daily_test_v2")$useClusters, 
                                    skipAssessmentPlots=FALSE, 
                                    brewPalette="Paired"
                                    )

saveToRDS(cdc_daily_210528, ovrWrite=FALSE, ovrWriteError=FALSE)

```

The process appears to work as intended.  Next steps are to update the county-level data process, making use of some of the functions available for CDC data processing.

The latest version of the data are downloaded and processed:  
```{r, fig.height=9, fig.width=9, cache=TRUE}

readList <- list("cdcDaily"="./RInputFiles/Coronavirus/CDC_dc_downloaded_210708.csv", 
                 "cdcHosp"="./RInputFiles/Coronavirus/CDC_h_downloaded_210708.csv"
                 )
compareList <- list("cdcDaily"=readFromRDS("cdc_daily_210528")$dfRaw$cdcDaily, 
                    "cdcHosp"=readFromRDS("cdc_daily_210528")$dfRaw$cdcHosp
                    )

cdc_daily_210708 <- readRunCDCDaily(thruLabel="Jul 08, 2021", 
                                    downloadTo=lapply(readList, FUN=function(x) if(file.exists(x)) NA else x), 
                                    readFrom=readList,
                                    compareFile=compareList, 
                                    writeLog="./RInputFiles/Coronavirus/Coronavirus_CDC_Daily_210708.log", 
                                    useClusters=readFromRDS("cdc_daily_210528")$useClusters, 
                                    skipAssessmentPlots=FALSE, 
                                    brewPalette="Paired"
                                    )

saveToRDS(cdc_daily_210708, ovrWrite=FALSE, ovrWriteError=FALSE)

```

Vaccines data are also available for download on the [CDC website](https://data.cdc.gov/api/views/unsk-b7fc/rows.csv?accessType=DOWNLOAD):  
```{r cache=TRUE}

urlVaccine <- "https://data.cdc.gov/api/views/unsk-b7fc/rows.csv?accessType=DOWNLOAD"
locVaccine <- "./RInputFiles/Coronavirus/CDC_vax_downloaded_210712.csv"

fileDownload(locVaccine, urlVaccine)

```

The file has many fields, including:  
  
* Location - state abbreviation
* Date - date of reporting
* MMWR_week - epidemiological week
* Administered - total doses administered
* Administered_[12Plus|18Plus|65Plus] - age breakdown of administered doses  
* Admin_per_100k - per capita doses administered  
* Admin_per_100k_[12Plus|18Plus|65Plus] - per capita administered doses by age bucket  
* Recip_Administered - total number of administered vaccines based on jurisdiction of residence  
* Series_Complete_Yes - number of people fully vaccinated  
* Series_Complete_[12Plus|18Plus|65Plus] - age breakdown of fully vaccinated  
* Series_Complete_Pop_Pct - percent of population fully vaccinated  
* Series_Complete_[12Plus|18Plus|65Plus]Pop_Pct - fully vaccinated percent by age bucket  
  
An individual can live in one state but be vaccinated in another state.  Per the [CDC field descriptions](https://data.cdc.gov/Vaccinations/COVID-19-Vaccinations-in-the-United-States-Jurisdi/unsk-b7fc):  
  
* Administered - based on state of receiving vaccine  
* Recip_Administered - based on state where recipient lives  
* Administered_[age] - based on state where recipient lives  
* Admin_per_100k and Admin_per_100k_[age] - based on state where recipient lives  
* Series_Complete[all] - based on state where recipient lives  
  
Fully vaccinated (series complete) metrics is defined as "Total number of people who are fully vaccinated (have second dose of a two-dose vaccine or one dose of a single-dose vaccine) based on the jurisdiction where recipient lives"
  
```{r}

vaxRaw_210712 <- fileRead(locVaccine)
glimpse(vaxRaw_210712)

vaxRenamer <- c("Location"="state", 
                "Date"="date", 
                "Admin_Per_100K"="Admin_Per_100k"
                )
vaxKeeper <- c("state", "date", "MMWR_week", 
               "Administered", "Administered_12Plus", "Administered_18Plus", "Administered_65Plus", 
               "Admin_Per_100k", "Admin_Per_100k_12Plus", "Admin_Per_100k_18Plus", "Admin_Per_100k_65Plus", 
               "Recip_Administered", 
               "Series_Complete_Yes", 
               "Series_Complete_12Plus", "Series_Complete_18Plus", "Series_Complete_65Plus",
               "Series_Complete_Pop_Pct",
               "Series_Complete_12PlusPop_Pct", "Series_Complete_18PlusPop_Pct", "Series_Complete_65PlusPop_Pct"
               )

vaxProcessed_210712 <- vaxRaw_210712 %>%
    colRenamer(vecRename=vaxRenamer) %>%
    colSelector(vecSelect=vaxKeeper) %>%
    colMutater(selfList=list("date"=lubridate::mdy))
glimpse(vaxProcessed_210712)

```
  
Counts by state are created:  
```{r, fig.height=9, fig.width=9}

vaxState <- vaxProcessed_210712 %>%
    group_by(state) %>%
    filter(date==max(date)) %>%
    select(state, date, Administered, Recip_Administered, Series_Complete_Yes) %>%
    ungroup() %>%
    arrange(-Administered)
vaxState
vaxState %>%
    filter(!(state %in% c(state.abb, "DC")))
vaxState %>%
    filter(!(state == "US")) %>%
    mutate(pctComplete=Series_Complete_Yes/sum(Series_Complete_Yes)) %>%
    mutate(is50DC=state %in% c(state.abb, "DC")) %>%
    group_by(is50DC) %>%
    summarize(n=n(), across(where(is.numeric), sum), .groups="drop")

vaxProcessed_210712 %>%
    filter(state=="US") %>%
    select(state, date, Administered, Recip_Administered, Series_Complete_Yes) %>%
    pivot_longer(-c(state, date)) %>%
    ggplot(aes(x=date, y=value/1000000)) + 
    geom_line(aes(group=name, color=name)) + 
    labs(x="", y="Number of Doses/People (millions)", title="All-US Vaccination totals")
    
```
  
* Shots administered in LTC are being tracked back to the location where the recipient lives  
* Shots administered by VA, DOD, Indian Health, etc., do not appear to map back to one of the 50 states or DC  
* Data for territories are included  
* A US total is included  
  
Roughly 5% of completely vaccinated individuals are tracked to entities that do not map back to states.  These will be deleted for further analysis, which may lead to some disconnects.

Next steps are to continue processing the data and to integrate with the other state-level metrics.

Implied populations and vaccinations by subgroup are calculated:  
```{r, fig.height=9, fig.width=9}

vaxImplied_210712 <- vaxProcessed_210712 %>%
    mutate(popTot=100*Series_Complete_Yes/Series_Complete_Pop_Pct, 
           pop65Plus=100*Series_Complete_65Plus/Series_Complete_65PlusPop_Pct, 
           pop18Plus=100*Series_Complete_18Plus/Series_Complete_18PlusPop_Pct, 
           pop12Plus=100*Series_Complete_12Plus/Series_Complete_12PlusPop_Pct, 
           pop1864=pop18Plus-pop65Plus,
           pop1217=pop12Plus-pop18Plus,
           pop0011=popTot-pop12Plus, 
           vax65Plus=Series_Complete_65Plus,
           vax1864=Series_Complete_18Plus-Series_Complete_65Plus,
           vax1217=Series_Complete_12Plus-Series_Complete_18Plus,
           vax0011=Series_Complete_Yes-Series_Complete_12Plus
           )

popData <- vaxImplied_210712 %>%
    filter(state %in% c(state.abb, "DC", "PR", "US")) %>%
    group_by(state) %>%
    summarize(across(.cols=c(pop65Plus, pop1864, pop1217, pop0011), 
                     .fns=list(mu=~mean(.x, na.rm=TRUE), 
                               sdmu=~sd(.x, na.rm=TRUE)/mean(.x, na.rm=TRUE),
                               rangemu=~diff(range(.x, na.rm=TRUE)/mean(.x, na.rm=TRUE))
                               )
                     ), 
              .groups="drop"
              )

popData %>%
    select(state, contains("_rangemu")) %>%
    pivot_longer(-state) %>%
    ggplot(aes(x=fct_reorder(state, value, .fun=max), y=value)) + 
    geom_point() + 
    coord_flip() + 
    facet_wrap(~name, nrow=1) + 
    labs(y="Range divided by mean", x=NULL, title="Consistency of population estimates by subgroup and state")

popData %>%
    select(state, contains("_mu")) %>%
    pivot_longer(-state) %>%
    group_by(state) %>%
    mutate(pct65Plus=sum(ifelse(name=="pop65Plus_mu", value, 0))/sum(value)) %>%
    ungroup() %>%
    ggplot(aes(x=fct_reorder(state, pct65Plus), y=value)) + 
    geom_col(aes(fill=name), position="fill") +
    coord_flip() +
    scale_fill_discrete("") +
    labs(y="Proportion of population", x=NULL, title="Population breakout by state")

vaxImplied_210712 %>%
    filter(state=="US") %>%
    select(state, date, starts_with("vax")) %>%
    pivot_longer(-c(state, date)) %>%
    ggplot(aes(x=date, y=value)) + 
    geom_line(aes(group=name, color=name))

vaxImplied_210712 %>%
    filter(state=="US") %>%
    select(state, date, starts_with("vax")) %>%
    pivot_longer(-c(state, date)) %>% 
    mutate(eq0=(value==0), lt0=(value<0)) %>%
    filter(value<=0) %>%
    group_by(eq0, lt0, name) %>% 
    summarize(across(date, .fns=list(min=min, max=max)), .groups="drop")

```

Population estimates are generally consistent by state across dates, with the greatest variability in the 12-17 age estimates (expected since it is the smallest group where rounded percent vaccinated would have the most impact).

Distributions by age and state appear reasonable.

There has clearly been a change in tracking where fully vaccinated are tracked using age buckets:  
  
* 2020-12-13 through 2021-03-04 has no age breakouts  
* 2021-03-05 through 2021-05-12 has no age breakouts for 12-17 years old  
  
Next steps are to modify code so that subtotal statistics by age bucket are used only when where appropriate.

The availability of fields for state 'US' (full nation) is explored:  
```{r, fig.height=9, fig.width=9}

vaxProcessed_210712 %>%
    filter(state=="US") %>%
    pivot_longer(-c(state, date)) %>%
    mutate(valType=case_when(value < 0 ~ "red", value==0 ~ "orange", value > 0 ~ "green")) %>%
    ggplot(aes(x=date, y=fct_reorder(name, valType=="green", .fun=sum), fill=valType)) + 
    geom_tile() +
    scale_fill_identity() + 
    labs(x=NULL, y=NULL, title="Data availability by metric", subtitle="Red is negative, orange is zero")

```

In the early months, data are available only for administration.  The "series complete" metrics are introduced later, with the 12Plus bucket added even later as authorizations for use in ages 12-17 were added.

A comparison of states/DC to US is made for each of the key metrics:  
```{r, fig.height=9, fig.width=9}

vaxProcessed_210712 %>%
    mutate(stateType=case_when(state=="US" ~ "US", state %in% c(state.abb, "DC") ~ "state/DC", TRUE ~ "other")) %>%
    group_by(stateType, date, MMWR_week) %>%
    summarize(across(where(is.numeric), .fns=sum), .groups="drop") %>%
    pivot_longer(-c(stateType, date, MMWR_week)) %>%
    filter(!(str_detect(name, "Per|Pct"))) %>%
    ggplot(aes(x=date, y=value)) + 
    geom_line(aes(group=stateType, color=stateType)) + 
    facet_wrap(~name, scales="free_y")

```
  
In general, the sum of the states and DC are close to the total for US.  Per capita and percentage metrics cannot be summed and were not compared directly.

Next steps are to adapt the population splits to account for the variable timing of initial data availability  A heuristic can likely be used for the split of 65Plus in the early days, with 12Plus and 18Plus assumed to be equal (no usage in 0-17 group) prior to age being broken out.
