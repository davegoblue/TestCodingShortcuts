---
title: "Coronavirus US - CDC"
author: "davegoblue"
date: "06/23/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
  
## Background  
This module extends code contained in Coronavirus_Statistics_v003.Rmd to include 2020-2021 data.  This file includes the latest code for analyzing all-cause death data from [CDC Weekly Deaths by Jurisdiction](https://catalog.data.gov/dataset/weekly-counts-of-deaths-by-jurisdiction-and-age-group).  CDC maintains data on deaths by week, age cohort, and state in the US.  Downloaded data are unique by state, epidemiological week, year, age, and type (actual vs. predicted/projected).

These data are known to have a lag between death and reporting, and the CDC back-correct to report deaths at the time the death occurred even if the death is reported in following weeks.  This means totals for recent weeks tend to run low (lag), and the CDC run a projection of the expected total number of deaths given the historical lag times.  Per other analysts on the internet, there is currently significant supra-lag, with lag times much longer than historical averages causing CDC projected deaths for recent weeks to be low.

Functions for the previous module are available in Coronavirus_Statistics_Functions_CDC_v003.R and Coronavirus_Statistics_Functions_Shared_v003.R.  The appropriate subset of these functions are copied and edited for use in this module.  The code leverages tidyverse and a variable mapping file throughout:  
```{r}

# All functions assume that tidyverse and its components are loaded and available
library(tidyverse)

# If the same function is in both files, use the version from the more specific source
source("./Generic_Added_Utility_Functions_202105_v001.R")
# source("./Coronavirus_Statistics_Functions_USAF_v003.R")

```
  
## Running Code  
The main function is readRunCDCAllCause(), which performs multiple tasks:  
  
STEP 0: Optionally, downloads the latest data file from CDC
STEP 1: Reads and processes a data file has been downloaded from CDC to local  
STEP 2: Extract relevant data from a processed state-level COVID Tracking Project list  
STEP 3: Basic plots of the CDC data  
STEP 4: Basic excess-deaths analysis  
STEP 5: Create cluster-level aggregate plots  
STEP 6: Create state-level aggregate plots  
STEP 7: Create age-cohort aggregate plots  
STEP 8: Returns a list of key data frames, modeling objects, named cluster vectors, etc.  
  
#### _Modifications: Main function_  
The main function to be edited is readRunCDCAllCause():  
```{r}

# Function to read and run the CDC all-cause deaths analysis
readRunCDCAllCause <- function(loc, 
                               startYear, 
                               curYear,
                               weekThru, 
                               startWeek, 
                               lst, 
                               cvDeathThru,
                               epiMap=readFromRDS("epiMonth"),
                               agePopData=readFromRDS("usPopBucket2020"),
                               cdcPlotStartWeek=startWeek,
                               periodKeep=paste0(startYear, "-", curYear-1), 
                               url="https://data.cdc.gov/api/views/y5bj-9g5w/rows.csv?accessType=DOWNLOAD",
                               dlData=isFALSE(file.exists(paste0(dir, loc))), 
                               dir="./RInputFiles/Coronavirus/", 
                               stateNoCheck=c()
                               ) {
    
    # FUNCTION ARGUMENTS:
    # loc: the CDC .csv file name (without path)
    # startYear: the starting year in the CDC data
    # curYear: the current analyis year in the CDC data
    # weekThru: how many weeks of the current year are the data valid thru?
    # startWeek: the starting week to use for cumulative sum of difference in expected all-cause deaths
    # lst: a state clustering process output list
    # epiMap: a mapping file of ew-month-quarter that mas epiweek (ew) to an appropriate month and quarter
    # agePopData: data containing US population as age (fct) - pop (int)
    # cvDeathThru: the date to use for pulling the CV death data
    # cdcPlotStartWeek: start week for CDC plots (10 is March which avoids a 1-week February outlier)
    # periodKeep: the period of previous data in the CDC all-cause deaths file (should be kept regardless)
    # url: the url for downloading CDC data
    # dlData: should CDC data be downloaded?  default is to not overwrite an existing file
    # dir: the CDC .csv directory (will use paste0(dir, loc) as the file location)
    # stateNoCheck: vector of states that should not error out for failing suppression checks
    
    # STEP 0: Download CDC data if requested
    if (dlData) fileDownload(fileName=paste0(dir, loc), url=url)
    
    return()
    
    # STEP 1: Read and process the CDC data
    cdc <- readProcessCDC(loc, weekThru=weekThru, periodKeep=periodKeep, fDir=dir, stateNoCheck=stateNoCheck)
    
    # STEP 2: Create the key data required for using state-level clusters
    clusterList <- helperKeyStateClusterMetrics(lst)
    
    # STEP 3: Generate plots of the processed CDC data
    cdcBasicPlots(cdc, clustVec=clusterList$clData, stateExclude=stateNoCheck)

    # Exclude stateNoCheck states
    cat("\nPlots will be run after excluding stateNoCheck states\n")
    cdcUse <- cdc %>% filter(!(state %in% stateNoCheck))
    
    # STEP 4: Full US excess deaths
    list_allUS <- cdcCohortAnalysis(cohortName="all US", 
                                    df=cdcUse,
                                    curYear=curYear, 
                                    startYear=startYear,
                                    startWeek=startWeek,
                                    plotTitle="All-cause US total deaths",
                                    predActualPlotsOnePage=TRUE
    )
    # cat("\n\n\n*** THROUGH STEP 4 ***\n\n\n")
    
    # STEP 5: Generate cluster-level aggregate plots
    clusterAgg <- cdcAggregateSummary(df=cdcUse, 
                                      critVar="state", 
                                      critSubsets=clusterList$stateCluster,
                                      startWeek=startWeek, 
                                      critListNames=paste0("cluster ", 1:length(clusterList$stateCluster)),
                                      factorCritList=FALSE,
                                      popData=clusterList$pop,
                                      cvDeathData=clusterList$deaths,
                                      idVarName="cluster"
    )
    # cat("\n\n\n*** THROUGH STEP 5 ***\n\n\n")
    
    # STEP 6: Generate state-level aggregate data, then plot
    stateAgg <- cdcAggregateSummary(df=cdcUse, 
                                    critVar="state", 
                                    critSubsets=setdiff(names(clusterList$clData), stateNoCheck),
                                    startWeek=startWeek, 
                                    idVarName="state", 
                                    subListNames=setdiff(names(clusterList$clData), stateNoCheck),
                                    showAllPlots=FALSE
    )
    # cat("\n\n\n*** THROUGH STEP 6a ***\n\n\n")
    
    helperKeyStateExcessPlots(df=stateAgg, 
                              epiMonth=epiMap,
                              cvDeaths=lst$consolidatedPlotData,
                              startWeek=cdcPlotStartWeek,
                              cvDeathDate=as.Date(cvDeathThru),
                              subT=paste0("CDC data through week ", weekThru, " of ", curYear)
    )
    # cat("\n\n\n*** THROUGH STEP 6b ***\n\n\n")
    
    # STEP 7: Generate age-level aggregate data, then plot
    ageAgg <- cdcAggregateSummary(df=cdcUse, 
                                  critVar="age", 
                                  critSubsets=levels(cdc$age),
                                  startWeek=startWeek, 
                                  idVarName="age", 
                                  subListNames=levels(cdc$age),
                                  showAllPlots=TRUE
    )
    helperKeyAgeExcessPlots(df=ageAgg, 
                            epiMonth=epiMap,
                            cvDeaths=lst$consolidatedPlotData,
                            popData=agePopData,
                            startWeek=cdcPlotStartWeek,
                            cvDeathDate=as.Date(cvDeathThru),
                            subT=paste0("CDC data through week ", weekThru, " of ", curYear)
    )
    
    # STEP 8: Return a list of key files
    list(cdc=cdc, 
         clusterList=clusterList, 
         allUSAgg=list_allUS$preds,
         clusterAgg=clusterAgg, 
         stateAgg=stateAgg, 
         ageAgg=ageAgg
    )
    
}


```

#### _Modifications: Additional functions_  
The data are initially run to download the latest CDC data:  
```{r cache=TRUE}

cdcLoc <- "Weekly_counts_of_deaths_by_jurisdiction_and_age_group_downloaded_20210623.csv"
readRunCDCAllCause(loc=cdcLoc)

```

The data are inspected to check that they are sufficient for the next steps:  
```{r, fig.height=9, fig.width=9}

remapVars=c('Jurisdiction'='fullState', 
            'Week Ending Date'='weekEnding', 
            'State Abbreviation'='state', 
            'Age Group'='age', 
            'Number of Deaths'='deaths', 
            'Time Period'='period', 
            'Year'='year', 
            'Week'='week'
            )

cdcRaw <- fileRead(paste0("./RInputFiles/Coronavirus/", cdcLoc), col_types="cccddcdcccc") %>%
    colRenamer(vecRename=remapVars)

cdcRaw
cdcRaw %>% 
    group_by(state, Type) %>% 
    summarize(deaths=sum(deaths, na.rm=TRUE)) %>%
    arrange(-deaths)

cdcRaw %>%
    mutate(subUnit=ifelse(state=="US", "whole", "components")) %>%
    group_by(subUnit, Type, year) %>%
    summarize(deaths=sum(deaths, na.rm=TRUE), .groups="drop") %>%
    ggplot(aes(x=year)) + 
    geom_col(aes(y=deaths), fill="lightblue") + 
    geom_text(aes(y=deaths/2, label=paste0(round(deaths/1000000, 2), " MM")), size=3) + 
    facet_grid(Type~subUnit) + 
    labs(x=NULL, y="Deaths", title="Raw CDC Summed Deaths")

```

Back of the envelope, the data appear reasonable for use in refining code.

The readrProcessCDC() function is updated:  
```{r, fig.height=9, fig.width=9}

ageLevels <- c("Under 25 years", "25-44 years", "45-64 years", 
               "65-74 years", "75-84 years", "85 years and older"
               )
periodLevels <- c("2015-2019", "2020", "2021")
yearLevels <- 2015:2021

# Function to read and process raw CDC all-cause deaths data
readProcessCDC <- function(fName, 
                           weekThru,
                           periodKeep=c("2015-2019", "2020"),
                           fDir="./RInputFiles/Coronavirus/",
                           col_types="ccciicdcccc", 
                           renameVars=remapVars,  # Update this approach 
                           maxSuppressAllowed=10, 
                           stateNoCheck=c()
                           ) {
    
    # FUNCTION ARGUMENTS:
    # fName: name of the downloaded CDC data file
    # weekThru: any record where week is less than or equal to weekThru will be kept
    # periodKeep: any record where period is in periodKeep will be kept
    # fDir: directory name for the downloaded CDC data file
    # col_types: variable type by column in the CDC data (passed to readr::read_csv())
    # renameVars: named vector for variable renaming of type c("Existing Name"="New Name")
    # maxSuppressAllowed: maximum number of data suppressions (must be in current week/year) to avoid error
    # stateNoCheck: vector of states that do NOT have suppression errors thrown
    
    # STEP 1: Read the CSV data
    cdcRaw <- fileRead(paste0(fDir, fName), col_types=col_types)
    # glimpse(cdcRaw)
    
    # STEP 2: Rename the variables for easier interpretation
    cdcRenamed <- cdcRaw %>%
        colRenamer(vecRename=renameVars) %>%
        colMutater(selfList=list("weekEnding"=lubridate::mdy))
    # glimpse(cdcRenamed)
    
    # STEP 3: Convert to factored data
    cdcFactored <- cdcRenamed %>%
        colMutater(selfList=list("age"=factor), levels=ageLevels) %>%
        colMutater(selfList=list("period"=factor), levels=periodLevels) %>%
        colMutater(selfList=list("year"=factor), levels=yearLevels)
    # glimpse(cdcFactored)
    
    # STEP 4: Filter the data to include only weighted deaths and only through the desired time period
    cdcFiltered <- cdcFactored %>%
        rowFilter(lstFilter=list("Type"="Predicted (weighted)")) %>%
        filter(period %in% all_of(periodKeep) | week <= weekThru)
    # glimpse(cdcFiltered)
    
    # STEP 4a: Check that all suppressed data and NA deaths have been eliminated
    cat("\n\n *** Data suppression checks *** \n")
    checkProblems <- cdcFiltered %>% 
        mutate(problem=(!is.na(Suppress) | is.na(deaths)), 
               curWeek=(!(year %in% all_of(periodKeep)) & week==weekThru), 
               noCheck=state %in% all_of(stateNoCheck)
               ) %>%
        group_by(noCheck, state, problem, curWeek) %>%
        summarize(n=n(), deaths=specNA(sum)(deaths), .groups="drop")
    errorProblems <- checkProblems %>%
        filter(problem)
    print(errorProblems)
    errorProblems <- errorProblems %>%
        group_by(noCheck, curWeek) %>%
        summarize(n=sum(n), .groups="drop")
    print(errorProblems)
    nPrev <- errorProblems %>% filter(!noCheck, !curWeek) %>% pull(n) %>% sum()
    nCur <- errorProblems %>% filter(!noCheck, curWeek) %>% pull(n) %>% sum()
    if (nPrev > 0) stop(paste0("\n\n", nPrev, " records not from current week/year with problems.  Fix and retry\n"))
    if (nCur > maxSuppressAllowed) {
        cat("\n\n", nCur, " records from current week/year with problems, exceeds tolerance of ", maxSuppressAllowed)
        stop("\nFix and retry\n")
    }

    cat("\n\nData suppression checks passed\n\n")
    
    # STEP 5: Remove any NA death fields, delete the US record, convert YC to be part of NY
    cdcProcessed <- cdcFiltered %>%
        rowFilter(lstExclude=list("state"=c("US", "PR"), "deaths"=c(NA))) %>%
        mutate(state=ifelse(state=="YC", "NY", state), 
               fullState=ifelse(state %in% c("NY", "YC"), "New York State (NY plus YC)", fullState)
        ) %>%
        group_by(fullState, weekEnding, state, year, week, age, period, Type, Suppress) %>%
        arrange(!is.na(Note)) %>%
        summarize(n=n(), deaths=sum(deaths), Note=first(Note), .groups="drop") %>%
        ungroup() %>%
        checkUniqueRows(uniqueBy=c("state", "year", "week", "age"))
    glimpse(cdcProcessed)
    
    # STEP 5a: Check control levels for key variables in processed file
    cat("\nCheck Control Levels and Record Counts for Processed Data:\n")
    cdcCheck <- cdcProcessed %>% mutate(n=1, n_deaths_na=ifelse(is.na(deaths), 1, 0))
    purrr::walk(list(c("age"), c("period", "year", "Type"), c("period", "Suppress"), c("period", "Note")), 
                .f=function(x) {
                    cat("\n\nChecking variable combination:", x, "\n")
                    checkControl(cdcCheck, groupBy=x, useVars=c("n", "n_deaths_na", "deaths"), fn=specNA(sum))
                    }
                )
    p1 <- checkControl(cdcCheck, 
                       groupBy=c("state"), 
                       useVars=c("deaths"), 
                       fn=specNA(sum), 
                       printControls=FALSE, 
                       pivotData=FALSE
                       ) %>%
        ggplot(aes(x=fct_reorder(state, deaths), y=deaths)) + 
        geom_col(fill="lightblue") + 
        geom_text(aes(y=deaths, label=paste0(round(deaths/1000), "k")), hjust=0, size=3) + 
        coord_flip() +
        labs(y="Total deaths", x=NULL, title="Total deaths by state in all years in processed file")
    print(p1)
    p2 <- checkControl(cdcCheck, 
                       groupBy=c("year", "week"), 
                       useVars=c("deaths"), 
                       fn=specNA(sum), 
                       printControls=FALSE, 
                       pivotData=FALSE
                       ) %>%
        ggplot(aes(x=week, y=deaths)) + 
        geom_line(aes(group=year, color=year)) + 
        labs(title="Deaths by year and epidemiological week", x="Epi week", y="US deaths") + 
        scale_color_discrete("Year") + 
        lims(y=c(0, NA))
    print(p2)
    
    # STEP 6: Return the processed data file
    cdcProcessed
    
}

cdc_temp <- readProcessCDC(cdcLoc, weekThru=17, stateNoCheck=c("NC"))
cdc_temp

```
  
The process now reads and processes the file and runs diagnostics for sanity checks.  

The helperKeyStateClusterMetrics() function is also updated:  
```{r, fig.height=9, fig.width=9}

# Convert the output of a state-level clustering list to population, membership, and deaths
helperKeyStateClusterMetrics <- function(lst) {
    
    # FUNCTION ARGUMENTS:
    # lst: the list containing the outputs of the state clustering routing
    
    # Extract the relevant elements from lst
    plotClusters <- lst[["plotDataList"]][["plotClusters"]]
    dfFull <- lst[["plotDataList"]][["dfFull"]] %>% select(state, date, pop, tot_deaths, new_deaths)
    
    # Create the aggregated data
    df <- joinFrames(plotClusters, dfFull, keyJoin="state")
    
    # Create reported cvDeaths by cluster
    dfWeekly <- df %>%
        mutate(year=lubridate::epiyear(date), week=lubridate::epiweek(date), cluster=as.character(cluster)) %>%
        group_by(state, cluster, year, week) %>%
        summarize(pop=max(pop), 
                  tot_deaths=specNA(max)(tot_deaths), 
                  new_deaths=specNA(sum)(new_deaths), 
                  .groups="drop"
                  ) %>%
        group_by(cluster, year, week) %>%
        summarize(pop=sum(pop), 
                  tot_deaths=specNA(sum)(tot_deaths), 
                  new_deaths=specNA(sum)(new_deaths), 
                  .groups="drop"
                  ) %>%
        checkUniqueRows(uniqueBy=c("cluster", "year", "week"))
    
    list(deaths=dfWeekly, useClusters=lst[["useClusters"]])
    
}

# Get a state-level clustering file
cdc_daily_210528 <- readFromRDS("cdc_daily_210528")
clusterList_temp <- helperKeyStateClusterMetrics(cdc_daily_210528)
clusterList_temp

clusterList_temp$deaths %>%
    pivot_longer(-c("cluster", "year", "week")) %>%
    filter(name %in% c("tot_deaths", "new_deaths"), !is.na(value)) %>%
    ggplot(aes(x=week, y=value)) + 
    geom_line(aes(group=cluster, color=cluster)) + 
    facet_grid(name~year, scales="free_y") + 
    labs(x="Epi Week", y="Deaths (total or incremental)", title="Evolution of deaths by cluster")

```

Data appear to be usable for the next steps in CDC processing