---
title: "Wild Card Game Analysis"
author: "davegoblue"
date: "2023-01-15"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Introduction
This file explores card games that use a standard 52-card deck, optionally modified so that one or more cards are wild, as follows:  
  
* One or more jokers may be added (the card has no natural rank or suit but may take on the most favorable)  
* One or more natural cards may also be used as a wild (in deuces wild, the deuce has a natural suit and rank and can also take on the suit and rank of a more favorable card)  
  
The analysis treats cards 1-52 as being the standard deck, with suits being 1-13, 14-26, 27-39, and 40-52. Counting the first card of each suit as 1, ranks are 1=Ace, 2-10=same card as value, 11=Jack, 12=Queen, 13=King. The Ace almost always plays as the highest rank, but can be treated as low for making a 5432A straight
  
## Methodology
### Basic Parameters
Several basic parameters of the game are established:  
```{r}

library(tidyverse) # tidyverse functionality is included throughout

source("./Generic_Added_Utility_Functions_202105_v001.R") # Basic functions

nCards <- 53 # This is a standard 52-card deck with a joker
nRanks <- 13 # There are 13 ranks A, 2-10, J, Q, K
nSuits <- 4 # There are four suits, each of 13 cards
perHand <- 5 # Number of cards drawn per hand
idxWild <- c(2, 15, 28, 41, 53) # The indices of the cards that can be considered wild (deuces and the joker)

# Check alignment of basic parameters
if(nSuits*nRanks > nCards) stop("\nerror, misaligned parameters for number of ranks, suits, and cards\n")
if(!isTRUE(setdiff(1:nCards, 1:(nRanks*nSuits)) %in% idxWild %>% reduce(.f=`&`)))
    stop("\nError, any cards outside the standard nRanks*nSuits must be included in idxWild\n")

# Announce the number of wild cards
cat("\nThe game will be played with a", nCards, "card deck with", length(idxWild), "cards considered wild")
cat("\nWild cards are of indices", paste0(idxWild, collapse=", "))

# Announce any cards of no suit or rank
if(!isTRUE(idxWild %in% 1:(nRanks*nSuits) %>% reduce(.f=`&`))) { 
    cat("\nWilds with no natural rank or suit at indices:", 
        paste0(idxWild[!(idxWild %in% 1:(nRanks*nSuits))], collapse=",")
        )
} else cat("\nAll wilds have a natural suit and rank")

# Announce wilds with natural ranks and suits
if(isTRUE(idxWild %in% 1:(nRanks*nSuits) %>% reduce(.f=`|`))) { 
    tmpIdxWild <- idxWild[idxWild %in% 1:(nRanks*nSuits)]
    cat("\nWilds with natural rank and suit at indices:", paste0(tmpIdxWild, collapse=", "))
    cat("\nThese are of suit-independent rank", paste0((tmpIdxWild-1)%%nRanks+1, collapse=", "), "\n")
} else cat("\nNo wilds have a natural suit and rank\n")

```

All choose(nCards, perHand) combinations of hands are created based on index:  
```{r, cache=TRUE}

startTime <- proc.time()


# Create a matrix of all possible hand indices
mtxHands <- t(combn(1:nCards, perHand))
str(mtxHands)


proc.time() - startTime

```
  
Hands are scored for their hand type, optionally using wilds. Functions are written:  
```{r}

# Determine if a hand is a flush
isFlush <- function(suits, useWild=4) {
    apply(suits, 1, FUN=function(x) ifelse(min(x)==max(x), TRUE, (max(x[x!=useWild])==min(x[x!=useWild]))))
}

# Determine if a hand is a straight (hard-coded for 5-card hands in a 13-card deck, Ace high or low)
isStraight <- function(rankCounts, isEligible=TRUE) {
    # Exclusion matrix for straights, currently designed only for 13-card decks and A high or low
    strMatrix <- matrix(data=0L, nrow=13, ncol=10)
    strMatrix[c(1, 10, 11, 12, 13), 1] <- 1L
    for (intCtr in 1:9) { strMatrix[intCtr:(intCtr+4), intCtr+1] <- 1L }
    apply(rankCounts, 1, max)<=1 & rowSums(rankCounts%*%(strMatrix-1)==0)>=1 & isEligible
}

# Hard-coded for 52-card deck with 1 joker
findHandTypes <- function (aHands, retAll=FALSE) {
    
    # Track hands that contain the joker and total number of wilds
    aJoker <- rowSums(aHands==53)>0
    nWild <- aJoker + rowSums(aHands%%13==2)
    
    # 1. Calculate natural values
    # 1a. Calculate ranks and suits, counting the joker as having no "rank" and being of a fifth "suit"
    aRanks <- ifelse(aHands==53, 0, 1 + (aHands-1) %% 13)
    aSuits <- ifelse(aHands==53, 0, 1 + (aHands-1) %/% 13)

    # 1b. Find the counts by rank in each hand
    aRankCount <- matrix(data=-1L, nrow=nrow(aHands), ncol=13)
    for (intCtr in 1:13) { aRankCount[, intCtr] <- rowSums(aRanks == intCtr) }
        
    # 1c. Find the natural flushes and straights
    nFlush <- isFlush(aSuits, useWild=-1)
    nStraight <- isStraight(aRankCount, isEligible=!aJoker)

    # 1d. Find max and count of ranks
    nQuads <- rowSums(aRankCount == 4)
    nTrips <- rowSums(aRankCount == 3)
    nPairs <- rowSums(aRankCount == 2)

    # 1e. Score the natural hand values (default is that a hand has nothing of value)
    nType <- rep(0L, nrow(aHands))
    # Five wilds (cannot exist) <- 1
    nType[nFlush==1 & nStraight==1 & aRankCount[, 1]==1 & aRankCount[, 13]==1] <- 2 # Royal
    # Five of a kind (cannot exist as natural) <- 3
    nType[nFlush==1 & nStraight==1 & (aRankCount[, 1]!=1 | aRankCount[, 13]!=1)] <- 4 # Straight flush
    nType[nQuads==1] <- 5 # Four of a kind
    nType[nTrips==1 & nPairs==1] <- 6 # Full House
    nType[nFlush==1 & nStraight==0] <- 7 # Flush
    nType[nFlush==0 & nStraight==1] <- 8 # Straight
    nType[nTrips==1 & nPairs==0] <- 9 # Three of a Kind
    nType[nPairs==2] <- 10 # Two Pair
    nType[nTrips==0 & nPairs==1] <- 11 # Pair

    
    # 2. Calculate wild values
    # 2a. Calculate ranks and suits, counting the joker and 2's as having no "rank" and being of a fifth "suit"
    wRanks <- ifelse(aHands==53|(aHands%%13==2), 0, 1 + (aHands-1) %% 13)
    wSuits <- ifelse(aHands==53|(aHands%%13==2), 0, 1 + (aHands-1) %/% 13)

    # 2b. Find the counts by rank in each hand
    wRankCount <- matrix(data=-1L, nrow=nrow(aHands), ncol=13)
    for (intCtr in 1:13) { wRankCount[, intCtr] <- rowSums(wRanks == intCtr) }
        
    # 2c. Find the wild flushes and straights
    wFlush <- isFlush(wSuits, useWild=0)
    wStraight <- isStraight(wRankCount, isEligible=TRUE)
    
    # 2d. Find max and count of ranks
    wQuads <- rowSums(wRankCount == 4)
    wTrips <- rowSums(wRankCount == 3)
    wPairs <- rowSums(wRankCount == 2)

    # 2e. Score the wild hand values (default is that a hand has nothing of value)
    wType <- rep(0L, nrow(aHands))
    
    # 2e1. Calculate number of royal cards in hand
    nRoyal <- rowSums(wRankCount[, c(1, 10, 11, 12, 13)])
    
    # 2e2. Five wilds (always five wilds)
    wType[nWild==5] <- 1 # Five wild
    
    # 2e3. Four wilds (always either royal flush or five of a kind)
    wType[nWild==4 & nRoyal==1] <- 2 # Royal
    wType[nWild==4 & nRoyal==0] <- 3 # Five of a kind
    
    # 2e4. Three wilds (always either royal flush or five of a kind or straight flush or four of a kind)
    wType[nWild==3 & wFlush==1 & wStraight==1 & nRoyal==2] <- 2 # Royal
    wType[nWild==3 & wPairs==1] <- 3 # Five of a kind
    wType[nWild==3 & wFlush==1 & wStraight==1 & nRoyal<2] <- 4 # Straight Flush
    wType[nWild==3 & !(wFlush==1 & wStraight==1) & wPairs==0] <- 5 # Four of a kind
    
    # 2e5. Two wilds (always either royal, five of a kind, straight flush, four of a kind, flush, straight, trips)
    # Cannot be a full house as any 3-2 using two wilds could instead be 5-0 or 1-4 and thus a better hand
    wType[nWild==2 & wFlush==1 & wStraight==1 & nRoyal==3] <- 2 # Royal
    wType[nWild==2 & wTrips==1] <- 3 # Five of a kind
    wType[nWild==2 & wFlush==1 & wStraight==1 & nRoyal<3] <- 4 # Straight Flush
    wType[nWild==2 & wPairs==1] <- 5 # Four of a kind
    wType[nWild==2 & wFlush==1 & wStraight==0] <- 7 # Flush
    wType[nWild==2 & wFlush==0 & wStraight==1] <- 8 # Straight
    wType[nWild==2 & !(wFlush==1 | wStraight==1) & wPairs==0 & wTrips==0] <- 9 # Three of a kind
    
    # 2e6. One wild (can be anything from pair to royal, with the exception of never two pair)
    wType[nWild==1 & wFlush==1 & wStraight==1 & nRoyal==4] <- 2 # Royal
    wType[nWild==1 & wQuads==1] <- 3 # Five of a kind
    wType[nWild==1 & wFlush==1 & wStraight==1 & nRoyal<4] <- 4 # Straight Flush
    wType[nWild==1 & wTrips==1] <- 5 # Four of a kind
    wType[nWild==1 & wPairs==2] <- 6 # Full House
    wType[nWild==1 & wFlush==1 & wStraight==0] <- 7 # Flush
    wType[nWild==1 & wFlush==0 & wStraight==1] <- 8 # Straight
    wType[nWild==1 & wPairs==1] <- 9 # Three of a kind
    wType[nWild==1 & !(wFlush==1 | wStraight==1) & wPairs==0 & wTrips==0 & wQuads==0] <- 11 # Pair
    
    # 2e7. No wild (is identical to natural)
    wType[nWild==0] <- nType[nWild==0]
    
    # Return the requested data
    if (isTRUE(retAll)) {
        list(nType=nType, 
             wType=wType, 
             nWild=nWild,
             wRankCount=wRankCount,
             aRankCount=aRankCount
             )
    } else {
        list(nType=nType, wType=wType, nWild=nWild)
    }
    
}

```
  
```{r, cache=TRUE}

# Calculate hands
tmpTime <- proc.time(); tmpHandTypes<-findHandTypes(mtxHands, retAll=TRUE); proc.time()-tmpTime

```
  
Hand types are evaluated:  
```{r, fig.height=9, fig.width=9}

# Create tibble
tblAllTypes <- tibble::tibble(wType=tmpHandTypes$wType, 
                              nType=tmpHandTypes$nType, 
                              nWild=tmpHandTypes$nWild
                              ) %>%
    mutate(wType=ifelse(wType==0, 99, wType), 
           nType=ifelse(nType==0, 99, nType)
           )
tblAllTypes

# Plot the overlaps
tblAllTypes %>%
    count(wType, nType) %>%
    mutate(wType=ifelse(wType %in% c(1, 3), case_when(wType==3 ~ "3 (5K)", wType==1 ~ "1 (5W)"), wType), 
           nType=case_when(nType==2 ~ "2 (RF)", nType==4 ~ "4 (SF)", nType==5 ~ "5 (4K)", nType==6 ~ "6 (FH)", 
                           nType==7 ~ "7 (FL)", nType==8 ~ "8 (ST)", nType==9 ~ "9 (3K)", nType==10 ~ "10 (2P)", 
                           nType==11 ~ "11 (Pair)", nType==99 ~ "99 (HC)", TRUE ~ "Error"
                           )
           ) %>%
    mutate(wType=factor(wType, 
                        levels=c("99", "11", "10", "9", "8", "7", "6", "5", "4", "3 (5K)", "2", "1 (5W)")
                        ), 
           nType=factor(nType, 
                        levels=c("99 (HC)", "11 (Pair)", "10 (2P)", "9 (3K)", "8 (ST)", "7 (FL)", 
                                 "6 (FH)", "5 (4K)", "4 (SF)", "2 (RF)"
                                 )
                        )
           ) %>%
    ggplot(aes(x=wType, y=nType)) + 
    geom_tile(aes(fill=(n>0))) + 
    geom_text(aes(label=n), size=3) + 
    scale_fill_discrete("Overlap\nexists?") + 
    labs(title="Number of hands by type in 53c5 game", 
         subtitle="Deuces can be natural or wild, joker (card 53) is wild only", 
         y="Natural hand type", 
         x="Wild hand type"
         )

```
  
Hands can be scored based on a paytable for both wild-type hands and natural-type hands (only the highest payout applies). An example from the game "DJ Wild" is assessed:  
```{r, fig.height=9, fig.width=9}

# Hand values
handValues <- tibble::tibble(handRank=c(1:11, 99), 
                             handDesc=c("5W", "RF", "5K", "SF", "4K", "FH", "FL", "ST", "3K", "2P", "1P", "HC"),
                             handLabel=paste0(handRank, " (", handDesc, ")"),
                             blindPay=c(2000, 100, 40, 25, 5, 4, 3, 2, 0, 0, 0, 0),
                             wildPay=c(2000, 90, 70, 25, 6, 5, 4, 3, 1, -1, -1, -1), 
                             naturalPay=c(NA, 1000, NA, 200, 60, 30, 25, 20, 6, -1, -1, -1)
                             )
handValues

# Create a mapping vector for type to description
vecMapHands <- handValues$handLabel %>% purrr::set_names(handValues$handRank)

# Payout grid plotted for all possible values
allValueGrid <- expand.grid(wildType=c(1:11, 99), naturalType=c(1:11, 99)) %>%
    tibble::tibble() %>%
    full_join(count(tblAllTypes, wType, nType), by=c("wildType"="wType", "naturalType"="nType")) %>%
    mutate(bestType=pmin(wildType, naturalType)) %>%
    left_join(select(handValues, handRank, wildPay), by=c("wildType"="handRank")) %>%
    left_join(select(handValues, handRank, naturalPay), by=c("naturalType"="handRank")) %>%
    left_join(select(handValues, handRank, blindPay), by=c("bestType"="handRank")) %>%
    mutate(bonusPay=pmax(wildPay, naturalPay, na.rm=TRUE))
allValueGrid

# Plot of payout values
allValueGrid %>%
    filter(!is.na(n)) %>%
    ggplot(aes(x=fct_rev(factor(vecMapHands[as.character(wildType)], levels=vecMapHands)), 
               y=fct_rev(factor(vecMapHands[as.character(naturalType)], levels=vecMapHands))
               )
           ) + 
    geom_tile(fill="lightgreen") +
    geom_text(aes(label=bonusPay)) + 
    labs(title="Example payouts by type in 53c5 game", 
         subtitle="Deuces can be natural or wild, joker (card 53) is wild only", 
         y="Natural hand type", 
         x="Wild hand type"
         )

# EV of payout values
allValueGrid %>%
    filter(!is.na(n)) %>%
    summarize(totPays=sum(n*bonusPay), n=sum(n)) %>%
    mutate(ev=totPays/n)

# Table by hand type
allValueTable <- allValueGrid %>%
    filter(!is.na(n)) %>%
    mutate(natWild=ifelse(naturalPay>wildPay, "Natural", "Wild"), 
           reportBonusType=ifelse(natWild=="Natural", naturalType, wildType),
           reportBonusLabel=factor(vecMapHands[as.character(reportBonusType)], levels=vecMapHands)
           ) %>%
    group_by(natWild, reportBonusLabel, bonusPay) %>%
    summarize(n=sum(n), .groups="drop") %>%
    mutate(prob=n/sum(n), per=1/prob, ev=n*bonusPay/sum(n))
allValueTable
allValueTable %>% select(n, ev) %>% colSums() %>% round(4)

```
  
Convert all hands to a value with ranks for tie-breaking (Ace high, with 5432A straights treated as having first tie-breaker 5 and last tie-breaker A). Hands are first converted to counts by rank with wild cards filling the next best ranks:  
```{r}

# Get the number of wilds in each hand
perHandNWild <- (rowSums(mtxHands==53)>0) + rowSums(mtxHands%%13==2)

# Get the ranks in each hand
perHandRanks <- ifelse(mtxHands==53, 0, 1 + (mtxHands-1) %% 13) # track joker as wild
perHandRanks[perHandRanks==2] <- 0 # track deuces as wild, ignore rank (place as best later)
perHandRanks[perHandRanks==1] <- 14 # count Aces as high

# Create the matrix of card types
perHandRankCount <- matrix(data=-1L, nrow=nrow(mtxHands), ncol=14)
for (intCtr in 1:14) { perHandRankCount[, intCtr] <- rowSums(perHandRanks == intCtr) }

# Create a tie-breaker matrix filled with 0's (column 13 is Ace)
mtxTieBreak <- matrix(data=0L, nrow=nrow(mtxHands), ncol=13)

# Function to get the cards in a straight
getStraightType <- function(x) {
    if(min(x[x>0]) >= 10) c(10, 11, 12, 13, 14)
    else if(min(x[x>0]) <= 5 & max(x)==14) c(2, 3, 4, 5, 14) # this treats Ace as the last card to resolve (Ace low)
    else seq(min(x[x>0]), min(x[x>0])+4)
}

# Function to get the cards in a flush
getFlushType <- function(x) {
    # Wild cards should be added as highest rank not already in hand (try A then K then Q then J then T)
    numAdd <- sum(x==0)
    if(numAdd > 0) {
        notThere <- (14:10)[!((14:10) %in% x)][1:numAdd]
        x <- c(x[x!=0], notThere)
    }
    sort(x, decreasing=TRUE)
}

# Function to get the cards in a four of a kind, full house, three of a kind, two pair, pair, or high card
getHighTypes <- function(rks, idx=1:14, outNum=c(1, 1, 1, 1, 1)) {
    vecOut <- rep(0L, length(outNum))
    for(x in seq_along(outNum)) {
        vecOut[x]<-max((rks==max(rks)) * idx)
        rks[match(vecOut[x], idx)] <- 0
    }
    rep(vecOut, times=outNum)
}

# 1. Five wild (nothing to do)
# 2. Royal flush (make the ranks 1 in the last 5 columns)
perHandRanks[tmpHandTypes$wType==2, ] <- t(apply(perHandRanks[tmpHandTypes$wType==2, ], 1, FUN=getStraightType))
# 3. Five of a kind (make the ranks all the same as the only rank)
perHandRanks[tmpHandTypes$wType==3, ] <- t(apply(perHandRankCount[tmpHandTypes$wType==3, ], 
                                           1, 
                                           FUN=getHighTypes, 
                                           outNum=c(5)
                                           )
                                     )
# 4. Straight flush (make the ranks all the best straight possible)
perHandRanks[tmpHandTypes$wType==4, ] <- t(apply(perHandRanks[tmpHandTypes$wType==4, ], 1, FUN=getStraightType))
# 5. Four of a kind (make the ranks four of the most frequent card or the highest card, one of the other)
perHandRanks[tmpHandTypes$wType==5, ] <- t(apply(perHandRankCount[tmpHandTypes$wType==5, ], 
                                           1, 
                                           FUN=getHighTypes, 
                                           outNum=c(4, 1)
                                           )
                                     )
# 6. Full house (make the ranks three of the most frequent card, two of the other)
perHandRanks[tmpHandTypes$wType==6, ] <- t(apply(perHandRankCount[tmpHandTypes$wType==6, ], 
                                           1, 
                                           FUN=getHighTypes, 
                                           outNum=c(3, 2)
                                           )
                                     )
# 7. Flush (need to implement)
perHandRanks[tmpHandTypes$wType==7, ] <- t(apply(perHandRanks[tmpHandTypes$wType==7, ], 1, FUN=getFlushType))
# 8. Straight (make the ranks all the best straight possible)
perHandRanks[tmpHandTypes$wType==8, ] <- t(apply(perHandRanks[tmpHandTypes$wType==8, ], 1, FUN=getStraightType))
# 9. Three of a kind (make the ranks three of the most frequent or highest card, one each of the other)
perHandRanks[tmpHandTypes$wType==9, ] <- t(apply(perHandRankCount[tmpHandTypes$wType==9, ], 
                                           1, 
                                           FUN=getHighTypes, 
                                           outNum=c(3, 1, 1)
                                           )
                                     )
# 10. Two pair (make the ranks two of the highest pair, two of the lowest pair, one of the remainder)
perHandRanks[tmpHandTypes$wType==10, ] <- t(apply(perHandRankCount[tmpHandTypes$wType==10, ], 
                                            1, 
                                            FUN=getHighTypes, 
                                            outNum=c(2, 2, 1)
                                            )
                                      )
# 11. One pair (make the ranks two of the pair or highest card, one each of the remainder)
perHandRanks[tmpHandTypes$wType==11, ] <- t(apply(perHandRankCount[tmpHandTypes$wType==11, ], 
                                            1, 
                                            FUN=getHighTypes, 
                                            outNum=c(2, 1, 1, 1)
                                            )
                                      )
# 0. High card (make the ranks in order of the highest cards)
perHandRanks[tmpHandTypes$wType==0, ] <- t(apply(perHandRankCount[tmpHandTypes$wType==0, ], 
                                            1, 
                                            FUN=getHighTypes, 
                                            outNum=c(1, 1, 1, 1, 1)
                                            )
                                      )

# Create the hand ranking table
allHandRanks <- tibble::tibble(handNum=1:nrow(mtxHands), wType=tmpHandTypes$wType) %>% 
    bind_cols(perHandRanks) %>% 
    set_names(c("handNum", "wType", "tb1", "tb2", "tb3", "tb4", "tb5")) %>% 
    mutate(wType=ifelse(wType==0, 99, wType)) %>% 
    arrange(wType, desc(tb1), desc(tb2), desc(tb3), desc(tb4), desc(tb5)) %>% 
    mutate(chgRank=ifelse(row_number()==1 | wType!=lag(wType) | tb1 != lag(tb1) | tb2 != lag(tb2) | tb3 != lag(tb3) | tb4 != lag(tb4) | tb5 != lag(tb5), 1, 0), 
           rank=cumsum(chgRank)
           )
allHandRanks %>%
    count(wType, rank, tb1, tb2, tb3, tb4, tb5) %>%
    arrange(-n, rank) %>%
    mutate(nvr=row_number()) %>%
    group_by(wType) %>%
    mutate(nty=row_number()) %>%
    ungroup() %>%
    filter(nvr<=10 | nty==1)

```
  
As expected, straight is the hand type with the greatest number of possible ties (there are only 10 types of straight and each can have 1,024 permutations of suits)

A function is written to assess probabilities associated with any given hand:  
```{r}

# Sort allHandRanks and ensure handNum and row_number() match
sortedHandRanks <- allHandRanks %>%
    mutate(qual=ifelse(wType<=11, "Q", "N")) %>%
    arrange(handNum)
if (sum((sortedHandRanks$handNum) != (1:nrow(sortedHandRanks)))>0) 
    stop("\nError in handNum order in sortedHandRanks\n")

# Function to get probabilities
findHandProbs <- function(exRank, idxExclude=NULL, df=sortedHandRanks) {
    rkData <- if(is.null(idxExclude)) df$rank else df$rank[-idxExclude]
    qualData <- if(is.null(idxExclude)) df$qual else df$qual[-idxExclude]
    pLN <- mean(rkData < exRank & qualData=="N")
    pLQ <- mean(rkData < exRank & qualData=="Q")
    pTN <- mean(rkData == exRank & qualData=="N")
    pTQ <- mean(rkData == exRank & qualData=="Q")
    pWN <- mean(rkData > exRank & qualData=="N")
    pWQ <- mean(rkData > exRank & qualData=="Q")
    pWNoTie <- (pWN+pWQ)/(1-pTN-pTQ)
    c(pLN=pLN, pLQ=pLQ, pTN=pTN, pTQ=pTQ, pWN=pWN, pWQ=pWQ, pWNoTie=pWNoTie)
}

# Example hand index
exHandNum <- 123456
exHandRank <- sortedHandRanks$rank[exHandNum]
cat("\nExample hand", 
    exHandNum, 
    "is of type", 
    sortedHandRanks$wType[exHandNum], 
    "and rank",
    exHandRank,
    "with cards", 
    mtxHands[exHandNum,], 
    "\n"
    )

res <- findHandProbs(exHandRank)
cat("Associated probabilities (if cards in example hand available to replay):", 
    "\nLoss: ", res["pLN"]+res["pLQ"], 
    "\nTie: ", res["pTN"]+res["pTQ"],
    "\nWin (no qualify): ", res["pWN"], 
    "\nWin (qualify): ", res["pWQ"], 
    "\nWin (excluding ties):", res["pWNoTie"],
    "\np(dealer qualifies):", res["pLQ"]+res["pTQ"]+res["pWQ"],
    "\nOptimal action: ", ifelse(res["pWNoTie"]<0.25, "Fold", ifelse(res["pWNoTie"]<=0.5, "Single", "Double")),
    "\n"
    )

```

The function is run excluding unavailable cards (e.g., none of a player's cards can appear in the dealer's hand). First, a list of exclusions is generated:  
```{r, cache=TRUE}

# Get all exclusion indices once
cardInHand <- lapply(1:53, FUN=function(x) which(rowSums(mtxHands==x)>0))

```
  
Then, the function is written and applied to the example hand:  
```{r}

# Function to get key values
getKeyValues <- function(keyRank, exclCards=c(), lstExclude=cardInHand, dfSort=sortedHandRanks) {

    # Get the union of exclusions
    if(length(exclCards)==0) exclHands<-c()
    else exclHands <- purrr::reduce(.x=lstExclude[c(exclCards)], .f=union)

    dfSort %>%
        filter(!(handNum %in% exclHands)) %>%
        summarize(pLQ=mean(qual=="Q" & rank<keyRank),
                  pLN=mean(qual=="N" & rank<keyRank), 
                  pTQ=mean(qual=="Q" & rank==keyRank),
                  pTN=mean(qual=="N" & rank==keyRank), 
                  pWQ=mean(qual=="Q" & rank>keyRank),
                  pWN=mean(qual=="N" & rank>keyRank), 
                  n=n()
                  ) %>%
        mutate(pWNoTie=(pWQ+pWN)/(1-pTQ-pTN), rank=keyRank)
        
}

smallSorted <- sortedHandRanks %>% select(handNum, rank, qual)

# Heads up probabilities
t <- proc.time(); getKeyValues(exHandRank, exclCards=mtxHands[exHandNum,], dfSort=smallSorted); proc.time() - t

# Heads up probabilities, dealer does not have a wild card
t <- proc.time() 
getKeyValues(exHandRank, exclCards=unique(c(mtxHands[exHandNum,], 2, 15, 28, 41, 53)), dfSort=smallSorted)
proc.time() - t

```

As expected, probabilities change slightly due to cards made unavailable (in player's hands or otherwise). Wild cards are very important in expected value of hand quality

A function is added to run multiple hands:  
```{r, fig.height=9, fig.width=9}

# Blind payouts
blindPay <- c(2000, 100, 40, 25, 5, 4, 3, 2, 0, 0, 0, 0) %>% purrr::set_names(paste0("b_", c(1:11, 99)))

# Add number of wilds
sortedHandRanks <- sortedHandRanks %>%
    mutate(nWild=perHandNWild)

calculateResults <- function(useHandNums, dfRanks=sortedHandRanks, hands=mtxHands, bPay=blindPay) {

    map_dfr(useHandNums, 
            .f=function(x) {
                getKeyValues(keyRank=dfRanks$rank[x], exclCards=as.vector(hands[x,])) %>%
                    mutate(type=dfRanks$wType[x], 
                           handNum=x, 
                           betPlay=ifelse((4*pWQ+3*pWN+2*pTQ+2*pTN)<(pLQ+pLN), 0, ifelse(pWNoTie<0.5, 1, 2)), 
                           evAnte=ifelse(betPlay==0, -1, pWQ-pLQ-pLN), 
                           evPlay=betPlay*(pWQ+pWN-pLQ-pLN),
                           evBlind=ifelse(betPlay==0, -1, bPay[paste0("b_", type)]*(pWQ+pWN)-pLQ-pLN), 
                           evAll=evAnte+evPlay+evBlind
                           )
                }
            )
}

```
  
```{r, fig.height=9, fig.width=9, cache=TRUE}

# Run for example hand of all hand types 4 (straight flush) or better
seq1a <- sortedHandRanks %>% 
    filter(wType <= 4) %>%
    group_by(nWild, wType, tb1, tb2, tb3, tb4, tb5) %>% 
    filter(row_number()==1) %>% 
    ungroup()

# Run for select hands
t <- proc.time(); resSFPlus <- calculateResults(useHandNums=seq1a$handNum); proc.time()-t

# Statistics for EV by hand type
resSFPlus %>%
    group_by(type) %>%
    summarize(n=n(), across(c(pWNoTie, evAll), .fns=list(min=min, mean=mean, med=median, max=max)))

# Plot for result type
resSFPlus %>%
    mutate(qualifies=pWQ+pTQ+pLQ, ties=pTQ+pTN) %>%
    select(handNum, type, pWQ, pWN, pLQ, pLN, ties, qualifies) %>%
    pivot_longer(-c(handNum, type)) %>%
    ggplot(aes(x=factor(type), y=value)) + 
    geom_boxplot(fill="lightblue") + 
    facet_wrap(~name) + 
    labs(title="Probabilities of results by hand type", x="Hand type", y="Probability")

```
  
```{r, fig.height=9, fig.width=9, cache=TRUE}

# Run for example hand of all hand types 5-8 (4K thru straight) or better
seq1b <- sortedHandRanks %>% 
    filter(wType <= 8 & wType >= 5) %>%
    group_by(nWild, wType, tb1, tb2, tb3, tb4, tb5) %>% 
    filter(row_number()==1) %>% 
    ungroup()

# Run for select hands
t <- proc.time(); resSTto4K <- calculateResults(useHandNums=seq1b$handNum); proc.time()-t

# Statistics for EV by hand type
resSTto4K %>%
    group_by(type) %>%
    summarize(n=n(), across(c(pWNoTie, evAll), .fns=list(min=min, mean=mean, med=median, max=max)))

# Plot for result type
resSTto4K %>%
    mutate(qualifies=pWQ+pTQ+pLQ, ties=pTQ+pTN) %>%
    select(handNum, type, pWQ, pWN, pLQ, pLN, ties, qualifies) %>%
    pivot_longer(-c(handNum, type)) %>%
    ggplot(aes(x=factor(type), y=value)) + 
    geom_boxplot(fill="lightblue") + 
    facet_wrap(~name) + 
    labs(title="Probabilities of results by hand type", x="Hand type", y="Probability")

```
  
```{r, fig.height=9, fig.width=9, cache=TRUE}

# Run for example hand of all hand types 9-10 (3K thru 2P)
seq1c <- sortedHandRanks %>% 
    filter(wType <= 10 & wType >= 9) %>%
    group_by(nWild, wType, tb1, tb2, tb3, tb4, tb5) %>% 
    filter(row_number()==1) %>% 
    ungroup()

# Run for select hands
t <- proc.time(); res3Kto2P <- calculateResults(useHandNums=seq1c$handNum); proc.time()-t

# Statistics for EV by hand type
res3Kto2P %>%
    group_by(type) %>%
    summarize(n=n(), across(c(pWNoTie, evAll), .fns=list(min=min, mean=mean, med=median, max=max)))

# Plot for result type
res3Kto2P %>%
    mutate(qualifies=pWQ+pTQ+pLQ, ties=pTQ+pTN) %>%
    select(handNum, type, pWQ, pWN, pLQ, pLN, ties, qualifies) %>%
    pivot_longer(-c(handNum, type)) %>%
    ggplot(aes(x=factor(type), y=value)) + 
    geom_boxplot(fill="lightblue") + 
    facet_wrap(~name) + 
    labs(title="Probabilities of results by hand type", x="Hand type", y="Probability")

```
  
```{r, fig.height=9, fig.width=9, cache=TRUE}

# Run for example hand of all hand types 11 with no wild (pair)
seq1d <- sortedHandRanks %>% 
    filter(wType == 11 & nWild==0) %>%
    group_by(nWild, wType, tb1, tb2, tb3, tb4, tb5) %>% 
    filter(row_number()==1) %>% 
    ungroup()

# Run for select hands
t <- proc.time(); resPairNoWild <- calculateResults(useHandNums=seq1d$handNum); proc.time()-t
resPairNoWild

```
  
```{r, fig.height=9, fig.width=9}

# Statistics for EV by hand type
resPairNoWild %>%
    full_join(select(seq1d, handNum, tb1), by="handNum") %>%
    group_by(tb1) %>%
    summarize(n=n(), across(c(pWNoTie, evAll), .fns=list(min=min, mean=mean, med=median, max=max)))

# Plot for result type
resPairNoWild %>%
    full_join(select(seq1d, handNum, tb1), by="handNum") %>%
    mutate(qualifies=pWQ+pTQ+pLQ, ties=pTQ+pTN) %>%
    select(handNum, tb1, pWQ, pWN, pLQ, pLN, ties, qualifies) %>%
    pivot_longer(-c(handNum, tb1)) %>%
    ggplot(aes(x=factor(tb1), y=value)) + 
    geom_boxplot(fill="lightblue") + 
    facet_wrap(~name) + 
    labs(title="Probabilities of results by pair type (no wild)", x="Pair type", y="Probability")

```
  
```{r, fig.height=9, fig.width=9, cache=TRUE}

# Run for example hand of all hand types 11 with wild (pair) and type 99 (no pair)
seq1e <- sortedHandRanks %>% 
    filter(wType==99 | (wType == 11 & nWild==1)) %>%
    group_by(nWild, wType, tb1, tb2, tb3, tb4, tb5) %>% 
    filter(row_number()==1) %>% 
    ungroup()

# Run for select hands
t <- proc.time(); resWildPairNoPair <- calculateResults(useHandNums=seq1e$handNum); proc.time()-t
resWildPairNoPair

```
  
```{r, fig.height=9, fig.width=9}

# Statistics for EV by hand type
resWildPairNoPair %>%
    full_join(select(seq1e, handNum, tb1, nWild), by="handNum") %>%
    group_by(type, nWild, tb1) %>%
    summarize(n=n(), across(c(pWNoTie, evAll), .fns=list(min=min, mean=mean, med=median, max=max)))

# Plot for result type
resWildPairNoPair %>%
    full_join(select(seq1e, handNum, tb1, nWild), by="handNum") %>%
    mutate(qualifies=pWQ+pTQ+pLQ, ties=pTQ+pTN) %>%
    select(handNum, tb1, nWild, type, pWQ, pWN, pLQ, pLN, ties, qualifies) %>%
    pivot_longer(-c(handNum, tb1, nWild, type)) %>%
    mutate(lab=paste0(type, "-", nWild, "-", stringr::str_pad(as.character(tb1), 2, side="left", pad="0"))) %>%
    ggplot(aes(x=factor(lab), y=value)) + 
    geom_boxplot(fill="lightblue") + 
    facet_wrap(~name) + 
    labs(title="Probabilities of results by type\nPair with wild (11-1), or no pair (99-0)", 
         x="Type", 
         y="Probability"
         )

```
  
The result files are combined and saved:  
```{r, fig.height=9, fig.width=9}

resAll_202301_v001 <- bind_rows(resWildPairNoPair, 
                                resPairNoWild, 
                                res3Kto2P, 
                                resSTto4K, 
                                resSFPlus,
                                .id="src"
                                ) %>%
    mutate(src=c("1"="Wild Pair or No Paor", 
                 "2"="Pair, No Wild", 
                 "3"="Two Pair or Trips", 
                 "4"="Straight to Quads", 
                 "5"="Straight Flush or Better"
                 )[src]
           )
resAll_202301_v001

saveToRDS(resAll_202301_v001, ovrWriteError=FALSE)

```
  
Results are explored:  
```{r, fig.height=9, fig.width=9}

# Create the analysis frame
dfResAll_202301_v001 <- resAll_202301_v001 %>% 
    left_join(select(sortedHandRanks, handNum, nWild, wType, starts_with("tb")), by="handNum") %>% 
    full_join(sortedHandRanks %>% count(nWild, wType, tb1, tb2, tb3, tb4, tb5, name="nOfType"))

# Chart of overall probabilities by bet amount
dfResAll_202301_v001 %>% 
    summarize(n=sum(nOfType), 
              across(c(pWNoTie, evAnte, evPlay, evBlind, evAll), .fns=function(x) sum(x*nOfType)/sum(nOfType))
              )

# Chart of probabilities by bet amount
dfResAll_202301_v001 %>% 
    group_by(betPlay) %>% 
    summarize(n=sum(nOfType), 
              minPw=min(pWNoTie), 
              across(c(pWNoTie, evAnte, evPlay, evBlind, evAll), .fns=function(x) sum(x*nOfType)/sum(nOfType))
              )

# Plot of win probabilities
dfResAll_202301_v001 %>%
    arrange(pWNoTie) %>% 
    mutate(cs=cumsum(nOfType)) %>% 
    ggplot(aes(x=cs/choose(53, 5), y=pWNoTie)) + 
    geom_line() + 
    geom_point(data=tibble::tibble(x=c(0, 0.25, 0.5, 1), col=c("black", "red", "green", "black")) %>% mutate(y=x), 
               aes(x=x, y=y, color=col), 
               size=3
               ) +
    scale_color_identity() +
    geom_abline(slope=1, intercept=0, lty=2) + 
    labs(title="Probability of winning based on 5-card hand", 
         x="5-card hand percentile", 
         y="Probability of winning (ties excluded)"
         )

```
  
Volatility of the bonus bet is explored, assuming 100 hands:  
```{r, fig.height=9, fig.width=9}

nBonusPay <- allValueGrid %>%
    select(n, bonusPay) %>%
    filter(!is.na(n)) %>%
    group_by(bonusPay) %>%
    summarize(n=sum(n))
nBonusPay

# Overall metrics - mean and standard deviation
nBonusPay %>%
    summarize(evBonus=sum(bonusPay*n)/sum(n), 
              evBonus2=sum(n*(bonusPay**2))/sum(n)
              ) %>%
    mutate(sdBonus=sqrt(evBonus2-evBonus**2))

# Simulations of 100 hands
set.seed(23013015)
nSims <- 10000
nPerSim <- 100
simTotal <- vector("numeric", length=nSims)

for(intCtr in 1:nSims) simTotal[intCtr] <- sum(sample(nBonusPay$bonusPay, 
                                                      size=nPerSim, 
                                                      prob=nBonusPay$n, 
                                                      replace=TRUE
                                                      )
                                               )

cat("\n", 
    nSims, 
    "simulations each of", 
    nPerSim, 
    "hands has mean:", 
    round(mean(simTotal), 2), 
    "with sd:", 
    round(sd(simTotal), 1), 
    "\n"
    )

# Plot of outcomes
tibble::tibble(result=simTotal) %>%
    arrange(result) %>%
    mutate(rn=row_number(), cummean=cumsum(result)/rn) %>%
    ggplot(aes(x=(rn-1)/(max(rn)-1), y=cummean)) + 
    geom_point() + 
    labs(title=paste0("Mean return for ", nPerSim, " hands"), 
         x="Result percentile", 
         y="Cumulative mean return for hands through percentile"
         )

# Quantiles and proportion greater than zero
quantile(simTotal, c(0, 0.01, 0.025, 0.05, 0.1, 0.25, 0.5, 0.75, 0.9, 0.95, 0.975, 0.99, 1))

cat("\n", 
    paste0(round(mean(simTotal>0)*100, 1), "%"), 
    "of simulations are wins, with mean win per winning simulation:", 
    round(mean(simTotal[simTotal>0]), 1), 
    "and median win per winning simulation:", 
    round(median(simTotal[simTotal>0]), 1)
    )
cat("\n", 
    paste0(round(mean(simTotal==0)*100, 1), "%"), 
    "of simulations are draws"
    )
cat("\n", 
    paste0(round(mean(simTotal<0)*100, 1), "%"), 
    "of simulations are losers, with mean loss per losing simulation:", 
    round(mean(simTotal[simTotal<0]), 1), 
    "and median loss per losing simulation:", 
    round(median(simTotal[simTotal<0]), 1),
    "\n"
    )

```
  
Volatility of the main bet is explored, assuming 100 hands:  
```{r, fig.height=9, fig.width=9, cache=TRUE}

dfHandData <- dfResAll_202301_v001 %>%
    select(wType, nOfType, betPlay, starts_with("p")) %>%
    mutate(win=pWQ+pWN, tie=pTQ+pTN, lose=pLQ+pLN, blindPay=blindPay[paste0("b_", wType)])
dfHandData

getHandOutcome <- function(pWQ, pWN, tie, lose, betPlay, blindPay) {
    if(betPlay==0) return(tibble::tibble(result="fold", ante=-1, blind=-1, play=0))
    result <- sample(c("win/qualify", "win/no qualify", "tie", "lose"), 
                     size=1, 
                     replace=TRUE, 
                     prob=c(pWQ, pWN, tie, lose)
                     )
    return(tibble::tibble(result=result, 
                          ante=case_when(result=="win/qualify" ~ 1, 
                                         result %in% c("win/no qualify", "tie") ~ 0, 
                                         result=="lose" ~ -1, 
                                         TRUE ~ -99
                                         ),
                          blind=case_when(result %in% c("win/qualify", "win/no qualify") ~ blindPay, 
                                          result=="tie" ~ 0, 
                                          result=="lose" ~ -1, 
                                          TRUE ~ -99
                                          ), 
                          play=case_when(result %in% c("win/qualify", "win/no qualify") ~ betPlay, 
                                         result=="tie" ~ 0, 
                                         result=="lose" ~ -betPlay, 
                                         TRUE ~ -99
                                         )
                          )
           )
    
}

lst200 <- lapply(1:200, FUN=function(y) {
    map_dfr(1:100, 
            .f=function(x) {
                rn <- sample(1:nrow(dfHandData), size=1, replace=TRUE, prob=dfHandData$nOfType)
                rd <- dfHandData[rn,]
                getHandOutcome(pWQ=rd$pWQ, 
                               pWN=rd$pWN, 
                               tie=rd$tie, 
                               lose=rd$lose, 
                               betPlay=rd$betPlay, 
                               blindPay=rd$blindPay
                               ) %>%
                    mutate(rn=rn, n=1)
                }
            )
            }
    )

res200 <- map_dfr(lst200, .f=function(x) summarize(x, across(c("ante", "blind", "play"), .fns=sum), n=n()))
res200

res200 %>%
    mutate(overall=ante+blind+play) %>%
    summarize(across(.fns=mean))

```
  
The process is converted for parallel processing:  
```{r, fig.height=9, fig.width=9}

# Simulations of 100 hands
set.seed(23020115)
nSims <- 10000
nPerSim <- 100
simTotal <- vector("numeric", length=nSims)

# Get the hand numbers for the simulation
rn <- sample(1:nrow(dfHandData), size=nPerSim*nSims, replace=TRUE, prob=dfHandData$nOfType)

# Get the outcomes for the simulation
rd <- dfHandData[rn,] %>% 
    mutate(prob=runif(nPerSim*nSims), 
           wintie=win+tie, 
           res=case_when(prob<=pWQ ~ "winQ", 
                         prob<=win ~ "winNo", 
                         prob <= wintie ~ "tie", 
                         prob <= wintie+lose ~ "lose", 
                         TRUE ~ "ERROR"
                         )
           )

# Convert to payouts by bet
rp <- rd %>%
    mutate(resActual=ifelse(betPlay==0, "fold", res), 
           resPlay=case_when(resActual %in% c("winQ", "winNo") ~ betPlay, 
                             resActual %in% c("fold", "tie") ~ 0, 
                             resActual %in% c("lose") ~ -betPlay, 
                             TRUE ~ -Inf
                             ), 
           resBlind=case_when(resActual %in% c("winQ", "winNo") ~ blindPay, 
                              resActual %in% c("tie") ~ 0, 
                              resActual %in% c("lose", "fold") ~ -1, 
                              TRUE ~ -Inf
                              ), 
           resAnte=case_when(resActual %in% c("winQ") ~ 1, 
                             resActual %in% c("tie", "winNo") ~ 0, 
                             resActual %in% c("lose", "fold") ~ -1, 
                             TRUE ~ -Inf
                             ), 
           resAll=resPlay+resBlind+resAnte
           ) %>%
    select(wType, betPlay, res, resActual, resPlay, resBlind, resAnte, resAll)
rp

# Get statistics by key attributes
rp %>%
    summarize(n=n(), across(c(resPlay, resBlind, resAnte, resAll), .fns=mean))

rp %>%
    group_by(wType, betPlay) %>%
    summarize(n=n(), across(c(resPlay, resBlind, resAnte, resAll), .fns=mean), .groups="drop") %>%
    arrange(desc(wType), betPlay)

rp %>%
    group_by(wType, resActual) %>%
    summarize(n=n(), across(c(resPlay, resBlind, resAnte, resAll), .fns=mean), .groups="drop") %>%
    arrange(desc(wType), resActual) %>%
    print(n=40)

rp %>%
    group_by(betPlay, resActual, res) %>%
    summarize(n=n(), 
              across(c(resPlay, resBlind, resAnte, resAll), .fns=list(mean=mean)), 
              .groups="drop"
              ) %>%
    arrange(betPlay)

```
  
The value of holding a specific card (no other values known) is explored:  
```{r, fig.height=9, fig.width=9, cache=TRUE}

# Full database of hands and outcomes
fullHandDB <- sortedHandRanks %>%
    select(handNum, rank, qual, nWild) %>%
    full_join(select(dfResAll_202301_v001, -handNum), by=c("rank", "nWild")) %>%
    mutate(nType=tblAllTypes$nType) %>%
    left_join(select(allValueGrid, wType=wildType, nType=naturalType, bonusPay), by=c("wType", "nType"))
fullHandDB

# Average bonus value given presence of card in hand
cardBonusValue <- map_dfr(.x=1:53,
                          .f=function(x) fullHandDB %>%
                              mutate(keyHand=ifelse(handNum %in% cardInHand[[x]], "Y", "N")) %>%
                              group_by(keyHand) %>%
                              summarize(n=n(), ev=mean(bonusPay), pctWin=mean(bonusPay>0)), 
                          .id="cardNum"
                          )

```
  
```{r, fig.height=9, fig.width=9}

# Check that values are suit independent
map_dfr(.x=1:13, 
        .f=function(x) cardBonusValue %>% 
            filter(as.integer(cardNum) %in% (x+c(0, 13, 26, 39))) %>%
            group_by(keyHand) %>%
            summarize(across(where(is.numeric), .fns=function(x) max(x)-min(x))), 
        .id="cardRank"
        ) %>%
    summary()

# Show hand values
cardBonusValue %>%
    filter(as.integer(cardNum) %in% c(1:13, 53)) %>%
    select(haveCard=keyHand, cardNum, ev, winProb=pctWin) %>%
    pivot_longer(-c(haveCard, cardNum)) %>%
    mutate(haveCard=ifelse(haveCard=="Y", "1. First card is this", "2. First card is NOT this")) %>%
    ggplot(aes(x=fct_reorder(cardNum, 
                             value, 
                             .fun=function(x) x[order(x, decreasing=TRUE)[2]] + min(x)/100
                             )
               )
           ) + 
    geom_point(aes(y=value)) + 
    geom_text(aes(y=value+0.01, label=round(value, 3)), size=2.5, hjust=0) +
    coord_flip() + 
    facet_grid(haveCard~name, scales="free_x") +
    labs(title="Expected value of bonus given single card in hand", y="Average", x="Card Index")

```
  
As expected, wild cards are very valuable and make bonus hands much more likely. The deuce is more valuable than the joker since it can make higher-paying natural straights and flushes. Of the non-wild cards, 10 is most valuable (can make any straight, including royal), followed by 7-8-9 (can make any straight, naturally or wild)
  
The value of holding a specific card (no other values known) is explored:  
```{r, fig.height=9, fig.width=9, cache=TRUE}

# Average bonus value given presence of card in hand
cardMainValue <- map_dfr(.x=1:53,
                         .f=function(x) fullHandDB %>%
                             mutate(keyHand=ifelse(handNum %in% cardInHand[[x]], "Y", "N")) %>%
                             group_by(keyHand, betPlay) %>%
                             summarize(n=n(), 
                                       across(c(pLQ, pLN, pTQ, pTN, pWQ, pWN, evPlay, evAll), .fns=mean), 
                                       .groups="drop"
                                       ), 
                         .id="cardNum"
                         )

```
  
```{r, fig.height=9, fig.width=9}

# Check that values are suit independent
map_dfr(.x=1:13, 
        .f=function(x) cardMainValue %>% 
            filter(as.integer(cardNum) %in% (x+c(0, 13, 26, 39))) %>%
            group_by(keyHand, betPlay) %>%
            summarize(across(where(is.numeric), .fns=function(x) max(x)-min(x)), .groups="drop"), 
        .id="cardRank"
        ) %>%
    summary()

# Show play bet size probabilities by initial card
cardMainValue %>%
    filter(as.integer(cardNum) %in% c(1:13, 53), keyHand=="Y") %>%
    group_by(cardNum) %>%
    mutate(pct=n/sum(n), cumpct=cumsum(pct)-pct/2) %>%
    ungroup() %>%
    ggplot(aes(x=factor(cardNum, levels=c(53, 2, 1, 13:3)))) + 
    geom_col(aes(y=pct, fill=fct_rev(factor(betPlay))), position="fill") + 
    geom_text(aes(y=cumpct, label=round(pct,3)), size=2.5) +
    labs(title="Play bet size by initial card", x="Initial card", y="Frequency") + 
    scale_fill_discrete("Play Bet")

# Show main bet EV by initial card and bet amount
cardMainValue %>%
    filter(as.integer(cardNum) %in% c(1:13, 53), keyHand=="Y") %>%
    group_by(cardNum) %>%
    summarize(across(c(evPlay, evAll), .fns=function(x) sum(x*n)/sum(n)), .groups="drop") %>%
    pivot_longer(-c(cardNum)) %>%
    ggplot(aes(x=factor(cardNum, levels=c(3:13, 1, 2, 53)))) + 
    geom_col(aes(y=value), fill="lightblue") + 
    geom_text(aes(y=value/2, label=round(value,3)), size=2.5) +
    labs(title="EV by initial card", x="Initial card", y="EV") + 
    coord_flip() +
    facet_wrap(~name)

# Show main bet EV by initial card and bet amount
cardMainValue %>%
    filter(as.integer(cardNum) %in% c(1:13, 53), keyHand=="Y") %>%
    select(cardNum, betPlay, evPlay, evAll) %>%
    pivot_longer(-c(cardNum, betPlay)) %>%
    ggplot(aes(x=factor(cardNum, levels=c(3:13, 1, 2, 53)))) + 
    geom_col(aes(y=value), fill="lightblue") + 
    geom_text(aes(y=value/2, label=round(value,3)), size=2.5) +
    labs(title="EV by initial card and bet size", x="Initial card", y="EV") + 
    coord_flip() +
    facet_grid(betPlay~name)

```
  
The overall value of holding a specific card (no other values known) is explored:  
```{r, fig.height=9, fig.width=9}

# Show play bet size probabilities by initial card
cardMainValue %>%
    filter(as.integer(cardNum) %in% c(1:13, 53), keyHand=="Y") %>%
    group_by(cardNum, keyHand) %>%
    summarize(across(c(evPlay, evAll), .fns=function(x) sum(x*n)/sum(n)), .groups="drop") %>%
    full_join(filter(select(cardBonusValue, -n), keyHand=="Y", as.integer(cardNum) %in% c(1:13, 53)), 
              by=c("cardNum", "keyHand")
              ) %>%
    rename(evBonus=ev, pctWinBouns=pctWin, evMainAll=evAll) %>%
    mutate(evOverAll3_1=3*evMainAll+evBonus) %>%
    select(cardNum, keyHand, evMainAll, evBonus, evOverAll3_1) %>%
    pivot_longer(-c(cardNum, keyHand)) %>%
    ggplot(aes(x=factor(cardNum, levels=c(2, 53, 1, 13:3)))) + 
    geom_col(aes(y=value), fill="lightblue") + 
    geom_text(aes(y=value, label=round(value,2), hjust=ifelse(value<0, 1, 0)), size=2.5) +
    labs(title="EV by initial card", x="Initial card", y="EV") + 
    coord_flip() +
    facet_wrap(~name)

```
  
The value of holding both a wild card and a specific card (no other values known) is explored:  
```{r, fig.height=9, fig.width=9, cache=TRUE}

# Average bonus value given presence of card in hand
cardWithWildValue <- map_dfr(.x=c(1:52),
                             .f=function(x) fullHandDB %>%
                                 mutate(keyHand=ifelse(handNum %in% intersect(cardInHand[[x]], cardInHand[[53]]), 
                                                       "Y", 
                                                       "N"
                                                       )
                                        ) %>%
                                 group_by(keyHand, betPlay) %>%
                                 summarize(n=n(), 
                                           across(c(pLQ, pLN, pTQ, pTN, pWQ, pWN, evPlay, evAll), .fns=mean), 
                                           .groups="drop"
                                           ), 
                             .id="cardNum"
                             )

```
  
```{r, fig.height=9, fig.width=9}

# Check that values are suit independent
map_dfr(.x=1:13, 
        .f=function(x) cardWithWildValue %>% 
            filter(as.integer(cardNum) %in% (x+c(0, 13, 26, 39))) %>%
            group_by(keyHand, betPlay) %>%
            summarize(across(where(is.numeric), .fns=function(x) max(x)-min(x)), .groups="drop"), 
        .id="cardRank"
        ) %>%
    summary()

# Show play bet size probabilities by second card
cardWithWildValue %>%
    filter(as.integer(cardNum) %in% c(1:13), keyHand=="Y") %>%
    group_by(cardNum) %>%
    mutate(pct=n/sum(n), cumpct=cumsum(pct)-pct/2) %>%
    ungroup() %>%
    ggplot(aes(x=factor(cardNum, levels=c(2, 1, 13:3)))) + 
    geom_col(aes(y=pct, fill=fct_rev(factor(betPlay))), position="fill") + 
    geom_text(aes(y=cumpct, label=round(pct,3)), size=2.5) +
    labs(title="Play bet size by second card given first card joker", x="Second card", y="Frequency") + 
    scale_fill_discrete("Play Bet")

# Show main bet EV by second card and bet amount
cardWithWildValue %>%
    filter(as.integer(cardNum) %in% c(1:13), keyHand=="Y") %>%
    group_by(cardNum) %>%
    summarize(across(c(evPlay, evAll), .fns=function(x) sum(x*n)/sum(n)), .groups="drop") %>%
    pivot_longer(-c(cardNum)) %>%
    ggplot(aes(x=factor(cardNum, levels=c(3:13, 1, 2)))) + 
    geom_col(aes(y=value), fill="lightblue") + 
    geom_text(aes(y=value/2, label=round(value,3)), size=2.5) +
    labs(title="EV by second card given first card joker", x="Second card", y="EV") + 
    coord_flip() +
    facet_wrap(~name)

# Show main bet EV by second card and bet amount
cardWithWildValue %>%
    filter(as.integer(cardNum) %in% c(1:13), keyHand=="Y") %>%
    select(cardNum, betPlay, evPlay, evAll) %>%
    pivot_longer(-c(cardNum, betPlay)) %>%
    ggplot(aes(x=factor(cardNum, levels=c(3:13, 1, 2)))) + 
    geom_col(aes(y=value), fill="lightblue") + 
    geom_text(aes(y=value/2, label=round(value,3)), size=2.5) +
    labs(title="EV by second card (assumes first is joker) and bet size", x="Second card", y="EV") + 
    coord_flip() +
    facet_grid(betPlay~name)

```
  
The value of holding two cards (not each of the same suit) is explored:  
```{r, fig.height=9, fig.width=9, cache=TRUE}

# Average main value given presence of two unsuited cards in hand
cardFirstTwoValue <- map2(.x=rep(1:13, each=13),
                          .y=rep(14:26, times=13),
                          .f=function(x, y) fullHandDB %>%
                              mutate(keyHand=ifelse(handNum %in% intersect(cardInHand[[x]], cardInHand[[y]]), 
                                                    "Y", 
                                                    "N"
                                                    ), 
                                     card1=x, 
                                     card2=y
                                     ) %>%
                              group_by(keyHand, betPlay, card1, card2) %>%
                              summarize(n=n(), 
                                        across(c(pLQ, pLN, pTQ, pTN, pWQ, pWN, evPlay, evAll), .fns=mean), 
                                        .groups="drop"
                                        )
                          )

```
  
```{r, fig.height=9, fig.width=9}

# Show play bet size probabilities by first two cards
cardFirstTwoValue %>%
    list_rbind() %>%
    filter(card1 != card2, keyHand=="Y") %>%
    group_by(card1, card2) %>%
    mutate(pct=n/sum(n)) %>%
    ungroup() %>%
    ggplot(aes(x=factor(card1, levels=c(2, 1, 13:3)), y=factor(card2, levels=c(15, 14, 26:16)))) + 
    geom_tile(aes(fill=pct)) + 
    geom_text(aes(label=round(pct,2)), size=2.5) +
    labs(title="Frequency of bet size by first two cards (unsuited)", x="First card", y="Second card") + 
    facet_wrap(~betPlay) +
    scale_fill_continuous("Proportion of hands", high="lightgreen", low="white") + 
    theme(legend.position = "bottom")

# Show main bet EV by second card
cardFirstTwoValue %>%
    list_rbind() %>%
    filter(card1 != card2, keyHand=="Y") %>%
    group_by(card1, card2) %>%
    summarize(across(c(evPlay, evAll), .fns=function(x) sum(x*n)/sum(n)), .groups="drop") %>%
    pivot_longer(-c(card1, card2)) %>%
    ggplot(aes(x=factor(card1, levels=c(2, 1, 13:3)), y=factor(card2, levels=c(15, 14, 26:16)))) + 
    geom_tile(aes(fill=value)) + 
    geom_text(aes(label=round(value,2)), size=2.5) +
    labs(title="EV by first two cards (unsuited)", x="First card", y="Second card") + 
    facet_wrap(~name) + 
    scale_fill_continuous("EV", high="lightgreen", low="white")

# Show main bet EV by second card and bet amount
cardFirstTwoValue %>%
    list_rbind() %>%
    filter(card1 != card2, keyHand=="Y") %>%
    select(card1, card2, betPlay, evPlay, evAll) %>%
    pivot_longer(-c(card1, card2, betPlay)) %>%
    ggplot(aes(x=factor(card1, levels=c(2, 1, 13:3)), y=factor(card2, levels=c(15, 14, 26:16)))) + 
    geom_tile(aes(fill=value)) + 
    geom_text(aes(label=round(value,2)), size=2.5) +
    labs(title="EV by first two cards (unsuited) and bet size", x="First card", y="Second card") + 
    facet_grid(betPlay~name) + 
    scale_fill_continuous("EV", high="lightgreen", low="white")

```
  
The value of holding two cards (not each of the same suit) is explored:  
```{r, fig.height=9, fig.width=9, cache=TRUE}

# Average main value given presence of two unsuited cards in hand
cardFirstTwoSuitedValue <- map2(.x=rep(1:13, each=13),
                                .y=rep(1:13, times=13),
                                .f=function(x, y) fullHandDB %>%
                                    mutate(keyHand=ifelse(handNum %in% intersect(cardInHand[[x]], cardInHand[[y]]), 
                                                          "Y", 
                                                          "N"
                                                          ), 
                                           card1=x, 
                                           card2=y
                                           ) %>%
                                    group_by(keyHand, betPlay, card1, card2) %>%
                                    summarize(n=n(), 
                                              across(c(pLQ, pLN, pTQ, pTN, pWQ, pWN, evPlay, evAll), .fns=mean), 
                                              .groups="drop"
                                              )
                                )

```
  
```{r, fig.height=9, fig.width=9}

# Show play bet size probabilities by first two cards (suited)
cardFirstTwoSuitedValue %>%
    list_rbind() %>%
    filter(card1 != card2, keyHand=="Y") %>%
    group_by(card1, card2) %>%
    mutate(pct=n/sum(n)) %>%
    ungroup() %>%
    ggplot(aes(x=factor(card1, levels=c(2, 1, 13:3)), y=factor(card2, levels=c(2, 1, 13:3)))) + 
    geom_tile(aes(fill=pct)) + 
    geom_text(aes(label=round(pct,2)), size=2.5) +
    labs(title="Frequency of bet size by first two cards (suited)", x="First card", y="Second card") + 
    facet_wrap(~betPlay) +
    scale_fill_continuous("Proportion of hands", high="lightgreen", low="white") + 
    theme(legend.position = "bottom")

# Show main bet EV by first two cards (suited)
cardFirstTwoSuitedValue %>%
    list_rbind() %>%
    filter(card1 != card2, keyHand=="Y") %>%
    group_by(card1, card2) %>%
    summarize(across(c(evPlay, evAll), .fns=function(x) sum(x*n)/sum(n)), .groups="drop") %>%
    pivot_longer(-c(card1, card2)) %>%
    ggplot(aes(x=factor(card1, levels=c(2, 1, 13:3)), y=factor(card2, levels=c(2, 1, 13:3)))) + 
    geom_tile(aes(fill=value)) + 
    geom_text(aes(label=round(value,2)), size=2.5) +
    labs(title="EV by first two cards (suited)", x="First card", y="Second card") + 
    facet_wrap(~name) + 
    scale_fill_continuous("EV", high="lightgreen", low="white")

# Show main bet EV by first two cards (suited) and bet amount
cardFirstTwoSuitedValue %>%
    list_rbind() %>%
    filter(card1 != card2, keyHand=="Y") %>%
    select(card1, card2, betPlay, evPlay, evAll) %>%
    pivot_longer(-c(card1, card2, betPlay)) %>%
    ggplot(aes(x=factor(card1, levels=c(2, 1, 13:3)), y=factor(card2, levels=c(2, 1, 13:3)))) + 
    geom_tile(aes(fill=value)) + 
    geom_text(aes(label=round(value,2)), size=2.5) +
    labs(title="EV by first two cards (suited) and bet size", x="First card", y="Second card") + 
    facet_grid(betPlay~name) + 
    scale_fill_continuous("EV", high="lightgreen", low="white")

```
  
An attempt is made to improve the hand exclusion process. The cards by hand matrix is created:  
```{r, fig.height=9, fig.width=9}

# Matrix of 1/0 for whether card is in hand
fullHandMatrix <- matrix(rep(0L, 53*choose(53,5)), nrow=choose(53,5), ncol=53)
for(intCtr in 1:53) {
    fullHandMatrix[cardInHand[[intCtr]], intCtr] <- 1L
}
colSums(fullHandMatrix)

# Select a subset of fullHandMatrix to be the exclusions
t <- proc.time()

set.seed(23022216)
exclMatrix <- fullHandMatrix[sample(1:nrow(fullHandMatrix), 10, replace=FALSE), ]

# Matrix math of the exclusions, run row by row of exclMatrix
map(1:10, 
    .f=function(x) 
        sortedHandRanks[which((fullHandMatrix %*% t(exclMatrix[x,,drop=FALSE]))>0),] %>% count(rank)
    ) %>% str

proc.time() - t

# Existing process
t <- proc.time()
calculateResults(useHandNums=1:10)
proc.time() - t

cat("\nThe existing process would take around", round(choose(53,5) * 5 / 10 / 60), "minutes for all hands\n")

```
  
While slow, the existing process is much faster than the attempted conversion to matrix math. Further exploration can potentially focus on optimizing calculateResults() and downstream functions:
```{r, fig.height=9, fig.width=9}

# Timing impact for union of cards in hand (9 hands per second, 0.11 seconds per hand)
t <- proc.time()
for(intCtr in 1:100) tmp <- purrr::reduce(.x=cardInHand[c(1, 2, 3, 4, 5)], .f=union)
proc.time() - t

# Timing impact for finding hand values (2.5 hands per second, 0.4 seconds per hand)
tmpRank <- sortedHandRanks$rank[1]
t <- proc.time()
for(intCtr in 1:100) {
    sortedHandRanks %>%
        filter(!(handNum %in% tmp)) %>%
        summarize(pLQ=mean(qual=="Q" & rank<tmpRank),
                  pLN=mean(qual=="N" & rank<tmpRank), 
                  pTQ=mean(qual=="Q" & rank==tmpRank),
                  pTN=mean(qual=="N" & rank==tmpRank), 
                  pWQ=mean(qual=="Q" & rank>tmpRank),
                  pWN=mean(qual=="N" & rank>tmpRank), 
                  n=n()
                  ) %>%
        mutate(pWNoTie=(pWQ+pWN)/(1-pTQ-pTN), rank=tmpRank)
}
proc.time() - t

```
  
The function for assessing probabilities of win, tie, lose, and qualify takes ~80% of the time, and is a candidate for further exploration:  
```{r, fig.height=9, fig.width=9}

t <- proc.time()
for(intCtr in 1:100) {
    sortedHandRanks %>%
        filter(!(handNum %in% tmp)) %>%
        mutate(result=case_when(rank < tmpRank ~ "L", 
                                rank==tmpRank ~ "T", 
                                rank > tmpRank ~ "W", 
                                TRUE ~ "Error"
                                )
               ) %>%
        count(qual, result)
}
proc.time() - t

t <- proc.time()
for(intCtr in 1:100) {
    sortedHandRanks %>%
        filter(!(handNum %in% tmp))
}
proc.time() - t

t <- proc.time()
for(intCtr in 1:100) {
    smallSorted %>%
        filter(!(handNum %in% tmp))
}
proc.time() - t

```
  
Creating a variable and then counting is slower than summarizing. A significant chunk of the time is in the filtering to only the relevant hands. Most of the time takes place in the actual filtering step, even if extraneous columns of the database are deleted

The total number of hands can be reduced by taking advantage of suit indifference (e.g., there are a hand has the same value if all its spades became hearts and all its hearts became spades). For hands with no wilds, there are the following combinations:  
  
* 5-0-0-0 (flushes)  
* 4-1-0-0  
* 3-2-0-0  
* 3-1-1-0  
* 2-2-1-0  
* 2-1-1-1  
  
All hands of a given type can be simulated using the first suit for the maximum number of cards:  
```{r, fig.height=9, fig.width=9}

# Get count by suit for each hand type
handSuit <- tibble::tibble(handNum=1:nrow(mtxHands), 
                           nWild=mtxHands %in% c(2, 15, 28, 41, 53) %>% matrix(ncol=5, byrow=FALSE) %>% rowSums,
                           n1=mtxHands %in% c(1, 3:13) %>% matrix(ncol=5, byrow=FALSE) %>% rowSums, 
                           n2=mtxHands %in% c(14, 16:26) %>% matrix(ncol=5, byrow=FALSE) %>% rowSums, 
                           n3=mtxHands %in% c(27, 29:39) %>% matrix(ncol=5, byrow=FALSE) %>% rowSums, 
                           n4=mtxHands %in% c(40, 42:52) %>% matrix(ncol=5, byrow=FALSE) %>% rowSums
                           )
handSuit

# Filter for only descending order
handSuit %>%
    filter(n2 <= n1, n3 <= n2, n4 <= n3) %>%
    count(nWild, n1, n2, n3, n4)

```
  
There is still significant duplication in this data, as 4s-3s-A-K-Q and 4s-3s-K-A-Q are the same for 2-1-1-1. But just this initial filtering reduces the volume to simulate by a factor of 6-7. As an example, the natural hands with no pair that are A-K-J-x-x are explored:  
```{r, fig.height=9, fig.width=9}

# Key hands to use - Filter for only descending order
handEligible <- handSuit %>%
    filter(n2 <= n1, n3 <= n2, n4 <= n3)
handEligible

# Eligible hands of type AKJxx
eligibleAKJxx <- allHandRanks %>% 
    filter(wType==99, tb1==14, tb2==13, tb3 == 11) %>%
    semi_join(handEligible, by=c("handNum"))
eligibleAKJxx

# Create tibble of hand types
mtxSmallTest <- mtxHands[eligibleAKJxx$handNum,]
tblSmallTest <- tibble::as_tibble(mtxSmallTest, .name_repair=make.names) %>%
    purrr::set_names(paste0("V", 1:5)) %>%
    mutate(handNum=eligibleAKJxx$handNum)
tblSmallTest

# Get suit counts of descending cards
tmpCheckSuits <- tblSmallTest %>%
    pivot_longer(-c(handNum)) %>%
    mutate(rank=1 + (value-1) %% 13, rank=ifelse(rank==1, 14, rank), suit=(value-1) %/% 13) %>%
    arrange(handNum, desc(rank))
tmpCheckSuits

# Get count of hands with Ace as first suit, King as first or second suit - 1,120 hands
tmpAKJxxUse <- tmpCheckSuits %>%
    filter((rank==14 & suit==0) | (rank==13 & suit %in% c(0, 1))) %>%
    group_by(handNum) %>%
    summarize(n=n()) %>%
    filter(n==2)
tmpAKJxxUse

```
  
```{r, fig.height=9, fig.width=9, cache=TRUE}

# Run for example hand of AKJxx that have A as suit 1 and K as suit 1 or 2
t <- proc.time()
resAKJxx <- calculateResults(useHandNums=tmpAKJxxUse$handNum)
proc.time()-t

```
  
```{r, fig.height=9, fig.width=9}

# Plot of EV by hand type
resAKJxx %>% 
    mutate(evAllIfPlay=2*pWQ+pWN-3*pLQ-3*pLN) %>% 
    left_join(tmpCheckSuits %>% 
                  filter(!(rank %in% c(14, 13, 11))) %>% 
                  group_by(handNum) %>% 
                  mutate(label=paste0("AKJ", max(rank), min(rank)), label=str_replace(label, "10", "T")) %>% 
                  filter(row_number()==1) %>% 
                  ungroup(), 
              by="handNum"
              ) %>% 
    ggplot(aes(x=factor(label))) + 
    coord_flip() + 
    labs(x=NULL, 
         y="Distribution", 
         title="EV if playing hands of type 99, ranks AKJxx", 
         subtitle="Fold is EV -2"
         ) + 
    geom_boxplot(aes(y=evAllIfPlay), fill="lightblue") + 
    geom_hline(yintercept=-2, lty=2)

```
  
Significant reductions in processing time can be achieved through systemizing an approach like this. Additional hand types of Ace-high are also explored:  
```{r}

# Eligible hands of type AKxxx (excluding AKJxx, already created)
eligibleAKxxx <- allHandRanks %>% 
    filter(wType==99, tb1==14, tb2==13, tb3 != 11) %>%
    semi_join(handEligible, by=c("handNum"))
eligibleAKxxx

# Create tibble of hand types
mtxSmallTest <- mtxHands[eligibleAKxxx$handNum,]
tblSmallTest <- tibble::as_tibble(mtxSmallTest, .name_repair=make.names) %>%
    purrr::set_names(paste0("V", 1:5)) %>%
    mutate(handNum=eligibleAKxxx$handNum)
tblSmallTest

# Get suit counts of descending cards
tmpCheckSuits <- tblSmallTest %>%
    pivot_longer(-c(handNum)) %>%
    mutate(rank=1 + (value-1) %% 13, rank=ifelse(rank==1, 14, rank), suit=(value-1) %/% 13) %>%
    arrange(handNum, desc(rank))
tmpCheckSuits

# Get count of hands with Ace as first suit, King as first or second suit - 3,640 hands
tmpAKxxxUse <- tmpCheckSuits %>%
    filter((rank==14 & suit==0) | (rank==13 & suit %in% c(0, 1))) %>%
    group_by(handNum) %>%
    summarize(n=n()) %>%
    filter(n==2)
tmpAKxxxUse

```
  
```{r, fig.height=9, fig.width=9, cache=TRUE}

# Run for all hands of AKxxx (except for AKJxx, previously run)
t <- proc.time()
resAKxxx <- calculateResults(useHandNums=tmpAKxxxUse$handNum)
proc.time()-t

```
  
```{r}

# Save file for use later
resAK99 <- resAKJxx %>%
    bind_rows(resAKxxx)
saveToRDS(resAK99, ovrWriteError=FALSE)

```
  
```{r, fig.height=9, fig.width=9}

tmpHR <- allHandRanks %>% 
    filter(wType==99, tb1==14, tb2==13) %>%
    semi_join(handEligible, by=c("handNum")) %>%
    pull(handNum)

tmpHS <- mtxHands[tmpHR,] %>%
    tibble::as_tibble(.name_repair=make.names) %>%
    purrr::set_names(paste0("V", 1:5)) %>%
    mutate(handNum=tmpHR) %>%
    pivot_longer(-c(handNum)) %>%
    mutate(rank=1 + (value-1) %% 13, rank=ifelse(rank==1, 14, rank), suit=(value-1) %/% 13) %>%
    arrange(handNum, desc(rank))

# Plot of EV by hand type
resAK99 %>% 
    mutate(evAllIfPlay=2*pWQ+pWN-3*pLQ-3*pLN) %>% 
    left_join(tmpHS %>% 
                  filter(!(rank %in% c(14, 13))) %>% 
                  group_by(handNum) %>% 
                  mutate(label=paste0("AK", max(rank), nth(rank, 2), min(rank)), 
                         label=str_replace(label, "12", "Q"),
                         label=str_replace(label, "11", "V"),
                         label=str_replace(label, "10", "T"),
                         card3=str_sub(label, 3, 3)
                         ) %>% 
                  filter(row_number()==1) %>% 
                  ungroup(), 
              by="handNum"
              ) %>% 
    ggplot(aes(x=factor(label))) + 
    coord_flip() + 
    labs(x=NULL, 
         y="Distribution", 
         title="EV if playing hands of type 99, ranks AKxxx", 
         subtitle="Fold is EV -2"
         ) + 
    geom_boxplot(aes(y=evAllIfPlay), fill="lightblue") + 
    geom_hline(yintercept=-2, lty=2) + 
    facet_wrap(~(card3 %in% c("Q", "V")), scales="free_y")

```
  
The file is explored for hands with identical win probabilities:  
```{r, fig.height=9, fig.width=9}

testSameEV <- resAK99 %>%
    arrange(pWN, pTN, pLN, pLQ) %>%
    group_by(rank) %>%
    mutate(across(c(pWN, pTN, pLN, pLQ), 
                  .fns=function(x) ifelse(row_number()==1, 0, x-lag(x)), 
                  .names="{.col}_lag"
                  ), 
           across(c(pWN, pTN, pLN, pLQ), 
                  .fns=function(x) ifelse(row_number()==1, 0, lead(x)-x), 
                  .names="{.col}_lead"
                  ), 
           maxLag=pmax(abs(pWN_lag), abs(pTN_lag), abs(pLN_lag), abs(pLQ_lag)), 
           maxLead=pmax(abs(pWN_lead), abs(pTN_lead), abs(pLN_lead), abs(pLQ_lead))
           ) %>%
    ungroup()

testSameEV %>%
    mutate(evPlay=2*pWQ+pWN-3*pLQ-3*pLN, isSame=ifelse(maxLag<=1e-9 | maxLead <= 1e-9, "match", "unique")) %>%
    ggplot(aes(x=evPlay)) +
    geom_histogram(aes(fill=isSame), bins=100) + 
    labs(x="EV of Play", y=NULL, title="Histogram of hands that match 1+ other hands in EV")

# Hands of same rank (4380) and EV - AKQJ9
testSameEV %>%
    filter(rank==4380) %>%
    filter(evPlay==max(evPlay)) %>%
    pull(handNum) %>%
    mtxHands[.,]

# Hands of same rank (4380) and EV - AKQJ9
testSameEV %>%
    filter(rank==4380) %>%
    filter(evPlay!=max(evPlay)) %>%
    pull(handNum) %>%
    mtxHands[.,]

```
  
As an example, AKQJ9 with suits 2-1-1-1 have identical EV provided the matching suit cards are A/K, A/Q, or A/J.

Natural hands of type JJxxx are also explored, though suit eligibility needs to be modified:  
```{r, fig.height=9, fig.width=9}

# Eligible hands of type JJxxx
eligibleJJxxx <- allHandRanks %>% 
    filter(wType==11, tb1==11, tb2==11) %>% 
    semi_join(handSuit %>% filter(n2 <= n1, n4 <= n3, nWild==0), by=c("handNum"))
eligibleJJxxx

# Create tibble of hand types
mtxSmallTest <- mtxHands[eligibleJJxxx$handNum,]
tblSmallTest <- tibble::as_tibble(mtxSmallTest, .name_repair=make.names) %>%
    purrr::set_names(paste0("V", 1:5)) %>%
    mutate(handNum=eligibleJJxxx$handNum)
tblSmallTest

# Get suit counts of descending cards
tmpCheckSuits <- tblSmallTest %>%
    pivot_longer(-c(handNum)) %>%
    mutate(rank=1 + (value-1) %% 13, rank=ifelse(rank==1, 14, rank), suit=(value-1) %/% 13) %>%
    arrange(handNum, desc(rank))
tmpCheckSuits

# Get count of hands with Jack as first two suits
tmpJJxxxUse <- tmpCheckSuits %>%
    filter((rank==11 & suit==0) | (rank==11 & suit %in% c(1))) %>%
    group_by(handNum) %>%
    summarize(n=n()) %>%
    filter(n==2)
tmpJJxxxUse

# Get suit counts by whether hands are used
tmpCheckSuits %>% 
    group_by(handNum, suit) %>% 
    summarize(n=n(), .groups="drop") %>% 
    mutate(suit=paste0("V", suit)) %>%
    pivot_wider(id_cols=handNum, names_from="suit", values_from="n", values_fill=0) %>%
    full_join(tmpJJxxxUse, by=c("handNum")) %>%
    mutate(type=ifelse(is.na(n), "Ineligible", "Eligible")) %>%
    count(type, V0, V1, V2, V3) %>%
    print(n=30)

```

```{r, fig.height=9, fig.width=9, cache=TRUE}

# Run for all hands of JJxxx (no wild)
t1 <- proc.time()
resJJxxx <- calculateResults(useHandNums=tmpJJxxxUse$handNum)
proc.time()-t1

```
  
```{r}

# Save file for use later
saveToRDS(resJJxxx, ovrWriteError=FALSE)

```
  
Hands of type JJxxx are explored for ranges of evPlay:  
```{r, fig.height=9, fig.width=9}

tmpHR <- tmpJJxxxUse %>%
    pull(handNum)

tmpHS <- mtxHands[tmpHR,] %>%
    tibble::as_tibble(.name_repair=make.names) %>%
    purrr::set_names(paste0("V", 1:5)) %>%
    mutate(handNum=tmpHR) %>%
    pivot_longer(-c(handNum)) %>%
    mutate(rank=1 + (value-1) %% 13, rank=ifelse(rank==1, 14, rank), suit=(value-1) %/% 13) %>%
    arrange(handNum, desc(rank))

# Plot of EV by hand type
resJJxxx %>% 
    mutate(evAllIfPlay=2*pWQ+pWN-3*pLQ-3*pLN) %>% 
    left_join(tmpHS %>% 
                  filter(!(rank %in% c(11))) %>% 
                  group_by(handNum) %>% 
                  mutate(label=paste0("JJ", max(rank), nth(rank, 2), min(rank)), 
                         label=str_replace(label, "14", "A"),
                         label=str_replace(label, "13", "K"),
                         label=str_replace(label, "12", "Q"),
                         label=str_replace(label, "10", "T"),
                         card3=str_sub(label, 3, 3)
                         ) %>% 
                  filter(row_number()==1) %>% 
                  ungroup(), 
              by="handNum"
              ) %>% 
    mutate(bucket=case_when(card3=="A" ~ "1. A", card3=="K" ~ "2. K", TRUE ~ "3. Q or lower")) %>%
    ggplot(aes(x=factor(label))) + 
    coord_flip() + 
    labs(x=NULL, 
         y="Distribution", 
         title="EV of play bet for natural hands of rank JJxxx"
         ) + 
    geom_boxplot(aes(y=evPlay), fill="lightblue") + 
    geom_hline(yintercept=0, lty=2) + 
    facet_wrap(~bucket, scales="free_y")

```
  
The JJxxx with no wilds has positive evPlay provided it contains two kickers of rank A, K, or Q.

Wild hands of type 2Jxxx (pair only) are also explored:  
```{r, fig.height=9, fig.width=9}

# Eligible hands of type JJxxx
eligible2Jxxx <- allHandRanks %>% 
    filter(wType==11, tb1==11, tb2==11) %>% 
    semi_join(handSuit %>% filter(n2 <= n1, n4 <= n3, nWild==1), by=c("handNum"))
eligible2Jxxx

# Create tibble of hand types
mtxSmallTest <- mtxHands[eligible2Jxxx$handNum,]
tblSmallTest <- tibble::as_tibble(mtxSmallTest, .name_repair=make.names) %>%
    purrr::set_names(paste0("V", 1:5)) %>%
    mutate(handNum=eligible2Jxxx$handNum)
tblSmallTest

# Get suit counts of descending cards
tmpCheckSuits <- tblSmallTest %>%
    pivot_longer(-c(handNum)) %>%
    mutate(rank=1 + (value-1) %% 13, rank=ifelse(rank==1, 14, rank), suit=(value-1) %/% 13) %>%
    arrange(handNum, desc(rank))
tmpCheckSuits

# Get count of hands with Jack and deuce as first suit
tmp2JxxxUse <- tmpCheckSuits %>%
    filter((rank==11 & suit==0) | (rank==2 & suit %in% c(0))) %>%
    group_by(handNum) %>%
    summarize(n=n()) %>%
    filter(n==2)
tmp2JxxxUse

# Get suit counts by whether hands are used
tmpCheckSuits %>% 
    group_by(handNum, suit) %>% 
    summarize(n=n(), .groups="drop") %>% 
    mutate(suit=paste0("V", suit)) %>%
    pivot_wider(id_cols=handNum, names_from="suit", values_from="n", values_fill=0) %>%
    full_join(tmp2JxxxUse, by=c("handNum")) %>%
    mutate(type=ifelse(is.na(n), "Ineligible", "Eligible")) %>%
    count(type, V0, V1, V2, V3) %>%
    print(n=50)

```

```{r, fig.height=9, fig.width=9, cache=TRUE}

# Run for all hands of 2Jxxx (one wild, pair only)
t1 <- proc.time()
res2Jxxx <- calculateResults(useHandNums=tmp2JxxxUse$handNum)
proc.time()-t1

```
  
```{r}

# Save file for use later
saveToRDS(res2Jxxx, ovrWriteError=FALSE)

```
  
Hands of type 2Jxxx are explored for ranges of evPlay:  
```{r, fig.height=9, fig.width=9}

tmpHR <- tmp2JxxxUse %>%
    pull(handNum)

tmpHS <- mtxHands[tmpHR,] %>%
    tibble::as_tibble(.name_repair=make.names) %>%
    purrr::set_names(paste0("V", 1:5)) %>%
    mutate(handNum=tmpHR) %>%
    pivot_longer(-c(handNum)) %>%
    mutate(rank=1 + (value-1) %% 13, rank=ifelse(rank==1, 14, rank), suit=(value-1) %/% 13) %>%
    arrange(handNum, desc(rank))

# Plot of EV by hand type
res2Jxxx %>% 
    mutate(evAllIfPlay=2*pWQ+pWN-3*pLQ-3*pLN) %>% 
    left_join(tmpHS %>% 
                  filter(!(rank %in% c(11, 2))) %>% 
                  group_by(handNum) %>% 
                  mutate(label=paste0("WJ", max(rank), nth(rank, 2), min(rank)), 
                         label=str_replace(label, "14", "A"),
                         label=str_replace(label, "13", "K"),
                         label=str_replace(label, "12", "Q"),
                         label=str_replace(label, "10", "T"),
                         card3=str_sub(label, 3, 3)
                         ) %>% 
                  filter(row_number()==1) %>% 
                  ungroup(), 
              by="handNum"
              ) %>% 
    mutate(bucket=case_when(card3=="A" ~ "1. A", card3=="K" ~ "2. K", TRUE ~ "3. Q or lower")) %>%
    ggplot(aes(x=factor(label))) + 
    coord_flip() + 
    labs(x=NULL, 
         y="evPlay", 
         title="EV of play bet for wild pairs of rank WJxxx"
         ) + 
    geom_boxplot(aes(y=evPlay), fill="lightblue") + 
    geom_hline(yintercept=0, lty=2) + 
    facet_wrap(~bucket, scales="free_y")

```
  
All wild pairs JJ have positive evPlay. Wild hands of type 2Txxx (pair only) are also explored:  
```{r, fig.height=9, fig.width=9}

# Eligible hands of type TTxxx
eligible2Txxx <- allHandRanks %>% 
    filter(wType==11, tb1==10, tb2==10) %>% 
    semi_join(handSuit %>% filter(n2 <= n1, n4 <= n3, nWild==1), by=c("handNum"))
eligible2Txxx

# Create tibble of hand types
mtxSmallTest <- mtxHands[eligible2Txxx$handNum,]
tblSmallTest <- tibble::as_tibble(mtxSmallTest, .name_repair=make.names) %>%
    purrr::set_names(paste0("V", 1:5)) %>%
    mutate(handNum=eligible2Txxx$handNum)
tblSmallTest

# Get suit counts of descending cards
tmpCheckSuits <- tblSmallTest %>%
    pivot_longer(-c(handNum)) %>%
    mutate(rank=1 + (value-1) %% 13, rank=ifelse(rank==1, 14, rank), suit=(value-1) %/% 13) %>%
    arrange(handNum, desc(rank))
tmpCheckSuits

# Get count of hands with Ten and deuce as first suit
tmp2TxxxUse <- tmpCheckSuits %>%
    filter((rank==10 & suit==0) | (rank==2 & suit %in% c(0))) %>%
    group_by(handNum) %>%
    summarize(n=n()) %>%
    filter(n==2)
tmp2TxxxUse

# Get suit counts by whether hands are used
tmpCheckSuits %>% 
    group_by(handNum, suit) %>% 
    summarize(n=n(), .groups="drop") %>% 
    mutate(suit=paste0("V", suit)) %>%
    pivot_wider(id_cols=handNum, names_from="suit", values_from="n", values_fill=0) %>%
    full_join(tmp2TxxxUse, by=c("handNum")) %>%
    mutate(type=ifelse(is.na(n), "Ineligible", "Eligible")) %>%
    count(type, V0, V1, V2, V3) %>%
    print(n=50)

```

```{r, fig.height=9, fig.width=9, cache=TRUE}

# Run for all hands of 2Jxxx (one wild, pair only)
t1 <- proc.time()
res2Txxx <- calculateResults(useHandNums=tmp2TxxxUse$handNum)
proc.time()-t1

```
  
```{r}

# Save file for use later
saveToRDS(res2Txxx, ovrWriteError=FALSE)

```
  
Hands of type 2Jxxx are explored for ranges of evPlay:  
```{r, fig.height=9, fig.width=9}

tmpHR <- tmp2TxxxUse %>%
    pull(handNum)

tmpHS <- mtxHands[tmpHR,] %>%
    tibble::as_tibble(.name_repair=make.names) %>%
    purrr::set_names(paste0("V", 1:5)) %>%
    mutate(handNum=tmpHR) %>%
    pivot_longer(-c(handNum)) %>%
    mutate(rank=1 + (value-1) %% 13, rank=ifelse(rank==1, 14, rank), suit=(value-1) %/% 13) %>%
    arrange(handNum, desc(rank))

# Plot of EV by hand type
res2Txxx %>% 
    mutate(evAllDouble=3*pWQ+2*pWN-4*pLQ-4*pLN, 
           evAllSingle=2*pWQ+pWN-3*pLQ-3*pLN
           ) %>% 
    left_join(tmpHS %>% 
                  filter(!(rank %in% c(10, 2))) %>% 
                  group_by(handNum) %>% 
                  mutate(label=paste0("WT", max(rank), nth(rank, 2), min(rank)), 
                         label=str_replace(label, "14", "A"),
                         label=str_replace(label, "13", "K"),
                         label=str_replace(label, "12", "Q"),
                         label=str_replace(label, "10", "T"),
                         card3=str_sub(label, 3, 3)
                         ) %>% 
                  filter(row_number()==1) %>% 
                  ungroup(), 
              by="handNum"
              ) %>% 
    select(handNum, label, evPlay, evAllSingle, evAllDouble) %>%
    pivot_longer(cols=-c(handNum, label)) %>%
    ggplot(aes(x=factor(label))) + 
    coord_flip() + 
    labs(x=NULL, 
         y=NULL, 
         title="EV for wild pairs of rank WTxxx"
         ) + 
    geom_boxplot(aes(y=value), fill="lightblue") + 
    geom_hline(aes(yintercept=ifelse(name=="evPlay", 0, -1)), lty=2) + 
    facet_wrap(~c("evPlay"="1. EV of play bet", 
                  "evAllSingle"="2. EV of all main bets (single play)", 
                  "evAllDouble"="3. EV of all main bets (double play)"
                  )[name], 
               scales="free_x"
               )

```
  
All wild pairs TT have negative evPlay.

Natural hands of type QQxxx are also explored:  
```{r, fig.height=9, fig.width=9}

# Eligible hands of type JJxxx
eligibleQQxxx <- allHandRanks %>% 
    filter(wType==11, tb1==12, tb2==12) %>% 
    semi_join(handSuit %>% filter(n2 <= n1, n4 <= n3, nWild==0), by=c("handNum"))
eligibleQQxxx

# Create tibble of hand types
mtxSmallTest <- mtxHands[eligibleQQxxx$handNum,]
tblSmallTest <- tibble::as_tibble(mtxSmallTest, .name_repair=make.names) %>%
    purrr::set_names(paste0("V", 1:5)) %>%
    mutate(handNum=eligibleQQxxx$handNum)
tblSmallTest

# Get suit counts of descending cards
tmpCheckSuits <- tblSmallTest %>%
    pivot_longer(-c(handNum)) %>%
    mutate(rank=1 + (value-1) %% 13, rank=ifelse(rank==1, 14, rank), suit=(value-1) %/% 13) %>%
    arrange(handNum, desc(rank))
tmpCheckSuits

# Get count of hands with Jack as first two suits
tmpQQxxxUse <- tmpCheckSuits %>%
    filter((rank==12 & suit==0) | (rank==12 & suit %in% c(1))) %>%
    group_by(handNum) %>%
    summarize(n=n()) %>%
    filter(n==2)
tmpQQxxxUse

# Get suit counts by whether hands are used
tmpCheckSuits %>% 
    group_by(handNum, suit) %>% 
    summarize(n=n(), .groups="drop") %>% 
    mutate(suit=paste0("V", suit)) %>%
    pivot_wider(id_cols=handNum, names_from="suit", values_from="n", values_fill=0) %>%
    full_join(tmpQQxxxUse, by=c("handNum")) %>%
    mutate(type=ifelse(is.na(n), "Ineligible", "Eligible")) %>%
    count(type, V0, V1, V2, V3) %>%
    print(n=30)

```

```{r, fig.height=9, fig.width=9, cache=TRUE}

# Run for all hands of JJxxx (no wild)
t1 <- proc.time()
resQQxxx <- calculateResults(useHandNums=tmpQQxxxUse$handNum)
proc.time()-t1

```
  
```{r}

# Save file for use later
saveToRDS(resQQxxx, ovrWriteError=FALSE)

```
  
Hands of type QQxxx are explored for ranges of evPlay:  
```{r, fig.height=9, fig.width=9}

tmpHR <- tmpQQxxxUse %>%
    pull(handNum)

tmpHS <- mtxHands[tmpHR,] %>%
    tibble::as_tibble(.name_repair=make.names) %>%
    purrr::set_names(paste0("V", 1:5)) %>%
    mutate(handNum=tmpHR) %>%
    pivot_longer(-c(handNum)) %>%
    mutate(rank=1 + (value-1) %% 13, rank=ifelse(rank==1, 14, rank), suit=(value-1) %/% 13) %>%
    arrange(handNum, desc(rank))

# Plot of EV by hand type
resQQxxx %>% 
    mutate(evAllDouble=3*pWQ+2*pWN-4*pLQ-4*pLN, 
           evAllSingle=2*pWQ+pWN-3*pLQ-3*pLN
           ) %>% 
    left_join(tmpHS %>% 
                  filter(!(rank %in% c(12, 2))) %>% 
                  group_by(handNum) %>% 
                  mutate(label=paste0("QQ", max(rank), nth(rank, 2), min(rank)), 
                         label=str_replace(label, "11", "J"),
                         label=str_replace(label, "13", "K"),
                         label=str_replace(label, "14", "A"),
                         label=str_replace(label, "10", "T"),
                         card3=str_sub(label, 3, 3)
                         ) %>% 
                  filter(row_number()==1) %>% 
                  ungroup(), 
              by="handNum"
              ) %>% 
    select(handNum, label, evPlay, card3) %>%
    pivot_longer(cols=-c(handNum, label, card3)) %>%
    ggplot(aes(x=factor(label))) + 
    coord_flip() + 
    labs(x=NULL, 
         y=NULL, 
         title="EV for natural pairs of rank QQxxx"
         ) + 
    geom_boxplot(aes(y=value), fill="lightblue") + 
    geom_hline(aes(yintercept=ifelse(name=="evPlay", 0, -1)), lty=2) + 
    facet_wrap(~c("A"="1. A", 
                  "K"="2. K/J", "J"="2. K/J", 
                  "T"="3. 5-T", "9"="3. 5-T", "8"="3. 5-T", "7"="3. 5-T", "6"="3. 5-T", "5"="3. 5-T"
                  )[card3], 
               scales="free_y"
               )

```
  
All natural pairs of rank QQxxx have positive evPlay. There are step-increases as xxx includes one or two cards of rank that can outpair QQ (A or K)

A subset of hands is explored that can be analyzed:  
  
1) Wilds, if any, are in ascending order (e.g., 2-15 is OK, but just 53 is not)  
2) Number of non-wild cards by suit is non-ascending (Spades >= Hearts >= Diamonds >= Clubs)  
3) If two suits have the same number of cards, the "rank is non-ascending  (Spades >= Hearts >= Diamonds >= Clubs)  
  
Code for the first two rules includes:  
```{r, fig.height=9, fig.width=9}

# Eligible wild combinations
all5Wild <- purrr::reduce(.x=cardInHand[c(2, 15, 28, 41, 53)], .f=intersect)
first4Wild <- purrr::reduce(.x=cardInHand[c(2, 15, 28, 41)], .f=intersect) %>%
    setdiff(purrr::reduce(.x=cardInHand[c(53)], .f=union))
first3Wild <- purrr::reduce(.x=cardInHand[c(2, 15, 28)], .f=intersect) %>%
    setdiff(purrr::reduce(.x=cardInHand[c(41, 53)], .f=union))
first2Wild <- purrr::reduce(.x=cardInHand[c(2, 15)], .f=intersect) %>%
    setdiff(purrr::reduce(.x=cardInHand[c(28, 41, 53)], .f=union))
first1Wild <- purrr::reduce(.x=cardInHand[c(2)], .f=intersect) %>%
    setdiff(purrr::reduce(.x=cardInHand[c(15, 28, 41, 53)], .f=union))
has0Wild <- (1:nrow(mtxHands)) %>%
    setdiff(purrr::reduce(.x=cardInHand[c(2, 15, 28, 41, 53)], .f=union))
wildEligible <- tibble::tibble(handNum=c(all5Wild, first4Wild, first3Wild, first2Wild, first1Wild, has0Wild)) %>%
    arrange(handNum)
sortedHandRanks %>%
    mutate(wildEligible=ifelse(handNum %in% wildEligible$handNum, "Eligible", "Not")) %>%
    count(nWild, wildEligible) %>%
    arrange(desc(nWild), wildEligible) %>%
    pivot_wider(id_cols=c("nWild"), names_from="wildEligible", values_from="n", values_fill=0) %>%
    bind_rows(colSums(.)) %>%
    mutate(nWild=case_when(nWild<=5~as.character(nWild), TRUE~"Total"), pctOK=Eligible/(Eligible+Not))

# Count by suit
t <- proc.time()
uaSpades <- tibble::tibble(handNum=purrr::reduce(.x=cardInHand[c(1, 3:13)], .f=union_all))
uaHearts <- tibble::tibble(handNum=purrr::reduce(.x=cardInHand[c(14, 16:26)], .f=union_all))
uaDiamonds <- tibble::tibble(handNum=purrr::reduce(.x=cardInHand[c(27, 29:39)], .f=union_all))
uaClubs <- tibble::tibble(handNum=purrr::reduce(.x=cardInHand[c(40, 42:52)], .f=union_all))
uaAll <- bind_rows(uaSpades, uaHearts, uaDiamonds, uaClubs, .id="suit") %>%
    mutate(suit=c("1"="Spades", "2"="Hearts", "3"="Diamonds", "4"="Clubs")[suit])
nPerSuit <- uaAll %>%
    mutate(n=1) %>%
    pivot_wider(id_cols="handNum", names_from="suit", values_from="n", values_fn=sum, values_fill=0)
proc.time()-t

# Analysis of eligibility
suitCountEligible <- nPerSuit %>%
    mutate(isOK=ifelse((Spades >= Hearts) & (Hearts >= Diamonds) & (Diamonds >= Clubs), "yes", "no"))
suitCountIneligible <- suitCountEligible %>% filter(isOK=="no") %>% pull(handNum)
sortedHandRanks %>%
    mutate(wildEligible=ifelse(handNum %in% wildEligible$handNum, "Eligible", "Not"), 
           suitCountEligible=ifelse(handNum %in% suitCountIneligible, "Not", "Eligible")
           ) %>%
    count(nWild, wildEligible, suitCountEligible) %>%
    mutate(nEligible=ifelse(wildEligible=="Eligible" & suitCountEligible=="Eligible", n, 0))

# Masks for suits
t <- proc.time()
maskSpade <- mtxHands %in% c(1, 3:13) %>% matrix(nrow=nrow(mtxHands), ncol=5, byrow=FALSE)
maskHeart <- mtxHands %in% (13+c(1, 3:13)) %>% matrix(nrow=nrow(mtxHands), ncol=5, byrow=FALSE)
maskDiamond <- mtxHands %in% (26+c(1, 3:13)) %>% matrix(nrow=nrow(mtxHands), ncol=5, byrow=FALSE)
maskClub <- mtxHands %in% (39+c(1, 3:13)) %>% matrix(nrow=nrow(mtxHands), ncol=5, byrow=FALSE)
suitCountCheck <- tibble::tibble(handNum=1:nrow(mtxHands),
                                 nSpade=rowSums(maskSpade), 
                                 nHeart=rowSums(maskHeart), 
                                 nDiamond=rowSums(maskDiamond), 
                                 nClub=rowSums(maskClub)
                                 )
proc.time()-t

# Confirm same results
nPerSuit %>%
    right_join(select(sortedHandRanks, handNum), by="handNum") %>%
    mutate(across(-c(handNum), .fns=function(x) ifelse(is.na(x), 0, x))) %>%
    arrange(handNum) %>%
    purrr::set_names(names(suitCountCheck)) %>%
    identical(x=., y=suitCountCheck)

```
  
The suit combinations of eligible hands are explored:  
```{r, fig.height=9, fig.width=9}

suitRankCountTable <- sortedHandRanks %>% 
    select(handNum, nWild) %>% 
    left_join(nPerSuit, by=c("handNum")) %>% 
    mutate(across(-c(handNum, nWild), .fns=function(x) ifelse(is.na(x), 0, x)), 
           wildEligible=ifelse(handNum %in% wildEligible$handNum, "Eligible", "Not"), 
           suitEligible=ifelse((Spades>=Hearts) & (Hearts>=Diamonds) & (Diamonds>=Clubs), "yes", "no")
           ) %>% 
    count(nWild, wildEligible, suitEligible, Spades, Hearts, Diamonds, Clubs) %>% 
    filter(wildEligible=="Eligible", suitEligible=="yes") %>% 
    arrange(-nWild, -Spades, -Hearts) %>%
    select(nWild, wildEligible, suitEligible, everything())
suitRankCountTable

# Duplicated combinations of 1-1-1-1 and 2-2
tmpSingleRank <- expand.grid(spades=3:14, hearts=3:14, diamonds=3:14, clubs=3:14) %>%
    tibble::as_tibble()
tmpSingleRank

# Resolving ties of type 1-1 (assume spades and hearts, suits are invariant)
elig11 <- tmpSingleRank %>%
    select(spades, hearts) %>%
    unique() %>%
    mutate(eligible=ifelse(spades>=hearts, "yes", "no"))
elig11 %>% count(eligible) %>% mutate(pct=n/sum(n))

# Resolving ties of type 2-2 (assume spades and hearts, suits are invariant)
elig22 <- tmpSingleRank %>%
    rename(spade2=diamonds, heart2=clubs) %>%
    filter(spades>spade2, hearts>heart2) %>%
    unique() %>%
    mutate(eligible=ifelse((spades>hearts) | (spades==hearts & spade2>=heart2), "yes", "no"))
elig22 %>% count(eligible) %>% mutate(pct=n/sum(n))

# Resolving ties of type 1-1-1 (assume spades and hearts and diamonds, suits are invariant)
elig111 <- tmpSingleRank %>%
    select(spades, hearts, diamonds) %>%
    unique() %>%
    mutate(eligible=ifelse((spades>=hearts) & (hearts>=diamonds), "yes", "no"))
elig111 %>% count(eligible) %>% mutate(pct=n/sum(n))

# Resolving ties of type 1-1-1-1 (all suits)
elig1111 <- tmpSingleRank %>%
    select(spades, hearts, diamonds, clubs) %>%
    unique() %>%
    mutate(eligible=ifelse((spades>=hearts) & (hearts>=diamonds) & (diamonds>=clubs), "yes", "no"))
elig1111 %>% count(eligible) %>% mutate(pct=n/sum(n))

# Full eligibility data
eligibleMap <- sapply(list(elig11, elig111, elig1111, elig22), FUN=function(x) mean(x$eligible=="yes")) %>%
    purrr::set_names(c("1-1", "1-1-1", "1-1-1-1", "2-2"))
eligibleMap <- c(eligibleMap, "none"=1)
eligibleMap

# Expected hands after de-duplications
suitRankCountDedup <- suitRankCountTable %>%
    mutate(dupType=case_when((Spades==1 & Hearts==1 & Diamonds==0)~"1-1", 
                             (Spades==1 & Hearts==1 & Diamonds==1 & Clubs==0)~"1-1-1", 
                             (Spades==2 & Hearts==2)~"2-2", 
                             (Spades>1 & Hearts==1 & Diamonds==1 & Clubs==0)~"1-1", 
                             (Spades==1 & Hearts==1 & Diamonds==1 & Clubs==1)~"1-1-1-1", 
                             (Spades>1 & Hearts==1 & Diamonds==1 & Clubs==1)~"1-1-1", 
                             TRUE~"none"
                             ), 
           dedupRatio=eligibleMap[dupType], 
           uniqueN=n*dedupRatio
           )
suitRankCountDedup
suitRankCountDedup %>% 
    group_by(nWild) %>%
    summarize(across(c(n, uniqueN), .fns=sum)) %>%
    arrange(desc(nWild)) %>%
    column_to_rownames("nWild") %>%
    mutate(pctUniqueN=round(uniqueN/sum(uniqueN),4)) %>%
    bind_rows(colSums(.))

```
  
After de-duplication, there are 102,360 unique hands that can be dealt in the game (assuming that the rank of wilds does not matter and that the highest-powered suit in order is spades, hearts, diamonds, clubs). Most of these are hands that do not contain a wild

The subset of non-duplicated hands with no wilds are extracted:  
```{r, fig.height=9, fig.width=9}

# Create a tibble of hands
tblHands <- tibble::as_tibble(mtxHands) %>%
    mutate(handNum=1:nrow(.))
tblHands

# Get the relevant last 3 cards for 2-1-1-1
tmpLast3 <- elig111 %>%
    mutate(across(c(spades, hearts, diamonds), .fns=function(x) ifelse(x==14, 1, x))) %>%
    filter(eligible=="yes") %>%
    rename(V5=diamonds, V4=hearts, V3=spades) %>%
    mutate(V3=V3+13, V4=V4+26, V5=V5+39)

# Get the set of 2-1-1-1 hands
hn2111 <- tblHands %>%
    semi_join(select(tmpLast3, V3, V4, V5), by=c("V3", "V4", "V5")) %>%
    filter(V1 %in% c(1, 3:13), V2 %in% c(1, 3:13))
hn2111

# Check that hand numbers are all eligible
nPerSuit %>%
    semi_join(hn2111, by="handNum") %>%
    mutate(wildOK=ifelse(handNum %in% wildEligible$handNum, "yes", "no")) %>%
    count(wildOK, Spades, Hearts, Diamonds, Clubs)


# Get the relevant first 4 cards for 2-2-1
tmpFirst4 <- elig22 %>%
    mutate(across(c(spades, spade2, hearts, heart2), .fns=function(x) ifelse(x==14, 1, x))) %>%
    filter(eligible=="yes") %>%
    mutate(V1=pmin(spades, spade2), 
           V2=pmax(spades, spade2), 
           V3=13+pmin(hearts, heart2),
           V4=13+pmax(hearts, heart2)
           )

# Get the set of 2-2-1 hands
hn221 <- tblHands %>%
    semi_join(select(tmpFirst4, V1, V2, V3, V4), by=c("V1", "V2", "V3", "V4")) %>%
    filter(V5 %in% c(27, 29:39))
hn221

# Check that hand numbers are all eligible
nPerSuit %>%
    semi_join(hn221, by="handNum") %>%
    mutate(wildOK=ifelse(handNum %in% wildEligible$handNum, "yes", "no")) %>%
    count(wildOK, Spades, Hearts, Diamonds, Clubs)


# Get the relevant last 2 cards for 3-1-1
tmpLast2 <- elig11 %>%
    mutate(across(c(spades, hearts), .fns=function(x) ifelse(x==14, 1, x))) %>%
    filter(eligible=="yes") %>%
    mutate(V4=spades+13, V5=hearts+26)

# Get the set of 3-1-1 hands
hn311 <- tblHands %>%
    semi_join(select(tmpLast2, V4, V5), by=c("V4", "V5")) %>%
    filter(V1 %in% c(1, 3:13), V2 %in% c(1, 3:13), V3 %in% c(1, 3:13))
hn311

# Check that hand numbers are all eligible
nPerSuit %>%
    semi_join(hn311, by="handNum") %>%
    mutate(wildOK=ifelse(handNum %in% wildEligible$handNum, "yes", "no")) %>%
    count(wildOK, Spades, Hearts, Diamonds, Clubs)


# Get the set of 3-2-0 and 4-1-0 and 5-0-0 hands
tmp3Plus <- nPerSuit %>%
    filter((Spades==5) | (Spades==4 & Hearts==1) | (Spades==3 & Hearts==2))

hn3Plus <- tblHands %>%
    semi_join(select(tmp3Plus, handNum), by=c("handNum"))
hn3Plus

# Check that hand numbers are all eligible
nPerSuit %>%
    semi_join(hn3Plus, by="handNum") %>%
    mutate(wildOK=ifelse(handNum %in% wildEligible$handNum, "yes", "no")) %>%
    count(wildOK, Spades, Hearts, Diamonds, Clubs)


# Integrate all relevant hand numbers
hn0Wild <- bind_rows(hn2111, hn221, hn311, hn3Plus) %>%
    left_join(select(sortedHandRanks, handNum, wType, qual, nWild), by=c("handNum")) %>%
    left_join(nPerSuit, by=c("handNum"))
hn0Wild

# Summarize hand types and suits
hn0Wild %>% count(nWild, Spades, Hearts, Diamonds, Clubs)
hn0Wild %>% count(nWild, qual, wType)
hn0Wild %>% count(nWild, qual, wType, Spades, Hearts, Diamonds, Clubs) %>% print(n=30)

```
  
The file is split in to components for running hands:  
```{r}

# Zero pairs (around 10k hands per sequence)
seq2a <- hn0Wild %>% filter(wType==99, V1==1)
seq2b <- hn0Wild %>% filter(wType==99, V1 %in% c(3, 4))
seq2c <- hn0Wild %>% filter(wType==99, V1 %in% c(5, 6, 7))
seq2d <- hn0Wild %>% filter(wType==99, V1 %in% c(8, 9, 10, 11, 12))

# One pair (around 10k hands per sequence)
seq2e <- hn0Wild %>% filter(wType==11, V1==1)
seq2f <- hn0Wild %>% filter(wType==11, V1 %in% c(3, 4))
seq2g <- hn0Wild %>% filter(wType==11, V1 %in% c(5, 6, 7))
seq2h <- hn0Wild %>% filter(wType==11, V1 %in% c(8, 9, 10, 11, 12))

# Two pair or better
seq2j <- hn0Wild %>% filter(!(wType %in% c(11, 99)))

# Check that data are the same
bind_rows(seq2a, seq2b, seq2c, seq2d, seq2e, seq2f, seq2g, seq2h, seq2j) %>%
    arrange(V1, V2, V3, V4, V5) %>%
    identical(arrange(hn0Wild, V1, V2, V3, V4, V5))

```

A function is written to run a hand number sequence only if the sequence is not already saved:  
```{r}

# Function to check if file exists and run if so
runHandSequence <- function(handNums, 
                            rdsName, 
                            skipIfExists=TRUE, 
                            saveFile=TRUE, 
                            ovrWrite=FALSE, 
                            returnFile=!isTRUE(saveFile) | (!isTRUE(skipIfExists) & !isTRUE(ovrWrite))
                            ) {
    
    # FUNCTION ARGUMENTS:
    # handNums: sequence of hand numbers to evaluate
    # rdsName: name of the RDS file (if exists or to be saved - no directory, no .RDS extension)
    # skipIfExists: boolean, if TRUE, check whether the file is already saved, and skip running if so
    # saveFile: boolean, should the file be saved after running
    # ovrWrite: boolean, should the previous file be overwritten?
    # returnFile: boolean, should the file be returned after creation?
    
    # Manage the file existence and decision to run or not run
    keyLoc <- paste0(formals(readFromRDS)$dir, rdsName, formals(readFromRDS)$addSuffix)
    fileExists <- file.exists(keyLoc)
    if(isTRUE(skipIfExists) & isTRUE(fileExists)) {
        cat("\nFile", keyLoc, "already exists, exiting without running or overwriting\n")
        return(NULL)
    }
    
    # Run the process and report on the time
    t1 <- proc.time()
    df <- calculateResults(useHandNums=handNums)
    print(proc.time()-t1)
    
    # Save the file if requested (overwriting the existing file)
    if(isTRUE(saveFile)) {
        # If file is to be overwritten, delete it
        if(isTRUE(ovrWrite) & isTRUE(fileExists)) {
            cat("\nRemoving existing file", keyLoc, "so new file can be written\n")
            Sys.chmod(keyLoc, mode="0777", use_umask=FALSE)
            file.remove(keyLoc)
        }
        # Write the file
        saveToRDS(obj=df, file=paste0(rdsName, ".RDS"), ovrWriteError=FALSE)
    }
    
    # Return the file if requested
    if(isTRUE(returnFile)) return(df)
    
}

```
  

```{r, fig.height=9, fig.width=9, cache=TRUE}

# Run for all non-duplicate hands of type 99 (no pair, no wild), Ace high
runHandSequence(handNums=seq2a$handNum, rdsName="ICGA_v001_seq2a", skipIfExists=TRUE, saveFile=TRUE)

```
  
```{r, fig.height=9, fig.width=9, cache=TRUE}

# Run for all non-duplicate hands of type 99 (no pair, no wild), sequence b
runHandSequence(handNums=seq2b$handNum, rdsName="ICGA_v001_seq2b", skipIfExists=TRUE, saveFile=TRUE)

```
  
```{r, fig.height=9, fig.width=9, cache=TRUE}

# Run for all non-duplicate hands of type 99 (no pair, no wild), sequence c
runHandSequence(handNums=seq2c$handNum, rdsName="ICGA_v001_seq2c", skipIfExists=TRUE, saveFile=TRUE)

```
  
```{r, fig.height=9, fig.width=9, cache=TRUE}

# Run for all non-duplicate hands of type 99 (no pair, no wild), sequence d
runHandSequence(handNums=seq2d$handNum, rdsName="ICGA_v001_seq2d", skipIfExists=TRUE, saveFile=TRUE)

```
  
```{r, fig.height=9, fig.width=9, cache=TRUE}

# Run for all non-duplicate hands of type 11 (one pair) with no wild, sequence e
runHandSequence(handNums=seq2e$handNum, rdsName="ICGA_v001_seq2e", skipIfExists=TRUE, saveFile=TRUE)

```
  
```{r, fig.height=9, fig.width=9, cache=TRUE}

# Run for all non-duplicate hands of type 11 (one pair) with no wild, sequence f
runHandSequence(handNums=seq2f$handNum, rdsName="ICGA_v001_seq2f", skipIfExists=TRUE, saveFile=TRUE)

```
  
```{r, fig.height=9, fig.width=9, cache=TRUE}

# Run for all non-duplicate hands of type 11 (one pair) with no wild, sequence g
runHandSequence(handNums=seq2g$handNum, rdsName="ICGA_v001_seq2g", skipIfExists=TRUE, saveFile=TRUE)

```
  
```{r, fig.height=9, fig.width=9, cache=TRUE}

# Run for all non-duplicate hands of type 11 (one pair) with no wild, sequence h
runHandSequence(handNums=seq2h$handNum, rdsName="ICGA_v001_seq2h", skipIfExists=TRUE, saveFile=TRUE)

```
  
```{r, fig.height=9, fig.width=9, cache=TRUE}

# Run for all non-duplicate hands of type 10 (two pair) or better with no wild, sequence j
runHandSequence(handNums=seq2j$handNum, rdsName="ICGA_v001_seq2j", skipIfExists=TRUE, saveFile=TRUE)

```
  
The subset of non-duplicated hands with one wild are extracted:  
```{r, fig.height=9, fig.width=9}

# Get the relevant last 4 cards for 1-1-1-1
tmpLast4 <- elig1111 %>%
    mutate(across(c(spades, hearts, diamonds, clubs), .fns=function(x) ifelse(x==14, 1, x))) %>%
    filter(eligible=="yes") %>%
    rename(V5=clubs, V4=diamonds, V3=hearts) %>%
    mutate(V1=ifelse(spades==1, spades, 2), V2=ifelse(spades==1, 2, spades), V3=V3+13, V4=V4+26, V5=V5+39)

# Get the set of 1-1-1-1 hands
hn1111 <- tblHands %>%
    semi_join(select(tmpLast4, V1, V2, V3, V4, V5), by=c("V1", "V2", "V3", "V4", "V5"))
hn1111

# Check that hand numbers are all eligible
nPerSuit %>%
    semi_join(hn1111, by="handNum") %>%
    mutate(wildOK=ifelse(handNum %in% wildEligible$handNum, "yes", "no")) %>%
    count(wildOK, Spades, Hearts, Diamonds, Clubs)


# Get the relevant first 4 cards for 2-2-0
tmpWild22 <- elig22 %>%
    mutate(across(c(spades, spade2, hearts, heart2), .fns=function(x) ifelse(x==14, 1, x))) %>%
    filter(eligible=="yes") %>%
    mutate(V1=pmin(spades, 2, spade2), 
           V2=ifelse(V1==1, 2, pmin(spades, spade2)),
           V3=pmax(spades, 2, spade2), 
           V4=13+pmin(hearts, heart2),
           V5=13+pmax(hearts, heart2)
           )

# Get the set of 2-2-0 hands
hn22 <- tblHands %>%
    semi_join(select(tmpWild22, V1, V2, V3, V4, V5), by=c("V1", "V2", "V3", "V4", "V5"))
hn22

# Check that hand numbers are all eligible
nPerSuit %>%
    semi_join(hn22, by="handNum") %>%
    mutate(wildOK=ifelse(handNum %in% wildEligible$handNum, "yes", "no")) %>%
    count(wildOK, Spades, Hearts, Diamonds, Clubs)


# Get the relevant last 2 cards for 2-1-1
tmpWild11 <- elig11 %>%
    mutate(across(c(spades, hearts), .fns=function(x) ifelse(x==14, 1, x))) %>%
    filter(eligible=="yes") %>%
    mutate(V4=spades+13, V5=hearts+26)

# Get the set of 2-1-1 hands
hn211 <- tblHands %>%
    semi_join(select(tmpWild11, V4, V5), by=c("V4", "V5")) %>%
    filter(V1 %in% c(1:13), V2 %in% c(1:13), V3 %in% c(1:13), V1==2 | V2==2)
hn211

# Check that hand numbers are all eligible
nPerSuit %>%
    semi_join(hn211, by="handNum") %>%
    mutate(wildOK=ifelse(handNum %in% wildEligible$handNum, "yes", "no")) %>%
    count(wildOK, Spades, Hearts, Diamonds, Clubs)


# Get the set of 3-1-0 and 4-0-0 hands
tmpWild34 <- nPerSuit %>%
    filter((Spades==3 & Hearts==1 & Diamonds==0 & Clubs==0) | (Spades==4 & Hearts==0 & Diamonds==0 & Clubs==0))

hnWild34 <- tblHands %>%
    semi_join(select(tmpWild34, handNum), by=c("handNum")) %>%
    filter(V1==2 | V2==2)
hnWild34

# Check that hand numbers are all eligible
nPerSuit %>%
    semi_join(hnWild34, by="handNum") %>%
    mutate(wildOK=ifelse(handNum %in% wildEligible$handNum, "yes", "no")) %>%
    count(wildOK, Spades, Hearts, Diamonds, Clubs)


# Integrate all relevant hand numbers
hn1Wild <- bind_rows(hn1111, hn22, hn211, hnWild34) %>%
    left_join(select(sortedHandRanks, handNum, wType, qual, nWild), by=c("handNum")) %>%
    left_join(nPerSuit, by=c("handNum"))
hn1Wild

# Summarize hand types and suits
hn1Wild %>% count(nWild, Spades, Hearts, Diamonds, Clubs)
hn1Wild %>% count(nWild, qual, wType)
hn1Wild %>% count(nWild, qual, wType, Spades, Hearts, Diamonds, Clubs) %>% print(n=30)

```
  
```{r, fig.height=9, fig.width=9, cache=TRUE}

# Run for all non-duplicate hands of type 10 (two pair) or better with no wild, sequence j
runHandSequence(handNums=hn1Wild$handNum, rdsName="ICGA_v001_1wild", skipIfExists=TRUE, saveFile=TRUE)

```
  
The subset of non-duplicated hands with two wild are extracted:  
```{r, fig.height=9, fig.width=9}

# Get the relevant last 3 cards for 1-1-1
tmpLast3 <- elig111 %>%
    mutate(across(c(spades, hearts, diamonds), .fns=function(x) ifelse(x==14, 1, x))) %>%
    filter(eligible=="yes") %>%
    rename(V5=diamonds) %>%
    mutate(V1=ifelse(spades==1, spades, 2), 
           V2=ifelse(spades==1, 2, spades), 
           V3=ifelse(hearts==1, 13+hearts, 15), 
           V4=ifelse(hearts==1, 15, 13+hearts), 
           V5=V5+26
           )

# Get the set of 1-1-1 hands
hn111 <- tblHands %>%
    semi_join(select(tmpLast3, V1, V2, V3, V4, V5), by=c("V1", "V2", "V3", "V4", "V5"))
hn111

# Check that hand numbers are all eligible
nPerSuit %>%
    semi_join(hn111, by="handNum") %>%
    mutate(wildOK=ifelse(handNum %in% wildEligible$handNum, "yes", "no")) %>%
    count(wildOK, Spades, Hearts, Diamonds, Clubs)


# Get the set of 2-1-0 and 3-0-0 hands
tmpWild23 <- nPerSuit %>%
    filter((Spades==2 & Hearts==1 & Diamonds==0 & Clubs==0) | (Spades==3 & Hearts==0 & Diamonds==0 & Clubs==0))

hnWild23 <- tblHands %>%
    semi_join(select(tmpWild23, handNum), by=c("handNum")) %>%
    filter((V1==2 | V2==2) & (V3==15 | V4==15 | V5==15))
hnWild23

# Check that hand numbers are all eligible
nPerSuit %>%
    semi_join(hnWild23, by="handNum") %>%
    mutate(wildOK=ifelse(handNum %in% wildEligible$handNum, "yes", "no")) %>%
    count(wildOK, Spades, Hearts, Diamonds, Clubs)


# Integrate all relevant hand numbers
hn2Wild <- bind_rows(hn111, hnWild23) %>%
    left_join(select(sortedHandRanks, handNum, wType, qual, nWild), by=c("handNum")) %>%
    left_join(nPerSuit, by=c("handNum"))
hn2Wild

# Summarize hand types and suits
hn2Wild %>% count(nWild, Spades, Hearts, Diamonds, Clubs)
hn2Wild %>% count(nWild, qual, wType)
hn2Wild %>% count(nWild, qual, wType, Spades, Hearts, Diamonds, Clubs) %>% print(n=30)

```
  
```{r, fig.height=9, fig.width=9, cache=TRUE}

# Run for all non-duplicate hands of type 10 (two pair) or better with no wild, sequence j
runHandSequence(handNums=hn2Wild$handNum, rdsName="ICGA_v001_2wild", skipIfExists=TRUE, saveFile=TRUE)

```
  
The subset of non-duplicated hands with three-plus wild are extracted:  
```{r, fig.height=9, fig.width=9}

# Get the relevant middle 2 cards for 1-1
tmpMid2 <- elig11 %>%
    mutate(across(c(spades, hearts), .fns=function(x) ifelse(x==14, 1, x))) %>%
    filter(eligible=="yes") %>%
    mutate(V1=ifelse(spades==1, spades, 2), 
           V2=ifelse(spades==1, 2, spades), 
           V3=ifelse(hearts==1, 13+hearts, 15), 
           V4=ifelse(hearts==1, 15, 13+hearts), 
           V5=28
           )

# Get the set of 1-1 hands
hn11 <- tblHands %>%
    semi_join(select(tmpMid2, V1, V2, V3, V4, V5), by=c("V1", "V2", "V3", "V4", "V5"))
hn11

# Check that hand numbers are all eligible
nPerSuit %>%
    semi_join(hn11, by="handNum") %>%
    mutate(wildOK=ifelse(handNum %in% wildEligible$handNum, "yes", "no")) %>%
    count(wildOK, Spades, Hearts, Diamonds, Clubs)


# Get the set of 2-0-0-0
tmpWild2 <- nPerSuit %>%
    filter((Spades==2 & Hearts==0 & Diamonds==0 & Clubs==0))

hnWild2 <- tblHands %>%
    semi_join(select(tmpWild2, handNum), by=c("handNum")) %>%
    filter((V1==2 | V2==2) & V4==15 & V5==28)
hnWild2

# Check that hand numbers are all eligible
nPerSuit %>%
    semi_join(hnWild2, by="handNum") %>%
    mutate(wildOK=ifelse(handNum %in% wildEligible$handNum, "yes", "no")) %>%
    count(wildOK, Spades, Hearts, Diamonds, Clubs)


# Get the set of 1-0-0-0 and 0-0-0-0 hands (hand number 444444, not in nPerSuit)
tmpWild45 <- nPerSuit %>%
    filter((Spades==1 & Hearts==0 & Diamonds==0 & Clubs==0)) %>%
    bind_rows(tibble::tibble(handNum=444444, Spades=0, Hearts=0, Diamonds=0, Clubs=0))

hnWild45 <- tblHands %>%
    semi_join(select(tmpWild45, handNum), by=c("handNum")) %>%
    filter((V1==2 | V2==2) & (V2==15 | V3==15) & (V3==28 | V4==28) & (V4==41 | V5==41))
hnWild45

# Check that hand numbers are all eligible
nPerSuit %>%
    bind_rows(tibble::tibble(handNum=444444, Spades=0, Hearts=0, Diamonds=0, Clubs=0)) %>%
    semi_join(hnWild45, by="handNum") %>%
    mutate(wildOK=ifelse(handNum %in% wildEligible$handNum, "yes", "no")) %>%
    count(wildOK, Spades, Hearts, Diamonds, Clubs)


# Integrate all relevant hand numbers
hn3PlusWild <- bind_rows(hn11, hnWild2, hnWild45) %>%
    left_join(select(sortedHandRanks, handNum, wType, qual, nWild), by=c("handNum")) %>%
    left_join(nPerSuit, by=c("handNum"))
hn3PlusWild

# Summarize hand types and suits
hn3PlusWild %>% count(nWild, Spades, Hearts, Diamonds, Clubs)
hn3PlusWild %>% count(nWild, qual, wType)
hn3PlusWild %>% count(nWild, qual, wType, Spades, Hearts, Diamonds, Clubs) %>% print(n=30)

```
  
```{r, fig.height=9, fig.width=9, cache=TRUE}

# Run for all non-duplicate hands of type 10 (two pair) or better with no wild, sequence j
runHandSequence(handNums=hn3PlusWild$handNum, rdsName="ICGA_v001_3Pluswild", skipIfExists=TRUE, saveFile=TRUE)

```
  
The non-duplicated hands are consolidated to a single file:  
```{r}

# Mapping file for src number to name
srcNumName <- c(paste0("seq2", letters[c(1:8, 10)]), "1wild", "2wild", "3pluswild") %>%
    purrr::set_names(as.character(1:12))

fullHandProbs <- readFromRDS("ICGA_v001_seq2a") %>% 
    bind_rows(readFromRDS("ICGA_v001_seq2b"), 
              readFromRDS("ICGA_v001_seq2c"), 
              readFromRDS("ICGA_v001_seq2d"), 
              readFromRDS("ICGA_v001_seq2e"), 
              readFromRDS("ICGA_v001_seq2f"), 
              readFromRDS("ICGA_v001_seq2g"), 
              readFromRDS("ICGA_v001_seq2h"), 
              readFromRDS("ICGA_v001_seq2j"), 
              readFromRDS("ICGA_v001_1wild"), 
              readFromRDS("ICGA_v001_2wild"), 
              readFromRDS("ICGA_v001_3Pluswild"), 
              .id="src"
              ) %>%
    mutate(srcName=srcNumName[src], 
           hndType=case_when(handNum %in% hn2111$handNum ~ "0 wild (2-1-1-1)", 
                             handNum %in% hn221$handNum ~ "0 wild (2-2-1)", 
                             handNum %in% hn311$handNum ~ "0 wild (3-1-1)",
                             handNum %in% (nPerSuit %>% filter(Spades==3 & Hearts==2) %>% pull(handNum)) ~ 
                                 "0 wild (3-2)",
                             handNum %in% (nPerSuit %>% filter(Spades==4 & Hearts==1) %>% pull(handNum)) ~ 
                                 "0 wild (4-1)",
                             handNum %in% (nPerSuit %>% filter(Spades==5 & Hearts==0) %>% pull(handNum)) ~ 
                                 "0 wild (5)",
                             handNum %in% hn1111$handNum ~ "1 wild (1-1-1-1)",
                             handNum %in% hn211$handNum ~ "1 wild (2-1-1)", 
                             handNum %in% hn22$handNum ~ "1 wild (2-2)",
                             handNum %in% (nPerSuit %>% 
                                               filter(Spades==3 & Hearts==1 & Diamonds==0 & Clubs==0) %>% 
                                               pull(handNum)
                                           ) ~ "1 wild (3-1)",
                             handNum %in% (nPerSuit %>% 
                                               filter(Spades==4 & Hearts==0 & Diamonds==0 & Clubs==0) %>% 
                                               pull(handNum)
                                           ) ~ "1 wild (4)",
                             handNum %in% hn111$handNum ~ "2 wild (1-1-1)",
                             handNum %in% (nPerSuit %>% 
                                               filter(Spades==2 & Hearts==1 & Diamonds==0 & Clubs==0) %>% 
                                               pull(handNum)
                                           ) ~ "2 wild (2-1)", 
                             handNum %in% (nPerSuit %>% 
                                               filter(Spades==3 & Hearts==0 & Diamonds==0 & Clubs==0) %>% 
                                               pull(handNum)
                                           ) ~ "2 wild (3)",
                             handNum %in% hn11$handNum ~ "3 wild (1-1)",
                             handNum %in% (nPerSuit %>% 
                                               filter(Spades==2 & Hearts==0 & Diamonds==0 & Clubs==0) %>% 
                                               pull(handNum)
                                           ) ~ "3 wild (2)",
                             handNum %in% (nPerSuit %>% 
                                               filter(Spades==1 & Hearts==0 & Diamonds==0 & Clubs==0) %>% 
                                               pull(handNum)
                                           ) ~ "4 wild (1)",
                             TRUE~"No suits"
                             )
           )
fullHandProbs
fullHandProbs %>% count(srcName)
fullHandProbs %>% count(hndType)
fullHandProbs %>% 
    count(hndType, srcName) %>% 
    pivot_wider(id_cols="hndType", names_from="srcName", values_from="n", values_fill=0)

```
  
Probabilities of winning (excluding ties from denominator) are calculated by rank:  
```{r, fig.height=9, fig.width=9}

fullHandProbs %>%
    mutate(useType=ifelse(type<11, "1. Two pair or better", ifelse(type==11, "2. Pair", "3. No Pair")), 
           hasWild=ifelse(str_detect(hndType, "0 wild"), "0 wild", "1+ wild")
           ) %>%
    ggplot(aes(x=factor(rank), y=pWNoTie)) + 
    geom_boxplot(aes(color=hasWild)) +
    facet_wrap(~useType, scales="free_x") + 
    theme(axis.text.x=element_blank(), axis.ticks.x=element_blank()) + 
    labs(x="Hand rank (best on left)", y="Win probability (excluding ties)", title="Win probability by rank") + 
    geom_hline(yintercept=c(0, 0.25, 0.5, 1), lty=2)

```

Hands with no pair are assessed for win probability:  
```{r, fig.height=9, fig.width=9}

# Include ranks of cards from sortedHandRanks
fullHandProbsData <- fullHandProbs %>%
    left_join(select(sortedHandRanks, -chgRank, -rank, -qual), by=c("handNum"))
fullHandProbsData

# Convert 14, 13, 12, 11, 10 to A, K, Q, J, T
numberToCard <- function(x) 
    case_when(x==14 ~ "A", x==13 ~ "K", x==12 ~ "Q", x==11 ~ "J", x==10 ~ "T", TRUE ~ as.character(x))

# Plot for ranks of non-pair hands
fullHandProbsData %>%
    filter(type==99) %>%
    mutate(ranks=paste0(numberToCard(tb1), numberToCard(tb2))) %>%
    group_by(tb1, tb2, ranks) %>%
    summarize(across(pWNoTie, .fns=list(max=max, med=median, min=min)), .groups="drop") %>%
    arrange(desc(tb1), desc(tb2)) %>%
    mutate(ranks=factor(ranks, levels=ranks)) %>%
    ggplot(aes(x=ranks)) + 
    geom_errorbar(aes(ymin=pWNoTie_min, ymax=pWNoTie_max), width=0.5) +
    geom_point(aes(y=pWNoTie_med)) +
    labs(x=NULL, 
         y="Win probability (ties excluded)", 
         title="Win probability for non-paired hands", 
         subtitle="Median and max/min range"
         ) + 
    geom_hline(yintercept=c(0, 0.25), lty=2)

# Plot for ranks of AK hands
fullHandProbsData %>%
    filter(type==99, tb1==14, tb2==13) %>%
    mutate(ranks=paste0(numberToCard(tb3), numberToCard(tb4))) %>%
    group_by(tb3, tb4, ranks) %>%
    summarize(across(pWNoTie, .fns=list(max=max, med=median, min=min)), .groups="drop") %>%
    arrange(desc(tb3), desc(tb4)) %>%
    mutate(ranks=factor(ranks, levels=ranks)) %>%
    ggplot(aes(x=ranks)) + 
    geom_errorbar(aes(ymin=pWNoTie_min, ymax=pWNoTie_max), width=0.5) +
    geom_point(aes(y=pWNoTie_med)) +
    labs(x=NULL, 
         y="Win probability (ties excluded)", 
         title="Win probability for non-paired hands of type AK based on third and fourth ranks", 
         subtitle="Median and max/min range"
         ) + 
    geom_hline(yintercept=c(0, 0.25), lty=2)

```
  
Hands without a pair are largely monotonic, with better ranks corresponding to higher win probabilities. The cutoff for 25% win probability is around AKJ7x
  
Hands with one pair are assessed for win probability:  
```{r, fig.height=9, fig.width=9}

# Plot for ranks of one-pair hands
fullHandProbsData %>%
    filter(type==11) %>%
    mutate(ranks=paste0(numberToCard(tb1)), 
           nOver=(tb3>tb1)+(tb4>tb1)+(tb5>tb1), 
           colorHand=ifelse(nWild==1, "wild", paste0(as.character(nOver), " overs"))
           ) %>%
    group_by(ranks, tb1, nOver, nWild, colorHand) %>%
    summarize(across(pWNoTie, .fns=list(max=max, med=median, min=min)), .groups="drop") %>%
    arrange(desc(tb1)) %>%
    mutate(ranks=factor(ranks, levels=unique(ranks))) %>%
    ggplot(aes(color=colorHand)) + 
    geom_errorbar(aes(x=as.numeric(ranks) + ifelse(colorHand=="wild", -0.2, -.1*(nOver-2)), 
                      ymin=pWNoTie_min, 
                      ymax=pWNoTie_max
                      ), 
                  width=0.1
                  ) +
    geom_point(aes(x=as.numeric(ranks) + ifelse(colorHand=="wild", -0.2, -.1*(nOver-2)), y=pWNoTie_med)) +
    labs(x=NULL, 
         y="Win probability (ties excluded)", 
         title="Win probability for paired hands", 
         subtitle="Median and max/min range"
    ) + 
    geom_hline(yintercept=c(0, 0.25, 0.5, 1), lty=2) + 
    scale_x_continuous(breaks=1:12, labels=c("A", "K", "Q", "J", "T", 9:3)) + 
    scale_color_discrete("Composition")

# Plot for ranks of one-pair JJ hands
fullHandProbsData %>%
    filter(type==11, tb1==11) %>%
    mutate(kicker=paste0(numberToCard(tb3)), 
           nOver=(tb3>tb1)+(tb4>tb1)+(tb5>tb1), 
           colorHand=ifelse(nWild==1, "wild", paste0(as.character(nOver), " overs"))
           ) %>%
    group_by(kicker, tb3, nOver, nWild, colorHand) %>%
    summarize(across(pWNoTie, .fns=list(max=max, med=median, min=min)), .groups="drop") %>%
    arrange(desc(tb3)) %>%
    mutate(kicker=factor(kicker, levels=unique(kicker))) %>%
    ggplot(aes(color=colorHand)) + 
    geom_errorbar(aes(x=as.numeric(kicker) + ifelse(colorHand=="wild", -0.2, -.1*(nOver-2)), 
                      ymin=pWNoTie_min, 
                      ymax=pWNoTie_max
                      ), 
                  width=0.1
                  ) +
    geom_point(aes(x=as.numeric(kicker) + ifelse(colorHand=="wild", -0.2, -.1*(nOver-2)), y=pWNoTie_med)) +
    labs(x="Kicker for JJ hand", 
         y="Win probability (ties excluded)", 
         title="Win probability for JJ paired hands", 
         subtitle="Median and max/min range"
    ) + 
    geom_hline(yintercept=c(0.5), lty=2) + 
    scale_x_continuous(breaks=1:9, labels=c("A", "K", "Q", "T", 9:5)) + 
    scale_color_discrete("Composition")

```
  
Hands with a pair are not strictly monotonic, and having a wild card or extra over-cards is more valuable in some cases than a higher kicker
  
Hands with two pairs are assessed for win probability:  
```{r, fig.height=9, fig.width=9}

# Plot for ranks of two-pair hands
fullHandProbsData %>%
    filter(type==10) %>%
    mutate(ranks=paste0(numberToCard(tb1), numberToCard(tb3)), 
           kickerType=case_when(tb5>tb1~"above", tb5<tb3~"below", TRUE~"between")
           ) %>%
    group_by(tb1, tb3, ranks, kickerType) %>%
    summarize(across(pWNoTie, .fns=list(max=max, med=median, min=min)), .groups="drop") %>%
    arrange(desc(tb1), desc(tb3)) %>%
    mutate(ranks=factor(ranks, levels=unique(ranks))) %>%
    ggplot(aes(x=ranks)) + 
    geom_errorbar(aes(ymin=pWNoTie_min, ymax=pWNoTie_max, color=kickerType), width=0.5) +
    geom_point(aes(y=pWNoTie_med, color=kickerType)) + 
    geom_line(aes(y=pWNoTie_med, group=kickerType, color=kickerType)) +
    labs(x="Two-pair ranks", 
         y="Win probability (ties excluded)", 
         title="Win probability for two-pair hands", 
         subtitle="Median and max/min range"
    ) + 
    geom_hline(yintercept=c(0.75), lty=2) + 
    theme(axis.text.x=element_text(size=7), legend.position="bottom") +
    scale_color_discrete("Kicker rank")

```
  
Hands with two pair are not strictly monotonic, and having higher ranks and more combinations that block straights are generally both valuable. There is little variation in win probability from best to worst two-pair hand, since it is a relatively rare hand type given the prevalence of wild cards
  
Hands with three-of-a-kind, straight, flush, and full house are assessed for win probability:  
```{r, fig.height=9, fig.width=9}

# Plot for three-of-a-kind, straight, flush, full house
fullHandProbsData %>%
    filter(type %in% c(6, 7, 8, 9)) %>%
    mutate(ranks=paste0(numberToCard(tb1), case_when(type==9~"\ntrip", 
                                                     type==8~"\nlow\nstraight", 
                                                     type==7~"\nflush", type==6~"\nfull")
                        ), 
           nWild=as.character(nWild)
           ) %>%
    group_by(type, tb1, ranks, nWild) %>%
    summarize(across(pWNoTie, .fns=list(max=max, med=median, min=min)), .groups="drop") %>%
    arrange(type, desc(tb1)) %>%
    mutate(ranks=ifelse(type==8 & tb1==2, "A\nlow\nstraight", ranks), 
           ranks=factor(ranks, levels=unique(ranks))
           ) %>%
    ggplot(aes(x=ranks)) + 
    geom_errorbar(aes(ymin=pWNoTie_min, ymax=pWNoTie_max, color=nWild), width=0.2) +
    geom_point(aes(y=pWNoTie_med, color=nWild)) + 
    labs(x="Hand type", 
         y="Win probability (ties excluded)", 
         title="Win probability for three-of-a-kind, straight, flush, full house", 
         subtitle="Median and max/min range"
    ) + 
    geom_hline(yintercept=c(0.75, 1), lty=2) + 
    theme(axis.text.x=element_text(size=7)) +
    scale_color_discrete("# wilds")

```
  
Win probability increases significantly as the rank and/or number of wilds in a three-of-a-kind increases. A similar but smaller magnitude impact is observed for straights. Flushes and full houses are powerful hands with win probabilities that are mostly independent of rank but modestly increased by possession of a wild (with flushes, a wild always makes the flush Ace-high, so rank and wilds are particularly associated in these hands)
  
Hands with four-of-a-kind or better are assessed for win probability:  
```{r, fig.height=9, fig.width=9}

# Plot for five wild, four-of-a-kind, straight flush, five-of-a-kind, royal flush
fullHandProbsData %>%
    filter(type %in% c(1, 2, 3, 4, 5)) %>%
    mutate(ranks=ifelse(type>2,
                        paste0(numberToCard(tb1), 
                               case_when(type==5~"\nquad", type==4~"\nlow\nSF", type==3~"\nquint")
                               ), 
                        ifelse(type==2, "RF", "5W")
                        ), 
           nWild=as.character(nWild)
           ) %>%
    group_by(type, tb1, ranks, nWild) %>%
    summarize(across(pWNoTie, .fns=list(max=max, med=median, min=min)), .groups="drop") %>%
    arrange(type, desc(tb1)) %>%
    mutate(ranks=factor(ranks, levels=unique(ranks))) %>%
    ggplot(aes(x=ranks)) + 
    geom_errorbar(aes(ymin=pWNoTie_min, ymax=pWNoTie_max, color=nWild), width=0.2) +
    geom_point(aes(y=pWNoTie_med, color=nWild)) + 
    labs(x="Hand type", 
         y="Win probability (ties excluded)", 
         title="Win probability for four-of-a-kind or better", 
         subtitle="Median and max/min range"
    ) + 
    geom_hline(yintercept=c(0.975, 1), lty=2) + 
    theme(axis.text.x=element_text(size=7)) +
    scale_color_discrete("# wilds")

```
  
Very strong hands almost always win, though Win probability increases slightly as the rank and/or number of wilds in a four-of-a-kind, straight flush, or five-of-a-kind increases

Hands are arranged from highest to lowest win probability, with gaps explored:  
```{r, fig.height=9, fig.width=9}

# Create delta as lowest gap between preceeding and succeeding hand
fullHandDelta <- fullHandProbsData %>%
    mutate(pWpL=pWQ+pWN-pLQ-pLN) %>%
    arrange(pWpL) %>%
    mutate(delta=case_when(row_number()==1 ~ lead(pWpL)-pWpL, 
                           row_number()==n() ~ pWpL-lag(pWpL), 
                           TRUE ~ pmin(lead(pWpL)-pWpL, pWpL-lag(pWpL))
                           )
           ) %>%
    select(delta, pWpL, everything())
fullHandDelta

# Summary of the delta statistic
summary(fullHandDelta %>% mutate(delta=1000000*delta) %>% pull(delta))

# Proportion of hands with zero delta
fullHandDelta %>%
    mutate(noGap = (1000000*delta < 0.1)) %>%
    group_by(rank, type, nWild) %>%
    summarize(n=n(), pct=mean(noGap), .groups="drop") %>%
    group_by(type, nWild) %>%
    summarize(pctNoGap=sum(pct*n)/sum(n), n=sum(n), .groups="drop") %>%
    ggplot(aes(x=factor(type), y=pctNoGap)) + 
    geom_text(aes(color=factor(nWild), label=round(pctNoGap, 3)), size=2.5) + 
    labs(x="Hand type", 
         y="Percent tied with previous and/or next", 
         title="Hands of tied value in fullHandProbData by hand type"
         ) + 
    scale_color_discrete("# Wild")

# Number of hands with zero delta
fullHandDelta %>%
    mutate(noGap = (1000000*delta < 0.1)) %>%
    count(type, nWild, noGap) %>%
    ggplot(aes(x=factor(type), y=n/1000)) + 
    geom_col(aes(fill=factor(noGap))) + 
    labs(x="Hand type", 
         y="Number of hands (000)", 
         title="Hands of tied value in fullHandProbData by hand type",
         subtitle="Facetted by number of wilds"
         ) + 
    scale_fill_discrete("No Gap?") + 
    facet_wrap(~nWild, scales="free_y") + 
    theme(legend.position = "bottom")

```
  
Even with the de-duplication process, many hands get the identical results as the previous or next hand. The majority of these cases are in hands with no wild and zero or one pair

Are hands with zero pairs monotonic based on rank?
```{r, fig.height=9, fig.width=9}

# Get range of EV of each rank of hands with no pair
noPairEV <- fullHandProbsData %>%
    filter(type==99) %>%
    mutate(evIfPlay=3*(pWQ+pWN) + 2*(pTQ+pTN) - (pLQ+pLN)) %>%
    group_by(rank, type, nWild, tb1, tb2, tb3, tb4, tb5) %>%
    summarize(n=n(), minEV=min(evIfPlay), meanEV=mean(evIfPlay), maxEV=max(evIfPlay), .groups="drop")
noPairEV

# Plot magnitude of EV range
noPairEV %>%
    ggplot(aes(x=(maxEV-minEV))) + 
    geom_histogram(fill="lightblue", bins=100) + 
    geom_vline(xintercept=0.001, lty=2) +
    labs(x="Range of EV within same rank", 
         y="Number of ranks", 
         title="Range of EV for hands of same rank", 
         subtitle="Hands with no pair, no wild", 
         caption="Dotted line at 0.001 (0.1% range of EV)"
         )

# Plot ranges of EV for hands of type AKQxx
noPairEV %>%
    filter(tb2==13, tb3>=11) %>%
    mutate(ranks=paste0("AK", 
                        case_when(tb3==12~"Q", tb3==11~"J", tb3==10 ~ "T", TRUE~as.character(tb3)), 
                        case_when(tb4==11~"J", tb4==10~"T", TRUE~as.character(tb4)), 
                        case_when(tb5==11~"J", tb5==10~"T", TRUE~as.character(tb5))
                        ), 
           rank45=400*tb3+20*tb4+tb5
           ) %>%
    ggplot(aes(x=fct_reorder(ranks, rank45))) + 
    geom_point(aes(y=meanEV)) + 
    geom_errorbar(aes(ymin=minEV, ymax=maxEV)) + 
    coord_flip() + 
    labs(x="EV of play vs. fold", y=NULL, title="EV of play vs. fold for hands of type AK[Q|J]xx") + 
    facet_wrap(~tb3, scales="free")

```

There are a few cases where hands are not monotonic in mean EV when sorted by rank. This typically occurs around a cut point where a lower ranked hand blocks more straights (e.g., from AKQT3 to AKQ98 or from AKQ93 to AKQ87). In addition, error bars frequently overlap between hands, for example, some AKQJ8 being better than some AKQJ9. The ranges are extremely small (at most just above 0.1% EV), so impact is likely very modest
  
Hands of type AKQJ9 and AKQJ8 are explored:  
```{r, fig.height=9, fig.width=9}

tmpSubset <- fullHandProbsData %>%
    filter(type==99) %>%
    mutate(evIfPlay=3*(pWQ+pWN) + 2*(pTQ+pTN) - (pLQ+pLN)) %>%
    filter(tb4==11, tb5 >= 8)
tmpSubset

# Plot for EV of playing hands
tmpSubset %>%
    arrange(evIfPlay) %>%
    mutate(rn=row_number(), ht=case_when(rank==4381~"AKQJ8", rank==4380~"AKQJ9", TRUE~"Error")) %>%
    ggplot(aes(x=rn, y=evIfPlay)) + 
    geom_point(aes(color=ht)) + 
    scale_color_discrete("Hand Type") + 
    labs(x=NULL, y="EV if played", title="Zero-pair hands AKQJ9 and AKQJ8 sorted by EV")

# Plot for EV of playing hands
tmpSubset %>%
    arrange(evIfPlay) %>%
    left_join(nPerSuit, by="handNum") %>%
    mutate(rn=row_number(), 
           ht=case_when(rank==4381~"AKQJ8", rank==4380~"AKQJ9", TRUE~"Error"), 
           suits=paste(Spades, Hearts, Diamonds, Clubs, sep="-")
           ) %>%
    ggplot(aes(x=rn, y=evIfPlay)) + 
    geom_point(aes(color=suits)) + 
    scale_color_discrete("Suits") + 
    labs(x=NULL, y="EV if played", title="EV of hands by suit distribution (AKQJ9 and AKQJ8)") + 
    facet_wrap(~ht)

```
  
Within each set of ranks, there are quanta based on the distribution of suits (2-1-1-1 being the most favorable to the player, 4-1-0-0 being the least). Within each quanta, there are some very minor distinctions in EV as well

The impact of suit distribution on all AKQxx and AKJxx hands is explored:  
```{r, fig.height=9, fig.width=9}

# Get range of EV of each rank of hands with no pair
noPairEVSuits <- fullHandProbsData %>%
    filter(type==99) %>%
    mutate(evIfPlay=3*(pWQ+pWN) + 2*(pTQ+pTN) - (pLQ+pLN)) %>%
    left_join(nPerSuit, by="handNum") %>%
    mutate(suits=paste(Spades, Hearts, Diamonds, Clubs, sep="-")) %>%
    group_by(rank, type, nWild, suits, tb1, tb2, tb3, tb4, tb5) %>%
    summarize(n=n(), 
              minEV=min(evIfPlay), 
              meanEV=mean(evIfPlay), 
              maxEV=max(evIfPlay), 
              sdEV=sd(evIfPlay), 
              rngEV=diff(range(evIfPlay)),
              .groups="drop"
              )
noPairEVSuits

# Plot magnitude of EV range
noPairEVSuits %>%
    ggplot(aes(x=(maxEV-minEV))) + 
    geom_histogram(fill="lightblue", bins=100) + 
    geom_vline(xintercept=0.001, lty=2) +
    labs(x="Range of EV within same rank and suit count", 
         y="Number of ranks", 
         title="Range of EV for hands of same rank and suit count", 
         subtitle="Hands with no pair, no wild", 
         caption="Dotted line at 0.001 (0.1% range of EV)"
         )

# Plot ranges of EV for hands of type AKQxx
noPairEVSuits %>%
    filter(tb2==13, tb3>=11) %>%
    mutate(ranks=paste0("AK", 
                        case_when(tb3==12~"Q", tb3==11~"J", tb3==10 ~ "T", TRUE~as.character(tb3)), 
                        case_when(tb4==11~"J", tb4==10~"T", TRUE~as.character(tb4)), 
                        case_when(tb5==11~"J", tb5==10~"T", TRUE~as.character(tb5))
                        ), 
           rank45=400*tb3+20*tb4+tb5
           ) %>%
    ggplot(aes(x=fct_reorder(ranks, rank45))) + 
    geom_point(aes(y=meanEV, color=suits)) + 
    coord_flip() + 
    labs(x="EV of play vs. fold", y=NULL, title="EV of play vs. fold for hands of type AK[Q|J]xx") + 
    scale_color_discrete("Suit\nDistribution") +
    facet_wrap(~tb3, scales="free")

```

Consistently, holding hand rank constant, average EV is most positive for 2-1-1-1 suit distribution and least positive for 4-1-0-0 suit distribution

A check for monotonicity within ranks and suit distributions is performed for hands with zero-pairs:  
The impact of suit distribution on all AKQxx and AKJxx hands is explored:  
```{r, fig.height=9, fig.width=9}

tmpDeltaNeg <- noPairEVSuits %>%
    arrange(rank, desc(suits)) %>%
    group_by(rank) %>%
    mutate(deltaNegFwd=ifelse(row_number()==1, FALSE, ifelse(minEV < lag(maxEV), TRUE, FALSE)),
           deltaNegBwd=ifelse(row_number()==n(), FALSE, ifelse(maxEV > lead(minEV), TRUE, FALSE)),
           deltaNeg=ifelse(deltaNegFwd, TRUE, ifelse(deltaNegBwd, TRUE, FALSE))
           ) %>%
    ungroup()
tmpDeltaNeg

# Counts of overlapping EV
tmpDeltaNeg %>% 
    count(deltaNeg, deltaNegFwd, deltaNegBwd)

# Counts by rank of overlaps
tmpDeltaNegCounts <- tmpDeltaNeg %>%
    group_by(rank) %>%
    summarize(sumDeltaNeg=sum(deltaNeg)) 
tmpDeltaNegCounts %>%
    count(sumDeltaNeg)

# Example hand types for each
for(intCtr in c(2, 3, 4, 5)) {
    tmpDeltaNegCounts %>%
        filter(sumDeltaNeg==intCtr) %>%
        left_join(noPairEVSuits, by="rank", multiple="all") %>%
        print()
}

# Magnitude of overlaps
noPairEVSuits %>%
    arrange(rank, desc(suits)) %>%
    group_by(rank) %>%
    mutate(deltaNext=ifelse(row_number()==n(), 0, lead(minEV)-maxEV)) %>%
    filter(row_number() != n()) %>%
    ungroup() %>%
    ggplot(aes(x=deltaNext)) + 
    geom_histogram(fill="lightblue", bins=100) + 
    labs(title="Delta from max of current range to min of next range\n(<0 means overlapping)", 
         y="Count", 
         x=NULL
         ) + 
    geom_vline(xintercept = 0, lty=2)

# Magnitude of overlaps
noPairEVSuits %>%
    arrange(rank, desc(suits)) %>%
    group_by(rank) %>%
    mutate(deltaNext=ifelse(row_number()==n(), 0, lead(meanEV)-meanEV)) %>%
    filter(row_number() != n()) %>%
    ungroup() %>%
    ggplot(aes(x=deltaNext)) + 
    geom_histogram(fill="lightblue", bins=100) + 
    labs(title="Delta from mean of current range to mean of next range\n(<0 means discontinuity)", 
         y="Count", 
         x=NULL
         ) + 
    geom_vline(xintercept = 0, lty=2)

```
  
On average, EV for zero-pair hands becomes more favorable as suit distribution moves from 4-1-0-0 to 2-1-1-1. Which cards fall in which suit buckets is sometimes important enough to make the sequence non-monotonic, though with extremely small impact on EV
  
