---
title: "Coronavirus US - CDC All-Cause Death"
author: "davegoblue"
date: "7/7/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Background  
This module extends code contained in Coronavirus_Statistics_v004.Rmd to include sourcing of all key functions and parameters.  This file includes the latest code for analyzing all-cause death data from [CDC Weekly Deaths by Jurisdiction](https://catalog.data.gov/dataset/weekly-counts-of-deaths-by-jurisdiction-and-age-group).  CDC maintains data on deaths by week, age cohort, and state in the US.  Downloaded data are unique by state, epidemiological week, year, age, and type (actual vs. predicted/projected).

These data are known to have a lag between death and reporting, and the CDC back-correct to report deaths at the time the death occurred even if the death is reported in following weeks.  This means totals for recent weeks tend to run low (lag), and the CDC run a projection of the expected total number of deaths given the historical lag times.  Per other analysts on the internet, there is currently significant supra-lag, with lag times much longer than historical averages causing CDC projected deaths for recent weeks to be low.

The code leverages tidyverse and sourced functions throughout:  
```{r}

# All functions assume that tidyverse and its components are loaded and available
library(tidyverse)

# If the same function is in both files, use the version from the more specific source
source("./Generic_Added_Utility_Functions_202105_v001.R")
source("./Coronavirus_CDC_Excess_Functions_v001.R")

```
  
## Running Code  
The main function is readRunCDCAllCause(), which performs multiple tasks:  
  
STEP 0: Optionally, downloads the latest data file from CDC
STEP 1: Reads and processes a data file has been downloaded from CDC to local  
STEP 2: Extract relevant data from a processed state-level COVID Tracking Project list  
STEP 3: Basic plots of the CDC data  
STEP 4: Basic excess-deaths analysis  
STEP 5: Create cluster-level aggregate plots  
STEP 6: Create state-level aggregate plots  
STEP 7: Create age-cohort aggregate plots  
STEP 8: Returns a list of key data frames, modeling objects, named cluster vectors, etc.  
  
The functions are tested on previously downloaded data:  
```{r, fig.height=9, fig.width=9}

cdcLoc <- "Weekly_counts_of_deaths_by_jurisdiction_and_age_group_downloaded_20210623.csv"
cdcList_20210703 <- readRunCDCAllCause(loc=cdcLoc, 
                                       weekThru=17, 
                                       lst=readFromRDS("cdc_daily_210528"), 
                                       dlData=FALSE, 
                                       stateNoCheck=c("NC"), 
                                       pdfCluster=TRUE, 
                                       pdfAge=TRUE
                                       )

```
  
The latest data are downloaded and processed:  
```{r, fig.height=9, fig.width=9, cache=TRUE}

cdcLoc <- "Weekly_counts_of_deaths_by_jurisdiction_and_age_group_downloaded_20210708.csv"
cdcList_20210708 <- readRunCDCAllCause(loc=cdcLoc, 
                                       weekThru=22, 
                                       lst=readFromRDS("cdc_daily_210708"), 
                                       stateNoCheck=c("NC", "AK", "WV"), 
                                       pdfCluster=TRUE, 
                                       pdfAge=TRUE
                                       )
saveToRDS(cdcList_20210708)

```
  
The function readProcessCDC() is updated to allow for more control in zeroing out (rather than erroring) where there is a small number of data suppression:  
```{r}

# Function to check for CDC excess suppression
checkCDCSuppression <- function(df, stateNoCheck, errTotAllowed=20, errMaxAllowed=round(errTotAllowed/2)) {
    
    # Categorize the potential issues in the file (note to suppress or NA deaths)
    checkProblems <- df %>% 
        mutate(problem=(!is.na(Suppress) | is.na(deaths)), 
               noCheck=state %in% all_of(stateNoCheck)
               )
    
    # Print a list of the problems, excluding those in stateNoCheck
    cat("\nRows in states to be checked that have NA deaths or a note for suppression:\n")
    checkProblems %>%
        filter(problem, !noCheck) %>%
        arrange(desc(year), desc(week)) %>%
        select(state, weekEnding, year, week, age, Suppress, deaths) %>%
        as.data.frame() %>%
        print()
    
    # Summarize the problems
    cat("\n\nProblems by state:\n")
    checkProblems %>%
        group_by(noCheck, state, problem) %>%
        summarize(n=n(), deaths=specNA(sum)(deaths), .groups="drop") %>%
        filter(problem) %>%
        print()
    
    # Assess the amount of error
    errorState <- checkProblems %>%
        filter(problem, !noCheck) %>%
        count(state)
    
    # Error out if threshold for error by state OR total errors exceeded
    errMax <- errorState %>% pull(n) %>% max()
    errTot <- errorState %>% pull(n) %>% sum()
    cat("\n\nThere are", errTot, "rows with errors; maximum for any given state is", errMax, "errors\n")
    
    if ((errTot > errTotAllowed) | (errMax > errMaxAllowed)) {
        stop("\nToo many errors; thresholds are ", errTotAllowed, " total and ", errMaxAllowed, " maximum\n")
    }
    
}



plotQCReadProcessCDC <- function(df, 
                                 ckCombos=list(c("age"), c("period", "year", "Type"), 
                                               c("period", "Suppress"), c("period", "Note")
                                               )
                                 ) {
    
    # Create dataset for analysis
    df <- df %>% 
        mutate(n=1, n_deaths_na=ifelse(is.na(deaths), 1, 0))
    
    # Check control totals by specified combinaions
    purrr::walk(ckCombos, .f=function(x) {
        cat("\n\nChecking variable combination:", x, "\n")
        checkControl(df, groupBy=x, useVars=c("n", "n_deaths_na", "deaths"), fn=specNA(sum))
        }
        )
    
    # Plot deaths by state
    p1 <- checkControl(df, 
                       groupBy=c("state"), 
                       useVars=c("deaths"), 
                       fn=specNA(sum), 
                       printControls=FALSE, 
                       pivotData=FALSE
                       ) %>%
        ggplot(aes(x=fct_reorder(state, deaths), y=deaths)) + 
        geom_col(fill="lightblue") + 
        geom_text(aes(y=deaths, label=paste0(round(deaths/1000), "k")), hjust=0, size=3) + 
        coord_flip() +
        labs(y="Total deaths", x=NULL, title="Total deaths by state in all years in processed file")
    print(p1)
    
    # Plot deaths by week/year
    p2 <- checkControl(df, 
                       groupBy=c("year", "week"), 
                       useVars=c("deaths"), 
                       fn=specNA(sum), 
                       printControls=FALSE, 
                       pivotData=FALSE
                       ) %>%
        ggplot(aes(x=week, y=deaths)) + 
        geom_line(aes(group=year, color=year)) + 
        labs(title="Deaths by year and epidemiological week", x="Epi week", y="US deaths") + 
        scale_color_discrete("Year") + 
        lims(y=c(0, NA))
    print(p2)
    
}



# Function to read and process raw CDC all-cause deaths data
readProcessCDC <- function(fName, 
                           weekThru,
                           periodKeep=cdcExcessParams$periodKeep,
                           fDir="./RInputFiles/Coronavirus/",
                           col_types=cdcExcessParams$colTypes, 
                           renameVars=cdcExcessParams$remapVars,
                           maxSuppressAllowed=20, 
                           stateNoCheck=c()
                           ) {
    
    # FUNCTION ARGUMENTS:
    # fName: name of the downloaded CDC data file
    # weekThru: any record where week is less than or equal to weekThru will be kept
    # periodKeep: any record where period is in periodKeep will be kept
    # fDir: directory name for the downloaded CDC data file
    # col_types: variable type by column in the CDC data (passed to readr::read_csv())
    # renameVars: named vector for variable renaming of type c("Existing Name"="New Name")
    # maxSuppressAllowed: maximum number of data suppressions (must be in current week/year) to avoid error
    # stateNoCheck: vector of states that do NOT have suppression errors thrown
    
    # STEP 1: Read the CSV data
    cdcRaw <- fileRead(paste0(fDir, fName), col_types=col_types)
    # glimpse(cdcRaw)
    
    # STEP 2: Rename the variables for easier interpretation
    cdcRenamed <- cdcRaw %>%
        colRenamer(vecRename=renameVars) %>%
        colMutater(selfList=list("weekEnding"=lubridate::mdy))
    # glimpse(cdcRenamed)
    
    # STEP 3: Convert to factored data
    cdcFactored <- cdcRenamed %>%
        colMutater(selfList=list("age"=factor), levels=cdcExcessParams$ageLevels) %>%
        colMutater(selfList=list("period"=factor), levels=cdcExcessParams$periodLevels) %>%
        colMutater(selfList=list("year"=factor), levels=cdcExcessParams$yearLevels)
    # glimpse(cdcFactored)
    
    # STEP 4: Filter the data to include only weighted deaths and only through the desired time period
    cdcFiltered <- cdcFactored %>%
        rowFilter(lstFilter=list("Type"="Predicted (weighted)")) %>%
        filter(period %in% all_of(periodKeep) | week <= weekThru)
    # glimpse(cdcFiltered)
    
    # STEP 4a: Check that all suppressed data and NA deaths have been eliminated
    cat("\n\n *** Data suppression checks *** \n")
    checkCDCSuppression(cdcFiltered, stateNoCheck=stateNoCheck, errTotAllowed=maxSuppressAllowed)
    cat("\n\nData suppression checks passed\n\n")
    
    # STEP 5: Remove any NA death fields, delete the US record, convert YC to be part of NY
    cdcProcessed <- cdcFiltered %>%
        rowFilter(lstExclude=list("state"=c("US", "PR"), "deaths"=c(NA))) %>%
        mutate(state=ifelse(state=="YC", "NY", state), 
               fullState=ifelse(state %in% c("NY", "YC"), "New York State (NY plus YC)", fullState)
               ) %>%
        group_by(fullState, weekEnding, state, year, week, age, period, Type, Suppress) %>%
        arrange(!is.na(Note)) %>%
        summarize(n=n(), deaths=sum(deaths), Note=first(Note), .groups="drop") %>%
        ungroup() %>%
        checkUniqueRows(uniqueBy=c("state", "year", "week", "age"))
    glimpse(cdcProcessed)
    
    # STEP 5a: Check control levels for key variables in processed file
    cat("\nCheck Control Levels and Record Counts for Processed Data:\n")
    plotQCReadProcessCDC(cdcProcessed)

    # STEP 6: Return the processed data file
    cdcProcessed
    
}

```

The data are processed using the updated function:  
```{r, fig.height=9, fig.width=9, cache=TRUE}

cdcLoc <- "Weekly_counts_of_deaths_by_jurisdiction_and_age_group_downloaded_20210708.csv"
cdcList_20210708_v2 <- readRunCDCAllCause(loc=cdcLoc, 
                                          weekThru=23, 
                                          lst=readFromRDS("cdc_daily_210708"), 
                                          stateNoCheck=c("NC"), 
                                          pdfCluster=TRUE, 
                                          pdfAge=TRUE
                                          )

```
  
The latest data are downloaded and processed:  
```{r, fig.height=9, fig.width=9, cache=TRUE}

cdcLoc <- "Weekly_counts_of_deaths_by_jurisdiction_and_age_group_downloaded_20210823.csv"
cdcList_20210823 <- readRunCDCAllCause(loc=cdcLoc, 
                                       weekThru=29, 
                                       lst=readFromRDS("cdc_daily_210815"), 
                                       stateNoCheck=c("NC", "AK", "CT"), 
                                       pdfCluster=TRUE, 
                                       pdfAge=TRUE
                                       )

```
  
CDC data for deaths by age and location available at [CDC website](https://data.cdc.gov/api/views/4va6-ph5s/rows.csv?accessType=DOWNLOAD) are downloaded, cached to avoid multiple hits to the server:  
```{r, fig.height=9, fig.width=9, cache=TRUE}

deathAgeLoc <- "./RInputFiles/Coronavirus/COvID_deaths_age_place_20210824.csv"
if (!file.exists(deathAgeLoc)) {
    fileDownload(fileName="./RInputFiles/Coronavirus/COvID_deaths_age_place_20210824.csv", 
                 url="https://data.cdc.gov/api/views/4va6-ph5s/rows.csv?accessType=DOWNLOAD"
                 )
} else {
    cat("\nFile already exists, not downloading\n")
}

```
  
The file is then read for a basic exploration:  
```{r, fig.height=9, fig.width=9}

deathAge_20210824_raw <- fileRead(deathAgeLoc, col_types="cccciiccccddddddc")
glimpse(deathAge_20210824_raw)

deathAge_20210824_conv <- deathAge_20210824_raw %>%
    colRenamer(vecRename=c("Data as of"="asofDate", 
                           "Start Date"="startDate", 
                           "End Date"="endDate", 
                           "HHS Region"="HHSRegion", 
                           "Place of Death"="deathPlace", 
                           "Age group"="Age", 
                           "COVID-19 Deaths"="covidDeaths", 
                           "Total Deaths"="totalDeaths", 
                           "Pneumonia Deaths"="pneumoDeaths", 
                           "Pneumonia and COVID-19 Deaths"="pneumoCovidDeaths", 
                           "Influenza Deaths"="fluDeaths", 
                           "Pneumonia, Influenza, or COVID-19 Deaths"="pnemoFluCovidDeaths"
                           )
               ) %>%
    colMutater(selfList=list("asofDate"=lubridate::mdy, "startDate"=lubridate::mdy, "endDate"=lubridate::mdy))
glimpse(deathAge_20210824_conv)

# Combinations of startDate and endDate
deathAge_20210824_conv %>%
    count(asofDate, startDate, endDate) %>%
    ggplot(aes(y=startDate, x=endDate)) + 
    geom_point(aes(size=n)) + 
    facet_wrap(~asofDate) + 
    labs(x="Ending Date", y="Starting Date", title="Combinations of Start and End Date")

deathAge_20210824_conv %>%
    count(Group, deathPlace, Age) %>%
    ggplot(aes(x=Group, y=deathPlace)) + 
    geom_tile(aes(fill=n)) + 
    facet_wrap(~Age) + 
    labs(x="Group", y="Place of Death", title="Combinations of Age, Place of Death, and Group")

deathState <- deathAge_20210824_conv %>%
    filter(Group=="By Total", deathPlace=="Total - All Places of Death", Age=="All Ages") %>%
    group_by(State) %>%
    summarize(across(where(is.numeric), sum, na.rm=TRUE)) %>%
    mutate(abb=state.abb[match(State, state.name)])
deathState %>% filter(is.na(abb))

deathBase <- deathState %>%
    select(State, covidDeaths, totalDeaths) %>%
    mutate(noncovid=covidDeaths/totalDeaths) %>%
    filter(!(State %in% c("United States", "Puerto Rico"))) %>%
    pivot_longer(-c(State)) %>%
    ggplot(aes(x=fct_reorder(State, value, max), y=value/1000)) + 
    coord_flip() + 
    theme(legend.position="bottom")
deathBase + 
    geom_col(data=~filter(., name=="totalDeaths"), aes(fill="All")) +
    geom_col(data=~filter(., name=="covidDeaths"), aes(fill="COVID")) + 
    scale_fill_manual("Type", breaks=c("COVID", "All"), labels=c("COVID", "All"), values=c("red", "black")) + 
    labs(title="Deaths 2020-present by state", x=NULL, y="Deaths (000s)")
deathBase + 
    geom_col(data=~filter(., name=="noncovid"), aes(y=value), position="identity") + 
    labs(x=NULL, y=NULL, title="Proportion of deaths from COVID")

```

The data appear to contain monthly totals, with the addition of full-year 2020, YTD 2021, and total 2020-YTD 2021. Totals are provided by age sub-group and overall, place of death category and overall, and monthly, annually, and total.

Total deaths and proportions from COVID appear sensible. Next steps are to continue processing and exploring the data:  
```{r, fig.height=9, fig.width=9}

# Add the state abbreviation
deathAge_20210824_conv <- deathAge_20210824_conv %>%
    mutate(abb=c(state.abb, "DC")[match(State, c(state.name, "District of Columbia"))])

# Function to check that totals match sum of sub-totals
checkSubTotals <- function(df, checkByVars, subVar, subVarTotal, sumVars=NULL, sumFunc=specNA(sum), ...) {
    
    # FUNCTION ARGUMENTS:
    # df: data.frame or tibble
    # checkByVars: variables that the frame will be checked by
    # subVar: variable that is being checked
    # subVarTotal: label for the value that is the total of subVar
    # sumVars: variables to be summed (NULL means all numeric)
    # sumFunc: function to be applied when summing all variables
    # ...: any other arguments to pass to summarize(across(all_of(checkByVars), .fns=sumFunc, ...))
    
    # If sumVars is NULL, find the sum variables
    if (is.null(sumVars)) sumVars <- df %>% head(1) %>% select_if(is.numeric) %>% names()
    
    # Keep only te desired variables in df
    df <- df %>%
        select(all_of(c(checkByVars, subVar, sumVars))) %>%
        arrange(across(all_of(checkByVars)))
    
    # Split the data frame by subtotal and total
    dfTot <- df %>%
        filter(get(subVar) == subVarTotal)
    dfSub <- df %>%
        filter(get(subVar) != subVarTotal) %>%
        group_by(across(all_of(checkByVars))) %>%
        summarize(across(all_of(sumVars), .fns=sumFunc, ...), .groups="drop") %>%
        mutate(fakeCol=subVarTotal) %>%
        colRenamer(vecRename=c("fakeCol"=subVar)) %>%
        select(names(dfTot))
    
    # Comparison of totals
    list(dfSub=dfSub, dfTot=dfTot)
    
}

checkNumbers <- function(lst, byVars, lstNames=NULL, absTol=100, pctTol=0.05, keyVar="key variable") {
    
    # FUNCTION ARGUMENTS:
    # lst: a list with two items that will be checked for similarity
    # byVars: by variables that should be identical across the list items
    # lstNames: names to use for the list (NULL means use names provided in lst)
    # absTol: absolute value of differences to flag
    # pctTol: percent tolerance for differences to flag
    # keyVar: name for the key variable in plot title
    
    # Check that lst is a list of length 2
    if (!("list" %in% class(lst)) | !(length(lst)==2)) stop("\nMust pass a list with two items\n")
    
    # Add names if passed in lstNames, otherwise use names(lst)
    if (!is.null(lstNames)) names(lst) <- lstNames 
    else lstNames <- names(lst)
    
    # Check for identical files using only byVars
    if (!isTRUE(identical(lst[[1]][, byVars], lst[[2]][, byVars]))) 
        stop("\nSub-lists differ by byVars, not comparing\n") 
    else cat("\nSub-lists are identical by:", paste0(byVars, collapse=", "), "\n")
    
    # Check the numeric values
    dfDelta <- lapply(lst, FUN=function(x) pivot_longer(x, cols=-all_of(byVars)) %>% 
               mutate(value=ifelse(is.na(value), 0, value)) %>%
               select(all_of(byVars), name, value)
           ) %>%
        purrr::reduce(.f=inner_join, by=c(all_of(byVars), "name")) %>%
        mutate(delta=value.x-value.y, pct=ifelse(delta==0, 0, delta/(value.x+value.y))) %>%
        purrr::set_names(c(all_of(byVars), "name", all_of(lstNames), "delta", "pct"))
    
    # Plot the differences using name as facet
    p1 <- dfDelta %>%
        ggplot(aes(x=delta, y=pct)) + 
        geom_point() + 
        facet_wrap(~name, scales="free") + 
        labs(title=paste0("Differences between totals and subtotals on variable: ", keyVar), 
             x="Difference between total and subtotal", 
             y="Percentage difference"
             )
    print(p1)
    
    # Flag significant outliers
    dfDelta %>%
        filter(abs(delta) >= absTol, abs(pct) >= pctTol) %>%
        arrange(-abs(delta)) %>%
        print()
    
}

# Get a list of the possible variables
allCheckVars <- names(deathAge_20210824_conv) %>% 
    setdiff(deathAge_20210824_conv %>% head(1) %>% select_if(is.numeric) %>% names()) %>%
    setdiff(c("Footnote", "abb", "HHSRegion"))

# Test for each variable in allCheckVars
subMap <- c("State"="United States", "Age"="All Ages", "deathPlace"="Total - All Places of Death")
lapply(c("State", "deathPlace", "Age"), 
       FUN=function(x) deathAge_20210824_conv %>% 
           select(-Year, -Month) %>%
           checkSubTotals(checkByVars=allCheckVars %>% setdiff(x), subVar=x, subVarTotal=unname(subMap[x])) %>%
           checkNumbers(byVars=allCheckVars, keyVar=x)
       )

```

Variables Age and deathPlace appear to be well-aligned between sub-totals and totals, while variable State shows some more significant differences. Next steps are to further research what is contained in State, including alignment to other data sources.

Deaths by state are compared between files, using July 31, 2021 as the cutoff:  
```{r, fig.height=9, fig.width=9}

# Create summary by state and year-month
death_sum_210824 <- deathAge_20210824_conv %>%
    filter(!is.na(Year), !is.na(Month), deathPlace=="Total - All Places of Death", Age=="All Ages") %>%
    mutate(ym=lubridate::ym(paste0(Year, "-", zeroPad2(Month))), 
           abb=c(state.abb, "DC", "US")[match(State, c(state.name, "District of Columbia", "United States"))]
           ) %>%
    select(State, abb, ym, where(is.numeric), -Year, -Month) %>%
    pivot_longer(-c(State, abb, ym)) %>%
    arrange(State, abb, name, ym) %>%
    group_by(State, abb, name) %>%
    mutate(cumValue=cumsum(ifelse(is.na(value), 0, value))) %>%
    ungroup() %>%
    mutate(date=lubridate::ceiling_date(ym, unit="month")-lubridate::days(1))

# Create summary from state-level file
death_daily_210815 <- readFromRDS("cdc_daily_210815")$dfPerCapita %>%
    select(date, abb=state, tot_deaths) %>%
    mutate(Year=lubridate::year(date), Month=lubridate::month(date)) %>%
    group_by(Year, Month) %>%
    filter(date==max(date)) %>%
    ungroup()
    
# Create a plot for evolution of United States
death_sum_210824 %>%
    filter(abb=="US", name=="covidDeaths", ym <= "2021-07-31") %>%
    ggplot(aes(x=date)) + 
    geom_line(aes(y=cumValue/1000, color="blue"), size=2) + 
    geom_point(data=summarize(group_by(filter(death_daily_210815, date <= "2021-07-31"), date), 
                              tot_deaths=sum(tot_deaths, na.rm=TRUE)
                              ), 
               aes(y=tot_deaths/1000, color="green"), 
               size=3
               ) +
    labs(x="End of month", y="Cumulative Deaths (000)", title="Cumulative COVID Deaths (000) in US by source") + 
    scale_color_manual("Source", labels=c("Summed\nstates", "Summed\nsubtotals"), values=c("green", "blue"))

```
  
Cumulative deaths by month for total US appear consistent across the files. Next steps are to continue exploring for state-level data:  
```{r, fig.height=9, fig.width=9}

# Create a plot for total by states
death_sum_210824 %>%
    filter(abb %in% c(state.abb, "DC"), name=="covidDeaths", date == "2021-07-31") %>%
    ggplot() + 
    geom_col(aes(x=fct_reorder(abb, cumValue), y=cumValue/1000), fill="lightblue") + 
    geom_point(data=filter(death_daily_210815, date == "2021-07-31"), 
               aes(x=abb, y=tot_deaths/1000), 
               size=3
               ) +
    coord_flip() +
    labs(x=NULL, 
         y="Cumulative Deaths (000)", 
         title="Cumulative COVID Deaths (000) in US as of 2021-07-31", 
         subtitle="Filled bars are summed subtotals, points are from CDC daily")

# Same plot using merged data
plot_cum0721 <- death_sum_210824 %>%
    filter(abb %in% c(state.abb, "DC"), name=="covidDeaths", date == "2021-07-31") %>%
    select(abb, cumValue) %>%
    inner_join(select(filter(death_daily_210815, date == "2021-07-31"), abb, tot_deaths), by=c("abb")) %>%
    mutate(pctdiff=abs(tot_deaths-cumValue)/(tot_deaths+cumValue))
plot_cum0721 %>%
    arrange(-pctdiff)
plot_cum0721 %>%
    summarize(across(where(is.numeric), sum))
plot_cum0721 %>%
    ggplot(aes(x=fct_reorder(abb, cumValue))) + 
    geom_col(aes(y=cumValue/1000), fill="lightblue") + 
    geom_point(aes(y=tot_deaths/1000), size=3) +
    coord_flip() +
    labs(x=NULL, 
         y="Cumulative Deaths (000)", 
         title="Cumulative COVID Deaths (000) in US as of 2021-07-31", 
         subtitle="Filled bars are summed subtotals, points are from CDC daily"
         )

```
  
The New York City data will need to be added to NY for further analysis. There are some surprising differences in total deaths reported by state, even as total deaths (after adding Nyc) are nearly identical between the files.

Breakdown of deaths by age is also explored:  
```{r, fig.height=9, fig.width=9}

deathAllData <- deathAge_20210824_conv %>%
    filter(deathPlace=="Total - All Places of Death")
deathAllData

# Proportions of death by age and cause
deathAllData %>%
    filter(State=="United States", Age != "All Ages", Group=="By Total") %>%
    select(Age, where(is.numeric), -Year, -Month) %>%
    pivot_longer(-Age) %>%
    ggplot() + 
    geom_col(aes(x=name, y=value, fill=fct_rev(Age)), position="fill") + 
    labs(x=NULL, y="Proportion of Deaths", title="Proportion of deaths by cause (2020-August 2021)") + 
    scale_fill_discrete("Age")

# Proportions of death by age and month
deathAllData %>%
    filter(State=="United States", Age != "All Ages", Group=="By Month") %>%
    mutate(ym=lubridate::ym(paste0(Year, "-", zeroPad2(Month)))) %>%
    select(Age, ym, totalDeaths, covidDeaths, fluDeaths) %>%
    pivot_longer(-c(Age, ym)) %>%
    ggplot() + 
    geom_col(aes(x=ym, y=value, fill=fct_rev(Age)), position="fill") + 
    facet_wrap(~name) +
    labs(x=NULL, y="Proportion of Deaths", title="Proportion of deaths by age and cause (2020-August 2021)") + 
    scale_fill_discrete("Age")

# Total death by age and month
deathAllData %>%
    filter(State=="United States", Age != "All Ages", Group=="By Month") %>%
    mutate(ym=lubridate::ym(paste0(Year, "-", zeroPad2(Month)))) %>%
    select(Age, ym, totalDeaths, covidDeaths, fluDeaths) %>%
    pivot_longer(-c(Age, ym)) %>%
    filter(ym != "2021-08-01") %>%
    ggplot() + 
    geom_line(aes(x=ym, y=value, color=fct_rev(Age), group=Age)) + 
    facet_wrap(~name, scales="free_y") +
    labs(x=NULL, y="Proportion of Deaths", title="Deaths by age and cause (2020-July 2021)") + 
    scale_color_discrete("Age")

```

There are very few reported flu deaths in the 2020-2021 data. The change in covidDeaths by age over time appears to be at most a minor driver of the change in totalDeaths by age over time. This is consistent with covidDeaths being in the 10%-20% range of totalDeaths, distributed by age (to a first order) in a somewhat similar pattern.

A similar process is run for place of death:  
```{r, fig.height=9, fig.width=9}

deathPlaceData <- deathAge_20210824_conv %>%
    filter(Age == "All Ages")
deathPlaceData

# Proportions of death by place and cause
deathPlaceData %>%
    filter(State=="United States", deathPlace!="Total - All Places of Death", Group=="By Total") %>%
    select(deathPlace, where(is.numeric), -Year, -Month) %>%
    pivot_longer(-deathPlace) %>%
    ggplot() + 
    coord_flip() +
    geom_col(aes(x=name, y=value, fill=fct_rev(deathPlace)), position="fill") + 
    labs(x=NULL, y="Proportion of Deaths", title="Proportion of deaths by place (2020-August 2021)") + 
    scale_fill_discrete("Death\nPlace") + 
    theme(legend.position="bottom")

# Proportions of death by place and month
deathPlaceData %>%
    filter(State=="United States", deathPlace!="Total - All Places of Death", Group=="By Month") %>%
    mutate(ym=lubridate::ym(paste0(Year, "-", zeroPad2(Month)))) %>%
    select(deathPlace, ym, totalDeaths, covidDeaths, fluDeaths) %>%
    pivot_longer(-c(deathPlace, ym)) %>%
    ggplot() + 
    geom_col(aes(x=ym, y=value, fill=fct_rev(deathPlace)), position="fill") + 
    facet_wrap(~name) +
    labs(x=NULL, y="Proportion of Deaths", title="Proportion of deaths by place and cause (2020-August 2021)") + 
    scale_fill_discrete("Death\nPlace") + 
    theme(legend.position="bottom")

# Total death by place and month
deathPlaceData %>%
    filter(State=="United States", deathPlace!="Total - All Places of Death", Group=="By Month") %>%
    mutate(ym=lubridate::ym(paste0(Year, "-", zeroPad2(Month)))) %>%
    select(deathPlace, ym, totalDeaths, covidDeaths, fluDeaths) %>%
    pivot_longer(-c(deathPlace, ym)) %>%
    filter(ym != "2021-08-01") %>%
    ggplot() + 
    geom_line(aes(x=ym, y=value, color=fct_rev(deathPlace), group=deathPlace)) + 
    facet_wrap(~name, scales="free_y") +
    labs(x=NULL, y="Proportion of Deaths", title="Deaths by place and cause (2020-July 2021)") + 
    scale_color_discrete("Death\nPlace")

```
  
Relative to overall deaths, COVID deaths appear more prevalent in the inpatient healthcare setting or nursing home and less prevalent at home. The proportion has moved away from nursing homes and towards inpatient (hospital) as the pandemic progressed.

Exploration of the place of death for COVID and non-COVID deaths is explored:  
```{r, fig.height=9, fig.width=9}

zeroNA <- function(x) ifelse(is.na(x), 0, x)

# Locations of death by age
tempPlotData <- deathAge_20210824_conv %>%
    mutate(nonCovidDeaths=zeroNA(totalDeaths)-zeroNA(covidDeaths)) %>%
    select(Group, startDate, endDate, State, deathPlace, Age, where(is.numeric), -Month, -Year) %>%
    pivot_longer(where(is.numeric))

# Basic plotting data
p1 <- tempPlotData %>%
    filter(name %in% c("covidDeaths", "nonCovidDeaths"), 
           State=="United States", 
           Group=="By Total"
           ) %>%
    ggplot(aes(x=Age, y=value/1000)) + 
    coord_flip() + 
    scale_fill_discrete("") +
    theme(legend.position="bottom") +
    labs(x=NULL, y="Deaths (000)", title="United States deaths (2020 thru mid-Aug 2021)")

# Overall deaths by age and type
p1 + 
    geom_col(data=~filter(., deathPlace=="Total - All Places of Death", Age !="All Ages"), 
             aes(fill=name), 
             position="stack"
             )

# Proportion deaths by age and type
p1 + 
    geom_col(data=~filter(., deathPlace=="Total - All Places of Death"), 
             aes(fill=fct_rev(name)), 
             position="fill"
             ) + 
    labs(y="Proportion of deaths")

# Overall deaths by age and type and location
p1 + 
    geom_col(data=~filter(., deathPlace!="Total - All Places of Death", Age != "All Ages"), 
             aes(fill=name), 
             position="stack"
             ) + 
    facet_wrap(~deathPlace)

# Proportion of deaths by age and type and location
p1 + 
    geom_col(data=~filter(., Age !="All Ages"), 
             aes(fill=fct_rev(name)), 
             position="fill"
             ) + 
    facet_wrap(~deathPlace) + 
    labs(y="Proportion of deaths") + 
    geom_hline(yintercept=0.25, lty=2)

```

As seen in other analyses, COVID deaths tend to occur in an older population in the institutional (nursing home or hospital) setting. Further exploration of these trends over time and by location may be interesting.

The evolution by month is also explored:  
```{r, fig.height=9, fig.width=9}

# Basic plotting data
p2 <- tempPlotData %>%
    filter(name %in% c("covidDeaths", "nonCovidDeaths"), 
           State=="United States", 
           Group=="By Month", 
           endDate <= "2021-07-31"
           ) %>%
    ggplot(aes(x=fct_reorder(deathPlace, value, max), y=value/1000)) + 
    coord_flip() + 
    scale_fill_discrete("") +
    theme(legend.position="bottom") +
    labs(x=NULL, y="Deaths (000)", title="United States deaths (2020 thru July 2021)")

# Overall deaths by month and place
p2 + 
    geom_col(data=~filter(., deathPlace!="Total - All Places of Death", Age =="All Ages"), 
             aes(fill=name), 
             position="stack"
             ) + 
    facet_wrap(~endDate)

# Proportion of deaths by month and place
p2 + 
    geom_col(data=~filter(., deathPlace!="Total - All Places of Death", Age =="All Ages"), 
             aes(fill=name), 
             position="fill"
             ) + 
    facet_wrap(~endDate) + 
    labs(y="Proportion of deaths")

# Overall deaths by month and age
p2 + 
    geom_col(data=~filter(., deathPlace=="Total - All Places of Death", Age !="All Ages"), 
             aes(x=Age, fill=name), 
             position="stack"
             ) + 
    facet_wrap(~endDate)

# Proportion of deaths by month and age
p2 + 
    geom_col(data=~filter(., deathPlace=="Total - All Places of Death", Age !="All Ages"), 
             aes(x=Age, fill=name), 
             position="fill"
             ) + 
    facet_wrap(~endDate) + 
    labs(y="Proportion of deaths")

```

COVID deaths are clearly clustered by each of age, month, and place. Older people, late-2020 and early-2021, and inpatient hospital settings have much higher amounts and proportions of covid death

The latest data are downloaded and processed:  
```{r, fig.height=9, fig.width=9, cache=TRUE}

cdcLoc <- "Weekly_counts_of_deaths_by_jurisdiction_and_age_group_downloaded_20210911.csv"
cdcList_20210911 <- readRunCDCAllCause(loc=cdcLoc, 
                                       weekThru=32, 
                                       lst=readFromRDS("cdc_daily_210902"), 
                                       stateNoCheck=c("NC", "WV", "CT"), 
                                       pdfCluster=TRUE, 
                                       pdfAge=TRUE
                                       )

saveToRDS(cdcList_20210911)

```
  
Plots are created for the deaths by week and age group, with the capacity to limit to a subset:  
```{r, fig.height=9, fig.width=9}

# Function to get the regression from a plot
tempGetReg <- function(df, regYears=2015:2019) {
    
    lm(deaths ~ age + weekEnding:age + 0, data=subset(df, year %in% all_of(regYears))) %>% 
        broom::tidy() %>% 
        mutate(age=factor(str_remove(str_remove(term, pattern=":.*"), pattern="age")), 
               type=ifelse(str_detect(term, pattern=":"), "slope", "intercept")
               ) %>% 
        select(age, name=type, value=estimate) %>% 
        pivot_wider(age)
    
}

# Function to plot differences from trend
getDiffTrend <- function(df, 
                         regYears, 
                         plotTitle, 
                         returnData=FALSE
                         ) {
    
    # FUNCTION ARGUMENTS:
    # df: data frame or tibble with filtered data
    # regYears: years to be used in regression
    # plotTitle: title for the plot
    # returnData: boolean, should the data be returned?
    
    # Run the linear mode and make the predictions
    tempLM <- lm(deaths ~ age + weekEnding:age + 0, data=subset(df, year %in% all_of(regYears)))
    tempDF <- df %>%
        mutate(pred=predict(tempLM, newdata=df))
    
    # Summarize to year-age
    sumDF <- tempDF %>%
        group_by(year, age) %>%
        summarize(across(where(is.numeric), sum), .groups="drop")
    
    # Plot the excess by year and age group
    p2 <- sumDF %>%
        ggplot(aes(x=year, y=deaths-pred)) + 
        geom_col(aes(fill=year)) + 
        geom_text(data=~filter(., !(year %in% all_of(regYears))), 
                  aes(y=0.5*(deaths-pred), label=round(deaths-pred))
                  ) +
        facet_wrap(~age, scales="free_y") + 
        labs(x="Year", 
             y="Actual deaths vs. predicted", 
             title=plotTitle, 
             subtitle=paste0("Trend line is linear model without seasonailty using ", 
                             paste0(regYears, collapse="-"), 
                             " data"
                             )
             )
    
    # Return the requested data
    if(returnData) list(objPlot=p2, fullDF=tempDF, sumDF=sumDF)
    else p2
    
}

# Function to create plots
plotAgeWeekDeath <- function(lst, 
                             keyStates=NULL, 
                             addLM=TRUE,
                             lmYears=2015:2019, 
                             diffTrend=FALSE, 
                             printPlots=TRUE, 
                             returnData=FALSE, 
                             returnPlots=!isTRUE(printPlots)
                             ) {
    
    # FUNCTION ARGUMENTS:
    # lst: a processed list file that includes the CDC deaths data
    # keyStates: states to be included
    # addLM: boolean, should a line for the linear model be added?
    # lmYears: what years should the linear model be fitted against?
    # diffTrend: boolean, should a difference from trend by year be calculated?
    # printPlots: boolean, should the plots be printed?
    # returnData: boolean, should the data be returned?
    # returnPlots: boolean, should the plot objects be returned?
    
    # Create the plot title (use 50 states plus DC if keyStates passed as NULL)
    plotTitle <- paste0("Total deaths by age cohort and week (", 
                        if (is.null(keyStates)) "50 states plus DC" else paste0(keyStates, collapse=", "),
                        ")"
                        )
    
    # Set the keyStates field to 50 states plus DC if not provided
    if (is.null(keyStates)) keyStates <- c(state.abb, "DC")
    
    # Extract the CDC data
    df <- lst[["cdc"]]
    
    # Create plot data
    p1Data <- df %>% 
        filter(state %in% all_of(keyStates)) %>% 
        group_by(weekEnding, year, age) %>% 
        summarize(deaths=sum(deaths), .groups="drop")
    
    # Create the plot
    p1 <- p1Data %>% 
        ggplot(aes(x=weekEnding, y=deaths)) + 
        geom_line(aes(color=year)) + 
        facet_wrap(~age, scales="free_y") + 
        lims(y=c(0, NA)) + 
        labs(title=plotTitle, 
             x="Week", 
             y="All-cause deaths"
             ) + 
        # subtitle="Dashed line is linear model without seasonailty using 2015-2019 data", 
        scale_color_discrete("Year")
    
    # Add the linear model if requested
    if (isTRUE(addLM)) {
        p1 <- p1 + 
            geom_abline(data=~tempGetReg(., regYears=lmYears), 
                        aes(slope=slope, intercept=intercept), 
                        lty=2
                        ) + 
            labs(subtitle=paste0("Dashed line is linear model without seasonailty using ", 
                                 paste0(lmYears, collapse="-"), 
                                 " data"
                                 )
                 )
    }
    
    # Display the plot if requested
    if (printPlots) print(p1)
    
    # Create a dataset for difference from expected deaths by year
    if (isTRUE(diffTrend)) {
        p2 <- getDiffTrend(p1Data, 
                           regYears=lmYears, 
                           plotTitle=paste0("Deaths vs trend for: ", 
                                            if (setequal(keyStates, c(state.abb, "DC"))) 
                                                "50 states plus DC" 
                                            else 
                                                paste0(keyStates, collapse=", ")
                                            ), 
                           returnData=returnData
                           )
        p2Plot <- if(isTRUE(returnData)) p2$objPlot else p2
        if (printPlots) print(p2Plot)
    } else {
        p2 <- NULL
    }
    
    # Return objects if requested
    if (isTRUE(returnData) | isTRUE(returnPlots)) {
        return(list(p1=if(isTRUE(returnPlots)) p1 else NULL, 
                    p2=if(isTRUE(returnPlots)) p2Plot else NULL, 
                    p1Data=if(isTRUE(returnData)) p1Data else NULL, 
                    p2Full=if(isTRUE(returnData)) p2$fullDF else NULL, 
                    p2Sum=if(isTRUE(returnData)) p2$sumDF else NULL
                    )
               )
    }
    
}

# Example plots
plotAgeWeekDeath(cdcList_20210911, addLM=FALSE)
plotAgeWeekDeath(cdcList_20210911)
plotAgeWeekDeath(cdcList_20210911, keyStates=c("NY", "NJ", "MA", "CT"))
plotAgeWeekDeath(cdcList_20210911, keyStates=c("TX", "LA", "MS", "AL", "FL"))
plotAgeWeekDeath(cdcList_20210911, keyStates=c("ND", "SD", "MT", "IA", "MO"))

# Examples with excess
plotAgeWeekDeath(cdcList_20210911, diffTrend=TRUE)
plotAgeWeekDeath(cdcList_20210911, keyStates=c("NY", "NJ", "MA", "CT"), diffTrend=TRUE)
plotAgeWeekDeath(cdcList_20210911, keyStates=c("TX", "LA", "MS", "AL", "FL"), diffTrend=TRUE)
plotAgeWeekDeath(cdcList_20210911, keyStates=c("ND", "SD", "MT", "IA", "MO"), diffTrend=TRUE)

# Examples with return options
plotAgeWeekDeath(cdcList_20210911, diffTrend=TRUE, printPlots=TRUE, returnData=FALSE, returnPlots=FALSE)
plotAgeWeekDeath(cdcList_20210911, diffTrend=TRUE, printPlots=FALSE, returnData=FALSE, returnPlots=FALSE)
plotAgeWeekDeath(cdcList_20210911, diffTrend=TRUE, printPlots=FALSE, returnData=FALSE, returnPlots=TRUE)
plotAgeWeekDeath(cdcList_20210911, diffTrend=TRUE, printPlots=FALSE, returnData=TRUE, returnPlots=FALSE)

```

The function can then be used to gather data for each state:  
```{r, fig.height=9, fig.width=9}

# Create death statistics for each state
tempStateList <- sort(c(state.abb, "DC")) %>%
    setdiff(c("WY", "WV", "VT", "SD", "RI", "NH", "ND", "MT", "ME", "ID", "HI", "DE", "DC", "AK"))
tempState <- lapply(tempStateList, 
                    FUN=function(x) plotAgeWeekDeath(cdcList_20210911, 
                                                     keyStates=x,
                                                     diffTrend=TRUE, 
                                                     printPlots=FALSE, 
                                                     returnData=TRUE, 
                                                     returnPlots=FALSE
                                                     )[["p2Full"]]
                    ) %>%
    bind_rows(.id="stateNum") %>%
    mutate(state=tempStateList[as.integer(stateNum)])
tempState

# Plot the results
tempState %>%
    filter() %>%
    group_by(state, weekEnding, year) %>%
    summarize(across(where(is.numeric), sum), .groups="drop") %>%
    ggplot(aes(x=weekEnding)) + 
    geom_line(aes(y=deaths, color=year)) + 
    geom_line(aes(y=pred), lty=2) + 
    facet_wrap(~state, scales="free_y") + 
    labs(x=NULL, 
         y="Weekly all-cause deaths", 
         title="All-cause deaths per week by state", 
         subtitle="Dashed line is linear trend without seasonality using 2015-2019 data"
         ) + 
    lims(y=c(0, NA)) +
    scale_color_discrete("")

```

The process is updated so that data can be calculated for those groups of state-age where there is sufficient data:  
```{r, fig.height=9, fig.width=9}

# Grid of all valid combinations of weekEnding-state-age
validGrid <- expand.grid(weekEnding=sort(unique(cdcList_20210911$cdc$weekEnding)), 
                         state=c(state.abb, "DC"),
                         age=unique(cdcList_20210911$cdc$age), 
                         stringsAsFactors=FALSE, 
                         KEEP.OUT.ATTRS=FALSE
                         ) %>%
    tibble::as_tibble() %>%
    mutate(year=factor(lubridate::epiyear(weekEnding)))

# Check that there are no records missing from validGrid
cdcList_20210911$cdc %>%
    anti_join(validGrid, by=c("weekEnding", "state", "age", "year"))

# Modified data to insert 0 deaths for any missing data
cdcMod <- cdcList_20210911$cdc %>%
    select(state, age, weekEnding, year, deaths) %>%
    right_join(validGrid, by=c("weekEnding", "state", "age", "year")) %>%
    mutate(deaths=ifelse(is.na(deaths), 0, deaths))
cdcMod

# Create data for each state as before
modStateList <- sort(c(state.abb, "DC"))
modState <- lapply(modStateList, 
                   FUN=function(x) plotAgeWeekDeath(list("cdc"=cdcMod), 
                                                    keyStates=x,
                                                    diffTrend=TRUE, 
                                                    printPlots=FALSE, 
                                                    returnData=TRUE, 
                                                    returnPlots=FALSE
                                                    )[["p2Full"]]
                   ) %>%
    bind_rows(.id="stateNum") %>%
    mutate(state=modStateList[as.integer(stateNum)])
modState

# Plot the results
modState %>%
    filter() %>%
    group_by(state, weekEnding, year) %>%
    summarize(across(where(is.numeric), sum), .groups="drop") %>%
    ggplot(aes(x=weekEnding)) + 
    geom_line(aes(y=deaths, color=year)) + 
    geom_line(aes(y=pred), lty=2) + 
    facet_wrap(~state, scales="free_y") + 
    labs(x=NULL, 
         y="Weekly all-cause deaths", 
         title="All-cause deaths per week by state", 
         subtitle="Dashed line is linear trend without seasonality using 2015-2019 data"
         ) + 
    lims(y=c(0, NA)) +
    scale_color_discrete("")

```

Plots of proportion of deaths by year are created:  
```{r, fig.height=9, fig.width=9}

modState %>%
    group_by(state, year, age) %>%
    summarize(across(where(is.numeric), sum), .groups="drop") %>%
    ggplot(aes(x=year, y=deaths)) + 
    geom_col(aes(fill=age), position="fill") + 
    facet_wrap(~state) + 
    labs(x=NULL, y="Proportion of deaths", title="Proportion of deaths by age group and state") + 
    scale_fill_discrete("") + 
    theme(axis.text.x = element_text(angle = 90))

modState %>%
    group_by(state, year, age) %>%
    summarize(across(where(is.numeric), sum), .groups="drop") %>%
    filter(year=="2020") %>%
    ggplot(aes(x=fct_reorder(state, deaths, sum))) +
    geom_col(aes(y=deaths/1000, fill=age), position="stack") + 
    geom_point(data=filter(readFromRDS("cdc_daily_210902")$dfPerCapita, date=="2020-12-13"), 
               aes(x=state, y=tot_deaths/1000)
               ) +
    labs(x=NULL, 
         y="2020 deaths (000)", 
         title="2020 deaths by age group and state", 
         subtitle="2020 reported coronavirus deaths are points, all-cause deaths are filled bars"
         ) + 
    scale_fill_discrete("") + 
    coord_flip()

```

Shares of total deaths by coronavirus are plotted on top of the age distribution:  
```{r, fig.height=9, fig.width=9}

p12020 <- modState %>%
    group_by(state, year, age) %>%
    summarize(across(where(is.numeric), sum), .groups="drop") %>%
    filter(year=="2020") %>% 
    inner_join(select(filter(readFromRDS("cdc_daily_210902")$dfPerCapita, date=="2020-12-31"), state, tot_deaths), 
               by="state"
               ) %>% 
    ggplot(aes(x=fct_reorder2(state, .x=tot_deaths, .y=deaths, .fun=function(x, y) -mean(x)/sum(y)))) +
    geom_col(aes(y=deaths/1000, fill=age), position="fill") + 
    geom_point(data=~summarize(group_by(., state), tot_deaths=mean(tot_deaths), deaths=sum(deaths), 
                               .groups="drop"
                               ), 
               aes(x=state, y=tot_deaths/deaths)
    ) +
    labs(x=NULL, 
         y="Proportion of 2020 deaths (000)", 
         title="2020 deaths by age group and state", 
         subtitle="2020 reported coronavirus deaths are points, all-cause 2020 deaths are filled bars"
    ) + 
    scale_fill_discrete("") + 
    coord_flip()
p12020

```

The plots are repeated for YTD July 2021:  
```{r, fig.height=9, fig.width=9}

p22021 <- modState %>%
    filter(weekEnding <= as.Date("2021-07-31")) %>%
    group_by(state, year, age) %>%
    summarize(across(where(is.numeric), sum), .groups="drop") %>%
    filter(year=="2021") %>% 
    inner_join(readFromRDS("cdc_daily_210902")$dfPerCapita %>%
                   filter(date %in% as.Date(c("2020-12-31", "2021-07-31"))) %>%
                   group_by(state) %>%
                   summarize(tot_deaths=max(tot_deaths)-min(tot_deaths)), 
               by="state"
               ) %>%
    ggplot(aes(x=fct_reorder2(state, .x=tot_deaths, .y=deaths, .fun=function(x, y) -mean(x)/sum(y)))) +
    geom_col(aes(y=deaths/1000, fill=age), position="fill") + 
    geom_point(data=~summarize(group_by(., state), tot_deaths=mean(tot_deaths), deaths=sum(deaths), 
                               .groups="drop"
                               ), 
               aes(x=state, y=tot_deaths/deaths)
    ) +
    labs(x=NULL, 
         y="Proportion of YTD July 2021 deaths (000)", 
         title="YTD July 2021 deaths by age group and state", 
         subtitle="2021 reported coronavirus deaths are points, all-cause 2021 deaths are filled bars"
    ) + 
    scale_fill_discrete("") + 
    coord_flip()
p22021

gridExtra::grid.arrange(p12020 + theme(legend.position="bottom") + geom_hline(yintercept=0.125, lty=2), 
                        p22021 + theme(legend.position="bottom") + geom_hline(yintercept=0.125, lty=2), 
                        nrow=1
                        )

```

The latest CDC all-cause death data are downloaded and processed:  
```{r, fig.height=9, fig.width=9, cache=TRUE}

cdcLoc <- "Weekly_counts_of_deaths_by_jurisdiction_and_age_group_downloaded_20211105.csv"
cdcList_20211105 <- readRunCDCAllCause(loc=cdcLoc, 
                                       weekThru=40, 
                                       lst=readFromRDS("cdc_daily_211104"), 
                                       stateNoCheck=c("NC"), 
                                       pdfCluster=TRUE, 
                                       pdfAge=TRUE
                                       )

```
  
All-cause deaths by year and state are plotted, with comparison to the 2015-2019 trendline:  
```{r, fig.height=9, fig.width=9}

# Grid of all valid combinations of weekEnding-state-age
validGrid <- expand.grid(weekEnding=sort(unique(cdcList_20211105$cdc$weekEnding)), 
                         state=c(state.abb, "DC"),
                         age=unique(cdcList_20211105$cdc$age), 
                         stringsAsFactors=FALSE, 
                         KEEP.OUT.ATTRS=FALSE
                         ) %>%
    tibble::as_tibble() %>%
    mutate(year=factor(lubridate::epiyear(weekEnding)))

# Check that there are no records missing from validGrid
cdcList_20211105$cdc %>%
    anti_join(validGrid, by=c("weekEnding", "state", "age", "year"))

# Modified data to insert 0 deaths for any missing data
cdcMod <- cdcList_20211105$cdc %>%
    select(state, age, weekEnding, year, deaths) %>%
    right_join(validGrid, by=c("weekEnding", "state", "age", "year")) %>%
    mutate(deaths=ifelse(is.na(deaths), 0, deaths))
cdcMod

# Create data for each state as before
modStateList <- sort(c(state.abb, "DC"))
modState <- lapply(modStateList, 
                   FUN=function(x) plotAgeWeekDeath(list("cdc"=cdcMod), 
                                                    keyStates=x,
                                                    diffTrend=TRUE, 
                                                    printPlots=FALSE, 
                                                    returnData=TRUE, 
                                                    returnPlots=FALSE
                                                    )[["p2Full"]]
                   ) %>%
    bind_rows(.id="stateNum") %>%
    mutate(state=modStateList[as.integer(stateNum)])
modState

# Plot the results
modState %>%
    filter() %>%
    group_by(state, weekEnding, year) %>%
    summarize(across(where(is.numeric), sum), .groups="drop") %>%
    ggplot(aes(x=weekEnding)) + 
    geom_line(aes(y=deaths, color=year)) + 
    geom_line(aes(y=pred), lty=2) + 
    facet_wrap(~state, scales="free_y") + 
    labs(x=NULL, 
         y="Weekly all-cause deaths", 
         title="All-cause deaths per week by state", 
         subtitle="Dashed line is linear trend without seasonality using 2015-2019 data"
         ) + 
    lims(y=c(0, NA)) +
    scale_color_discrete("")

```
  
All-cause deaths by age are also plotted:  
```{r, fig.height=9, fig.width=9}

plotAgeWeekDeath(cdcList_20211105, diffTrend=TRUE, printPlots=TRUE, returnData=FALSE, returnPlots=FALSE)

```
  
Deaths by location data are also updated and explored:    
```{r, fig.height=9, fig.width=9, cache=TRUE}

deathAgeLoc <- "./RInputFiles/Coronavirus/COvID_deaths_age_place_20211108.csv"
if (!file.exists(deathAgeLoc)) {
    fileDownload(fileName=deathAgeLoc, 
                 url="https://data.cdc.gov/api/views/4va6-ph5s/rows.csv?accessType=DOWNLOAD"
                 )
} else {
    cat("\nFile already exists, not downloading\n")
}

```
  
```{r, fig.height=9, fig.width=9}

deathAge_20211108_raw <- fileRead(deathAgeLoc, col_types="cccciiccccddddddc")
glimpse(deathAge_20211108_raw)

deathAge_20211108_conv <- deathAge_20211108_raw %>%
    colRenamer(vecRename=c("Data as of"="asofDate", 
                           "Start Date"="startDate", 
                           "End Date"="endDate", 
                           "HHS Region"="HHSRegion", 
                           "Place of Death"="deathPlace", 
                           "Age group"="Age", 
                           "COVID-19 Deaths"="covidDeaths", 
                           "Total Deaths"="totalDeaths", 
                           "Pneumonia Deaths"="pneumoDeaths", 
                           "Pneumonia and COVID-19 Deaths"="pneumoCovidDeaths", 
                           "Influenza Deaths"="fluDeaths", 
                           "Pneumonia, Influenza, or COVID-19 Deaths"="pnemoFluCovidDeaths"
                           )
               ) %>%
    colMutater(selfList=list("asofDate"=lubridate::mdy, "startDate"=lubridate::mdy, "endDate"=lubridate::mdy))
glimpse(deathAge_20211108_conv)

# Combinations of startDate and endDate
deathAge_20211108_conv %>%
    count(asofDate, startDate, endDate) %>%
    ggplot(aes(y=startDate, x=endDate)) + 
    geom_point(aes(size=n)) + 
    facet_wrap(~asofDate) + 
    labs(x="Ending Date", y="Starting Date", title="Combinations of Start and End Date")

deathAge_20211108_conv %>%
    count(Group, deathPlace, Age) %>%
    ggplot(aes(x=Group, y=deathPlace)) + 
    geom_tile(aes(fill=n)) + 
    facet_wrap(~Age) + 
    labs(x="Group", y="Place of Death", title="Combinations of Age, Place of Death, and Group")

deathState <- deathAge_20211108_conv %>%
    filter(Group=="By Total", deathPlace=="Total - All Places of Death", Age=="All Ages") %>%
    group_by(State) %>%
    summarize(across(where(is.numeric), sum, na.rm=TRUE)) %>%
    mutate(abb=state.abb[match(State, state.name)])
deathState %>% filter(is.na(abb))

deathBase <- deathState %>%
    select(State, covidDeaths, totalDeaths) %>%
    mutate(noncovid=covidDeaths/totalDeaths) %>%
    filter(!(State %in% c("United States", "Puerto Rico"))) %>%
    pivot_longer(-c(State)) %>%
    ggplot(aes(x=fct_reorder(State, value, max), y=value/1000)) + 
    coord_flip() + 
    theme(legend.position="bottom")
deathBase + 
    geom_col(data=~filter(., name=="totalDeaths"), aes(fill="All")) +
    geom_col(data=~filter(., name=="covidDeaths"), aes(fill="COVID")) + 
    scale_fill_manual("Type", breaks=c("COVID", "All"), labels=c("COVID", "All"), values=c("red", "black")) + 
    labs(title="Deaths 2020-present by state", x=NULL, y="Deaths (000s)")
deathBase + 
    geom_col(data=~filter(., name=="noncovid"), aes(y=value), position="identity") + 
    labs(x=NULL, y=NULL, title="Proportion of deaths from COVID")

# Add the state abbreviation
deathAge_20211108_conv <- deathAge_20211108_conv %>%
    mutate(abb=c(state.abb, "DC", "US")[match(State, c(state.name, "District of Columbia", "United States"))])

# Get a list of the possible variables
allCheckVars <- names(deathAge_20211108_conv) %>% 
    setdiff(deathAge_20211108_conv %>% head(1) %>% select_if(is.numeric) %>% names()) %>%
    setdiff(c("Footnote", "abb", "HHSRegion"))

# Test for each variable in allCheckVars
subMap <- c("State"="United States", "Age"="All Ages", "deathPlace"="Total - All Places of Death")
lapply(c("State", "deathPlace", "Age"), 
       FUN=function(x) deathAge_20211108_conv %>% 
           select(-Year, -Month) %>%
           checkSubTotals(checkByVars=allCheckVars %>% setdiff(x), subVar=x, subVarTotal=unname(subMap[x])) %>%
           checkNumbers(byVars=allCheckVars, keyVar=x)
       )

```
  
The above are converted to functional form:  
```{r, fig.height=9, fig.width=9}

processAllCauseLocation <- function(loc, 
                                    url="https://data.cdc.gov/api/views/4va6-ph5s/rows.csv?accessType=DOWNLOAD",
                                    col_types="cccciiccccddddddc",
                                    vecRename=c("Data as of"="asofDate", 
                                                "Start Date"="startDate", 
                                                "End Date"="endDate", 
                                                "HHS Region"="HHSRegion", 
                                                "Place of Death"="deathPlace", 
                                                "Age group"="Age", 
                                                "COVID-19 Deaths"="covidDeaths", 
                                                "Total Deaths"="totalDeaths", 
                                                "Pneumonia Deaths"="pneumoDeaths", 
                                                "Pneumonia and COVID-19 Deaths"="pneumoCovidDeaths", 
                                                "Influenza Deaths"="fluDeaths", 
                                                "Pneumonia, Influenza, or COVID-19 Deaths"="pnemoFluCovidDeaths"
                                                ),
                                    selfList=list("asofDate"=lubridate::mdy, 
                                                  "startDate"=lubridate::mdy, 
                                                  "endDate"=lubridate::mdy
                                                  ),
                                    dir="./RInputFiles/Coronavirus/",
                                    dlData=isFALSE(file.exists(paste0(dir, loc))), 
                                    allCheckVars=NULL, 
                                    subMap=c("State"="United States", 
                                             "Age"="All Ages", 
                                             "deathPlace"="Total - All Places of Death"
                                             ), 
                                    createPlot5=TRUE
                                    ) {
    
    # FUNCTION ARGUMENTS:
    # loc: the location of the CDC all-cause death by location file
    # url: the location of the all-cause death by location data
    # col_types: the column types for the data in loc
    # vecRename: vector for renaming columns in raw data
    # selfList: list for colMutater() for the data from loc
    # dir: the directory for the downloaded data in loc
    # dlData: boolean, should data be downloaded?
    # allCheckVars: variable list to be checked
    # subMap: subsets to be checked for summation to the whole
    # createPlot5: boolean, should comparisons of totals and sum of subtotals be created

    # Step 0: Download the data if requested
    if (dlData) fileDownload(fileName=paste0(dir, loc), url=url)
    
    # Step 1: Read the CSV data
    deathLoc_raw <- fileRead(paste0(dir, loc), col_types=col_types)
    
    # Step 2: Rename variables for easier interpretation, convert the dates, add the state abbreviation
    deathLoc_conv <- deathLoc_raw %>%
        colRenamer(vecRename=vecRename) %>%
        colMutater(selfList=selfList) %>%
        mutate(abb=c(state.abb, "DC", "US")[match(State, c(state.name, "District of Columbia", "United States"))])

    # Step 3: Plots for combinations included
    p1 <- deathLoc_conv %>%
        count(asofDate, startDate, endDate) %>%
        ggplot(aes(y=startDate, x=endDate)) + 
        geom_point(aes(size=n)) + 
        facet_wrap(~asofDate) + 
        labs(x="Ending Date", y="Starting Date", title="Combinations of Start and End Date")
    p2 <- deathLoc_conv %>%
        count(Group, deathPlace, Age) %>%
        ggplot(aes(x=Group, y=deathPlace)) + 
        geom_tile(aes(fill=n)) + 
        facet_wrap(~Age) + 
        labs(x="Group", y="Place of Death", title="Combinations of Age, Place of Death, and Group")
    gridExtra::grid.arrange(p1, p2, ncol=1)
    
    # Step 4: Deaths by state
    dfTemp <- deathLoc_conv %>%
        filter(Group=="By Total", deathPlace=="Total - All Places of Death", Age=="All Ages") %>%
        group_by(State, abb) %>%
        summarize(across(where(is.numeric), sum, na.rm=TRUE))
    cat("\nStates without abbreviations\n")
    print(dfTemp %>% filter(is.na(abb)))

    # Step 4a: Plots
    deathBase <- dfTemp %>%
        select(State, covidDeaths, totalDeaths) %>%
        mutate(noncovid=covidDeaths/totalDeaths) %>%
        filter(!(State %in% c("United States", "Puerto Rico"))) %>%
        pivot_longer(-c(State)) %>%
        ggplot(aes(x=fct_reorder(State, value, max), y=value/1000)) + 
        coord_flip() + 
        theme(legend.position="bottom")
    p3 <- deathBase + 
        geom_col(data=~filter(., name=="totalDeaths"), aes(fill="All")) +
        geom_col(data=~filter(., name=="covidDeaths"), aes(fill="COVID")) + 
        scale_fill_manual("Type", breaks=c("COVID", "All"), labels=c("COVID", "All"), values=c("red", "black")) + 
        labs(title="Deaths 2020-present by state", x=NULL, y="Deaths (000s)")
    p4 <- deathBase + 
        geom_col(data=~filter(., name=="noncovid"), aes(y=value), position="identity") + 
        labs(x=NULL, y=NULL, title="Proportion of deaths from COVID")
    gridExtra::grid.arrange(p3, p4, nrow=1)

    # Step 5: Check for alignment by variable combinations (run only if createPlot5 is TRUE)
    if(isTRUE(createPlot5)) {
        # Create allCheckVars if not passed
        if (is.null(allCheckVars)) {
            allCheckVars <- deathLoc_conv %>% 
                select(-where(is.numeric)) %>% 
                names %>% 
                setdiff(c("Footnote", "abb", "HHSRegion"))
        }
        # Run for the key subsets
        lapply(names(subMap), 
               FUN=function(x) deathLoc_conv %>% 
                   select(-Year, -Month) %>%
                   checkSubTotals(checkByVars=allCheckVars %>% setdiff(x), 
                                  subVar=x, 
                                  subVarTotal=unname(subMap[x])
                                  ) %>%
                   checkNumbers(byVars=allCheckVars, keyVar=x)
               )
    }
    
    # Return a list of the key datasets
    list(deathLoc_raw=deathLoc_raw, deathLoc_conv=deathLoc_conv)

}

# Test the function
testList_20211108 <- processAllCauseLocation("COvID_deaths_age_place_20211108.csv")
identical(deathAge_20211108_raw, testList_20211108$deathLoc_raw)
identical(deathAge_20211108_conv, testList_20211108$deathLoc_conv)

```

Deaths by state are compared between CDC files, using October 31, 2021 as the cutoff:  
```{r, fig.height=9, fig.width=9}

# Create summary by state and year-month
death_sum_20211108 <- testList_20211108$deathLoc_conv %>%
    filter(!is.na(Year), !is.na(Month), deathPlace=="Total - All Places of Death", Age=="All Ages") %>%
    mutate(ym=lubridate::ym(paste0(Year, "-", zeroPad2(Month)))) %>%
    select(State, abb, ym, where(is.numeric), -Year, -Month) %>%
    pivot_longer(-c(State, abb, ym)) %>%
    arrange(State, abb, name, ym) %>%
    group_by(State, abb, name) %>%
    mutate(cumValue=cumsum(ifelse(is.na(value), 0, value))) %>%
    ungroup() %>%
    mutate(date=lubridate::ceiling_date(ym, unit="month")-lubridate::days(1))

# Create summary from state-level file
death_daily_211104 <- readFromRDS("cdc_daily_211104")$dfPerCapita %>%
    select(date, abb=state, tot_deaths) %>%
    mutate(Year=lubridate::year(date), Month=lubridate::month(date)) %>%
    group_by(Year, Month) %>%
    filter(date==max(date)) %>%
    ungroup()
    
# Create a plot for evolution of United States
death_sum_20211108 %>%
    filter(abb=="US", name=="covidDeaths", ym <= "2021-10-31") %>%
    ggplot(aes(x=date)) + 
    geom_line(aes(y=cumValue/1000, color="blue"), size=2) + 
    geom_point(data=summarize(group_by(filter(death_daily_211104, date <= "2021-10-31"), date), 
                              tot_deaths=sum(tot_deaths, na.rm=TRUE)
                              ), 
               aes(y=tot_deaths/1000, color="green"), 
               size=3
               ) +
    labs(x="End of month", y="Cumulative Deaths (000)", title="Cumulative COVID Deaths (000) in US by source") + 
    scale_color_manual("Source", labels=c("Summed\nstates", "Summed\nsubtotals"), values=c("green", "blue"))

# Comparison of totals by state
plot_cum1021 <- death_sum_20211108 %>%
    filter(abb %in% c(state.abb, "DC"), name=="covidDeaths", date == "2021-10-31") %>%
    select(abb, cumValue) %>%
    inner_join(select(filter(death_daily_211104, date == "2021-10-31"), abb, tot_deaths), by=c("abb")) %>%
    mutate(pctdiff=abs(tot_deaths-cumValue)/(tot_deaths+cumValue))
plot_cum1021 %>%
    arrange(-pctdiff)
plot_cum1021 %>%
    summarize(across(where(is.numeric), sum))
plot_cum1021 %>%
    ggplot(aes(x=fct_reorder(abb, cumValue))) + 
    geom_col(aes(y=cumValue/1000), fill="lightblue") + 
    geom_point(aes(y=tot_deaths/1000), size=3) +
    coord_flip() +
    labs(x=NULL, 
         y="Cumulative Deaths (000)", 
         title="Cumulative COVID Deaths (000) in US as of 2021-10-31", 
         subtitle="Filled bars are summed subtotals, points are from CDC daily"
         )

```
  
Breakdowns of deaths by age and place are also explored:  
```{r, fig.height=9, fig.width=9}

deathAllData <- testList_20211108$deathLoc_conv %>%
    filter(deathPlace=="Total - All Places of Death")
deathAllData

# Proportions of death by age and cause
deathAllData %>%
    filter(State=="United States", Age != "All Ages", Group=="By Total") %>%
    select(Age, where(is.numeric), -Year, -Month) %>%
    pivot_longer(-Age) %>%
    ggplot() + 
    geom_col(aes(x=name, y=value, fill=fct_rev(Age)), position="fill") + 
    labs(x=NULL, y="Proportion of Deaths", title="Proportion of deaths by cause (2020-October 2021)") + 
    scale_fill_discrete("Age")

# Proportions of death by age and month
deathAllData %>%
    filter(State=="United States", Age != "All Ages", Group=="By Month") %>%
    mutate(ym=lubridate::ym(paste0(Year, "-", zeroPad2(Month)))) %>%
    select(Age, ym, totalDeaths, covidDeaths, fluDeaths) %>%
    pivot_longer(-c(Age, ym)) %>%
    ggplot() + 
    geom_col(aes(x=ym, y=value, fill=fct_rev(Age)), position="fill") + 
    facet_wrap(~name) +
    labs(x=NULL, y="Proportion of Deaths", title="Proportion of deaths by age and cause (2020-October 2021)") + 
    scale_fill_discrete("Age")

# Total death by age and month
deathAllData %>%
    filter(State=="United States", Age != "All Ages", Group=="By Month") %>%
    mutate(ym=lubridate::ym(paste0(Year, "-", zeroPad2(Month)))) %>%
    select(Age, ym, totalDeaths, covidDeaths, fluDeaths) %>%
    pivot_longer(-c(Age, ym)) %>%
    filter(ym <= "2021-09-30") %>%
    ggplot() + 
    geom_line(aes(x=ym, y=value, color=fct_rev(Age), group=Age)) + 
    facet_wrap(~name, scales="free_y") +
    labs(x=NULL, y="Proportion of Deaths", title="Deaths by age and cause (2020-September 2021)") + 
    scale_color_discrete("Age")

deathPlaceData <- testList_20211108$deathLoc_conv %>%
    filter(Age == "All Ages")
deathPlaceData

# Proportions of death by place and cause
deathPlaceData %>%
    filter(State=="United States", deathPlace!="Total - All Places of Death", Group=="By Total") %>%
    select(deathPlace, where(is.numeric), -Year, -Month) %>%
    pivot_longer(-deathPlace) %>%
    ggplot() + 
    coord_flip() +
    geom_col(aes(x=name, y=value, fill=fct_rev(deathPlace)), position="fill") + 
    labs(x=NULL, y="Proportion of Deaths", title="Proportion of deaths by place (2020-October 2021)") + 
    scale_fill_discrete("Death\nPlace") + 
    theme(legend.position="bottom")

# Proportions of death by place and month
deathPlaceData %>%
    filter(State=="United States", deathPlace!="Total - All Places of Death", Group=="By Month") %>%
    mutate(ym=lubridate::ym(paste0(Year, "-", zeroPad2(Month)))) %>%
    select(deathPlace, ym, totalDeaths, covidDeaths, fluDeaths) %>%
    pivot_longer(-c(deathPlace, ym)) %>%
    ggplot() + 
    geom_col(aes(x=ym, y=value, fill=fct_rev(deathPlace)), position="fill") + 
    facet_wrap(~name) +
    labs(x=NULL, y="Proportion of Deaths", title="Proportion of deaths by place and cause (2020-October 2021)") + 
    scale_fill_discrete("Death\nPlace") + 
    theme(legend.position="bottom")

# Total death by place and month
deathPlaceData %>%
    filter(State=="United States", deathPlace!="Total - All Places of Death", Group=="By Month") %>%
    mutate(ym=lubridate::ym(paste0(Year, "-", zeroPad2(Month)))) %>%
    select(deathPlace, ym, totalDeaths, covidDeaths, fluDeaths) %>%
    pivot_longer(-c(deathPlace, ym)) %>%
    filter(ym <= "2021-09-30") %>%
    ggplot() + 
    geom_line(aes(x=ym, y=value, color=fct_rev(deathPlace), group=deathPlace)) + 
    facet_wrap(~name, scales="free_y") +
    labs(x=NULL, y="Proportion of Deaths", title="Deaths by place and cause (2020-September 2021)") + 
    scale_color_discrete("Death\nPlace")

```
  
Exploration of the place of death for COVID and non-COVID deaths is explored:  
```{r, fig.height=9, fig.width=9}

# Locations of death by age
tempPlotData <- testList_20211108$deathLoc_conv %>%
    mutate(nonCovidDeaths=zeroNA(totalDeaths)-zeroNA(covidDeaths)) %>%
    select(Group, startDate, endDate, State, deathPlace, Age, where(is.numeric), -Month, -Year) %>%
    pivot_longer(where(is.numeric))

# Basic plotting data
p1 <- tempPlotData %>%
    filter(name %in% c("covidDeaths", "nonCovidDeaths"), 
           State=="United States", 
           Group=="By Total"
           ) %>%
    ggplot(aes(x=Age, y=value/1000)) + 
    coord_flip() + 
    scale_fill_discrete("") +
    theme(legend.position="bottom") +
    labs(x=NULL, y="Deaths (000)", title="United States deaths (2020 thru October 2021)")

# Overall deaths by age and type
p1a <- p1 + 
    geom_col(data=~filter(., deathPlace=="Total - All Places of Death", Age !="All Ages"), 
             aes(fill=name), 
             position="stack"
             )

# Proportion deaths by age and type
p1b <- p1 + 
    geom_col(data=~filter(., deathPlace=="Total - All Places of Death"), 
             aes(fill=fct_rev(name)), 
             position="fill"
             ) + 
    labs(y="Proportion of deaths")

gridExtra::grid.arrange(p1a, p1b, nrow=1)

# Overall deaths by age and type and location
p1 + 
    geom_col(data=~filter(., deathPlace!="Total - All Places of Death", Age != "All Ages"), 
             aes(fill=name), 
             position="stack"
             ) + 
    facet_wrap(~deathPlace)

# Proportion of deaths by age and type and location
p1 + 
    geom_col(data=~filter(., Age !="All Ages"), 
             aes(fill=fct_rev(name)), 
             position="fill"
             ) + 
    facet_wrap(~deathPlace) + 
    labs(y="Proportion of deaths") + 
    geom_hline(yintercept=0.25, lty=2)

```

The evolution by month is also explored:  
```{r, fig.height=9, fig.width=9}

# Basic plotting data
p2 <- tempPlotData %>%
    filter(name %in% c("covidDeaths", "nonCovidDeaths"), 
           State=="United States", 
           Group=="By Month", 
           endDate <= "2021-10-31"
           ) %>%
    ggplot(aes(x=fct_reorder(deathPlace, value, max), y=value/1000)) + 
    coord_flip() + 
    scale_fill_discrete("") +
    theme(legend.position="bottom") +
    labs(x=NULL, y="Deaths (000)", title="United States deaths (2020 thru October 2021)")

# Overall deaths by month and place
p2 + 
    geom_col(data=~filter(., deathPlace!="Total - All Places of Death", Age =="All Ages"), 
             aes(fill=name), 
             position="stack"
             ) + 
    facet_wrap(~endDate, nrow=3)

# Proportion of deaths by month and place
p2 + 
    geom_col(data=~filter(., deathPlace!="Total - All Places of Death", Age =="All Ages"), 
             aes(fill=name), 
             position="fill"
             ) + 
    facet_wrap(~endDate, nrow=3) + 
    labs(y="Proportion of deaths")

# Overall deaths by month and age
p2 + 
    geom_col(data=~filter(., deathPlace=="Total - All Places of Death", Age !="All Ages"), 
             aes(x=Age, fill=name), 
             position="stack"
             ) + 
    facet_wrap(~endDate, nrow=3)

# Proportion of deaths by month and age
p2 + 
    geom_col(data=~filter(., deathPlace=="Total - All Places of Death", Age !="All Ages"), 
             aes(x=Age, fill=name), 
             position="fill"
             ) + 
    facet_wrap(~endDate, nrow=3) + 
    labs(y="Proportion of deaths")

```

There are clear patterns in COVID deaths by each of age, month, and place, with proportions evolving over time.

The functional form is used for comparing deaths by state between CDC files:  
```{r, fig.height=9, fig.width=9}

compareCDCDeaths <- function(lstLoc,
                             lstState,
                             thruDate,
                             keyDeathPlaces=c("Total - All Places of Death"),
                             keyAges=c("All Ages"), 
                             returnData=FALSE
                             ) {

    # FUNCTION ARGUMENTS
    # lstLoc: list containing the processed death-location data, with sub-list "deathLoc_conv"
    # lstState: list containing processed CDC COVID death data by state, with sub-list "dfPerCapita"
    # thruDate: character, formatted as YYYY-MM-DD
    # keyDeathPlaces: places of death to include from lstLoc
    # keyAges: ages to include from lstLoc
    # returnData: boolean, should data be returned?
    
    # Create summary by state and year-month
    death_sum <- lstLoc[["deathLoc_conv"]] %>%
        filter(!is.na(Year), 
               !is.na(Month), 
               deathPlace %in% all_of(keyDeathPlaces), 
               Age %in% all_of(keyAges)
               ) %>%
        mutate(ym=lubridate::ym(paste0(Year, "-", zeroPad2(Month)))) %>%
        select(State, abb, ym, where(is.numeric), -Year, -Month) %>%
        pivot_longer(-c(State, abb, ym)) %>%
        arrange(State, abb, name, ym) %>%
        group_by(State, abb, name) %>%
        mutate(cumValue=cumsum(ifelse(is.na(value), 0, value))) %>%
        ungroup() %>%
        mutate(date=lubridate::ceiling_date(ym, unit="month")-lubridate::days(1))

    # Create summary from state-level file
    death_daily <- lstState[["dfPerCapita"]] %>%
        select(date, abb=state, tot_deaths) %>%
        mutate(Year=lubridate::year(date), Month=lubridate::month(date)) %>%
        group_by(Year, Month) %>%
        filter(date==max(date)) %>%
        ungroup()
    
    # Create a plot for evolution of United States
    p1 <- death_sum %>%
        filter(abb=="US", name=="covidDeaths", ym <= thruDate) %>%
        ggplot(aes(x=date)) + 
        geom_line(aes(y=cumValue/1000, color="blue"), size=2) + 
        geom_point(data=summarize(group_by(filter(death_daily, date <= thruDate), date), 
                                  tot_deaths=sum(tot_deaths, na.rm=TRUE)
                                  ), 
                   aes(y=tot_deaths/1000, color="green"), 
                   size=3
                   ) +
        labs(x="End of month", 
             y="Cumulative COVID Deaths (000)", 
             title="Cumulative COVID Deaths (000) in US by source"
             ) + 
        scale_color_manual("Source", 
                           labels=c("Summed\nCDC Location", "Summed\nCDC Daily"), 
                           values=c("green", "blue")
                           )
    print(p1)

    # Comparison of totals by state
    plot_cum <- death_sum %>%
        filter(abb %in% c(state.abb, "DC"), 
               name=="covidDeaths", 
               date == thruDate
               ) %>%
        select(abb, cumValue) %>%
        inner_join(select(filter(death_daily, date == thruDate), abb, tot_deaths), by=c("abb")) %>%
        mutate(pctdiff=abs(tot_deaths-cumValue)/(tot_deaths+cumValue))
    plot_cum %>%
        arrange(-pctdiff) %>%
        print()
    plot_cum %>%
        summarize(across(where(is.numeric), sum)) %>%
        print()
    p2 <- plot_cum %>%
        ggplot(aes(x=fct_reorder(abb, cumValue))) + 
        geom_col(aes(y=cumValue/1000), fill="lightblue") + 
        geom_point(aes(y=tot_deaths/1000), size=3) +
        coord_flip() +
        labs(x=NULL, 
             y="Cumulative Deaths (000)", 
             title=paste0("Cumulative COVID Deaths (000) in US as of ", thruDate), 
             subtitle="Filled bars are summed CDC location, points are from CDC daily"
             )
    print(p2)

    if(isTRUE(returnData)) return(plot_cum)
    
}

compareCDCDeaths(lstLoc=testList_20211108, lstState=readFromRDS("cdc_daily_211104"), thruDate="2021-10-31")

```
  
A function for breakdowns of deaths by age and place are also explored:  
```{r, fig.height=9, fig.width=9}

plotDeathDetails <- function(lst, 
                             keyVar,
                             timeLabel,
                             dfFilter=list(), 
                             p1Include=list("State"="United States", "Group"="By Total"),
                             p1Exclude=list("Age"="All Ages"),
                             p2Include=list("State"="United States", "Group"="By Month"),
                             p2Exclude=p1Exclude,
                             p3Include=p2Include,
                             p3Exclude=p2Exclude,
                             p2PlotVars=c("totalDeaths", "covidDeaths", "fluDeaths"),
                             p3PlotVars=p2PlotVars,
                             legendLabel=keyVar,
                             legendPosition=NULL,
                             returnData=FALSE
                             ) {

    # FUNCTION ARGUMENTS:
    # lst: a processed list file with sub-list "deathLoc_conv"
    # keyVar: the key variable being explored (e.g., "Age" or "deathPlace")
    # timeLabel: the label for the plot timing (e.g., "2020-October 2021")
    # dfFilter: a list of format list("variable"=c("allowed values")) for filtering data to produce df
    # p1Include: a list of format list("variable"=c("allowed values")) for filtering data to produce plot 1
    # p1Exclude: a list of format list("variable"=c("disallowed values")) for filtering data to produce plot 1
    # p2Include: a list of format list("variable"=c("allowed values")) for filtering data to produce plot 2
    # p2Exclude: a list of format list("variable"=c("disallowed values")) for filtering data to produce plot 2
    # p3Include: a list of format list("variable"=c("allowed values")) for filtering data to produce plot 3
    # p3Exclude: a list of format list("variable"=c("disallowed values")) for filtering data to produce plot 3
    # p2PlotVars: variables to include in the second plot
    # p3PlotVars: variables to include in the third plot
    # legendLabel: label to be used for the legend
    # legendPosition: the position for the legend (NULL means leave defaults)
    # returnData: boolean, should the data be returned?

    # Create the data for processing
    df <- lst[["deathLoc_conv"]] %>%
        rowFilter(lstFilter=dfFilter)
    
    # Create the first plot
    p1 <- df %>%
        rowFilter(lstFilter=p1Include, lstExclude=p1Exclude) %>%
        select(all_of(keyVar), where(is.numeric), -Year, -Month) %>%
        pivot_longer(!all_of(keyVar)) %>%
        ggplot() + 
        geom_col(aes(x=name, y=value, fill=fct_rev(get(keyVar))), position="fill") + 
        labs(x=NULL, 
             y="Proportion of Deaths", 
             title=paste0("Proportion of deaths (", timeLabel, ")")
             ) + 
        scale_fill_discrete(legendLabel)
    if(!is.null(legendPosition)) p1 <- p1 + theme(legend.position=legendPosition)
    print(p1)

    # Create the second plot
    p2 <- df %>%
        rowFilter(lstFilter=p2Include, lstExclude=p2Exclude) %>%
        mutate(ym=lubridate::ym(paste0(Year, "-", zeroPad2(Month)))) %>%
        select(all_of(keyVar), ym, all_of(p2PlotVars)) %>%
        pivot_longer(!c(all_of(keyVar), ym)) %>%
        ggplot() + 
        geom_col(aes(x=ym, y=value, fill=fct_rev(get(keyVar))), position="fill") + 
        facet_wrap(~name) +
        labs(x=NULL, 
             y="Proportion of Deaths", 
             title=paste0("Proportion of deaths (", timeLabel, ")")
             ) + 
        scale_fill_discrete(legendLabel)
    if(!is.null(legendPosition)) p2 <- p2 + theme(legend.position=legendPosition)
    print(p2)
    
    # Create the third plot
    p3 <- df %>%
        rowFilter(lstFilter=p2Include, lstExclude=p2Exclude) %>%
        mutate(ym=lubridate::ym(paste0(Year, "-", zeroPad2(Month)))) %>%
        select(all_of(keyVar), ym, all_of(p3PlotVars)) %>%
        pivot_longer(!c(all_of(keyVar), ym)) %>%
        ggplot() + 
        geom_line(aes(x=ym, y=value, color=fct_rev(get(keyVar)), group=get(keyVar))) + 
        facet_wrap(~name, scales="free_y") +
        labs(x=NULL, 
             y="Deaths", 
             title=paste0("Deaths (", timeLabel, ")")
             ) + 
        scale_color_discrete(legendLabel)
    if(!is.null(legendPosition)) p3 <- p3 + theme(legend.position=legendPosition)
    print(p3)

    # Return the data file if requested
    if(isTRUE(returnData)) return(df)
    
}

# Plots by age cohort
plotDeathDetails(testList_20211108, 
                 keyVar="Age",
                 timeLabel="2020-October 2021",
                 dfFilter=list("deathPlace"="Total - All Places of Death"), 
                 returnData=TRUE
                 )

# Plots by place of death cohort
plotDeathDetails(testList_20211108, 
                 keyVar="deathPlace",
                 timeLabel="2020-October 2021",
                 dfFilter=list("Age"="All Ages"), 
                 p1Exclude=list("deathPlace"="Total - All Places of Death"),
                 legendLabel="Death\nPlace",
                 legendPosition="bottom",
                 returnData=TRUE
                 )

```
  
A function for exploring the place of death for COVID and non-COVID deaths is created:  
```{r, fig.height=9, fig.width=9}

exploreDeathPlace <- function(lst, 
                              timeLabel,
                              endMonth,
                              returnData=FALSE
                              ) {

    # FUNCTION ARGUMENTS:
    # lst: a processed list file with sub-list "deathLoc_conv"
    # timeLabel: the label for the plot timing (e.g., "2020-October 2021")
    # endMonth: the last day of the final month to include in the monthly plots, formatted as "YYYY-MM-DD"
    # returnData: boolean, should df be returned?
    
    # Locations of death by age
    df <- lst[["deathLoc_conv"]] %>%
        mutate(nonCovidDeaths=zeroNA(totalDeaths)-zeroNA(covidDeaths)) %>%
        select(Group, startDate, endDate, State, deathPlace, Age, where(is.numeric), -Month, -Year) %>%
        pivot_longer(where(is.numeric))

    # Basic plotting data
    p1 <- df %>%
        filter(name %in% c("covidDeaths", "nonCovidDeaths"), 
               State=="United States", 
               Group=="By Total"
               ) %>%
        ggplot(aes(x=Age, y=value/1000)) + 
        coord_flip() + 
        scale_fill_discrete("") +
        theme(legend.position="bottom") +
        labs(x=NULL, 
             y="Deaths (000)", 
             title=paste0("United States deaths (", timeLabel, ")")
             )

    # Overall deaths by age and type
    p1a <- p1 + 
        geom_col(data=~filter(., deathPlace=="Total - All Places of Death", Age !="All Ages"), 
                 aes(fill=name), 
                 position="stack"
                 )

    # Proportion deaths by age and type
    p1b <- p1 + 
        geom_col(data=~filter(., deathPlace=="Total - All Places of Death"), 
                 aes(fill=fct_rev(name)), 
                 position="fill"
                 ) + 
        labs(y="Proportion of deaths")

    gridExtra::grid.arrange(p1a, p1b, nrow=1)

    # Overall deaths by age and type and location
    p1c <- p1 + 
        geom_col(data=~filter(., deathPlace!="Total - All Places of Death", Age != "All Ages"), 
                 aes(fill=name), 
                 position="stack"
                 ) + 
        facet_wrap(~deathPlace)

    # Proportion of deaths by age and type and location
    p1d <- p1 + 
        geom_col(data=~filter(., Age !="All Ages"), 
                 aes(fill=fct_rev(name)), 
                 position="fill"
                 ) + 
        facet_wrap(~deathPlace) + 
        labs(y="Proportion of deaths") + 
        geom_hline(yintercept=0.25, lty=2)
    
    gridExtra::grid.arrange(p1c, p1d, nrow=1)

    
    # Basic plotting data by month (not pivoted)
    p2 <- df %>%
        filter(name %in% c("covidDeaths", "nonCovidDeaths"), 
               State=="United States", 
               Group=="By Month", 
               endDate <= endMonth
               ) %>%
        ggplot(aes(x=fct_reorder(deathPlace, value, max), y=value/1000)) + 
        scale_color_discrete("") +
        theme(legend.position="bottom") +
        labs(x=NULL, 
             y="Deaths (000)", 
             title=paste0("United States deaths (", timeLabel, ")")
             )
        
    # Basic plotting data by month (percent deaths from coVID)
    p3 <- df %>%
        filter(name %in% c("covidDeaths", "totalDeaths"), 
               State=="United States", 
               Group=="By Month", 
               endDate <= endMonth
               ) %>%
        pivot_wider(names_from="name", values_from="value") %>% 
        mutate(pctCov=covidDeaths/totalDeaths)

    # Overall deaths by month and place
    p2a <- p2 +
        geom_line(data=~filter(., deathPlace!="Total - All Places of Death", Age =="All Ages"), 
                  aes(x=endDate, group=name, color=name)
                  ) + 
        facet_wrap(~deathPlace[deathPlace!="Total - All Places of Death"], ncol=1)

    # Proportion of deaths by month and place
    p3a <- p3 %>%
        filter(deathPlace!="Total - All Places of Death", Age =="All Ages") %>%
        ggplot(aes(x=endDate, y=pctCov)) + 
        labs(x=NULL, 
             y="Proportion of deaths from COVID",
             title=paste0("United States deaths (", timeLabel, ")")
             ) +
        geom_col(fill="lightblue") + 
        geom_text(aes(label=paste0(round(100*pctCov), "%")), 
                  vjust=0, 
                  size=3
                  ) + 
        facet_wrap(~deathPlace, ncol=1) + 
        lims(y=c(0, 1))
    
    gridExtra::grid.arrange(p2a, p3a, nrow=1)
    
    # Overall deaths by month and age
    p2b <- p2 + 
        geom_line(data=~filter(., deathPlace=="Total - All Places of Death", Age !="All Ages"), 
                  aes(x=endDate, group=name, color=name)
                  ) + 
        facet_wrap(~Age[Age!="All Ages"], ncol=1)
    
    # Proportion of deaths by month and age
    p3b <- p3 %>%
        filter(deathPlace=="Total - All Places of Death", Age !="All Ages") %>%
        ggplot(aes(x=endDate, y=pctCov)) +
        labs(x=NULL, 
             y="Proportion of deaths from COVID",
             title=paste0("United States deaths (", timeLabel, ")")
             ) +
        geom_col(fill="lightblue") + 
        geom_text(aes(label=paste0(round(100*pctCov), "%")), 
                  vjust=0, 
                  size=3
                  ) + 
        facet_wrap(~Age, ncol=1) + 
        lims(y=c(0, 1))
    
    gridExtra::grid.arrange(p2b, p3b, nrow=1)
    
    # Return the processed data frame, if requested
    if(isTRUE(returnData)) return(df)
    
}

exploreDeathPlace(testList_20211108, 
                  timeLabel="2020-October 2021",
                  endMonth="2021-10-31",
                  returnData=TRUE
                  )

```
  
The functions can be integrated:  
```{r, fig.height=9, fig.width=9}

# Load and process all-cause deaths data
testList_20211108 <- processAllCauseLocation("COvID_deaths_age_place_20211108.csv")

# Compare all-cause deaths data between files
deathDelta_20211031 <- compareCDCDeaths(lstLoc=testList_20211108, 
                                        lstState=readFromRDS("cdc_daily_211104"), 
                                        thruDate="2021-10-31", 
                                        returnData=TRUE
                                        )

# Plots by age cohort
deathAge_20211031 <- plotDeathDetails(testList_20211108, 
                                      keyVar="Age",
                                      timeLabel="2020-October 2021",
                                      dfFilter=list("deathPlace"="Total - All Places of Death"), 
                                      returnData=TRUE
                                      )

# Plots by place of death cohort
deathPlace_20211031 <- plotDeathDetails(testList_20211108, 
                                        keyVar="deathPlace",
                                        timeLabel="2020-October 2021",
                                        dfFilter=list("Age"="All Ages"), 
                                        p1Exclude=list("deathPlace"="Total - All Places of Death"),
                                        legendLabel="Death\nPlace",
                                        legendPosition="bottom",
                                        returnData=TRUE
                                        )

exploreDeathPlace(testList_20211108, 
                  timeLabel="2020-October 2021",
                  endMonth="2021-10-31",
                  returnData=FALSE
                  )

```

The process is converted to functional form:  
```{r, fig.height=9, fig.width=9}

analyzeAllCause <- function(loc, 
                            cdcDailyList,
                            compareThruDate,
                            plotTitleTime=paste0("2020 through ", compareThruDate),
                            endMonth=NULL,
                            dlData=!file.exists(loc)
                            ) {
    
    # FUNCTION ARGUMENTS:
    # loc: the location where detailed death data is stored (or should be downloaded to)
    #      will have ./RInputFiles/Coronavirus pre-pended to it
    # cdcDailyList: list file containing processed CDC Daily files
    # compareThruDate: date for comparisons of deaths between files
    # plotTitleTime: text to be included in plot title to describe timing
    # endMonth: ending month to be used for COVID vs non-COVID plots (NULL means infer from compareThruDate)
    # dlData: boolean, should the data be downloaded?
    
    # STEP 1: find ending month if passed as NULL
    if(is.null(endMonth)) {
        endMonth <- lubridate::floor_date(as.Date(compareThruDate)+lubridate::days(1), unit="month")
        endMonth <- endMonth - lubridate::days(1)
    }
    
    # STEP 2: Load and process all-cause deaths data
    allCauseList <- processAllCauseLocation(loc)

    # STEP 3: Compare all-cause deaths between file
    deathDelta <- compareCDCDeaths(lstLoc=allCauseList, 
                                   lstState=cdcDailyList, 
                                   thruDate=compareThruDate, 
                                   returnData=TRUE
                                   )

    # STEP 4: Plots by age cohort
    deathAge <- plotDeathDetails(allCauseList, 
                                 keyVar="Age",
                                 timeLabel=plotTitleTime,
                                 dfFilter=list("deathPlace"="Total - All Places of Death"), 
                                 returnData=TRUE
                                 )
    
    # STEP 5: Plots by place of death cohort
    deathPlace <- plotDeathDetails(allCauseList, 
                                   keyVar="deathPlace",
                                   timeLabel=plotTitleTime,
                                   dfFilter=list("Age"="All Ages"), 
                                   p1Exclude=list("deathPlace"="Total - All Places of Death"),
                                   legendLabel="Death\nPlace",
                                   legendPosition="bottom",
                                   returnData=TRUE
                                   )
    
    # STEP 6: Additional plots for COVID vs non-COVID
    exploreDeathPlace(allCauseList, 
                      timeLabel=plotTitleTime,
                      endMonth=endMonth,
                      returnData=FALSE
                      )
    
    # STEP 7: Return list
    list(allCauseList=allCauseList, 
         deathDelta=deathDelta, 
         deathAge=deathAge, 
         deathPlace=deathPlace, 
         compareThruDate=compareThruDate, 
         endMonth=endMonth
         )
    
}

allCauseTest <- analyzeAllCause(loc="COvID_deaths_age_place_20211108.csv", 
                                cdcDailyList=readFromRDS("cdc_daily_211104"), 
                                compareThruDate="2021-10-31"
                                )

```
  
Deaths by year are compared between data sources:  
```{r, fig.height=9, fig.width=9}

df1 <- cdcList_20211105$cdc %>%
    mutate(Year=as.integer(as.character(year))) %>%
    group_by(Year) %>% 
    summarize(deaths=sum(deaths))

df2 <- allCauseTest$allCauseList$deathLoc_conv %>% 
    filter(Group=="By Year", State=="United States", Age=="All Ages", deathPlace=="Total - All Places of Death") %>%
    select(Year, totalDeaths)

df1 %>%
    left_join(df2, by="Year") %>%
    ggplot(aes(x=Year)) + 
    geom_col(aes(y=totalDeaths/1000000), fill="lightblue") +
    geom_line(aes(y=deaths/1000000), color="red") + 
    geom_text(aes(y=deaths/1000000 + 0.05, label=round(deaths/1000000, 2)), color="red", vjust=0) +
    geom_text(aes(y=totalDeaths/2000000, label=round(totalDeaths/1000000, 2)), color="black", vjust=0) +
    lims(y=c(0, NA)) + 
    labs(x=NULL, 
         y="Total Deaths (millions)", 
         title="Total US deaths by year and data source (millions)", 
         subtitle="2021 total is thru October 2021\nLine is CDC all-cause, bars are summed CDC death-place"
         )

```
  
The CDC all-cause deaths are converted to monthly, assuming that days by week can be divided by 7 to create deaths by day:  
```{r, fig.height=9, fig.width=9}

df3 <- cdcList_20211105$cdc %>%
    group_by(weekEnding) %>%
    summarize(deathsPerDay=sum(deaths)/7)

df4 <- allCauseTest$allCauseList$deathLoc_conv %>% 
    filter(Group=="By Month", State=="United States", Age=="All Ages", deathPlace=="Total - All Places of Death") %>%
    select(Year, Month, totalDeaths) %>%
    mutate(date=as.Date(paste0(Year, "-", Month, "-1")))

map_dfr(.x=0:6, .f=function(x) mutate(df3, day=weekEnding-lubridate::days(x))) %>%
    mutate(ym=customYYYYMM(day)) %>%
    group_by(ym) %>%
    summarize(deaths=sum(deathsPerDay)) %>%
    mutate(date=as.Date(paste0(ym, "-01"))) %>%
    ggplot(aes(x=date)) + 
    geom_line(aes(y=deaths/1000)) + 
    geom_line(data=df4, aes(y=totalDeaths/1000), color="red", linetype="dashed") +
    lims(y=c(0, NA)) + 
    labs(x=NULL, 
         y="US Monthly Deaths (000)", 
         title="Comparison of US Monthly Deaths (000) by CDC data source", 
         subtitle="Solid black line is all-cause (2015-2021)\nDashed red line is summed age-place (2020-2021)"
         )

```
  
The data appear to be largely internally consistent at the US national level. Trends are assessed using only the non-COVID data:  
```{r, fig.height=9, fig.width=9}

df4 <- allCauseTest$allCauseList$deathLoc_conv %>% 
    filter(Group=="By Month", State=="United States", Age=="All Ages", deathPlace=="Total - All Places of Death") %>%
    select(Year, Month, totalDeaths, covidDeaths) %>%
    mutate(date=as.Date(paste0(Year, "-", Month, "-1")), nonCovidDeaths=totalDeaths-covidDeaths)

map_dfr(.x=0:6, .f=function(x) mutate(df3, day=weekEnding-lubridate::days(x))) %>%
    mutate(ym=customYYYYMM(day)) %>%
    group_by(ym) %>%
    summarize(deaths=sum(deathsPerDay)) %>%
    mutate(date=as.Date(paste0(ym, "-01"))) %>%
    filter(date <= "2021-09-30") %>%
    ggplot(aes(x=date)) + 
    geom_line(aes(y=deaths/1000)) + 
    geom_line(data=filter(df4, date <= "2021-09-30"), 
              aes(y=nonCovidDeaths/1000), 
              color="red", 
              linetype="dashed"
              ) +
    lims(y=c(0, NA)) + 
    labs(x=NULL, 
         y="US Monthly Deaths (000)", 
         title="Comparison of US Monthly Deaths (000) and non-COVID Deaths (000)", 
         subtitle="Solid black line is all-cause (2015-2021)\nDashed red line is summed age-place non-COVID (2020-2021)"
         )

```

A more integrated plot is produced:  
```{r, fig.height=9, fig.width=9}

dfTest <- map_dfr(.x=0:6, .f=function(x) mutate(df3, day=weekEnding-lubridate::days(x))) %>%
    mutate(ym=customYYYYMM(day)) %>%
    group_by(ym) %>%
    summarize(deaths=sum(deathsPerDay)) %>%
    mutate(date=as.Date(paste0(ym, "-01"))) %>%
    filter(date <= "2021-09-30") %>% 
    mutate(year=lubridate::year(date), month=factor(month.abb[lubridate::month(date)], levels=month.abb))

lmTest <- lm(deaths ~ year + month, data=filter(dfTest, date <= "2019-12-31"))

mapColor <- c("Actual\nall-cause"="red", "Actual\nnon-COVID"="black", "Trend from\n2015-2019"="red")
mapLineType <- c("Actual\nall-cause"="solid", "Actual\nnon-COVID"="solid", "Trend from\n2015-2019"="dotted")
mapSize <- c("Actual\nall-cause"=1.5, "Actual\nnon-COVID"=0.5, "Trend from\n2015-2019"=1)

dfTest %>% 
    mutate(pred=predict(lmTest, newdata=.)) %>% 
    ggplot(aes(x=date)) + 
    geom_line(aes(y=deaths/1000, 
                  color="Actual\nall-cause", 
                  linetype="Actual\nall-cause", 
                  size="Actual\nall-cause"
                  )
              ) + 
    geom_line(data=filter(df4, date <= "2021-09-30"), 
              aes(y=nonCovidDeaths/1000, 
                  color="Actual\nnon-COVID", 
                  linetype="Actual\nnon-COVID", 
                  size="Actual\nnon-COVID"
                  )
              ) + 
    geom_line(aes(y=pred/1000, 
                  color="Trend from\n2015-2019", 
                  linetype="Trend from\n2015-2019", 
                  size="Trend from\n2015-2019"
                  )
              ) + 
    lims(y=c(0, NA)) + 
    labs(x=NULL, y="Monthly deaths (000)", title="US monthly deaths (000) by type and vs. 2015-2019 trend") +
    scale_color_manual(name="Source:", values=mapColor) + 
    scale_linetype_manual(name="Source:", values=mapLineType) + 
    scale_size_manual(name="Source:", values=mapSize)

```
  
The process is converted to functional form:  
```{r, fig.height=9, fig.width=9}

deathTrends <- function(lstCDC, 
                        lstCDCSub,
                        dateThru, 
                        trendThru, 
                        lstCDCFilter=list(),
                        lstCDCSubFilter=list("State"="United States", "Age"="All Ages"),
                        createPlot=TRUE,
                        mapColor=c("Actual\nall-cause"="red", 
                                   "Actual\nnon-COVID"="black", 
                                   "Trend from\n2015-2019"="red"
                                   ),
                        mapLineType=c("Actual\nall-cause"="solid", 
                                      "Actual\nnon-COVID"="solid", 
                                      "Trend from\n2015-2019"="dotted"
                                      ),
                        mapSize=c("Actual\nall-cause"=1.5, 
                                  "Actual\nnon-COVID"=0.5, 
                                  "Trend from\n2015-2019"=1
                                  )

                        ) {

    # FUNCTION ARGUMENTS:
    # lstCDC: processed list of CDC all-cause deaths
    # lstCDCSub: processed list of CDC age-place-cause deaths
    # dateThru: latest date for the analysis
    # trendThru: latest date for the trend regression
    # lstCDCFilter: named list with filtering criteria for lstCDC, passed to rowFilter()
    # lstCDCSubFilter: named list with filtering criteria for lstCDCSub, passed to rowFilter()
    # createPlot: boolean, should the plot be created (if FALSE, only the data is created ad returned)
    # mapColor: mapping vector for plot color elements
    # mapLineType: mapping vector for plot linetype elements
    # mapSize: mapping vector for plot size elements
    
    # Extrapolate all-cause deaths by month
    dfAllCause <- lstCDC[["cdc"]] %>%
        rowFilter(lstFilter=lstCDCFilter) %>%
        group_by(weekEnding) %>%
        summarize(deathsPerDay=sum(deaths)/7)
    dfAllCause <- map_dfr(.x=0:6, .f=function(x) mutate(dfAllCause, day=weekEnding-lubridate::days(x))) %>%
        mutate(ym=customYYYYMM(day)) %>%
        group_by(ym) %>%
        summarize(deaths=sum(deathsPerDay)) %>%
        mutate(date=as.Date(paste0(ym, "-01"))) %>%
        filter(date <= dateThru) %>% 
        mutate(year=lubridate::year(date), 
               month=factor(month.abb[lubridate::month(date)], levels=month.abb)
               )
    
    # Create the linear trend of all-cause deaths
    lmAllCause <- lm(deaths ~ year + month, data=filter(dfAllCause, date <= trendThru))
    
    # Create the integrated all-cause deaths with projections
    dfAllCause <- dfAllCause %>%
        mutate(pred=predict(lmAllCause, newdata=.))

    # Extract the subset data
    dfSubset <- lstCDCSub[["allCauseList"]][["deathLoc_conv"]] %>% 
        rowFilter(lstFilter=list("Group"="By Month", "deathPlace"="Total - All Places of Death")) %>%
        rowFilter(lstFilter=lstCDCSubFilter) %>%
        group_by(Year, Month) %>%
        summarize(across(c(totalDeaths, covidDeaths), .fns=sum, na.rm=TRUE), .groups="drop") %>%
        mutate(date=as.Date(paste0(Year, "-", Month, "-1")), 
               nonCovidDeaths=totalDeaths-covidDeaths
               )

    if(isTRUE(createPlot)) {
    
        # Create and print the plot
        p1 <- dfAllCause %>% 
            ggplot(aes(x=date)) + 
            geom_line(aes(y=deaths/1000, 
                          color="Actual\nall-cause", 
                          linetype="Actual\nall-cause", 
                          size="Actual\nall-cause"
                          )
                      ) + 
            geom_line(data=filter(dfSubset, date <= dateThru), 
                      aes(y=nonCovidDeaths/1000, 
                          color="Actual\nnon-COVID", 
                          linetype="Actual\nnon-COVID", 
                          size="Actual\nnon-COVID"
                          )
                      ) + 
            geom_line(aes(y=pred/1000, 
                          color="Trend from\n2015-2019", 
                          linetype="Trend from\n2015-2019", 
                          size="Trend from\n2015-2019"
                          )
                      ) + 
            lims(y=c(0, NA)) + 
            labs(x=NULL, 
                 y="Monthly deaths (000)", 
                 title="US monthly deaths (000) by type and vs. 2015-2019 trend"
                 ) +
            scale_color_manual(name="Source:", values=mapColor) + 
            scale_linetype_manual(name="Source:", values=mapLineType) + 
            scale_size_manual(name="Source:", values=mapSize)
        print(p1)
        
    }

    # Return key data components
    list(dfAllCause=dfAllCause, dfSubset=dfSubset, lmAllCause=lmAllCause)
    
}

deathTrends(cdcList_20211105, 
            lstCDCSub = allCauseTest,
            dateThru = "2021-09-30", 
            trendThru = "2019-12-31"
            )

deathTrends(cdcList_20211105, 
            lstCDCSub = allCauseTest,
            lstCDCFilter=list("state"=c("NY")), 
            lstCDCSubFilter=list("Age"="All Ages", "State"=c("New York", "New York City")),
            dateThru = "2021-09-30", 
            trendThru = "2019-12-31"
            )

deathTrends(cdcList_20211105, 
            lstCDCSub = allCauseTest,
            lstCDCFilter=list("age"=c("75-84 years", "85 years and older")), 
            lstCDCSubFilter=list("Age"=c("75-84 years", "85 years and over"), "State"="United States"),
            dateThru = "2021-09-30", 
            trendThru = "2019-12-31"
            )

```

The data outputs are used to calculate excess deaths as both 1) non-COVID vs baseline, and 2) COVID:  
```{r, fig.height=9, fig.width=9}

# Get the data
deathAllList <- deathTrends(cdcList_20211105, 
                            lstCDCSub = allCauseTest,
                            dateThru = "2021-09-30", 
                            trendThru = "2019-12-31", 
                            createPlot=FALSE
                            )

# Create the integrated file
deathAllList$dfAllCause %>%
    select(date, allCause=deaths, pred) %>%
    inner_join(select(deathAllList$dfSubset, date, nonCovidDeaths, covidDeaths), by="date") %>%
    mutate(deltaAllCause=allCause-covidDeaths-nonCovidDeaths, 
           deltaPred=nonCovidDeaths-pred
           ) %>%
    pivot_longer(-c(date)) %>%
    arrange(date) %>%
    group_by(name) %>%
    mutate(cumValue=cumsum(value)) %>%
    ggplot(aes(x=date, y=cumValue/1000)) + 
    geom_line(data=~filter(., name=="deltaPred"), aes(color="nonCovid")) +
    geom_text(data=~filter(., name=="deltaPred", date==max(date)), 
              aes(color="nonCovid", label=round(cumValue/1000)), 
              hjust=0
              ) + 
    geom_line(data=~filter(., name=="covidDeaths"), aes(color="covid")) + 
    geom_text(data=~filter(., name=="covidDeaths", date==max(date)), 
              aes(color="covid", label=round(cumValue/1000)), 
              hjust=0
              ) + 
    labs(x=NULL, y="Cumulative Deaths (000)", title="Cumulative excess deaths (000) since January 2020") + 
    scale_color_manual("Type:", 
                       values=c("nonCovid"="black", "covid"="red"), 
                       labels=c("nonCovid"="non-COVID\nvs. trend of\n2015-2019", "covid"="COVID")
                       ) + 
    geom_hline(yintercept=0, lty=2)

```

This is converted to functional form:  
```{r, fig.height=9, fig.width=9}

makeCumulativeDeath <- function(lst, 
                                divBy=1000, 
                                yLab=NULL, 
                                plotTitle=NULL,
                                plotSubtitle=NULL,
                                plotYLim=NULL,
                                plotLegendPosition=NULL,
                                plotLabels=NULL,
                                returnData=FALSE, 
                                printPlot=TRUE, 
                                returnPlot=!isTRUE(printPlot)
                                ) {
    
    # FUNCTION ARGUMENTS
    # lst: a processed list file from deathTrends()
    # divBy: divide death values by (1000 means plots will be in thousands)
    # yLab: y-axis label (NULL means use divBy to create)
    # plotTitle: title (NULL means use divBy and earliest date in inner_join to create)
    # plotSubtitle: subtitle (NULL means none)
    # plotYLim: vector c(ymin, ymax) to force y-limits on the plot (NULL means use defaults)
    # plotLegendPosition: character string for theme(legend.position=) to override the default legend position
    # plotLabels: mapping file of elements to labels for the plot legend (NULL means key off plotLegendPosition)
    # returnData: boolean, should the data frame be returned?
    # printPlot: should the plot be printed
    # returnPlot: should the plot be returned
    
    # Create plotLabels if passed as NULL
    if(is.null(plotLabels)) {
        plotLabels <- c("nonCovid"="non-COVID\nvs. trend of\n2015-2019", "covid"="COVID")
        if(!is.null(plotLegendPosition)) 
            if(plotLegendPosition=="bottom") 
                plotLabels["nonCovid"] <- stringr::str_replace_all(plotLabels["nonCovid"], "\n", " ")
    }

    # Create the data frame
    df <- lst[["dfAllCause"]] %>%
        select(date, allCause=deaths, pred) %>%
        inner_join(select(lst[["dfSubset"]], date, nonCovidDeaths, covidDeaths), by="date") %>%
        mutate(deltaAllCause=allCause-covidDeaths-nonCovidDeaths, 
               deltaPred=nonCovidDeaths-pred
               ) %>%
        pivot_longer(-c(date)) %>%
        arrange(date) %>%
        group_by(name) %>%
        mutate(cumValue=cumsum(value))
    
    # Create the labels if needed
    # Unit conversion text
    if(divBy==1) xtraText <- ""
    else if(isTRUE(all.equal(log10(divBy), round(log10(divBy))))) 
        xtraText <- paste0(" (", stringr::str_sub(as.character(divBy), start=2), ")")
    else xtraText <- paste0(" (", as.character(round(divBy)), "s)")
    # Earliest date
    earlyDate <- format(min(df$date), "%B %Y")
    # Replacement of NULL values
    if (is.null(yLab)) yLab <- paste0("Cumulative Deaths", xtraText)
    if (is.null(plotTitle)) plotTitle <- paste0("Cumulative change in deaths", xtraText, " since ", earlyDate)
    
    # Create the plot
    p1 <- df %>%
        ggplot(aes(x=date, y=cumValue/divBy)) + 
        geom_text(data=~filter(., name=="deltaPred", date==max(date)), 
                  aes(color="nonCovid", label=round(cumValue/divBy)), 
                  hjust=0
                  ) + 
        geom_text(data=~filter(., name=="covidDeaths", date==max(date)), 
                  aes(color="covid", label=round(cumValue/divBy)), 
                  hjust=0
                  ) + 
        geom_line(data=~filter(., name=="deltaPred"), aes(color="nonCovid")) +
        geom_line(data=~filter(., name=="covidDeaths"), aes(color="covid")) + 
        labs(x=NULL, y=yLab, title=plotTitle, subtitle=plotSubtitle) + 
        scale_color_manual("Type:", values=c("nonCovid"="black", "covid"="red"), labels=plotLabels) + 
        geom_hline(yintercept=0, lty=2)
    if(!is.null(plotYLim)) p1 <- p1 + lims(y=plotYLim)
    if(!is.null(plotLegendPosition)) p1 <- p1 + theme(legend.position=plotLegendPosition)
    if(isTRUE(printPlot)) print(p1)
    
    # Return the plot or data if requested (plot takes precedence)
    if(isTRUE(returnPlot)) return(p1)
    if(isTRUE(returnData)) return(df)
    
}


makeCumulativeDeath(deathAllList)
makeCumulativeDeath(deathAllList, returnData=TRUE)

deathTrends(cdcList_20211105, 
            lstCDCSub = allCauseTest,
            lstCDCFilter=list("age"=c("75-84 years", "85 years and older")), 
            lstCDCSubFilter=list("Age"=c("75-84 years", "85 years and over"), "State"="United States"),
            dateThru = "2021-09-30", 
            trendThru = "2019-12-31", 
            createPlot=FALSE
            ) %>%
    makeCumulativeDeath(plotSubtitle="Age 75+")

```

The function is run for four groups:  
  
* 75+  
* 65-74  
* Under 65  
* All US  
  
```{r, fig.height=9, fig.width=9}

# Age 75+
p1 <- deathTrends(cdcList_20211105, 
            lstCDCSub = allCauseTest,
            lstCDCFilter=list("age"=c("75-84 years", "85 years and older")), 
            lstCDCSubFilter=list("Age"=c("75-84 years", "85 years and over"), "State"="United States"),
            dateThru = "2021-09-30", 
            trendThru = "2019-12-31", 
            createPlot=FALSE
            ) %>%
    makeCumulativeDeath(plotSubtitle="Age 75+", plotLegendPosition="bottom", plotYLim=c(-100, 800), printPlot=FALSE)

# Age 65-74
p2 <- deathTrends(cdcList_20211105, 
            lstCDCSub = allCauseTest,
            lstCDCFilter=list("age"=c("65-74 years")), 
            lstCDCSubFilter=list("Age"=c("65-74 years"), "State"="United States"),
            dateThru = "2021-09-30", 
            trendThru = "2019-12-31", 
            createPlot=FALSE
            ) %>%
    makeCumulativeDeath(plotSubtitle="Age 65-74", plotLegendPosition="bottom", plotYLim=c(-100, 800), printPlot=FALSE)

# Age 0-64
p3 <- deathTrends(cdcList_20211105, 
            lstCDCSub = allCauseTest,
            lstCDCFilter=list("age"=c("45-64 years", "25-44 years", "Under 25 years")), 
            lstCDCSubFilter=list("Age"=c("50-64 years", "40-49 years", "30-39 years", "18-29 years", "0-17 years"), 
                                 "State"="United States"
                                 ),
            dateThru = "2021-09-30", 
            trendThru = "2019-12-31", 
            createPlot=FALSE
            ) %>%
    makeCumulativeDeath(plotSubtitle="Age 0-64", plotLegendPosition="bottom", plotYLim=c(-100, 800), printPlot=FALSE)

# All Ages
p4 <- deathTrends(cdcList_20211105, 
            lstCDCSub = allCauseTest,
            lstCDCFilter=list(), 
            lstCDCSubFilter=list("Age"=c("All Ages"), "State"="United States"),
            dateThru = "2021-09-30", 
            trendThru = "2019-12-31", 
            createPlot=FALSE
            ) %>%
    makeCumulativeDeath(plotSubtitle="All Ages", plotLegendPosition="bottom", plotYLim=c(-100, 800), printPlot=FALSE)

gridExtra::grid.arrange(p4, p1, p2, p3, nrow=2)

```

The latest CDC all-cause deaths data are downloaded:  
```{r, fig.height=9, fig.width=9, cache=TRUE}

cdcLoc <- "Weekly_counts_of_deaths_by_jurisdiction_and_age_group_downloaded_20211203.csv"
cdcList_20211203 <- readRunCDCAllCause(loc=cdcLoc, 
                                       weekThru=45, 
                                       lst=readFromRDS("cdc_daily_211202"), 
                                       stateNoCheck=c("WV"), 
                                       pdfCluster=TRUE, 
                                       pdfAge=TRUE
                                       )

```

The most recent data for deaths by age and location are downloaded and processed:  
```{r, fig.height=9, fig.width=9, cache=TRUE}

allCause_211204 <- analyzeAllCause(loc="COvID_deaths_age_place_20211204.csv", 
                                   cdcDailyList=readFromRDS("cdc_daily_211202"), 
                                   compareThruDate="2021-11-30"
                                   )

```

