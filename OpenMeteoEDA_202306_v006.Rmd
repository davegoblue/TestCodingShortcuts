---
title: "Open Meteo Weather Exploration"
author: "davegoblue"
date: "2025-08-23"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Background
Open-Meteo maintains an [API for historical weather](https://open-meteo.com/en/docs/historical-weather-api) that allows for non-commercial usage of historical weather data maintained by the website.

This file builds on _v001, _v002, _v003, _v004, and _v005 to run exploratory analysis on some historical weather data.

## Functions and Libraries
The exploration process uses tidyverse, ranger, several generic custom functions, and several functions specific to Open Meteo processing. First, tidyverse, ranger, and the generic functions are loaded:  
```{r}

library(tidyverse) # tidyverse functionality is included throughout
library(ranger) # predict() does not work on ranger objects unless ranger has been called

source("./Generic_Added_Utility_Functions_202105_v001.R") # Basic functions

```
  
Next, specific functions written in _v001, _v002, _v003, _v004, and _v005 are sourced:  
```{r}

source("./SimpleOneVar_Functions_202411_v001.R") # Functions for basic single variable analysis
source("./OpenMeteo_NextBest_202411_v001.R") # Functions for finding 'next best' predictor given existing model
source("./OpenMeteo_Functions_202411_v001.R") # Core functions for loading, processing, analysis of Open Meteo
source("./Generic_Analysis_Functions_202411_v001.R") # Additional functions for random forest and related analysis

```
  
Key mapping tables for available metrics are also copied:  
```{r}

hourlyMetrics <- "temperature_2m,relativehumidity_2m,dewpoint_2m,apparent_temperature,pressure_msl,surface_pressure,precipitation,rain,snowfall,cloudcover,cloudcover_low,cloudcover_mid,cloudcover_high,shortwave_radiation,direct_radiation,direct_normal_irradiance,diffuse_radiation,windspeed_10m,windspeed_100m,winddirection_10m,winddirection_100m,windgusts_10m,et0_fao_evapotranspiration,weathercode,vapor_pressure_deficit,soil_temperature_0_to_7cm,soil_temperature_7_to_28cm,soil_temperature_28_to_100cm,soil_temperature_100_to_255cm,soil_moisture_0_to_7cm,soil_moisture_7_to_28cm,soil_moisture_28_to_100cm,soil_moisture_100_to_255cm"
dailyMetrics <- "weathercode,temperature_2m_max,temperature_2m_min,apparent_temperature_max,apparent_temperature_min,precipitation_sum,rain_sum,snowfall_sum,precipitation_hours,sunrise,sunset,windspeed_10m_max,windgusts_10m_max,winddirection_10m_dominant,shortwave_radiation_sum,et0_fao_evapotranspiration"

hourlyDescription <- "Air temperature at 2 meters above ground\nRelative humidity at 2 meters above ground\nDew point temperature at 2 meters above ground\nApparent temperature is the perceived feels-like temperature combining wind chill factor, relative humidity and solar radiation\nAtmospheric air pressure reduced to mean sea level (msl) or pressure at surface. Typically pressure on mean sea level is used in meteorology. Surface pressure gets lower with increasing elevation.\nAtmospheric air pressure reduced to mean sea level (msl) or pressure at surface. Typically pressure on mean sea level is used in meteorology. Surface pressure gets lower with increasing elevation.\nTotal precipitation (rain, showers, snow) sum of the preceding hour. Data is stored with a 0.1 mm precision. If precipitation data is summed up to monthly sums, there might be small inconsistencies with the total precipitation amount.\nOnly liquid precipitation of the preceding hour including local showers and rain from large scale systems.\nSnowfall amount of the preceding hour in centimeters. For the water equivalent in millimeter, divide by 7. E.g. 7 cm snow = 10 mm precipitation water equivalent\nTotal cloud cover as an area fraction\nLow level clouds and fog up to 2 km altitude\nMid level clouds from 2 to 6 km altitude\nHigh level clouds from 6 km altitude\nShortwave solar radiation as average of the preceding hour. This is equal to the total global horizontal irradiation\nDirect solar radiation as average of the preceding hour on the horizontal plane and the normal plane (perpendicular to the sun)\nDirect solar radiation as average of the preceding hour on the horizontal plane and the normal plane (perpendicular to the sun)\nDiffuse solar radiation as average of the preceding hour\nWind speed at 10 or 100 meters above ground. Wind speed on 10 meters is the standard level.\nWind speed at 10 or 100 meters above ground. Wind speed on 10 meters is the standard level.\nWind direction at 10 or 100 meters above ground\nWind direction at 10 or 100 meters above ground\nGusts at 10 meters above ground of the indicated hour. Wind gusts in CERRA are defined as the maximum wind gusts of the preceding hour. Please consult the ECMWF IFS documentation for more information on how wind gusts are parameterized in weather models.\nET0 Reference Evapotranspiration of a well watered grass field. Based on FAO-56 Penman-Monteith equations ET0 is calculated from temperature, wind speed, humidity and solar radiation. Unlimited soil water is assumed. ET0 is commonly used to estimate the required irrigation for plants.\nWeather condition as a numeric code. Follow WMO weather interpretation codes. See table below for details. Weather code is calculated from cloud cover analysis, precipitation and snowfall. As barely no information about atmospheric stability is available, estimation about thunderstorms is not possible.\nVapor Pressure Deificit (VPD) in kilopascal (kPa). For high VPD (>1.6), water transpiration of plants increases. For low VPD (<0.4), transpiration decreases\nAverage temperature of different soil levels below ground.\nAverage temperature of different soil levels below ground.\nAverage temperature of different soil levels below ground.\nAverage temperature of different soil levels below ground.\nAverage soil water content as volumetric mixing ratio at 0-7, 7-28, 28-100 and 100-255 cm depths.\nAverage soil water content as volumetric mixing ratio at 0-7, 7-28, 28-100 and 100-255 cm depths.\nAverage soil water content as volumetric mixing ratio at 0-7, 7-28, 28-100 and 100-255 cm depths.\nAverage soil water content as volumetric mixing ratio at 0-7, 7-28, 28-100 and 100-255 cm depths."
dailyDescription <- "The most severe weather condition on a given day\nMaximum and minimum daily air temperature at 2 meters above ground\nMaximum and minimum daily air temperature at 2 meters above ground\nMaximum and minimum daily apparent temperature\nMaximum and minimum daily apparent temperature\nSum of daily precipitation (including rain, showers and snowfall)\nSum of daily rain\nSum of daily snowfall\nThe number of hours with rain\nSun rise and set times\nSun rise and set times\nMaximum wind speed and gusts on a day\nMaximum wind speed and gusts on a day\nDominant wind direction\nThe sum of solar radiaion on a given day in Megajoules\nDaily sum of ET0 Reference Evapotranspiration of a well watered grass field"

# Create tibble for hourly metrics
tblMetricsHourly <- tibble::tibble(metric=hourlyMetrics %>% str_split_1(","), 
                                   description=hourlyDescription %>% str_split_1("\n")
                                   )
tblMetricsHourly %>% 
    print(n=50)

# Create tibble for daily metrics
tblMetricsDaily <- tibble::tibble(metric=dailyMetrics %>% str_split_1(","), 
                                  description=dailyDescription %>% str_split_1("\n")
                                   )
tblMetricsDaily

```

A previously existing hourly dataset is loaded, with key analysis variables defined in a vector:  
```{r}

# Load previous data
allCityHourly <- readFromRDS("allCity_20241116")

# Get core training variables
varsTrainHourly <- getVarsTrain(allCityHourly)
varsTrainHourly

# Assign default label
keyLabel <- genericKeyLabelOM()
keyLabel

# Get years of data available
allCityHourly %>% 
    mutate(year=year(date)) %>%
    group_by(src) %>%
    summarize(n=n(), minYear=min(year), maxYear=max(year), minDate=min(date), maxDate=max(date))

```

A daily dataset is created from existing data:  
```{r, fig.height=9, fig.width=9}

omCityMap <- c("bos"="Boston MA", 
               "ord"="Chicago IL", 
               "hou"="Houston TX",
               "lax"="Los Angeles CA", 
               "las"="Las Vegas NV",
               "mia"="Miami FL", 
               "nyc"="New York NY"
               )

allCityDaily <- map_dfr(.x=names(omCityMap), 
                        .f=function(x) omRunAllSteps(dlData=FALSE, runStats=FALSE, abbCity=x, returnDF=TRUE), 
                        .id="src"
                        ) %>%
    mutate(cityName=unname(omCityMap)[as.integer(src)])

allCityDaily %>% 
    mutate(year=year(date)) %>%
    group_by(cityName) %>%
    summarize(n=n(), minYear=min(year), maxYear=max(year), minDate=min(date), maxDate=max(date))

```

Hourly data is updated with city name to match daily data:  
```{r, fig.height=9, fig.width=9}

hourlyCityMap <- c("Boston"="Boston MA", 
                   "Chicago"="Chicago IL", 
                   "Houston"="Houston TX",
                   "LA"="Los Angeles CA", 
                   "Vegas"="Las Vegas NV",
                   "Miami"="Miami FL", 
                   "NYC"="New York NY"
                   )

allCityHourly <- allCityHourly %>%
    mutate(cityName=hourlyCityMap[src]) 

allCityHourly %>%
    group_by(src, cityName) %>%
    summarize(n=n(), minDate=min(date), maxDate=max(date), .groups="drop")

```

Alignment of maximum temperature is explored:  
```{r, fig.height=9, fig.width=9}

maxTDelta <- allCityHourly %>%
    group_by(cityName, date) %>%
    summarize(maxT=max(temperature_2m), .groups="drop") %>%
    filter(year(date)<=2022) %>%
    left_join(select(allCityDaily, cityName, date, temperature_2m_max), by=c("cityName", "date")) %>%
    mutate(delta=maxT-temperature_2m_max)

maxTDelta %>%
    summary()

maxTDelta %>%
    group_by(cityName) %>%
    summarize(pctDiff=mean(abs(delta)>0.01))

```
  
10% of observations in Chicago differ, potentially due to time zone conversions. All other cities align

The differences in Chicago observations are further explored:  
```{r, fig.height=9, fig.width=9}

maxTDelta %>%
    filter(cityName=="Chicago IL") %>%
    mutate(mon=month(date), year=year(date), isDiff=abs(delta)>0.01) %>%
    group_by(year, mon) %>%
    summarize(pctDiff=mean(isDiff), n=n(), .groups="drop") %>%
    ggplot(aes(x=factor(month.abb[mon], levels=month.abb), y=pctDiff, group=1)) + 
    geom_line() + 
    geom_hline(data=~summarize(., yint=sum(n*pctDiff)/sum(n)), aes(yintercept=yint), lty=2) +
    facet_wrap(~year) + 
    labs(x=NULL, y="Proportion mismatched", title="Mismatches between daily and hourly maximum temperature")

```

In general, mismatches seem to be more common in the colder season

A sample of the larger mismatches are explored:  
```{r, fig.height=9, fig.width=9}

tmpDates <- maxTDelta %>%
    filter(cityName=="Chicago IL") %>%
    mutate(mon=month(date), year=year(date), isDiff=abs(delta)>2.5) %>%
    filter(isDiff) %>%
    pull(date)
tmpDates

tmpDF <- allCityHourly %>%
    filter(cityName=="Chicago IL") %>%
    select(cityName, time, date, hour, temperature_2m)

map_dfr(.x=tmpDates, 
        .f=function(x) tmpDF %>% filter(date %in% c(x, x-1, x+1)), 
        .id="src"
        ) %>%
    mutate(src=tmpDates[as.integer(src)], isSame=(src==date)) %>%
    left_join(select(maxTDelta, cityName, src=date, temperature_2m_max), by=c("cityName", "src")) %>%
    ggplot(aes(x=time, y=temperature_2m)) +
    geom_line() + 
    geom_line(aes(y=temperature_2m_max), lty=2) +
    facet_wrap(~src, scales="free") + 
    labs(x=NULL, y="Temperature (C)", title="Hourly temperatures near key disconnect dates")

```

Disconnects appear to arise when the maximum temperature is reached very early and/or very late in the day. This is consistent with time zones potentially driving the differences.

Shading is added for clarity:  
```{r, fig.height=9, fig.width=9}

map_dfr(.x=tmpDates, 
        .f=function(x) tmpDF %>% filter(date %in% c(x, x-1, x+1)), 
        .id="src"
        ) %>%
    mutate(src=tmpDates[as.integer(src)], isSame=(src==date)) %>%
    left_join(select(maxTDelta, cityName, src=date, temperature_2m_max), by=c("cityName", "src")) %>%
    ggplot(aes(x=time, y=temperature_2m)) +
    geom_line() + 
    geom_line(aes(y=temperature_2m_max), lty=2) +
    facet_wrap(~src, scales="free") + 
    labs(x=NULL, 
         y="Temperature (C)", 
         title="Hourly temperatures near key disconnect dates", 
         subtitle="Line is hourly data, shaded region is the 24 hours in the key date", 
         caption="Dotted line is maximum temperature reported in daily data"
         ) +
    geom_tile(data=~filter(., isSame), fill="lightblue", aes(x=time, y=0, height=+Inf), alpha=0.5)

```

Chicago data are shifted by an hour to check whether time zones fully explain the differences:  
```{r, fig.height=9, fig.width=9}

# Run previously
# tmpDF <- allCityHourly %>%
#     filter(cityName=="Chicago IL") %>%
#     select(cityName, time, date, hour, temperature_2m)

tmpDF %>% 
    mutate(newtime=time-hours(1), date=date(newtime)) %>% 
    filter(!(date %in% c(min(date)))) %>% 
    group_by(cityName, date) %>% 
    summarize(maxT=max(temperature_2m), .groups="drop") %>% 
    filter(year(date)<=2022) %>% 
    left_join(select(allCityDaily, cityName, date, temperature_2m_max), by=c("cityName", "date")) %>%
    mutate(delta=maxT-temperature_2m_max) %>% 
    summary()

```

If date is recalculated based on time minus one hour, the Chicago hourly data aligns with the Chicago daily data for maximum temperature

Alignment of precipitation is explored, first with time zones in hourly data "as is":  
```{r, fig.height=9, fig.width=9}

sumPDelta <- allCityHourly %>%
    group_by(cityName, date) %>%
    summarize(sumP=sum(precipitation), .groups="drop") %>%
    filter(year(date)<=2022) %>%
    left_join(select(allCityDaily, cityName, date, precipitation_sum), by=c("cityName", "date")) %>%
    mutate(delta=sumP-precipitation_sum)

sumPDelta %>%
    summary()

sumPDelta %>%
    group_by(cityName) %>%
    summarize(pctDiff=mean(abs(delta)>0.005))

```
  
25% of observations in Chicago differ, likely due to time zone conversions. All other cities align

Chicago data is updated to be one hour earlier:  
```{r, fig.height=9, fig.width=9}

sumPDelta <- allCityHourly %>%
    mutate(date=as.Date(ifelse(cityName %in% c("Chicago IL"), time-hours(1), date))) %>%
    group_by(cityName, date) %>%
    summarize(sumP=sum(precipitation), .groups="drop") %>%
    filter(year(date)<=2022) %>%
    left_join(select(allCityDaily, cityName, date, precipitation_sum), by=c("cityName", "date")) %>%
    mutate(delta=sumP-precipitation_sum)

sumPDelta %>%
    summary()

sumPDelta %>%
    group_by(cityName) %>%
    summarize(pctDiff=mean(abs(delta)>0.005))

```
  
After adjusting for time zone in Chicago, all observations align

The process is generalized in a function that adjusts only Chicago and with other significant hard-coding:  
```{r, fig.height=9, fig.width=9}

tmpDailyVsHourly <- function(df1=allCityHourly, 
                             df2=allCityDaily, 
                             chgCities=c("Chicago IL"),
                             chgHours=-1,
                             varDF1="precipitation",
                             varDF2="precipitation_sum",
                             fn=sum,
                             eqTol=0.005
                             ) {

    df <- df1 %>%
        mutate(date=as.Date(ifelse(cityName %in% chgCities, time+hours(chgHours), date))) %>%
        group_by(cityName, date) %>%
        summarize(across(.cols=all_of(varDF1), .fns=fn, .names="agg"), .groups="drop") %>%
        filter(year(date)<=2022) %>%
        left_join(select(df2, all_of(c("cityName", "date", varDF2))), 
                         by=c("cityName", "date")
                  ) %>%
        mutate(delta=agg-get(varDF2))

    df %>%
        summary() %>%
        print()

    df %>%
        group_by(cityName) %>%
        summarize(pctDiff=mean(abs(delta)>eqTol)) %>%
        print()
}

tmpDailyVsHourly(varDF1="precipitation", varDF2="precipitation_sum", fn=sum, eqTol=0.005)

```

The function is tested for maximum temperature:  
```{r, fig.height=9, fig.width=9}

# No change in time
tmpDailyVsHourly(varDF1="temperature_2m", varDF2="temperature_2m_max", fn=max, eqTol=0.005, chgCities=c())

# Chicago shifted by -1 hours (default)
tmpDailyVsHourly(varDF1="temperature_2m", varDF2="temperature_2m_max", fn=max, eqTol=0.005)

```

The function is tested for maximum and minimum apparent temperature:  
```{r, fig.height=9, fig.width=9}

# Maximum apparent temperature, with Chicago time shift
tmpDailyVsHourly(varDF1="apparent_temperature", varDF2="apparent_temperature_max", fn=max, eqTol=0.005)

# Minimum apparent temperature, with Chicago time shift
tmpDailyVsHourly(varDF1="apparent_temperature", varDF2="apparent_temperature_min", fn=min, eqTol=0.005)

```

The function is tested for sum of precipitation and snowfall:  
```{r, fig.height=9, fig.width=9}

# Precipitation, with Chicago time shift
tmpDailyVsHourly(varDF1="precipitation", varDF2="precipitation_sum", fn=sum, eqTol=0.005)

# Snowfall, with Chicago time shift
tmpDailyVsHourly(varDF1="snowfall", varDF2="snowfall_sum", fn=sum, eqTol=0.005)

```

The function is tested for hours of precipitation:  
```{r, fig.height=9, fig.width=9}

# Precipitation hours, with Chicago time shift
tmpDailyVsHourly(varDF1="precipitation", varDF2="precipitation_hours", fn=function(x) sum(x>0), eqTol=0.005)


```

A random forest model is created to estimate dewpoint based on temperature and apparent temperature given city and month:  
```{r, fig.height=9, fig.width=9, cache=TRUE}

# Use only 10% as training data
set.seed(25091014)
idxTrain_v1 <- sample(1:nrow(allCityHourly), round(0.1*nrow(allCityHourly)), replace=FALSE)

rfTestDewP <- runFullRF(dfTrain=allCityHourly[idxTrain_v1, ] %>% 
                            mutate(fct_city=factor(cityName), 
                                   fct_mon=factor(month.abb[month(date)], levels=month.abb)
                                   ) %>%
                            select(dewpoint_2m, temperature_2m, apparent_temperature, fct_city, fct_mon),
                        dfTest=allCityHourly[-idxTrain_v1, ] %>% 
                            mutate(fct_city=factor(cityName), 
                                   fct_mon=factor(month.abb[month(date)], levels=month.abb)
                                   ),
                        yVar="dewpoint_2m", 
                        xVars=c("temperature_2m", "apparent_temperature", "fct_city", "fct_mon"),
                        isContVar=TRUE,
                        rndTo=-1L,
                        returnData=TRUE
                        )

rfTestDewP$tstPred %>%
    group_by(fct_city, fct_mon) %>%
    summarize(n=n(), 
              tssActual=sum((dewpoint_2m-mean(dewpoint_2m))**2), 
              rssPred=sum((dewpoint_2m-pred)**2), 
              r2=1-rssPred/tssActual, 
              rmse=sqrt(rssPred/n), 
              .groups="drop"
              ) %>%
    ggplot(aes(x=fct_city, y=fct_mon)) + 
    geom_tile(aes(fill=r2)) + 
    geom_text(aes(label=round(r2, 3)), size=3) +
    scale_fill_continuous("R2", low="white", high="lightgreen", limits=c(0, 1)) + 
    labs(x=NULL, y=NULL, title="R2 for dewpoint predictions")

```

Actual daily dewpoints are calculated using hourly data:  
```{r, fig.height=9, fig.width=9}

dewPDaily <- allCityHourly %>% 
    mutate(fct_city=factor(cityName), 
           fct_mon=factor(month.abb[month(date)], levels=month.abb)
           ) %>%
    group_by(fct_city, fct_mon, date) %>%
    summarize(across(dewpoint_2m, .fns=list(mean=mean, min=min, max=max)), .groups="drop")
dewPDaily

```

Annual average dewpoints by city are explored:  
```{r, fig.height=9, fig.width=9}

dewPDaily %>%
    mutate(year=year(date)) %>%
    filter(year>=2010, year<2023) %>%
    group_by(year, fct_city) %>%
    summarize(mudp=mean(dewpoint_2m_mean), .groups="drop") %>%
    ggplot(aes(x=factor(year), y=mudp)) + 
    geom_line(aes(group=fct_city, color=fct_city), lwd=1) + 
    labs(title="Average dewpoint by city and year", y="Average dewpoint (C)", x=NULL) + 
    scale_color_discrete(NULL)

```

Monthly average dewpoints by city are explored:  
```{r, fig.height=9, fig.width=9}

dewPDaily %>%
    mutate(year=year(date)) %>%
    filter(year>=2010, year<2023) %>%
    group_by(fct_city, fct_mon) %>%
    summarize(mudp=mean(dewpoint_2m_mean), 
              maxdp=max(dewpoint_2m_mean),
              mindp=min(dewpoint_2m_mean),
              .groups="drop"
              ) %>%
    ggplot(aes(x=fct_mon)) + 
    geom_line(aes(y=mudp, group=fct_city, color=fct_city), lwd=1) + 
    labs(title="Average dewpoint by city and month", y="Average dewpoint (C)", x=NULL) + 
    scale_color_discrete(NULL)

```

Rolling 21-day average dewpoints by city are explored:  
```{r, fig.height=9, fig.width=9}

dewPDaily %>%
    mutate(year=year(date), doy=pmin(365, yday(date))) %>%
    arrange(fct_city, date) %>%
    group_by(fct_city) %>%
    helperRollingAgg(origVar="dewpoint_2m_mean", newName="dewpoint_r21", k=21) %>%
    ungroup() %>%
    filter(year>=2010, year<2023, !is.na(dewpoint_r21)) %>%
    group_by(fct_city, doy) %>%
    summarize(mudp=mean(dewpoint_r21), 
              maxdp=max(dewpoint_r21),
              mindp=min(dewpoint_r21),
              .groups="drop"
              ) %>%
    ggplot(aes(x=doy)) + 
    geom_line(aes(y=mudp, group=fct_city, color=fct_city), lwd=1) + 
    labs(title="Average dewpoint by city and day of year", 
         subtitle="Rolling 21-day",
         y="Average rolling 21-day dewpoint (C)", 
         x="Day of year"
         ) + 
    scale_color_discrete(NULL)

```

Dew points are added to the daily data:
```{r, fig.height=9, fig.width=9}

allCityDaily_v2 <- 
    allCityDaily %>%
    left_join(dewPDaily %>%
                  mutate(cityName=as.character(fct_city)) %>%
                  select(cityName, date, starts_with("dewp")), 
              by=c("cityName", "date")
              )

allCityDaily_v2 %>%
    group_by(cityName) %>%
    summarize(n=n(), hasDew=sum(!is.na(dewpoint_2m_mean)))

```

Relationships among temperature, dewpoint, and apparent temperature are explored:  
```{r, fig.height=9, fig.width=9}

allCityDaily_v2 %>%
    mutate(muTemp=(temperature_2m_max + temperature_2m_min)/2, 
           muApp=(apparent_temperature_max + apparent_temperature_min)/2,
           muDew=dewpoint_2m_mean
           ) %>%
    filter(month(date)==7, year(date)>=2010, year(date)<2023) %>%
    select(cityName, muTemp, muDew, muApp) %>%
    mutate(across(where(is.numeric), .fns=round)) %>%
    count(cityName, muTemp, muApp) %>%
    ggplot(aes(x=muTemp, y=muApp)) + 
    geom_point(aes(size=n), alpha=0.5)+ 
    facet_wrap(~cityName) + 
    labs(title="July apparent temperature vs. temperature", 
         x="Average daily temperature (C)", 
         y="Average daily\napparent temperature (C)"
         ) + 
    scale_size_continuous(NULL)

allCityDaily_v2 %>%
    mutate(muTemp=(temperature_2m_max + temperature_2m_min)/2, 
           muApp=(apparent_temperature_max + apparent_temperature_min)/2,
           muDew=dewpoint_2m_mean
           ) %>%
    filter(month(date)==7, year(date)>=2010, year(date)<2023) %>%
    select(cityName, muTemp, muDew, muApp) %>%
    mutate(across(where(is.numeric), .fns=round)) %>%
    count(cityName, muDew, muApp) %>%
    ggplot(aes(x=muDew, y=muApp)) + 
    geom_point(aes(size=n), alpha=0.5)+ 
    facet_wrap(~cityName) + 
    labs(title="July apparent temperature vs. dewpoint", 
         x="Average daily dewpoint (C)", 
         y="Average daily\napparent temperature (C)"
         ) + 
    scale_size_continuous(NULL)

allCityDaily_v2 %>%
    mutate(muTemp=(temperature_2m_max + temperature_2m_min)/2, 
           muApp=(apparent_temperature_max + apparent_temperature_min)/2,
           muDew=dewpoint_2m_mean
           ) %>%
    filter(month(date)==7, year(date)>=2010, year(date)<2023) %>%
    select(cityName, muTemp, muDew, muApp) %>%
    mutate(across(where(is.numeric), .fns=round)) %>%
    count(cityName, muDew, muTemp) %>%
    ggplot(aes(x=muDew, y=muTemp)) + 
    geom_point(aes(size=n), alpha=0.5)+ 
    facet_wrap(~cityName) + 
    labs(title="July temperature vs. dewpoint", 
         x="Average daily dewpoint (C)", 
         y="Average daily\ntemperature (C)"
         ) + 
    scale_size_continuous(NULL)

```

Relationships among temperature, dewpoint, and apparent temperature are further explored:  
```{r, fig.height=9, fig.width=9}

allCityDaily_v2 %>%
    mutate(muTemp=(temperature_2m_max + temperature_2m_min)/2, 
           muApp=(apparent_temperature_max + apparent_temperature_min)/2,
           muDew=dewpoint_2m_mean
           ) %>%
    filter(month(date)==7, year(date)>=2010, year(date)<2023) %>%
    select(cityName, muTemp, muDew, muApp) %>%
    mutate(across(where(is.numeric), .fns=round), 
           appr5=autoRound(muApp, rndTo=5L)
           ) %>%
    count(cityName, muDew, muTemp, appr5) %>%
    ggplot(aes(x=muDew, y=muTemp)) + 
    geom_point(aes(size=n, color=factor(appr5)), alpha=0.5)+ 
    facet_wrap(~cityName) + 
    labs(title="July temperature vs. dewpoint", 
         x="Average daily dewpoint (C)", 
         y="Average daily\ntemperature (C)"
         ) + 
    scale_size_continuous(NULL) + 
    scale_color_discrete("App Temp\n(nearest 5 C)")

```

A simple linear regression is explored:  
```{r, fig.height=9, fig.width=9}

allCityDaily_v2 %>%
    mutate(muTemp=(temperature_2m_max + temperature_2m_min)/2, 
           muApp=(apparent_temperature_max + apparent_temperature_min)/2,
           muDew=dewpoint_2m_mean
           ) %>%
    filter(month(date)==7, year(date)>=2010, year(date)<2023) %>%
    select(cityName, muTemp, muDew, muApp) %>%
    lm(muApp ~ muTemp, data=.) %>%
    summary()

allCityDaily_v2 %>%
    mutate(muTemp=(temperature_2m_max + temperature_2m_min)/2, 
           muApp=(apparent_temperature_max + apparent_temperature_min)/2,
           muDew=dewpoint_2m_mean
           ) %>%
    filter(month(date)==7, year(date)>=2010, year(date)<2023) %>%
    select(cityName, muTemp, muDew, muApp) %>%
    lm(muApp ~ muDew, data=.) %>%
    summary()

```

On average, temperature is better than dewpoint as a predictor of apparent temperature. Interaction is also explored:
```{r, fig.height=9, fig.width=9}

allCityDaily_v2 %>%
    mutate(muTemp=(temperature_2m_max + temperature_2m_min)/2, 
           muApp=(apparent_temperature_max + apparent_temperature_min)/2,
           muDew=dewpoint_2m_mean
           ) %>%
    filter(month(date)==7, year(date)>=2010, year(date)<2023) %>%
    select(cityName, muTemp, muDew, muApp) %>%
    lm(muApp ~ muTemp + muDew, data=.) %>%
    summary()

allCityDaily_v2 %>%
    mutate(muTemp=(temperature_2m_max + temperature_2m_min)/2, 
           muApp=(apparent_temperature_max + apparent_temperature_min)/2,
           muDew=dewpoint_2m_mean
           ) %>%
    filter(month(date)==7, year(date)>=2010, year(date)<2023) %>%
    select(cityName, muTemp, muDew, muApp) %>%
    lm(muApp ~ muTemp + muDew + muTemp:muDew, data=.) %>%
    summary()

```

The inclusion of both temperature and dewpoint meaningfully decreases residual standard error. The interaction term between temperature and dewpoint, while statistically significant, has little practical impact. City is added as an additional explanatory variable:  
```{r, fig.height=9, fig.width=9}

allCityDaily_v2 %>%
    mutate(muTemp=(temperature_2m_max + temperature_2m_min)/2, 
           muApp=(apparent_temperature_max + apparent_temperature_min)/2,
           muDew=dewpoint_2m_mean
           ) %>%
    filter(month(date)==7, year(date)>=2010, year(date)<2023) %>%
    select(cityName, muTemp, muDew, muApp) %>%
    lm(muApp ~ muTemp + muDew + cityName + 0, data=.) %>%
    summary()

allCityDaily_v2 %>%
    mutate(muTemp=(temperature_2m_max + temperature_2m_min)/2, 
           muApp=(apparent_temperature_max + apparent_temperature_min)/2,
           muDew=dewpoint_2m_mean
           ) %>%
    filter(month(date)==7, year(date)>=2010, year(date)<2023) %>%
    select(cityName, muTemp, muDew, muApp) %>%
    lm(muApp ~ muTemp:cityName + muDew:cityName + cityName + 0, data=.) %>%
    summary()

```

Including city reduces residual error slightly

Dewpoints by month are further explored:  
```{r, fig.height=9, fig.width=9}

dewPDaily %>%
    mutate(gte68=(dewpoint_2m_mean>=20), 
           lte32=(dewpoint_2m_mean<=0)
           ) %>%
    group_by(fct_city, fct_mon) %>%
    summarize(gte68=mean(gte68), lte32=mean(lte32), .groups="drop") %>%
    pivot_longer(cols=-c(fct_city, fct_mon)) %>%
    ggplot(aes(x=fct_mon, y=value)) + 
    geom_line(aes(group=name, color=c("gte68"=">=68F", "lte32"="<=32F")[name])) + 
    facet_wrap(~fct_city) + 
    labs(x=NULL, y="Proportion of days", title="Proportion of days by month by dewpoint range") + 
    scale_color_discrete("Dewpoint")

```

Dewpoints at or above 20C (68F) by year are explored:  
```{r, fig.height=9, fig.width=9}

dewPDaily %>%
    mutate(gte68=(dewpoint_2m_mean>=20), 
           lte32=(dewpoint_2m_mean<=0), 
           year=year(date), 
           doy=yday(date)
           ) %>%
    filter(year < 2023) %>%
    arrange(fct_city, date) %>%
    group_by(fct_city, year) %>%
    mutate(gte68=cumsum(gte68), lte32=cumsum(lte32)) %>%
    ungroup() %>%
    ggplot(aes(x=doy, y=gte68)) + 
    geom_line(aes(group=factor(year), color=factor(year))) + 
    facet_wrap(~fct_city, scales="free_y") + 
    labs(x=NULL, 
         y="Days with dewpoint >= 20C (68F)", 
         title="Cumulative days by year with dewpoint >= 20C (68F)"
         ) + 
    scale_color_discrete(NULL)

```

Dewpoints at or below 0C (32F) by year are explored:  
```{r, fig.height=9, fig.width=9}

dewPDaily %>%
    mutate(gte68=(dewpoint_2m_mean>=20), 
           lte32=(dewpoint_2m_mean<=0), 
           year=year(date), 
           doy=yday(date)
           ) %>%
    filter(year < 2023) %>%
    arrange(fct_city, date) %>%
    group_by(fct_city, year) %>%
    mutate(gte68=cumsum(gte68), lte32=cumsum(lte32)) %>%
    ungroup() %>%
    ggplot(aes(x=doy, y=lte32)) + 
    geom_line(aes(group=factor(year), color=factor(year))) + 
    facet_wrap(~fct_city, scales="free_y") + 
    labs(x=NULL, 
         y="Days with dewpoint <= 0C (32F)", 
         title="Cumulative days by year with dewpoint <= 0C (32F)"
         ) + 
    scale_color_discrete(NULL)

```

Dewpoints at or above 20C (68F) by month are explored:  
```{r, fig.height=9, fig.width=9}

dewPDaily %>%
    mutate(gte68=(dewpoint_2m_mean>=20), 
           lte32=(dewpoint_2m_mean<=0), 
           year=year(date), 
           doy=yday(date)
           ) %>%
    filter(year < 2023) %>%
    group_by(fct_city, fct_mon) %>%
    summarize(gte68=sum(gte68), lte32=sum(lte32), .groups="drop") %>%
    ggplot(aes(x=fct_mon, y=gte68)) + 
    geom_col(fill="lightblue") +
    geom_text(aes(label=gte68), size=2.5, vjust=0) +
    facet_wrap(~fct_city) + 
    labs(x=NULL, 
         y="# Days (2010-2022)", 
         title="Days with dewpoint >= 20C (68F)\n2010-2022"
         ) + 
    scale_color_discrete(NULL)

```

Dewpoints at or below 0C (32F) by month are explored:  
```{r, fig.height=9, fig.width=9}

dewPDaily %>%
    mutate(gte68=(dewpoint_2m_mean>=20), 
           lte32=(dewpoint_2m_mean<=0), 
           year=year(date), 
           doy=yday(date)
           ) %>%
    filter(year < 2023) %>%
    group_by(fct_city, fct_mon) %>%
    summarize(gte68=sum(gte68), lte32=sum(lte32), .groups="drop") %>%
    ggplot(aes(x=fct_mon, y=lte32)) + 
    geom_col(fill="lightblue") +
    geom_text(aes(label=lte32), size=2.5, vjust=0) +
    facet_wrap(~fct_city) + 
    labs(x=NULL, 
         y="# Days (2010-2022)", 
         title="Days with dewpoint <= 0C (32F)\n2010-2022"
         ) + 
    scale_color_discrete(NULL)

```

Proportion of days with dewpoints at or above 20C (68F) by month are explored:  
```{r, fig.height=9, fig.width=9}

dewPDaily %>%
    mutate(gte68=(dewpoint_2m_mean>=20), 
           lte32=(dewpoint_2m_mean<=0), 
           year=year(date), 
           doy=yday(date)
           ) %>%
    filter(year < 2023) %>%
    group_by(fct_city, fct_mon) %>%
    summarize(gte68=mean(gte68), lte32=mean(lte32), .groups="drop") %>%
    ggplot(aes(x=fct_mon, y=gte68)) + 
    geom_col(fill="lightblue") +
    geom_text(aes(label=round(gte68,2)), size=2.5, vjust=0) +
    facet_wrap(~fct_city) + 
    labs(x=NULL, 
         y="Proportion of Days (2010-2022)", 
         title="Days with dewpoint >= 20C (68F)\n2010-2022"
         ) + 
    scale_color_discrete(NULL)

```

Proportion of days with dewpoints at or below 0C (32F) by month are explored:  
```{r, fig.height=9, fig.width=9}

dewPDaily %>%
    mutate(gte68=(dewpoint_2m_mean>=20), 
           lte32=(dewpoint_2m_mean<=0), 
           year=year(date), 
           doy=yday(date)
           ) %>%
    filter(year < 2023) %>%
    group_by(fct_city, fct_mon) %>%
    summarize(gte68=mean(gte68), lte32=mean(lte32), .groups="drop") %>%
    ggplot(aes(x=fct_mon, y=lte32)) + 
    geom_col(fill="lightblue") +
    geom_text(aes(label=round(lte32,2)), size=2.5, vjust=0) +
    facet_wrap(~fct_city) + 
    labs(x=NULL, 
         y="Proportion of Days (2010-2022)", 
         title="Days with dewpoint <= 0C (32F)\n2010-2022"
         ) + 
    scale_color_discrete(NULL)

```

ACF is calculated for dew point for a single city:  
```{r, fig.height=9, fig.width=9}

dewPDaily %>% 
    filter(fct_city=="Chicago IL") %>% 
    arrange(date) %>% 
    select(dewpoint_2m_mean) %>% 
    acf(lag.max=1000, main="ACF for daily dewpoint - Chicago IL (2010-2022)")

```

ACF is calculated for dew point for each city:  
```{r, fig.height=9, fig.width=9}

dewCities <- dewPDaily %>% 
    pull(fct_city) %>% 
    as.vector() %>% 
    unique()

dewACF <- lapply(dewCities, 
                 FUN=function(x) {
                     dewPDaily %>% 
                         filter(fct_city==x) %>% 
                         arrange(date) %>% 
                         select(dewpoint_2m_mean) %>% 
                         acf(lag.max=2000, plot=FALSE)
                     }
                 )
names(dewACF) <- dewCities

```

ACF are combined into a single tibble:  
```{r, fig.height=9, fig.width=9}

dewACFAll <- map_dfr(.x=dewCities, 
                     .f=function(x) tibble::tibble(lag=as.vector(dewACF[[x]][["lag"]]), 
                                                   acf=as.vector(dewACF[[x]][["acf"]])
                                                   ), 
                     .id="src") %>% 
    mutate(cityName=dewCities[as.integer(src)])

dewACFAll

dewACFAll %>%
    filter(lag > 0) %>%
    group_by(cityName) %>%
    summarize(mu_abs_acf=mean(abs(acf))) %>%
    arrange(desc(mu_abs_acf))

```

ACF by city are plotted:  
```{r, fig.height=9, fig.width=9}

dewACFAll %>% 
    filter(lag>0) %>%
    ggplot(aes(x=lag, y=acf)) + 
    geom_line(aes(color=cityName, group=cityName), lwd=1) + 
    labs(x="Lag (zero excluded)", y="ACF", title="ACF of dewpoint by city") + 
    scale_color_discrete(NULL) + 
    lims(y=c(-1, 1))

```

PACF is calculated for dew point for a single city:  
```{r, fig.height=9, fig.width=9}

dewPDaily %>% 
    filter(fct_city=="Chicago IL") %>% 
    arrange(date) %>% 
    select(dewpoint_2m_mean) %>% 
    pacf(lag.max=1000, main="PACF for daily dewpoint - Chicago IL (2010-2022)")


dewPDaily %>% 
    filter(fct_city=="Chicago IL") %>% 
    arrange(date) %>% 
    select(dewpoint_2m_mean) %>% 
    pacf(lag.max=20, main="PACF for daily dewpoint - Chicago IL (2010-2022)")

```

PACF is calculated for dew point for each city:  
```{r, fig.height=9, fig.width=9}

dewPACF <- lapply(dewCities, 
                  FUN=function(x) {
                      dewPDaily %>% 
                          filter(fct_city==x) %>% 
                          arrange(date) %>% 
                          select(dewpoint_2m_mean) %>% 
                          pacf(lag.max=2000, plot=FALSE)
                      }
                  )
names(dewPACF) <- dewCities

```

PACF are combined into a single tibble:  
```{r, fig.height=9, fig.width=9}

dewPACFAll <- map_dfr(.x=dewCities, 
                      .f=function(x) tibble::tibble(lag=as.vector(dewPACF[[x]][["lag"]]), 
                                                    pacf=as.vector(dewPACF[[x]][["acf"]])
                                                   ), 
                      .id="src") %>% 
    mutate(cityName=dewCities[as.integer(src)])
dewPACFAll

dewPACFAll %>%
    filter(lag > 0) %>%
    group_by(cityName) %>%
    summarize(mu_abs_pacf=mean(abs(pacf))) %>%
    arrange(desc(mu_abs_pacf))

```

PACF by city are plotted:  
```{r, fig.height=9, fig.width=9}

dewPACFAll %>% 
    filter(lag>0) %>%
    ggplot(aes(x=lag, y=pacf)) + 
    geom_line(aes(color=cityName, group=cityName), lwd=1) + 
    labs(x="Lag (zero excluded)", y="PACF", title="PACF of dewpoint by city") + 
    scale_color_discrete(NULL) + 
    lims(y=c(-1, 1)) + 
    scale_x_log10()

```

A baseline ARIMA model is explored, starting with c(0, 0, 0):  
```{r, fig.height=9, fig.width=9}

tstARIMA <- lapply(dewCities, 
                   FUN=function(x) dewPDaily %>% 
                       filter(fct_city==x) %>% 
                       pull(dewpoint_2m_mean) %>% 
                       arima(order=c(0, 0, 0))
                   )
names(tstARIMA) <- dewCities

tibble::tibble(cityName=names(tstARIMA), 
               intercept=sapply(names(tstARIMA), FUN=function(x) tstARIMA[[x]]$coef),
               se=sapply(names(tstARIMA), FUN=function(x) tstARIMA[[x]]$var.coef %>% sqrt), 
               sigma2=sapply(names(tstARIMA), FUN=function(x) tstARIMA[[x]]$residuals %>% var),
               sigma=sqrt(sigma2)
               ) %>%
    arrange(sigma)

```

The ARIMA model is explored at c(1, 0, 0):  
```{r, fig.height=9, fig.width=9}

tstARIMA <- lapply(dewCities, 
                   FUN=function(x) dewPDaily %>% 
                       arrange(date) %>%
                       filter(fct_city==x) %>% 
                       pull(dewpoint_2m_mean) %>% 
                       arima(order=c(1, 0, 0))
                   )
names(tstARIMA) <- dewCities

tibble::tibble(cityName=names(tstARIMA), 
               sigma2=sapply(names(tstARIMA), FUN=function(x) tstARIMA[[x]]$residuals %>% var),
               sigma=sqrt(sigma2)
               ) %>%
    inner_join(sapply(names(tstARIMA), FUN=function(x) tstARIMA[[x]]$coef) %>%
                   t() %>%
                   as.data.frame() %>%
                   rownames_to_column("cityName") %>%
                   as_tibble(), 
               by="cityName"
    ) %>%
    arrange(sigma)

```

The ARIMA model is explored at c(0, 0, 1):  
```{r, fig.height=9, fig.width=9}

tstARIMA <- lapply(dewCities, 
                   FUN=function(x) dewPDaily %>% 
                       arrange(date) %>%
                       filter(fct_city==x) %>% 
                       pull(dewpoint_2m_mean) %>% 
                       arima(order=c(0, 0, 1))
                   )
names(tstARIMA) <- dewCities

tibble::tibble(cityName=names(tstARIMA), 
               sigma2=sapply(names(tstARIMA), FUN=function(x) tstARIMA[[x]]$residuals %>% var),
               sigma=sqrt(sigma2)
               ) %>%
    inner_join(sapply(names(tstARIMA), FUN=function(x) tstARIMA[[x]]$coef) %>%
                   t() %>%
                   as.data.frame() %>%
                   rownames_to_column("cityName") %>%
                   as_tibble(), 
               by="cityName"
    ) %>%
    arrange(sigma)

```

The ARIMA model is explored at c(1, 0, 1):  
```{r, fig.height=9, fig.width=9}

tstARIMA <- lapply(dewCities, 
                   FUN=function(x) dewPDaily %>% 
                       arrange(date) %>%
                       filter(fct_city==x) %>% 
                       pull(dewpoint_2m_mean) %>% 
                       arima(order=c(1, 0, 1))
                   )
names(tstARIMA) <- dewCities

tibble::tibble(cityName=names(tstARIMA), 
               sigma2=sapply(names(tstARIMA), FUN=function(x) tstARIMA[[x]]$residuals %>% var),
               sigma=sqrt(sigma2)
               ) %>%
    inner_join(sapply(names(tstARIMA), FUN=function(x) tstARIMA[[x]]$coef) %>%
                   t() %>%
                   as.data.frame() %>%
                   rownames_to_column("cityName") %>%
                   as_tibble(), 
               by="cityName"
    ) %>%
    arrange(sigma)

```

The ARIMA model is explored at c(2, 0, 0):  
```{r, fig.height=9, fig.width=9}

tstARIMA <- lapply(dewCities, 
                   FUN=function(x) dewPDaily %>% 
                       arrange(date) %>%
                       filter(fct_city==x) %>% 
                       pull(dewpoint_2m_mean) %>% 
                       arima(order=c(2, 0, 0))
                   )
names(tstARIMA) <- dewCities

tibble::tibble(cityName=names(tstARIMA), 
               sigma2=sapply(names(tstARIMA), FUN=function(x) tstARIMA[[x]]$residuals %>% var),
               sigma=sqrt(sigma2)
               ) %>%
    inner_join(sapply(names(tstARIMA), FUN=function(x) tstARIMA[[x]]$coef) %>%
                   t() %>%
                   as.data.frame() %>%
                   rownames_to_column("cityName") %>%
                   as_tibble(), 
               by="cityName"
    ) %>%
    arrange(sigma)

```

The auto.arima() process is run to estimate optimal parameters for a single city:  
```{r, fig.height=9, fig.width=9}

dewPDaily %>% 
    filter(fct_city=="Chicago IL") %>% 
    arrange(date) %>%
    pull(dewpoint_2m_mean) %>% 
    forecast::auto.arima()

```

The auto.arima() process is run to estimate optimal parameters for all cities:  
```{r, fig.height=9, fig.width=9}

tstARIMA <- lapply(dewCities, 
                   FUN=function(x) dewPDaily %>% 
                       arrange(date) %>%
                       filter(fct_city==x) %>% 
                       pull(dewpoint_2m_mean) %>% 
                       forecast::auto.arima()
                   )
names(tstARIMA) <- dewCities

```

The optimal model by city is pulled:  
```{r, fig.height=9, fig.width=9}

sapply(tstARIMA, 
       FUN=function(x) c(ar=x$arma[1], ma=x$arma[2], d=x$arma[6], sig2=round(x$sigma2,2))
       ) %>%
    t()

```

Sigma-squared is also explored:  
```{r, fig.height=9, fig.width=9}

cat("\n\nOptimal Parameters (ARIMA for daily mean dewpoint by city):\n")
sapply(tstARIMA, 
       FUN=function(x) c(ar=x$arma[1], ma=x$arma[2], d=x$arma[6], sig2=round(x$sigma2,2))
       ) %>%
    t() %>% 
    as.data.frame() %>% 
    rownames_to_column("cityName") %>% 
    full_join(dewPDaily %>% group_by(fct_city) %>% summarize(varOrig=var(dewpoint_2m_mean)), 
              by=c("cityName"="fct_city")
              ) %>% 
    mutate(pct=1-sig2/varOrig)

```

Rolling 21-day dewpoints by city are plotted:  
```{r, fig.height=9, fig.width=9}

dewPDaily %>% 
    mutate(doy=yday(date)) %>% 
    arrange(date) %>% 
    group_by(fct_city) %>% 
    helperRollingAgg(origVar="dewpoint_2m_mean", newName="dewpoint_r21", k=21) %>% 
    group_by(fct_city, doy) %>% 
    summarize(dewpoint_r21=mean(dewpoint_r21, na.rm=TRUE), .groups="drop") %>% 
    ggplot(aes(x=doy)) + 
    geom_line(aes(y=dewpoint_r21), lwd=2) + 
    geom_point(data=dewPDaily %>% mutate(doy=yday(date), year=year(date)) %>% arrange(date), 
               aes(y=dewpoint_2m_mean, group=year), 
               alpha=0.25, 
               size=0.1
               ) + 
    facet_wrap(~fct_city) + 
    labs(x="Day of year", 
         y="Dewpoint (C)", 
         title="Dewpoint by day of year\n(actual and rolling 21-day average)"
         )

```

Daily dewpoint data are converted to deviation from long-term rolling 21-day mean by day of year:  
```{r, fig.height=9, fig.width=9}

dewPDaily_vs_r21 <- dewPDaily %>% 
    mutate(doy=pmin(yday(date), 365), year=year(date)) %>% 
    left_join(dewPDaily %>% 
                  mutate(doy=pmin(yday(date),365)) %>% 
                  arrange(date) %>%
                  group_by(fct_city) %>% 
                  helperRollingAgg(origVar="dewpoint_2m_mean", newName="dewpoint_r21", k=21) %>% 
                  group_by(fct_city, doy) %>% 
                  summarize(dewpoint_r21=mean(dewpoint_r21, na.rm=TRUE), .groups="drop"), 
              by=c("fct_city", "doy")
              ) %>% 
    mutate(delta_r21=dewpoint_2m_mean-dewpoint_r21)

dewPDaily_vs_r21

summary(dewPDaily_vs_r21)

```

A baseline ARIMA model is explored, starting with c(0, 0, 0):  
```{r, fig.height=9, fig.width=9}

tstARIMA <- lapply(dewCities, 
                   FUN=function(x) dewPDaily_vs_r21 %>% 
                       arrange(date) %>%
                       filter(fct_city==x) %>% 
                       pull(delta_r21) %>% 
                       arima(order=c(0, 0, 0))
                   )
names(tstARIMA) <- dewCities

tibble::tibble(cityName=names(tstARIMA), 
               intercept=sapply(names(tstARIMA), FUN=function(x) tstARIMA[[x]]$coef),
               se=sapply(names(tstARIMA), FUN=function(x) tstARIMA[[x]]$var.coef %>% sqrt), 
               sigma2=sapply(names(tstARIMA), FUN=function(x) tstARIMA[[x]]$residuals %>% var),
               sigma=sqrt(sigma2)
               ) %>%
    arrange(sigma)

```

The ARIMA model is explored at c(1, 0, 0):  
```{r, fig.height=9, fig.width=9}

tstARIMA <- lapply(dewCities, 
                   FUN=function(x) dewPDaily_vs_r21 %>% 
                       arrange(date) %>%
                       filter(fct_city==x) %>% 
                       pull(delta_r21) %>% 
                       arima(order=c(1, 0, 0))
                   )
names(tstARIMA) <- dewCities

tibble::tibble(cityName=names(tstARIMA), 
               sigma2=sapply(names(tstARIMA), FUN=function(x) tstARIMA[[x]]$residuals %>% var),
               sigma=sqrt(sigma2)
               ) %>%
    inner_join(sapply(names(tstARIMA), FUN=function(x) tstARIMA[[x]]$coef) %>%
                   t() %>%
                   as.data.frame() %>%
                   rownames_to_column("cityName") %>%
                   as_tibble(), 
               by="cityName"
    ) %>%
    arrange(sigma)

```

The ARIMA model is explored at c(0, 0, 1):  
```{r, fig.height=9, fig.width=9}

tstARIMA <- lapply(dewCities, 
                   FUN=function(x) dewPDaily_vs_r21 %>% 
                       arrange(date) %>%
                       filter(fct_city==x) %>% 
                       pull(delta_r21) %>% 
                       arima(order=c(0, 0, 1))
                   )
names(tstARIMA) <- dewCities

tibble::tibble(cityName=names(tstARIMA), 
               sigma2=sapply(names(tstARIMA), FUN=function(x) tstARIMA[[x]]$residuals %>% var),
               sigma=sqrt(sigma2)
               ) %>%
    inner_join(sapply(names(tstARIMA), FUN=function(x) tstARIMA[[x]]$coef) %>%
                   t() %>%
                   as.data.frame() %>%
                   rownames_to_column("cityName") %>%
                   as_tibble(), 
               by="cityName"
    ) %>%
    arrange(sigma)

```

The ARIMA model is explored at c(1, 0, 1):  
```{r, fig.height=9, fig.width=9}

tstARIMA <- lapply(dewCities, 
                   FUN=function(x) dewPDaily_vs_r21 %>% 
                       arrange(date) %>%
                       filter(fct_city==x) %>% 
                       pull(delta_r21) %>% 
                       arima(order=c(1, 0, 1))
                   )
names(tstARIMA) <- dewCities

tibble::tibble(cityName=names(tstARIMA), 
               sigma2=sapply(names(tstARIMA), FUN=function(x) tstARIMA[[x]]$residuals %>% var),
               sigma=sqrt(sigma2)
               ) %>%
    inner_join(sapply(names(tstARIMA), FUN=function(x) tstARIMA[[x]]$coef) %>%
                   t() %>%
                   as.data.frame() %>%
                   rownames_to_column("cityName") %>%
                   as_tibble(), 
               by="cityName"
    ) %>%
    arrange(sigma)

```

The ARIMA model is explored at c(2, 0, 0):  
```{r, fig.height=9, fig.width=9}

tstARIMA <- lapply(dewCities, 
                   FUN=function(x) dewPDaily_vs_r21 %>% 
                       arrange(date) %>%
                       filter(fct_city==x) %>% 
                       pull(delta_r21) %>% 
                       arima(order=c(2, 0, 0))
                   )
names(tstARIMA) <- dewCities

tibble::tibble(cityName=names(tstARIMA), 
               sigma2=sapply(names(tstARIMA), FUN=function(x) tstARIMA[[x]]$residuals %>% var),
               sigma=sqrt(sigma2)
               ) %>%
    inner_join(sapply(names(tstARIMA), FUN=function(x) tstARIMA[[x]]$coef) %>%
                   t() %>%
                   as.data.frame() %>%
                   rownames_to_column("cityName") %>%
                   as_tibble(), 
               by="cityName"
    ) %>%
    arrange(sigma)

```

Sigma-squared for a single city is compared across models:  
```{r, fig.height=9, fig.width=9}

pdqList <- list("c(0, 0, 0)"=c(0, 0, 0), 
                "c(1, 0, 0)"=c(1, 0, 0), 
                "c(0, 0, 1)"=c(0, 0, 1), 
                "c(1, 0, 1)"=c(1, 0, 1), 
                "c(2, 0, 0)"=c(2, 0, 0)
                )

sapply(pdqList, FUN=function(pdq) lapply("Boston MA", FUN=function(x) { tmp<- dewPDaily_vs_r21 %>% 
                                             arrange(date) %>%
                                             filter(fct_city==x) %>% 
                                             pull(delta_r21) %>% 
                                             arima(x=., order=unname(pdq)); tmp$sigma2}
                                         )
       ) %>% 
    as_tibble() %>% 
    t()

```

Sigma-squared for all cities is compiled across models:  
```{r, fig.height=9, fig.width=9}

pdqList <- list("c(0, 0, 0)"=c(0, 0, 0), 
                "c(1, 0, 0)"=c(1, 0, 0), 
                "c(0, 0, 1)"=c(0, 0, 1), 
                "c(1, 0, 1)"=c(1, 0, 1), 
                "c(2, 0, 0)"=c(2, 0, 0)
                )

pdqAll <- sapply(pdqList, FUN=function(pdq) sapply(dewCities, 
                                                   FUN=function(x) { 
                                                       tmp<- dewPDaily_vs_r21 %>% 
                                                           arrange(date) %>%
                                                           filter(fct_city==x) %>% 
                                                           pull(delta_r21) %>% 
                                                           arima(x=., order=unname(pdq)) 
                                                       tmp$sigma2
                                                       }
                                                   )
                  ) %>%
    t() %>%
    as.data.frame() %>%
    rownames_to_column("ARIMA") %>%
    as_tibble()

pdqAll

```

Sigma-squared for all cities is plotted:  
```{r, fig.height=9, fig.width=9}

pdqAll %>% 
    pivot_longer(cols=-ARIMA, names_to="city") %>% 
    group_by(city) %>% 
    mutate(pct=value/max(value)) %>% 
    ungroup() %>% 
    ggplot(aes(x=fct_reorder(ARIMA, -pct), y=pct, fill=city)) + 
    facet_wrap(~city) + 
    geom_col() + 
    theme(legend.position = "none") + 
    geom_text(data=~filter(., pct<1), aes(y=pct/2, label=round(pct, 2)), size=3) + 
    labs(x="ARIMA(p, d, q)", 
         y="Sigma-squared\nrelative to ARIMA(0, 0, 0)", 
         title="Relative sigma-squared by model", 
         subtitle="(daily dewpoint vs. long-term 21-day mean for day of year)"
         )

```

The auto.arima() process is run to estimate optimal parameters for all cities:  
```{r, fig.height=9, fig.width=9}

tstARIMA <- lapply(dewCities, 
                   FUN=function(x) dewPDaily_vs_r21 %>% 
                       arrange(date) %>%
                       filter(fct_city==x) %>% 
                       pull(delta_r21) %>% 
                       forecast::auto.arima(d=0)
                   )
names(tstARIMA) <- dewCities

```

The auto.arima() parameters are pulled for all cities:  
```{r, fig.height=9, fig.width=9}

sapply(tstARIMA, 
       FUN=function(x) c(ar=x$arma[1], ma=x$arma[2], d=x$arma[6], sig2=round(x$sigma2,2))
       ) %>%
    t()

```

Sigma-squared for all cities is updated:  
```{r, fig.height=9, fig.width=9}

sapply(tstARIMA, 
       FUN=function(x) c(ar=x$arma[1], ma=x$arma[2], d=x$arma[6], sig2=round(x$sigma2,2))
       ) %>%
    t() %>% 
    as.data.frame() %>% 
    rownames_to_column("name") %>% 
    select(name, value=sig2) %>% 
    mutate(ARIMA="auto") %>% 
    pivot_wider(id_cols="ARIMA") %>% 
    bind_rows(pdqAll) %>% 
    pivot_longer(cols=-ARIMA, names_to="city") %>% 
    group_by(city) %>% 
    mutate(pct=value/max(value)) %>% 
    ungroup() %>% 
    ggplot(aes(x=fct_reorder(ARIMA, -pct), y=pct, fill=city)) + 
    facet_wrap(~city) + 
    geom_col() + 
    theme(legend.position = "none") + 
    geom_text(data=~filter(., pct<1), aes(y=pct/2, label=round(pct, 2)), size=3) + 
    labs(x="ARIMA(p, d, q)", 
         y="Sigma-squared\nrelative to ARIMA(0, 0, 0)", 
         title="Relative sigma-squared by model", 
         subtitle="(daily dewpoint vs. long-term 21-day mean for day of year)"
         )

```

Sigma-squared for all cities is updated, incuding the baseline:  
```{r, fig.height=9, fig.width=9}

sapply(tstARIMA, 
       FUN=function(x) c(ar=x$arma[1], ma=x$arma[2], d=x$arma[6], sig2=round(x$sigma2,2))
       ) %>%
    t() %>% 
    as.data.frame() %>% 
    rownames_to_column("name") %>% 
    select(name, value=sig2) %>% 
    mutate(ARIMA="auto") %>% 
    pivot_wider(id_cols="ARIMA") %>% 
    bind_rows(pdqAll) %>% 
    bind_rows(dewPDaily %>% 
                  group_by(fct_city) %>% 
                  summarize(value=var(dewpoint_2m_mean)) %>% 
                  mutate(ARIMA="base") %>% 
                  pivot_wider(id_cols="ARIMA", names_from="fct_city")
              ) %>%
    pivot_longer(cols=-ARIMA, names_to="city") %>% 
    group_by(city) %>% 
    mutate(pct=value/max(value)) %>% 
    ungroup() %>% 
    ggplot(aes(x=fct_reorder(ARIMA, -pct), y=pct, fill=city)) + 
    facet_wrap(~city) + 
    geom_col() + 
    theme(legend.position = "none") + 
    geom_text(data=~filter(., pct<1), aes(y=pct/2, label=round(pct, 2)), size=3) + 
    labs(x="ARIMA(p, d, q)", 
         y="Sigma-squared\nrelative to ARIMA(0, 0, 0)", 
         title="Relative sigma-squared by model", 
         subtitle="(daily dewpoint vs. long-term 21-day mean for day of year)",
         caption="base=daily dewpoint (no adjustmens)\nc(p, d, q) and auto are all vs. long-term 21-day mean"
    )

```

Lag/lead for dewpoint vs. 21-day mean is plotted:  
```{r, fig.height=9, fig.width=9}

dewPDaily_vs_r21 %>% 
    arrange(fct_city, date) %>% 
    group_by(fct_city) %>% 
    mutate(dewNext=lead(delta_r21)) %>% 
    ungroup() %>% 
    filter(complete.cases(.)) %>% 
    count(fct_city, delta_r21=round(delta_r21), dewNext=round(dewNext)) %>% 
    ggplot(aes(x=delta_r21, y=dewNext)) + 
    geom_point(aes(size=n), alpha=0.1) + 
    facet_wrap(~fct_city) + 
    geom_smooth(aes(weight=n), method="lm") + 
    annotate("point", x=0, y=0, color="red") + 
    geom_abline(intercept=0, slope=1, color="red", lty=2) + 
    labs(x="Dewpoint vs. long-term 21-day mean", 
         y="Next day's dewpoint vs. long-term 21-day mean", 
         title="Dewpoint vs. long-term 21-day mean by day of year and city"
         ) + 
    scale_size_continuous("# Obs")

```

Daily mean temperature data are converted to deviation from long-term rolling 21-day mean by day of year:  
```{r, fig.height=9, fig.width=9}

tempDaily_vs_r21 <- allCityDaily %>% 
    mutate(doy=pmin(yday(date), 365), 
           year=year(date), 
           meanTemp=0.5*(temperature_2m_max+temperature_2m_min), 
           fct_city=factor(cityName)
           ) %>% 
    select(fct_city, date, doy, year, meanTemp) %>%
    left_join(allCityDaily %>% 
                  mutate(doy=pmin(yday(date),365), 
                         meanTemp=0.5*(temperature_2m_max+temperature_2m_min),
                         fct_city=factor(cityName)
                         ) %>% 
                  arrange(date) %>%
                  group_by(fct_city) %>% 
                  helperRollingAgg(origVar="meanTemp", newName="temp_r21", k=21) %>% 
                  group_by(fct_city, doy) %>% 
                  summarize(temp_r21=mean(temp_r21, na.rm=TRUE), .groups="drop"), 
              by=c("fct_city", "doy")
              ) %>% 
    mutate(delta_r21=meanTemp-temp_r21)

tempDaily_vs_r21

summary(tempDaily_vs_r21)

```

A baseline ARIMA model is explored, starting with c(0, 0, 0):  
```{r, fig.height=9, fig.width=9}

tstARIMA <- lapply(dewCities, 
                   FUN=function(x) tempDaily_vs_r21 %>% 
                       arrange(date) %>%
                       filter(fct_city==x) %>% 
                       pull(delta_r21) %>% 
                       arima(order=c(0, 0, 0))
                   )
names(tstARIMA) <- dewCities

tibble::tibble(cityName=names(tstARIMA), 
               intercept=sapply(names(tstARIMA), FUN=function(x) tstARIMA[[x]]$coef),
               se=sapply(names(tstARIMA), FUN=function(x) tstARIMA[[x]]$var.coef %>% sqrt), 
               sigma2=sapply(names(tstARIMA), FUN=function(x) tstARIMA[[x]]$residuals %>% var),
               sigma=sqrt(sigma2)
               ) %>%
    arrange(sigma)

```

Lag/lead for temperature vs. 21-day mean is plotted:  
```{r, fig.height=9, fig.width=9}

tempDaily_vs_r21 %>% 
    arrange(fct_city, date) %>% 
    group_by(fct_city) %>% 
    mutate(tempNext=lead(delta_r21)) %>% 
    ungroup() %>% 
    filter(complete.cases(.)) %>% 
    count(fct_city, delta_r21=round(delta_r21), tempNext=round(tempNext)) %>% 
    ggplot(aes(x=delta_r21, y=tempNext)) + 
    geom_point(aes(size=n), alpha=0.1) + 
    facet_wrap(~fct_city) + 
    geom_smooth(aes(weight=n), method="lm") + 
    annotate("point", x=0, y=0, color="red") + 
    geom_abline(intercept=0, slope=1, color="red", lty=2) + 
    labs(x="Temperature vs. long-term 21-day mean", 
         y="Next day's temperature vs. long-term 21-day mean", 
         title="Temperature vs. long-term 21-day mean by day of year and city"
         ) + 
    scale_size_continuous("# Obs")

```

The ARIMA model is explored at c(1, 0, 0):  
```{r, fig.height=9, fig.width=9}

tstARIMA <- lapply(dewCities, 
                   FUN=function(x) tempDaily_vs_r21 %>% 
                       arrange(date) %>%
                       filter(fct_city==x) %>% 
                       pull(delta_r21) %>% 
                       arima(order=c(1, 0, 0))
                   )
names(tstARIMA) <- dewCities

tibble::tibble(cityName=names(tstARIMA), 
               sigma2=sapply(names(tstARIMA), FUN=function(x) tstARIMA[[x]]$residuals %>% var),
               sigma=sqrt(sigma2)
               ) %>%
    inner_join(sapply(names(tstARIMA), FUN=function(x) tstARIMA[[x]]$coef) %>%
                   t() %>%
                   as.data.frame() %>%
                   rownames_to_column("cityName") %>%
                   as_tibble(), 
               by="cityName"
    ) %>%
    arrange(sigma)

```

The ARIMA model is explored at c(0, 0, 1):  
```{r, fig.height=9, fig.width=9}

tstARIMA <- lapply(dewCities, 
                   FUN=function(x) tempDaily_vs_r21 %>% 
                       arrange(date) %>%
                       filter(fct_city==x) %>% 
                       pull(delta_r21) %>% 
                       arima(order=c(0, 0, 1))
                   )
names(tstARIMA) <- dewCities

tibble::tibble(cityName=names(tstARIMA), 
               sigma2=sapply(names(tstARIMA), FUN=function(x) tstARIMA[[x]]$residuals %>% var),
               sigma=sqrt(sigma2)
               ) %>%
    inner_join(sapply(names(tstARIMA), FUN=function(x) tstARIMA[[x]]$coef) %>%
                   t() %>%
                   as.data.frame() %>%
                   rownames_to_column("cityName") %>%
                   as_tibble(), 
               by="cityName"
    ) %>%
    arrange(sigma)

```

The ARIMA model is explored at c(1, 0, 1):  
```{r, fig.height=9, fig.width=9}

tstARIMA <- lapply(dewCities, 
                   FUN=function(x) tempDaily_vs_r21 %>% 
                       arrange(date) %>%
                       filter(fct_city==x) %>% 
                       pull(delta_r21) %>% 
                       arima(order=c(1, 0, 1))
                   )
names(tstARIMA) <- dewCities

tibble::tibble(cityName=names(tstARIMA), 
               sigma2=sapply(names(tstARIMA), FUN=function(x) tstARIMA[[x]]$residuals %>% var),
               sigma=sqrt(sigma2)
               ) %>%
    inner_join(sapply(names(tstARIMA), FUN=function(x) tstARIMA[[x]]$coef) %>%
                   t() %>%
                   as.data.frame() %>%
                   rownames_to_column("cityName") %>%
                   as_tibble(), 
               by="cityName"
    ) %>%
    arrange(sigma)

```

The ARIMA model is explored at c(2, 0, 0):  
```{r, fig.height=9, fig.width=9}

tstARIMA <- lapply(dewCities, 
                   FUN=function(x) tempDaily_vs_r21 %>% 
                       arrange(date) %>%
                       filter(fct_city==x) %>% 
                       pull(delta_r21) %>% 
                       arima(order=c(2, 0, 0))
                   )
names(tstARIMA) <- dewCities

tibble::tibble(cityName=names(tstARIMA), 
               sigma2=sapply(names(tstARIMA), FUN=function(x) tstARIMA[[x]]$residuals %>% var),
               sigma=sqrt(sigma2)
               ) %>%
    inner_join(sapply(names(tstARIMA), FUN=function(x) tstARIMA[[x]]$coef) %>%
                   t() %>%
                   as.data.frame() %>%
                   rownames_to_column("cityName") %>%
                   as_tibble(), 
               by="cityName"
    ) %>%
    arrange(sigma)

```

Sigma-squared for all cities is compiled across models:  
```{r, fig.height=9, fig.width=9}

pdqList <- list("c(0, 0, 0)"=c(0, 0, 0), 
                "c(1, 0, 0)"=c(1, 0, 0), 
                "c(0, 0, 1)"=c(0, 0, 1), 
                "c(1, 0, 1)"=c(1, 0, 1), 
                "c(2, 0, 0)"=c(2, 0, 0)
                )

pdqAll <- sapply(pdqList, FUN=function(pdq) sapply(dewCities, 
                                                   FUN=function(x) { 
                                                       tmp<- tempDaily_vs_r21 %>% 
                                                           arrange(date) %>%
                                                           filter(fct_city==x) %>% 
                                                           pull(delta_r21) %>% 
                                                           arima(x=., order=unname(pdq)) 
                                                       tmp$sigma2
                                                       }
                                                   )
                  ) %>%
    t() %>%
    as.data.frame() %>%
    rownames_to_column("ARIMA") %>%
    as_tibble()

pdqAll

```

Sigma-squared for all cities is plotted:  
```{r, fig.height=9, fig.width=9}

pdqAll %>% 
    pivot_longer(cols=-ARIMA, names_to="city") %>% 
    group_by(city) %>% 
    mutate(pct=value/max(value)) %>% 
    ungroup() %>% 
    ggplot(aes(x=fct_reorder(ARIMA, -pct), y=pct, fill=city)) + 
    facet_wrap(~city) + 
    geom_col() + 
    theme(legend.position = "none") + 
    geom_text(data=~filter(., pct<1), aes(y=pct/2, label=round(pct, 2)), size=3) + 
    labs(x="ARIMA(p, d, q)", 
         y="Sigma-squared\nrelative to ARIMA(0, 0, 0)", 
         title="Relative sigma-squared by model", 
         subtitle="(daily temperature vs. long-term 21-day mean for day of year)"
         )

```

The auto.arima() process is run to estimate optimal parameters for all cities:  
```{r, fig.height=9, fig.width=9}

tstARIMA <- lapply(dewCities, 
                   FUN=function(x) tempDaily_vs_r21 %>% 
                       arrange(date) %>%
                       filter(fct_city==x) %>% 
                       pull(delta_r21) %>% 
                       forecast::auto.arima(d=0)
                   )
names(tstARIMA) <- dewCities

```

The auto.arima() parameters are pulled for all cities:  
```{r, fig.height=9, fig.width=9}

sapply(tstARIMA, 
       FUN=function(x) c(ar=x$arma[1], ma=x$arma[2], d=x$arma[6], sig2=round(x$sigma2,2))
       ) %>%
    t()

```

Sigma-squared for all cities is updated:  
```{r, fig.height=9, fig.width=9}

sapply(tstARIMA, 
       FUN=function(x) c(ar=x$arma[1], ma=x$arma[2], d=x$arma[6], sig2=round(x$sigma2,2))
       ) %>%
    t() %>% 
    as.data.frame() %>% 
    rownames_to_column("name") %>% 
    select(name, value=sig2) %>% 
    mutate(ARIMA="auto") %>% 
    pivot_wider(id_cols="ARIMA") %>% 
    bind_rows(pdqAll) %>% 
    pivot_longer(cols=-ARIMA, names_to="city") %>% 
    group_by(city) %>% 
    mutate(pct=value/max(value)) %>% 
    ungroup() %>% 
    ggplot(aes(x=fct_reorder(ARIMA, -pct), y=pct, fill=city)) + 
    facet_wrap(~city) + 
    geom_col() + 
    theme(legend.position = "none") + 
    geom_text(data=~filter(., pct<1), aes(y=pct/2, label=round(pct, 2)), size=3) + 
    labs(x="ARIMA(p, d, q)", 
         y="Sigma-squared\nrelative to ARIMA(0, 0, 0)", 
         title="Relative sigma-squared by model", 
         subtitle="(daily temperature vs. long-term 21-day mean for day of year)"
         )

```

Sigma-squared for all cities is updated, incuding the baseline:  
```{r, fig.height=9, fig.width=9}

sapply(tstARIMA, 
       FUN=function(x) c(ar=x$arma[1], ma=x$arma[2], d=x$arma[6], sig2=round(x$sigma2,2))
       ) %>%
    t() %>% 
    as.data.frame() %>% 
    rownames_to_column("name") %>% 
    select(name, value=sig2) %>% 
    mutate(ARIMA="auto") %>% 
    pivot_wider(id_cols="ARIMA") %>% 
    bind_rows(pdqAll) %>% 
    bind_rows(tempDaily_vs_r21 %>% 
                  group_by(fct_city) %>% 
                  summarize(value=var(meanTemp)) %>% 
                  mutate(ARIMA="base") %>% 
                  pivot_wider(id_cols="ARIMA", names_from="fct_city")
              ) %>%
    pivot_longer(cols=-ARIMA, names_to="city") %>% 
    group_by(city) %>% 
    mutate(pct=value/max(value)) %>% 
    ungroup() %>% 
    ggplot(aes(x=fct_reorder(ARIMA, -pct), y=pct, fill=city)) + 
    facet_wrap(~city) + 
    geom_col() + 
    theme(legend.position = "none") + 
    geom_text(data=~filter(., pct<1), aes(y=pct/2, label=round(pct, 2)), size=3) + 
    labs(x="ARIMA(p, d, q)", 
         y="Sigma-squared\nrelative to ARIMA(0, 0, 0)", 
         title="Relative sigma-squared by model", 
         subtitle="(daily temperature vs. long-term 21-day mean for day of year)",
         caption="base=daily temperature (no adjustmens)\nc(p, d, q) and auto are all vs. long-term 21-day mean"
    )

```

Daily maximum wind speed data are converted to deviation from long-term rolling 21-day mean by day of year:  
```{r, fig.height=9, fig.width=9}

windDaily_vs_r21 <- allCityDaily %>% 
    mutate(doy=pmin(yday(date), 365), 
           year=year(date), 
           maxWind=windspeed_10m_max, 
           fct_city=factor(cityName)
           ) %>% 
    select(fct_city, date, doy, year, maxWind) %>%
    left_join(allCityDaily %>% 
                  mutate(doy=pmin(yday(date),365), 
                         maxWind=windspeed_10m_max, 
                         fct_city=factor(cityName)
                         ) %>% 
                  arrange(date) %>%
                  group_by(fct_city) %>% 
                  helperRollingAgg(origVar="maxWind", newName="wind_r21", k=21) %>% 
                  group_by(fct_city, doy) %>% 
                  summarize(wind_r21=mean(wind_r21, na.rm=TRUE), .groups="drop"), 
              by=c("fct_city", "doy")
              ) %>% 
    mutate(delta_r21=maxWind-wind_r21)

windDaily_vs_r21

summary(windDaily_vs_r21)

```

Lag/lead for maximum wind speed vs. 21-day mean is plotted:  
```{r, fig.height=9, fig.width=9}

windDaily_vs_r21 %>% 
    arrange(fct_city, date) %>% 
    group_by(fct_city) %>% 
    mutate(windNext=lead(delta_r21)) %>% 
    ungroup() %>% 
    filter(complete.cases(.)) %>% 
    count(fct_city, delta_r21=round(delta_r21), windNext=round(windNext)) %>% 
    ggplot(aes(x=delta_r21, y=windNext)) + 
    geom_point(aes(size=n), alpha=0.1) + 
    facet_wrap(~fct_city) + 
    geom_smooth(aes(weight=n), method="lm") + 
    annotate("point", x=0, y=0, color="red") + 
    geom_abline(intercept=0, slope=1, color="red", lty=2) + 
    labs(x="Maximum wind speed vs. long-term 21-day mean", 
         y="Next day's maximum wind speed vs. long-term 21-day mean", 
         title="Maximum wind speed vs. long-term 21-day mean by day of year and city"
         ) + 
    scale_size_continuous("# Obs")

```

A baseline ARIMA model is explored, starting with c(0, 0, 0):  
```{r, fig.height=9, fig.width=9}

tstARIMA <- lapply(dewCities, 
                   FUN=function(x) windDaily_vs_r21 %>% 
                       arrange(date) %>%
                       filter(fct_city==x) %>% 
                       pull(delta_r21) %>% 
                       arima(order=c(0, 0, 0))
                   )
names(tstARIMA) <- dewCities

tibble::tibble(cityName=names(tstARIMA), 
               intercept=sapply(names(tstARIMA), FUN=function(x) tstARIMA[[x]]$coef),
               se=sapply(names(tstARIMA), FUN=function(x) tstARIMA[[x]]$var.coef %>% sqrt), 
               sigma2=sapply(names(tstARIMA), FUN=function(x) tstARIMA[[x]]$residuals %>% var),
               sigma=sqrt(sigma2)
               ) %>%
    arrange(sigma)

```

The ARIMA model is explored at c(1, 0, 0):  
```{r, fig.height=9, fig.width=9}

tstARIMA <- lapply(dewCities, 
                   FUN=function(x) windDaily_vs_r21 %>% 
                       arrange(date) %>%
                       filter(fct_city==x) %>% 
                       pull(delta_r21) %>% 
                       arima(order=c(1, 0, 0))
                   )
names(tstARIMA) <- dewCities

tibble::tibble(cityName=names(tstARIMA), 
               sigma2=sapply(names(tstARIMA), FUN=function(x) tstARIMA[[x]]$residuals %>% var),
               sigma=sqrt(sigma2)
               ) %>%
    inner_join(sapply(names(tstARIMA), FUN=function(x) tstARIMA[[x]]$coef) %>%
                   t() %>%
                   as.data.frame() %>%
                   rownames_to_column("cityName") %>%
                   as_tibble(), 
               by="cityName"
    ) %>%
    arrange(sigma)

```

The ARIMA model is explored at c(0, 0, 1):  
```{r, fig.height=9, fig.width=9}

tstARIMA <- lapply(dewCities, 
                   FUN=function(x) windDaily_vs_r21 %>% 
                       arrange(date) %>%
                       filter(fct_city==x) %>% 
                       pull(delta_r21) %>% 
                       arima(order=c(0, 0, 1))
                   )
names(tstARIMA) <- dewCities

tibble::tibble(cityName=names(tstARIMA), 
               sigma2=sapply(names(tstARIMA), FUN=function(x) tstARIMA[[x]]$residuals %>% var),
               sigma=sqrt(sigma2)
               ) %>%
    inner_join(sapply(names(tstARIMA), FUN=function(x) tstARIMA[[x]]$coef) %>%
                   t() %>%
                   as.data.frame() %>%
                   rownames_to_column("cityName") %>%
                   as_tibble(), 
               by="cityName"
    ) %>%
    arrange(sigma)

```

The ARIMA model is explored at c(1, 0, 1):  
```{r, fig.height=9, fig.width=9}

tstARIMA <- lapply(dewCities, 
                   FUN=function(x) windDaily_vs_r21 %>% 
                       arrange(date) %>%
                       filter(fct_city==x) %>% 
                       pull(delta_r21) %>% 
                       arima(order=c(1, 0, 1))
                   )
names(tstARIMA) <- dewCities

tibble::tibble(cityName=names(tstARIMA), 
               sigma2=sapply(names(tstARIMA), FUN=function(x) tstARIMA[[x]]$residuals %>% var),
               sigma=sqrt(sigma2)
               ) %>%
    inner_join(sapply(names(tstARIMA), FUN=function(x) tstARIMA[[x]]$coef) %>%
                   t() %>%
                   as.data.frame() %>%
                   rownames_to_column("cityName") %>%
                   as_tibble(), 
               by="cityName"
    ) %>%
    arrange(sigma)

```

The ARIMA model is explored at c(2, 0, 0):  
```{r, fig.height=9, fig.width=9}

tstARIMA <- lapply(dewCities, 
                   FUN=function(x) windDaily_vs_r21 %>% 
                       arrange(date) %>%
                       filter(fct_city==x) %>% 
                       pull(delta_r21) %>% 
                       arima(order=c(2, 0, 0))
                   )
names(tstARIMA) <- dewCities

tibble::tibble(cityName=names(tstARIMA), 
               sigma2=sapply(names(tstARIMA), FUN=function(x) tstARIMA[[x]]$residuals %>% var),
               sigma=sqrt(sigma2)
               ) %>%
    inner_join(sapply(names(tstARIMA), FUN=function(x) tstARIMA[[x]]$coef) %>%
                   t() %>%
                   as.data.frame() %>%
                   rownames_to_column("cityName") %>%
                   as_tibble(), 
               by="cityName"
    ) %>%
    arrange(sigma)

```

Sigma-squared for all cities is compiled across models:  
```{r, fig.height=9, fig.width=9}

pdqList <- list("c(0, 0, 0)"=c(0, 0, 0), 
                "c(1, 0, 0)"=c(1, 0, 0), 
                "c(0, 0, 1)"=c(0, 0, 1), 
                "c(1, 0, 1)"=c(1, 0, 1), 
                "c(2, 0, 0)"=c(2, 0, 0)
                )

pdqAll <- sapply(pdqList, FUN=function(pdq) sapply(dewCities, 
                                                   FUN=function(x) { 
                                                       tmp<- windDaily_vs_r21 %>% 
                                                           arrange(date) %>%
                                                           filter(fct_city==x) %>% 
                                                           pull(delta_r21) %>% 
                                                           arima(x=., order=unname(pdq)) 
                                                       tmp$sigma2
                                                       }
                                                   )
                  ) %>%
    t() %>%
    as.data.frame() %>%
    rownames_to_column("ARIMA") %>%
    as_tibble()

pdqAll

```

Sigma-squared for all cities is plotted:  
```{r, fig.height=9, fig.width=9}

pdqAll %>% 
    pivot_longer(cols=-ARIMA, names_to="city") %>% 
    group_by(city) %>% 
    mutate(pct=value/max(value)) %>% 
    ungroup() %>% 
    ggplot(aes(x=fct_reorder(ARIMA, -pct), y=pct, fill=city)) + 
    facet_wrap(~city) + 
    geom_col() + 
    theme(legend.position = "none") + 
    geom_text(data=~filter(., pct<1), aes(y=pct/2, label=round(pct, 2)), size=3) + 
    labs(x="ARIMA(p, d, q)", 
         y="Sigma-squared\nrelative to ARIMA(0, 0, 0)", 
         title="Relative sigma-squared by model", 
         subtitle="(daily maximum wind speed vs. long-term 21-day mean for day of year)"
         )

```

The auto.arima() process is run to estimate optimal parameters for all cities:  
```{r, fig.height=9, fig.width=9}

tstARIMA <- lapply(dewCities, 
                   FUN=function(x) windDaily_vs_r21 %>% 
                       arrange(date) %>%
                       filter(fct_city==x) %>% 
                       pull(delta_r21) %>% 
                       forecast::auto.arima(d=0)
                   )
names(tstARIMA) <- dewCities

```

The auto.arima() parameters are pulled for all cities:  
```{r, fig.height=9, fig.width=9}

sapply(tstARIMA, 
       FUN=function(x) c(ar=x$arma[1], ma=x$arma[2], d=x$arma[6], sig2=round(x$sigma2,2))
       ) %>%
    t()

```

Sigma-squared for all cities is updated:  
```{r, fig.height=9, fig.width=9}

sapply(tstARIMA, 
       FUN=function(x) c(ar=x$arma[1], ma=x$arma[2], d=x$arma[6], sig2=round(x$sigma2,2))
       ) %>%
    t() %>% 
    as.data.frame() %>% 
    rownames_to_column("name") %>% 
    select(name, value=sig2) %>% 
    mutate(ARIMA="auto") %>% 
    pivot_wider(id_cols="ARIMA") %>% 
    bind_rows(pdqAll) %>% 
    pivot_longer(cols=-ARIMA, names_to="city") %>% 
    group_by(city) %>% 
    mutate(pct=value/max(value)) %>% 
    ungroup() %>% 
    ggplot(aes(x=fct_reorder(ARIMA, -pct), y=pct, fill=city)) + 
    facet_wrap(~city) + 
    geom_col() + 
    theme(legend.position = "none") + 
    geom_text(data=~filter(., pct<1), aes(y=pct/2, label=round(pct, 2)), size=3) + 
    labs(x="ARIMA(p, d, q)", 
         y="Sigma-squared\nrelative to ARIMA(0, 0, 0)", 
         title="Relative sigma-squared by model", 
         subtitle="(daily maximum wind speed vs. long-term 21-day mean for day of year)"
         )

```

Sigma-squared for all cities is updated, incuding the baseline:  
```{r, fig.height=9, fig.width=9}

sapply(tstARIMA, 
       FUN=function(x) c(ar=x$arma[1], ma=x$arma[2], d=x$arma[6], sig2=round(x$sigma2,2))
       ) %>%
    t() %>% 
    as.data.frame() %>% 
    rownames_to_column("name") %>% 
    select(name, value=sig2) %>% 
    mutate(ARIMA="auto") %>% 
    pivot_wider(id_cols="ARIMA") %>% 
    bind_rows(pdqAll) %>% 
    bind_rows(windDaily_vs_r21 %>% 
                  group_by(fct_city) %>% 
                  summarize(value=var(maxWind)) %>% 
                  mutate(ARIMA="base") %>% 
                  pivot_wider(id_cols="ARIMA", names_from="fct_city")
              ) %>%
    pivot_longer(cols=-ARIMA, names_to="city") %>% 
    group_by(city) %>% 
    mutate(pct=value/max(value)) %>% 
    ungroup() %>% 
    ggplot(aes(x=fct_reorder(ARIMA, -pct), y=pct, fill=city)) + 
    facet_wrap(~city) + 
    geom_col() + 
    theme(legend.position = "none") + 
    geom_text(data=~filter(., pct<1), aes(y=pct/2, label=round(pct, 2)), size=3) + 
    labs(x="ARIMA(p, d, q)", 
         y="Sigma-squared\nrelative to ARIMA(0, 0, 0)", 
         title="Relative sigma-squared by model", 
         subtitle="(daily maximum wind speed vs. long-term 21-day mean for day of year)",
         caption="base=daily max wind speed (no adjustmens)\nc(p, d, q) and auto are all vs. long-term 21-day mean"
    )

```

Daily precipitation data are converted to deviation from long-term rolling 21-day mean by day of year:  
```{r, fig.height=9, fig.width=9}

precipDaily_vs_r21 <- allCityDaily %>% 
    mutate(doy=pmin(yday(date), 365), 
           year=year(date), 
           sumPrecip=precipitation_sum, 
           fct_city=factor(cityName)
           ) %>% 
    select(fct_city, date, doy, year, sumPrecip) %>%
    left_join(allCityDaily %>% 
                  mutate(doy=pmin(yday(date),365), 
                         sumPrecip=precipitation_sum, 
                         fct_city=factor(cityName)
                         ) %>% 
                  arrange(date) %>%
                  group_by(fct_city) %>% 
                  helperRollingAgg(origVar="sumPrecip", newName="precip_r21", k=21) %>% 
                  group_by(fct_city, doy) %>% 
                  summarize(precip_r21=mean(precip_r21, na.rm=TRUE), .groups="drop"), 
              by=c("fct_city", "doy")
              ) %>% 
    mutate(delta_r21=sumPrecip-precip_r21)

precipDaily_vs_r21

summary(precipDaily_vs_r21)

```

Lag/lead for precipitation vs. 21-day mean is plotted:  
```{r, fig.height=9, fig.width=9}

precipDaily_vs_r21 %>% 
    arrange(fct_city, date) %>% 
    group_by(fct_city) %>% 
    mutate(precipNext=lead(delta_r21)) %>% 
    ungroup() %>% 
    filter(complete.cases(.)) %>% 
    count(fct_city, delta_r21=round(delta_r21), precipNext=round(precipNext)) %>% 
    ggplot(aes(x=delta_r21, y=precipNext)) + 
    geom_point(aes(size=n), alpha=0.1) + 
    facet_wrap(~fct_city) + 
    geom_smooth(aes(weight=n), method="lm") + 
    annotate("point", x=0, y=0, color="red") + 
    geom_abline(intercept=0, slope=1, color="red", lty=2) + 
    labs(x="Precipitation vs. long-term 21-day mean", 
         y="Next day's precipitation vs. long-term 21-day mean", 
         title="Precipitation vs. long-term 21-day mean by day of year and city"
         ) + 
    scale_size_continuous("# Obs")

```

A baseline ARIMA model is explored, starting with c(0, 0, 0):  
```{r, fig.height=9, fig.width=9}

tstARIMA <- lapply(dewCities, 
                   FUN=function(x) precipDaily_vs_r21 %>% 
                       arrange(date) %>%
                       filter(fct_city==x) %>% 
                       pull(delta_r21) %>% 
                       arima(order=c(0, 0, 0))
                   )
names(tstARIMA) <- dewCities

tibble::tibble(cityName=names(tstARIMA), 
               intercept=sapply(names(tstARIMA), FUN=function(x) tstARIMA[[x]]$coef),
               se=sapply(names(tstARIMA), FUN=function(x) tstARIMA[[x]]$var.coef %>% sqrt), 
               sigma2=sapply(names(tstARIMA), FUN=function(x) tstARIMA[[x]]$residuals %>% var),
               sigma=sqrt(sigma2)
               ) %>%
    arrange(sigma)

```

The ARIMA model is explored at c(1, 0, 0):  
```{r, fig.height=9, fig.width=9}

tstARIMA <- lapply(dewCities, 
                   FUN=function(x) precipDaily_vs_r21 %>% 
                       arrange(date) %>%
                       filter(fct_city==x) %>% 
                       pull(delta_r21) %>% 
                       arima(order=c(1, 0, 0))
                   )
names(tstARIMA) <- dewCities

tibble::tibble(cityName=names(tstARIMA), 
               sigma2=sapply(names(tstARIMA), FUN=function(x) tstARIMA[[x]]$residuals %>% var),
               sigma=sqrt(sigma2)
               ) %>%
    inner_join(sapply(names(tstARIMA), FUN=function(x) tstARIMA[[x]]$coef) %>%
                   t() %>%
                   as.data.frame() %>%
                   rownames_to_column("cityName") %>%
                   as_tibble(), 
               by="cityName"
    ) %>%
    arrange(sigma)

```

The ARIMA model is explored at c(0, 0, 1):  
```{r, fig.height=9, fig.width=9}

tstARIMA <- lapply(dewCities, 
                   FUN=function(x) precipDaily_vs_r21 %>% 
                       arrange(date) %>%
                       filter(fct_city==x) %>% 
                       pull(delta_r21) %>% 
                       arima(order=c(0, 0, 1))
                   )
names(tstARIMA) <- dewCities

tibble::tibble(cityName=names(tstARIMA), 
               sigma2=sapply(names(tstARIMA), FUN=function(x) tstARIMA[[x]]$residuals %>% var),
               sigma=sqrt(sigma2)
               ) %>%
    inner_join(sapply(names(tstARIMA), FUN=function(x) tstARIMA[[x]]$coef) %>%
                   t() %>%
                   as.data.frame() %>%
                   rownames_to_column("cityName") %>%
                   as_tibble(), 
               by="cityName"
    ) %>%
    arrange(sigma)

```

The ARIMA model is explored at c(1, 0, 1):  
```{r, fig.height=9, fig.width=9}

tstARIMA <- lapply(dewCities, 
                   FUN=function(x) precipDaily_vs_r21 %>% 
                       arrange(date) %>%
                       filter(fct_city==x) %>% 
                       pull(delta_r21) %>% 
                       arima(order=c(1, 0, 1))
                   )
names(tstARIMA) <- dewCities

tibble::tibble(cityName=names(tstARIMA), 
               sigma2=sapply(names(tstARIMA), FUN=function(x) tstARIMA[[x]]$residuals %>% var),
               sigma=sqrt(sigma2)
               ) %>%
    inner_join(sapply(names(tstARIMA), FUN=function(x) tstARIMA[[x]]$coef) %>%
                   t() %>%
                   as.data.frame() %>%
                   rownames_to_column("cityName") %>%
                   as_tibble(), 
               by="cityName"
    ) %>%
    arrange(sigma)

```

The ARIMA model is explored at c(2, 0, 0):  
```{r, fig.height=9, fig.width=9}

tstARIMA <- lapply(dewCities, 
                   FUN=function(x) precipDaily_vs_r21 %>% 
                       arrange(date) %>%
                       filter(fct_city==x) %>% 
                       pull(delta_r21) %>% 
                       arima(order=c(2, 0, 0))
                   )
names(tstARIMA) <- dewCities

tibble::tibble(cityName=names(tstARIMA), 
               sigma2=sapply(names(tstARIMA), FUN=function(x) tstARIMA[[x]]$residuals %>% var),
               sigma=sqrt(sigma2)
               ) %>%
    inner_join(sapply(names(tstARIMA), FUN=function(x) tstARIMA[[x]]$coef) %>%
                   t() %>%
                   as.data.frame() %>%
                   rownames_to_column("cityName") %>%
                   as_tibble(), 
               by="cityName"
    ) %>%
    arrange(sigma)

```

Sigma-squared for all cities is compiled across models:  
```{r, fig.height=9, fig.width=9}

pdqList <- list("c(0, 0, 0)"=c(0, 0, 0), 
                "c(1, 0, 0)"=c(1, 0, 0), 
                "c(0, 0, 1)"=c(0, 0, 1), 
                "c(1, 0, 1)"=c(1, 0, 1), 
                "c(2, 0, 0)"=c(2, 0, 0)
                )

pdqAll <- sapply(pdqList, FUN=function(pdq) sapply(dewCities, 
                                                   FUN=function(x) { 
                                                       tmp<- precipDaily_vs_r21 %>% 
                                                           arrange(date) %>%
                                                           filter(fct_city==x) %>% 
                                                           pull(delta_r21) %>% 
                                                           arima(x=., order=unname(pdq)) 
                                                       tmp$sigma2
                                                       }
                                                   )
                  ) %>%
    t() %>%
    as.data.frame() %>%
    rownames_to_column("ARIMA") %>%
    as_tibble()

pdqAll

```

Sigma-squared for all cities is plotted:  
```{r, fig.height=9, fig.width=9}

pdqAll %>% 
    pivot_longer(cols=-ARIMA, names_to="city") %>% 
    group_by(city) %>% 
    mutate(pct=value/max(value)) %>% 
    ungroup() %>% 
    ggplot(aes(x=fct_reorder(ARIMA, -pct), y=pct, fill=city)) + 
    facet_wrap(~city) + 
    geom_col() + 
    theme(legend.position = "none") + 
    geom_text(data=~filter(., pct<1), aes(y=pct/2, label=round(pct, 2)), size=3) + 
    labs(x="ARIMA(p, d, q)", 
         y="Sigma-squared\nrelative to ARIMA(0, 0, 0)", 
         title="Relative sigma-squared by model", 
         subtitle="(daily precipitation vs. long-term 21-day mean for day of year)"
         )

```

The auto.arima() process is run to estimate optimal parameters for all cities:  
```{r, fig.height=9, fig.width=9}

tstARIMA <- lapply(dewCities, 
                   FUN=function(x) precipDaily_vs_r21 %>% 
                       arrange(date) %>%
                       filter(fct_city==x) %>% 
                       pull(delta_r21) %>% 
                       forecast::auto.arima(d=0)
                   )
names(tstARIMA) <- dewCities

```

The auto.arima() parameters are pulled for all cities:  
```{r, fig.height=9, fig.width=9}

sapply(tstARIMA, 
       FUN=function(x) c(ar=x$arma[1], ma=x$arma[2], d=x$arma[6], sig2=round(x$sigma2,2))
       ) %>%
    t()

```

Sigma-squared for all cities is updated:  
```{r, fig.height=9, fig.width=9}

sapply(tstARIMA, 
       FUN=function(x) c(ar=x$arma[1], ma=x$arma[2], d=x$arma[6], sig2=round(x$sigma2,2))
       ) %>%
    t() %>% 
    as.data.frame() %>% 
    rownames_to_column("name") %>% 
    select(name, value=sig2) %>% 
    mutate(ARIMA="auto") %>% 
    pivot_wider(id_cols="ARIMA") %>% 
    bind_rows(pdqAll) %>% 
    pivot_longer(cols=-ARIMA, names_to="city") %>% 
    group_by(city) %>% 
    mutate(pct=value/max(value)) %>% 
    ungroup() %>% 
    ggplot(aes(x=fct_reorder(ARIMA, -pct), y=pct, fill=city)) + 
    facet_wrap(~city) + 
    geom_col() + 
    theme(legend.position = "none") + 
    geom_text(data=~filter(., pct<1), aes(y=pct/2, label=round(pct, 2)), size=3) + 
    labs(x="ARIMA(p, d, q)", 
         y="Sigma-squared\nrelative to ARIMA(0, 0, 0)", 
         title="Relative sigma-squared by model", 
         subtitle="(daily precipitation vs. long-term 21-day mean for day of year)"
         )

```

Sigma-squared for all cities is updated, incuding the baseline:  
```{r, fig.height=9, fig.width=9}

sapply(tstARIMA, 
       FUN=function(x) c(ar=x$arma[1], ma=x$arma[2], d=x$arma[6], sig2=round(x$sigma2,2))
       ) %>%
    t() %>% 
    as.data.frame() %>% 
    rownames_to_column("name") %>% 
    select(name, value=sig2) %>% 
    mutate(ARIMA="auto") %>% 
    pivot_wider(id_cols="ARIMA") %>% 
    bind_rows(pdqAll) %>% 
    bind_rows(precipDaily_vs_r21 %>% 
                  group_by(fct_city) %>% 
                  summarize(value=var(sumPrecip)) %>% 
                  mutate(ARIMA="base") %>% 
                  pivot_wider(id_cols="ARIMA", names_from="fct_city")
              ) %>%
    pivot_longer(cols=-ARIMA, names_to="city") %>% 
    group_by(city) %>% 
    mutate(pct=value/max(value)) %>% 
    ungroup() %>% 
    ggplot(aes(x=fct_reorder(ARIMA, -pct), y=pct, fill=city)) + 
    facet_wrap(~city) + 
    geom_col() + 
    theme(legend.position = "none") + 
    geom_text(data=~filter(., pct<1), aes(y=pct/2, label=round(pct, 2)), size=3) + 
    labs(x="ARIMA(p, d, q)", 
         y="Sigma-squared\nrelative to ARIMA(0, 0, 0)", 
         title="Relative sigma-squared by model", 
         subtitle="(daily precipitation vs. long-term 21-day mean for day of year)",
         caption="base=daily precipitation (no adjustmens)\nc(p, d, q) and auto are all vs. long-term 21-day mean"
    )

```

Daily shortwave radiation data are converted to deviation from long-term rolling 21-day mean by day of year:  
```{r, fig.height=9, fig.width=9}

swrDaily_vs_r21 <- allCityDaily %>% 
    mutate(doy=pmin(yday(date), 365), 
           year=year(date), 
           sumSWR=shortwave_radiation_sum, 
           fct_city=factor(cityName)
           ) %>% 
    select(fct_city, date, doy, year, sumSWR) %>%
    left_join(allCityDaily %>% 
                  mutate(doy=pmin(yday(date),365), 
                         sumSWR=shortwave_radiation_sum, 
                         fct_city=factor(cityName)
                         ) %>% 
                  arrange(date) %>%
                  group_by(fct_city) %>% 
                  helperRollingAgg(origVar="sumSWR", newName="swr_r21", k=21) %>% 
                  group_by(fct_city, doy) %>% 
                  summarize(swr_r21=mean(swr_r21, na.rm=TRUE), .groups="drop"), 
              by=c("fct_city", "doy")
              ) %>% 
    mutate(delta_r21=sumSWR-swr_r21)

swrDaily_vs_r21

summary(swrDaily_vs_r21)

```

Lag/lead for shortwave radiation vs. 21-day mean is plotted:  
```{r, fig.height=9, fig.width=9}

swrDaily_vs_r21 %>% 
    arrange(fct_city, date) %>% 
    group_by(fct_city) %>% 
    mutate(swrNext=lead(delta_r21)) %>% 
    ungroup() %>% 
    filter(complete.cases(.)) %>% 
    count(fct_city, delta_r21=round(delta_r21), swrNext=round(swrNext)) %>% 
    ggplot(aes(x=delta_r21, y=swrNext)) + 
    geom_point(aes(size=n), alpha=0.1) + 
    facet_wrap(~fct_city) + 
    geom_smooth(aes(weight=n), method="lm") + 
    annotate("point", x=0, y=0, color="red") + 
    geom_abline(intercept=0, slope=1, color="red", lty=2) + 
    labs(x="Shortwave radiation vs. long-term 21-day mean", 
         y="Next day's shortwave radiation vs. long-term 21-day mean", 
         title="Shortwave radiation vs. long-term 21-day mean by day of year and city"
         ) + 
    scale_size_continuous("# Obs")

```

A baseline ARIMA model is explored, starting with c(0, 0, 0):  
```{r, fig.height=9, fig.width=9}

tstARIMA <- lapply(dewCities, 
                   FUN=function(x) swrDaily_vs_r21 %>% 
                       arrange(date) %>%
                       filter(fct_city==x) %>% 
                       pull(delta_r21) %>% 
                       arima(order=c(0, 0, 0))
                   )
names(tstARIMA) <- dewCities

tibble::tibble(cityName=names(tstARIMA), 
               intercept=sapply(names(tstARIMA), FUN=function(x) tstARIMA[[x]]$coef),
               se=sapply(names(tstARIMA), FUN=function(x) tstARIMA[[x]]$var.coef %>% sqrt), 
               sigma2=sapply(names(tstARIMA), FUN=function(x) tstARIMA[[x]]$residuals %>% var),
               sigma=sqrt(sigma2)
               ) %>%
    arrange(sigma)

```

The ARIMA model is explored at c(1, 0, 0):  
```{r, fig.height=9, fig.width=9}

tstARIMA <- lapply(dewCities, 
                   FUN=function(x) swrDaily_vs_r21 %>% 
                       arrange(date) %>%
                       filter(fct_city==x) %>% 
                       pull(delta_r21) %>% 
                       arima(order=c(1, 0, 0))
                   )
names(tstARIMA) <- dewCities

tibble::tibble(cityName=names(tstARIMA), 
               sigma2=sapply(names(tstARIMA), FUN=function(x) tstARIMA[[x]]$residuals %>% var),
               sigma=sqrt(sigma2)
               ) %>%
    inner_join(sapply(names(tstARIMA), FUN=function(x) tstARIMA[[x]]$coef) %>%
                   t() %>%
                   as.data.frame() %>%
                   rownames_to_column("cityName") %>%
                   as_tibble(), 
               by="cityName"
    ) %>%
    arrange(sigma)

```

The ARIMA model is explored at c(0, 0, 1):  
```{r, fig.height=9, fig.width=9}

tstARIMA <- lapply(dewCities, 
                   FUN=function(x) swrDaily_vs_r21 %>% 
                       arrange(date) %>%
                       filter(fct_city==x) %>% 
                       pull(delta_r21) %>% 
                       arima(order=c(0, 0, 1))
                   )
names(tstARIMA) <- dewCities

tibble::tibble(cityName=names(tstARIMA), 
               sigma2=sapply(names(tstARIMA), FUN=function(x) tstARIMA[[x]]$residuals %>% var),
               sigma=sqrt(sigma2)
               ) %>%
    inner_join(sapply(names(tstARIMA), FUN=function(x) tstARIMA[[x]]$coef) %>%
                   t() %>%
                   as.data.frame() %>%
                   rownames_to_column("cityName") %>%
                   as_tibble(), 
               by="cityName"
    ) %>%
    arrange(sigma)

```

The ARIMA model is explored at c(1, 0, 1):  
```{r, fig.height=9, fig.width=9}

tstARIMA <- lapply(dewCities, 
                   FUN=function(x) swrDaily_vs_r21 %>% 
                       arrange(date) %>%
                       filter(fct_city==x) %>% 
                       pull(delta_r21) %>% 
                       arima(order=c(1, 0, 1))
                   )
names(tstARIMA) <- dewCities

tibble::tibble(cityName=names(tstARIMA), 
               sigma2=sapply(names(tstARIMA), FUN=function(x) tstARIMA[[x]]$residuals %>% var),
               sigma=sqrt(sigma2)
               ) %>%
    inner_join(sapply(names(tstARIMA), FUN=function(x) tstARIMA[[x]]$coef) %>%
                   t() %>%
                   as.data.frame() %>%
                   rownames_to_column("cityName") %>%
                   as_tibble(), 
               by="cityName"
    ) %>%
    arrange(sigma)

```

The ARIMA model is explored at c(2, 0, 0):  
```{r, fig.height=9, fig.width=9}

tstARIMA <- lapply(dewCities, 
                   FUN=function(x) swrDaily_vs_r21 %>% 
                       arrange(date) %>%
                       filter(fct_city==x) %>% 
                       pull(delta_r21) %>% 
                       arima(order=c(2, 0, 0))
                   )
names(tstARIMA) <- dewCities

tibble::tibble(cityName=names(tstARIMA), 
               sigma2=sapply(names(tstARIMA), FUN=function(x) tstARIMA[[x]]$residuals %>% var),
               sigma=sqrt(sigma2)
               ) %>%
    inner_join(sapply(names(tstARIMA), FUN=function(x) tstARIMA[[x]]$coef) %>%
                   t() %>%
                   as.data.frame() %>%
                   rownames_to_column("cityName") %>%
                   as_tibble(), 
               by="cityName"
    ) %>%
    arrange(sigma)

```

Sigma-squared for all cities is compiled across models:  
```{r, fig.height=9, fig.width=9}

pdqList <- list("c(0, 0, 0)"=c(0, 0, 0), 
                "c(1, 0, 0)"=c(1, 0, 0), 
                "c(0, 0, 1)"=c(0, 0, 1), 
                "c(1, 0, 1)"=c(1, 0, 1), 
                "c(2, 0, 0)"=c(2, 0, 0)
                )

pdqAll <- sapply(pdqList, FUN=function(pdq) sapply(dewCities, 
                                                   FUN=function(x) { 
                                                       tmp<- swrDaily_vs_r21 %>% 
                                                           arrange(date) %>%
                                                           filter(fct_city==x) %>% 
                                                           pull(delta_r21) %>% 
                                                           arima(x=., order=unname(pdq)) 
                                                       tmp$sigma2
                                                       }
                                                   )
                  ) %>%
    t() %>%
    as.data.frame() %>%
    rownames_to_column("ARIMA") %>%
    as_tibble()

pdqAll

```

Sigma-squared for all cities is plotted:  
```{r, fig.height=9, fig.width=9}

sapply(tstARIMA, 
       FUN=function(x) c(ar=x$arma[1], ma=x$arma[2], d=x$arma[6], sig2=round(x$sigma2,2))
       ) %>%
    t() %>% 
    as.data.frame() %>% 
    rownames_to_column("name") %>% 
    select(name, value=sig2) %>% 
    mutate(ARIMA="auto") %>% 
    pivot_wider(id_cols="ARIMA") %>% 
    bind_rows(pdqAll) %>% 
    pivot_longer(cols=-ARIMA, names_to="city") %>% 
    group_by(city) %>% 
    mutate(pct=value/max(value)) %>% 
    ungroup() %>% 
    ggplot(aes(x=fct_reorder(ARIMA, -pct), y=pct, fill=city)) + 
    facet_wrap(~city) + 
    geom_col() + 
    theme(legend.position = "none") + 
    geom_text(data=~filter(., pct<1), aes(y=pct/2, label=round(pct, 2)), size=3) + 
    labs(x="ARIMA(p, d, q)", 
         y="Sigma-squared\nrelative to ARIMA(0, 0, 0)", 
         title="Relative sigma-squared by model", 
         subtitle="(daily shortwave radiation vs. long-term 21-day mean for day of year)"
         )

```

The auto.arima() process is run to estimate optimal parameters for all cities:  
```{r, fig.height=9, fig.width=9}

tstARIMA <- lapply(dewCities, 
                   FUN=function(x) swrDaily_vs_r21 %>% 
                       arrange(date) %>%
                       filter(fct_city==x) %>% 
                       pull(delta_r21) %>% 
                       forecast::auto.arima(d=0)
                   )
names(tstARIMA) <- dewCities

```

The auto.arima() parameters are pulled for all cities:  
```{r, fig.height=9, fig.width=9}

sapply(tstARIMA, 
       FUN=function(x) c(ar=x$arma[1], ma=x$arma[2], d=x$arma[6], sig2=round(x$sigma2,2))
       ) %>%
    t()

```

Sigma-squared for all cities is updated:  
```{r, fig.height=9, fig.width=9}

sapply(tstARIMA, 
       FUN=function(x) c(ar=x$arma[1], ma=x$arma[2], d=x$arma[6], sig2=round(x$sigma2,2))
       ) %>%
    t() %>% 
    as.data.frame() %>% 
    rownames_to_column("name") %>% 
    select(name, value=sig2) %>% 
    mutate(ARIMA="auto") %>% 
    pivot_wider(id_cols="ARIMA") %>% 
    bind_rows(pdqAll) %>% 
    pivot_longer(cols=-ARIMA, names_to="city") %>% 
    group_by(city) %>% 
    mutate(pct=value/max(value)) %>% 
    ungroup() %>% 
    ggplot(aes(x=fct_reorder(ARIMA, -pct), y=pct, fill=city)) + 
    facet_wrap(~city) + 
    geom_col() + 
    theme(legend.position = "none") + 
    geom_text(data=~filter(., pct<1), aes(y=pct/2, label=round(pct, 2)), size=3) + 
    labs(x="ARIMA(p, d, q)", 
         y="Sigma-squared\nrelative to ARIMA(0, 0, 0)", 
         title="Relative sigma-squared by model", 
         subtitle="(daily shortwave radiation vs. long-term 21-day mean for day of year)"
         )

```

Sigma-squared for all cities is updated, incuding the baseline:  
```{r, fig.height=9, fig.width=9}

sapply(tstARIMA, 
       FUN=function(x) c(ar=x$arma[1], ma=x$arma[2], d=x$arma[6], sig2=round(x$sigma2,2))
       ) %>%
    t() %>% 
    as.data.frame() %>% 
    rownames_to_column("name") %>% 
    select(name, value=sig2) %>% 
    mutate(ARIMA="auto") %>% 
    pivot_wider(id_cols="ARIMA") %>% 
    bind_rows(pdqAll) %>% 
    bind_rows(swrDaily_vs_r21 %>% 
                  group_by(fct_city) %>% 
                  summarize(value=var(sumSWR)) %>% 
                  mutate(ARIMA="base") %>% 
                  pivot_wider(id_cols="ARIMA", names_from="fct_city")
              ) %>%
    pivot_longer(cols=-ARIMA, names_to="city") %>% 
    group_by(city) %>% 
    mutate(pct=value/max(value)) %>% 
    ungroup() %>% 
    ggplot(aes(x=fct_reorder(ARIMA, -pct), y=pct, fill=city)) + 
    facet_wrap(~city) + 
    geom_col() + 
    theme(legend.position = "none") + 
    geom_text(data=~filter(., pct<1), aes(y=pct/2, label=round(pct, 2)), size=3) + 
    labs(x="ARIMA(p, d, q)", 
         y="Sigma-squared\nrelative to ARIMA(0, 0, 0)", 
         title="Relative sigma-squared by model", 
         subtitle="(daily shortwave radiation vs. long-term 21-day mean for day of year)",
         caption="base=daily SWR (no adjustmens)\nc(p, d, q) and auto are all vs. long-term 21-day mean"
    )

```

ACF is calculated for shortwave radiation for each city:  
```{r, fig.height=9, fig.width=9}

dewCities <- dewPDaily %>% 
    pull(fct_city) %>% 
    as.vector() %>% 
    unique()

swrACF <- lapply(dewCities, 
                 FUN=function(x) {
                     swrDaily_vs_r21 %>% 
                         filter(fct_city==x) %>% 
                         arrange(date) %>% 
                         select(sumSWR) %>% 
                         acf(lag.max=2000, plot=FALSE)
                     }
                 )
names(swrACF) <- dewCities

swrACFAll <- map_dfr(.x=dewCities, 
                     .f=function(x) tibble::tibble(lag=as.vector(swrACF[[x]][["lag"]]), 
                                                   acf=as.vector(swrACF[[x]][["acf"]])
                                                   ), 
                     .id="src") %>% 
    mutate(cityName=dewCities[as.integer(src)])

swrACFAll

swrACFAll %>%
    filter(lag > 0) %>%
    group_by(cityName) %>%
    summarize(mu_abs_acf=mean(abs(acf))) %>%
    arrange(desc(mu_abs_acf))

```

ACF by city are plotted:  
```{r, fig.height=9, fig.width=9}

swrACFAll %>% 
    filter(lag>0) %>%
    ggplot(aes(x=lag, y=acf)) + 
    geom_line(aes(color=cityName, group=cityName), lwd=1) + 
    labs(x="Lag (zero excluded)", y="ACF", title="ACF of shortwave radiation by city") + 
    scale_color_discrete(NULL) + 
    lims(y=c(-1, 1))

```

PACF is calculated for shortwave radiation for each city:  
```{r, fig.height=9, fig.width=9}

swrPACF <- lapply(dewCities, 
                  FUN=function(x) {
                      swrDaily_vs_r21 %>% 
                          filter(fct_city==x) %>% 
                          arrange(date) %>% 
                          select(sumSWR) %>% 
                          pacf(lag.max=2000, plot=FALSE)
                      }
                  )
names(swrPACF) <- dewCities

swrPACFAll <- map_dfr(.x=dewCities, 
                      .f=function(x) tibble::tibble(lag=as.vector(swrPACF[[x]][["lag"]]), 
                                                    pacf=as.vector(swrPACF[[x]][["acf"]])
                                                    ), 
                      .id="src") %>% 
    mutate(cityName=dewCities[as.integer(src)])

swrPACFAll

swrPACFAll %>%
    filter(lag > 0) %>%
    group_by(cityName) %>%
    summarize(mu_abs_pacf=mean(abs(pacf))) %>%
    arrange(desc(mu_abs_pacf))

```

PACF by city are plotted:  
```{r, fig.height=9, fig.width=9}

swrPACFAll %>% 
    filter(lag>0) %>%
    ggplot(aes(x=lag, y=pacf)) + 
    geom_line(aes(color=cityName, group=cityName), lwd=1) + 
    labs(x="Lag (zero excluded)", y="PACF", title="PACF of shortwave radiation by city") + 
    scale_color_discrete(NULL) + 
    lims(y=c(-1, 1))


swrPACFAll %>% 
    filter(lag>0, lag<=50) %>%
    ggplot(aes(x=lag, y=pacf)) + 
    geom_line(aes(color=cityName, group=cityName), lwd=1) + 
    labs(x="Lag (zero excluded)", y="PACF", title="PACF of shortwave radiation by city") + 
    scale_color_discrete(NULL) + 
    lims(y=c(-1, 1))

```

ACF is calculated and plotted for seasonally-adjusted shortwave radiation for each city:  
```{r, fig.height=9, fig.width=9}

swrACF_r21 <- lapply(dewCities, 
                     FUN=function(x) {
                         swrDaily_vs_r21 %>% 
                             filter(fct_city==x) %>% 
                             arrange(date) %>% 
                             select(delta_r21) %>% 
                             acf(lag.max=2000, plot=FALSE)
                         }
                     )
names(swrACF_r21) <- dewCities

swrACFAll_r21 <- map_dfr(.x=dewCities, 
                         .f=function(x) tibble::tibble(lag=as.vector(swrACF_r21[[x]][["lag"]]), 
                                                       acf=as.vector(swrACF_r21[[x]][["acf"]])
                                                       ), 
                         .id="src") %>% 
    mutate(cityName=dewCities[as.integer(src)])

swrACFAll_r21

swrACFAll_r21 %>%
    filter(lag > 0) %>%
    group_by(cityName) %>%
    summarize(mu_abs_acf=mean(abs(acf))) %>%
    arrange(desc(mu_abs_acf))

swrACFAll_r21 %>% 
    filter(lag>0) %>%
    ggplot(aes(x=lag, y=acf)) + 
    geom_line(aes(color=cityName, group=cityName), lwd=1) + 
    labs(x="Lag (zero excluded)", y="ACF", title="ACF of seasonally-adjusted shortwave radiation by city") + 
    scale_color_discrete(NULL) + 
    lims(y=c(-1, 1))

swrACFAll_r21 %>% 
    filter(lag>0, lag<=30) %>%
    ggplot(aes(x=lag, y=acf)) + 
    geom_line(aes(color=cityName, group=cityName), lwd=1) + 
    labs(x="Lag (zero excluded)", y="ACF", title="ACF of seasonally-adjusted shortwave radiation by city") + 
    scale_color_discrete(NULL) + 
    lims(y=c(-1, 1))

```

PACF is calculated and plotted for seasonally-adjusted shortwave radiation for each city:  
```{r, fig.height=9, fig.width=9}

swrPACF_r21 <- lapply(dewCities, 
                      FUN=function(x) {
                          swrDaily_vs_r21 %>% 
                              filter(fct_city==x) %>% 
                              arrange(date) %>% 
                              select(delta_r21) %>% 
                              pacf(lag.max=2000, plot=FALSE)
                          }
                     )
names(swrPACF_r21) <- dewCities

swrPACFAll_r21 <- map_dfr(.x=dewCities, 
                          .f=function(x) tibble::tibble(lag=as.vector(swrPACF_r21[[x]][["lag"]]), 
                                                        acf=as.vector(swrPACF_r21[[x]][["acf"]])
                                                        ), 
                          .id="src") %>% 
    mutate(cityName=dewCities[as.integer(src)])

swrPACFAll_r21

swrPACFAll_r21 %>%
    filter(lag > 0) %>%
    group_by(cityName) %>%
    summarize(mu_abs_acf=mean(abs(acf))) %>%
    arrange(desc(mu_abs_acf))

swrPACFAll_r21 %>% 
    filter(lag>0) %>%
    ggplot(aes(x=lag, y=acf)) + 
    geom_line(aes(color=cityName, group=cityName), lwd=1) + 
    labs(x="Lag (zero excluded)", y="PACF", title="PACF of seasonally-adjusted shortwave radiation by city") + 
    scale_color_discrete(NULL) + 
    lims(y=c(-1, 1))

swrPACFAll_r21 %>% 
    filter(lag>0, lag<=30) %>%
    ggplot(aes(x=lag, y=acf)) + 
    geom_line(aes(color=cityName, group=cityName), lwd=1) + 
    labs(x="Lag (zero excluded)", y="PACF", title="PACF of seasonally-adjusted shortwave radiation by city") + 
    scale_color_discrete(NULL) + 
    lims(y=c(-1, 1))

```

ACF is calculated and plotted for seasonally-adjusted temperature for each city:  
```{r, fig.height=9, fig.width=9}

tempACF_r21 <- lapply(dewCities, 
                      FUN=function(x) {
                          tempDaily_vs_r21 %>% 
                              filter(fct_city==x) %>% 
                              arrange(date) %>% 
                              select(delta_r21) %>% 
                              acf(lag.max=2000, plot=FALSE)
                          }
                      )
names(tempACF_r21) <- dewCities

tempACFAll_r21 <- map_dfr(.x=dewCities, 
                          .f=function(x) tibble::tibble(lag=as.vector(tempACF_r21[[x]][["lag"]]), 
                                                        acf=as.vector(tempACF_r21[[x]][["acf"]])
                                                        ), 
                          .id="src") %>% 
    mutate(cityName=dewCities[as.integer(src)])

tempACFAll_r21

tempACFAll_r21 %>%
    filter(lag > 0) %>%
    group_by(cityName) %>%
    summarize(mu_abs_acf=mean(abs(acf))) %>%
    arrange(desc(mu_abs_acf))

tempACFAll_r21 %>% 
    filter(lag>0) %>%
    ggplot(aes(x=lag, y=acf)) + 
    geom_line(aes(color=cityName, group=cityName), lwd=1) + 
    labs(x="Lag (zero excluded)", y="ACF", title="ACF of seasonally-adjusted mean temperature by city") + 
    scale_color_discrete(NULL) + 
    lims(y=c(-1, 1))

tempACFAll_r21 %>% 
    filter(lag>0, lag<=30) %>%
    ggplot(aes(x=lag, y=acf)) + 
    geom_line(aes(color=cityName, group=cityName), lwd=1) + 
    labs(x="Lag (zero excluded)", y="ACF", title="ACF of seasonally-adjusted mean temperature by city") + 
    scale_color_discrete(NULL) + 
    lims(y=c(-1, 1))

```

PACF is calculated and plotted for seasonally-adjusted temperature for each city:  
```{r, fig.height=9, fig.width=9}

tempPACF_r21 <- lapply(dewCities, 
                       FUN=function(x) {
                           tempDaily_vs_r21 %>% 
                               filter(fct_city==x) %>% 
                               arrange(date) %>% 
                               select(delta_r21) %>% 
                               pacf(lag.max=2000, plot=FALSE)
                           }
                       )
names(tempPACF_r21) <- dewCities

tempPACFAll_r21 <- map_dfr(.x=dewCities, 
                           .f=function(x) tibble::tibble(lag=as.vector(tempPACF_r21[[x]][["lag"]]), 
                                                         acf=as.vector(tempPACF_r21[[x]][["acf"]])
                                                         ), 
                           .id="src") %>% 
    mutate(cityName=dewCities[as.integer(src)])

tempPACFAll_r21

tempPACFAll_r21 %>%
    filter(lag > 0) %>%
    group_by(cityName) %>%
    summarize(mu_abs_acf=mean(abs(acf))) %>%
    arrange(desc(mu_abs_acf))

tempPACFAll_r21 %>% 
    filter(lag>0) %>%
    ggplot(aes(x=lag, y=acf)) + 
    geom_line(aes(color=cityName, group=cityName), lwd=1) + 
    labs(x="Lag (zero excluded)", y="PACF", title="PACF of seasonally-adjusted mean temperature by city") + 
    scale_color_discrete(NULL) + 
    lims(y=c(-1, 1))

tempPACFAll_r21 %>% 
    filter(lag>0, lag<=30) %>%
    ggplot(aes(x=lag, y=acf)) + 
    geom_line(aes(color=cityName, group=cityName), lwd=1) + 
    labs(x="Lag (zero excluded)", y="PACF", title="PACF of seasonally-adjusted mean temperature by city") + 
    scale_color_discrete(NULL) + 
    lims(y=c(-1, 1))

```

The ACF plot creation process is converted to functional form:  
```{r, fig.height=9, fig.width=9}

makeACFPlot <- function(df, 
                        cities=dewCities, 
                        keyVar="delta_r21", 
                        fn=acf, 
                        lagMax=2000, 
                        lagCuts=list(c(1, +Inf)), 
                        plotTitle="provided data",
                        printSummary=TRUE,
                        makePlots=TRUE,
                        returnData=TRUE
                        ) {

    # FUNCTIOn ARGUMENTS:
    # df: tibble containing data
    # cities: city names for including as colors in plot
    # fn: the function to calculate (should be acf or pacf)
    # lagMax: the maximum lage to use in fn
    # lagCuts: list of tuples for plot x-axis min/max cut points list(c(x1min, x1max), c(x2min, x2max), ...)
    # plotTitle: description for the plot data, will have "fn of " prepended
    # printSummary: boolean, should a summary of mean absolute fn by city be printed?
    # makePlots: boolean, should plots be created?
    # returnData: bollean, should dfACF be returned?
    
    vecACF <- lapply(cities, 
                     FUN=function(x) {
                         df %>% 
                             filter(fct_city==x) %>% 
                             arrange(date) %>% 
                             select(all_of(keyVar)) %>% 
                             fn(lag.max=lagMax, plot=FALSE)
                         }
                     )

    names(vecACF) <- cities

    dfACF <- map_dfr(.x=cities, 
                     .f=function(x) tibble::tibble(lag=as.vector(vecACF[[x]][["lag"]]), 
                                                   acf=as.vector(vecACF[[x]][["acf"]])
                                                   ), 
                     .id="src"
                     ) %>% 
        mutate(cityName=cities[as.integer(src)])

    if(isTRUE(printSummary)) {
        dfACF %>%
            filter(lag > 0) %>%
            group_by(cityName) %>%
            summarize(mu_abs_acf=mean(abs(acf))) %>%
            arrange(desc(mu_abs_acf)) %>%
            print()
    }
    
    if(isTRUE(makePlots)) {
        for(i in 1:length(lagCuts)) {
            xmin <- lagCuts[[i]][1]
            xmax <- lagCuts[[i]][2]
            p1 <- dfACF %>%
                filter(lag>=xmin, lag<=xmax) %>%
                ggplot(aes(x=lag, y=acf)) +
                geom_line(aes(color=cityName, group=cityName), lwd=1) +
                labs(x="Lag", 
                     y=toupper(deparse(substitute(fn))), 
                     title=paste0(toupper(deparse(substitute(fn))), " of ", plotTitle)
                     ) +
                scale_color_discrete(NULL) +
                lims(y=c(-1, 1))
            print(p1)
        }
    }
    
    if(isTRUE(returnData)) return(dfACF)
        
}

```

The function is tested:  
```{r, fig.height=9, fig.width=9}

# Base functionality
makeACFPlot(tempDaily_vs_r21, keyVar="delta_r21")

# PACF functionality
makeACFPlot(tempDaily_vs_r21, keyVar="delta_r21", fn=pacf)

# Exclude elements of printing/plotting
makeACFPlot(tempDaily_vs_r21, keyVar="delta_r21", printSummary=FALSE)
makeACFPlot(tempDaily_vs_r21, keyVar="delta_r21", returnData=FALSE)
makeACFPlot(tempDaily_vs_r21, keyVar="delta_r21", makePlots=FALSE)

# Specialized cut points
makeACFPlot(tempDaily_vs_r21, keyVar="delta_r21", lagCuts=list(c(0, +Inf), c(1, 10)))

# Customized plot titles
makeACFPlot(tempDaily_vs_r21, 
            keyVar="delta_r21", 
            lagCuts=list(c(0, +Inf), c(1, 10)), 
            plotTitle="seasonally-adjusted mean temperature by city"
            )

# Create tibble for multiple elements
map_dfr(.x=c("delta_r21", "temp_r21", "meanTemp"), 
        .f=function(x) makeACFPlot(tempDaily_vs_r21, keyVar=x, printSummary=FALSE, makePlots=FALSE), 
        .id="src"
        ) %>%
    mutate(src=c("delta_r21", "temp_r21", "meanTemp")[as.integer(src)]) %>%
    pivot_wider(id_cols=c("lag", "cityName"), names_from="src", values_from="acf")

```

Relative ACF by city for mean temperature are plotted:  
```{r, fig.height=9, fig.width=9}

# Create tibble for multiple elements
dfTempACF <- map_dfr(.x=c("delta_r21", "temp_r21", "meanTemp"), 
        .f=function(x) makeACFPlot(tempDaily_vs_r21, keyVar=x, printSummary=FALSE, makePlots=FALSE), 
        .id="src"
        ) %>%
    mutate(src=c("delta_r21", "temp_r21", "meanTemp")[as.integer(src)]) %>%
    pivot_wider(id_cols=c("lag", "cityName"), names_from="src", values_from="acf")
dfTempACF

dfTempACF %>%
    pivot_longer(cols=-c(lag, cityName)) %>%
    ggplot(aes(x=lag, y=value)) + 
    geom_line(aes(color=name)) + 
    facet_wrap(~cityName) + 
    labs(x="Lag", y="ACF", title="ACF by mean temperature metric and city") + 
    scale_color_discrete("Metric") + 
    lims(y=c(-1, 1))

```

Relative PACF by city for mean temperature are plotted:  
```{r, fig.height=9, fig.width=9}

# Create tibble for multiple elements
dfTempPACF <- map_dfr(.x=c("delta_r21", "temp_r21", "meanTemp"), 
                      .f=function(x) makeACFPlot(tempDaily_vs_r21, 
                                                 fn=pacf, 
                                                 keyVar=x, 
                                                 printSummary=FALSE,
                                                 makePlots=FALSE
                                                 ), 
                      .id="src"
                      ) %>%
    mutate(src=c("delta_r21", "temp_r21", "meanTemp")[as.integer(src)]) %>%
    pivot_wider(id_cols=c("lag", "cityName"), names_from="src", values_from="acf")
dfTempPACF

dfTempPACF %>%
    pivot_longer(cols=-c(lag, cityName)) %>%
    ggplot(aes(x=lag, y=value)) + 
    geom_line(aes(color=name)) + 
    facet_wrap(~cityName) + 
    labs(x="Lag", y="PACF", title="PACF by mean temperature metric and city") + 
    scale_color_discrete("Metric") + 
    lims(y=c(-1, 1))


dfTempPACF %>%
    pivot_longer(cols=-c(lag, cityName)) %>%
    filter(lag <= 20) %>%
    ggplot(aes(x=lag, y=value)) + 
    geom_line(aes(color=name)) + 
    facet_wrap(~cityName) + 
    labs(x="Lag", y="PACF", title="PACF by mean temperature metric and city") + 
    scale_color_discrete("Metric") + 
    lims(y=c(-1, 1))

```

Relative ACF by city for mean dewpoint are plotted:  
```{r, fig.height=9, fig.width=9}

# Create tibble for multiple elements
dfDewACF <- map_dfr(.x=c("delta_r21", "dewpoint_r21", "dewpoint_2m_mean"), 
                    .f=function(x) makeACFPlot(dewPDaily_vs_r21, keyVar=x, printSummary=FALSE, makePlots=FALSE), 
                    .id="src"
                    ) %>%
    mutate(src=c("delta_r21", "dewpoint_r21", "dewpoint_2m_mean")[as.integer(src)]) %>%
    pivot_wider(id_cols=c("lag", "cityName"), names_from="src", values_from="acf")
dfDewACF

dfDewACF %>%
    pivot_longer(cols=-c(lag, cityName)) %>%
    ggplot(aes(x=lag, y=value)) + 
    geom_line(aes(color=name)) + 
    facet_wrap(~cityName) + 
    labs(x="Lag", y="ACF", title="ACF by mean dewpoint metric and city") + 
    scale_color_discrete("Metric") + 
    lims(y=c(-1, 1))

```

Relative PACF by city for mean dewpoint are plotted:  
```{r, fig.height=9, fig.width=9}

# Create tibble for multiple elements
dfDewPACF <- map_dfr(.x=c("delta_r21", "dewpoint_r21", "dewpoint_2m_mean"), 
                     .f=function(x) makeACFPlot(dewPDaily_vs_r21, 
                                                fn=pacf, 
                                                keyVar=x, 
                                                printSummary=FALSE,
                                                makePlots=FALSE
                                                ), 
                     .id="src"
                     ) %>%
    mutate(src=c("delta_r21", "dewpoint_r21", "dewpoint_2m_mean")[as.integer(src)]) %>%
    pivot_wider(id_cols=c("lag", "cityName"), names_from="src", values_from="acf")
dfDewPACF

dfDewPACF %>%
    pivot_longer(cols=-c(lag, cityName)) %>%
    ggplot(aes(x=lag, y=value)) + 
    geom_line(aes(color=name)) + 
    facet_wrap(~cityName) + 
    labs(x="Lag", y="PACF", title="PACF by mean dewpoint metric and city") + 
    scale_color_discrete("Metric") + 
    lims(y=c(-1, 1))


dfDewPACF %>%
    pivot_longer(cols=-c(lag, cityName)) %>%
    filter(lag <= 20) %>%
    ggplot(aes(x=lag, y=value)) + 
    geom_line(aes(color=name)) + 
    facet_wrap(~cityName) + 
    labs(x="Lag", y="PACF", title="PACF by mean dewpoint metric and city") + 
    scale_color_discrete("Metric") + 
    lims(y=c(-1, 1))

```

Relative ACF by city for maximum wind speed are plotted:  
```{r, fig.height=9, fig.width=9}

keepVars <- c("delta_r21", "wind_r21", "maxWind")
useDF <- windDaily_vs_r21

# Create tibble for multiple elements
dfWindACF <- map_dfr(.x=keepVars, 
                     .f=function(x) makeACFPlot(useDF, keyVar=x, printSummary=FALSE, makePlots=FALSE), 
                     .id="src"
                     ) %>%
    mutate(src=keepVars[as.integer(src)]) %>%
    pivot_wider(id_cols=c("lag", "cityName"), names_from="src", values_from="acf")
dfWindACF

dfWindACF %>%
    pivot_longer(cols=-c(lag, cityName)) %>%
    ggplot(aes(x=lag, y=value)) + 
    geom_line(aes(color=name)) + 
    facet_wrap(~cityName) + 
    labs(x="Lag", y="ACF", title="ACF by mean windspeed metric and city") + 
    scale_color_discrete("Metric") + 
    lims(y=c(-1, 1))

```

Relative PACF by city for mean maximum wind speed are plotted:  
```{r, fig.height=9, fig.width=9}

keepVars <- c("delta_r21", "wind_r21", "maxWind")
useDF <- windDaily_vs_r21

# Create tibble for multiple elements
dfWindPACF <- map_dfr(.x=keepVars, 
                      .f=function(x) makeACFPlot(useDF, 
                                                 fn=pacf, 
                                                 keyVar=x, 
                                                 printSummary=FALSE,
                                                 makePlots=FALSE
                                                 ), 
                      .id="src"
                      ) %>%
    mutate(src=keepVars[as.integer(src)]) %>%
    pivot_wider(id_cols=c("lag", "cityName"), names_from="src", values_from="acf")
dfWindACF

dfWindPACF %>%
    pivot_longer(cols=-c(lag, cityName)) %>%
    ggplot(aes(x=lag, y=value)) + 
    geom_line(aes(color=name)) + 
    facet_wrap(~cityName) + 
    labs(x="Lag", y="PACF", title="PACF by maximum wind speed metric and city") + 
    scale_color_discrete("Metric") + 
    lims(y=c(-1, 1))

dfWindPACF %>%
    pivot_longer(cols=-c(lag, cityName)) %>%
    filter(lag <= 20) %>%
    ggplot(aes(x=lag, y=value)) + 
    geom_line(aes(color=name)) + 
    facet_wrap(~cityName) + 
    labs(x="Lag", y="PACF", title="PACF by maximum wind speed metric and city") + 
    scale_color_discrete("Metric") + 
    lims(y=c(-1, 1))

```

Rolling 21-day mean maximum wind speed is further explored:  
```{r, fig.height=9, fig.width=9}

windDaily_vs_r21 %>%
    filter(year(date)>2010) %>%
    ggplot(aes(x=date, y=wind_r21)) +
    geom_line() + 
    geom_smooth(aes(y=maxWind), color="lightblue", method="loess", span=21/365) +
    facet_wrap(~fct_city) + 
    labs(x=NULL, 
         y="Rolling 21-day maximum wind speed", 
         caption="Black: Mean based on city and day-of-year\nBlue: Smooth on raw data"
         )

dfWindPACF %>%
    filter(lag>=100) %>%
    mutate(abs_wind_r21=abs(wind_r21)) %>%
    group_by(cityName) %>%
    slice_max(abs_wind_r21, n=6) %>%
    print(n=50)

```

There is a consistently large PACF at lag 366. Some cities appear to have a disconnected increase in mean maximum wind speed

Mean maximum wind speed by year is further explored:  
```{r, fig.height=9, fig.width=9}

windDaily_vs_r21 %>%
    filter(year(date)>2010) %>%
    group_by(fct_city, year) %>%
    summarize(muWind=mean(maxWind), mur21=mean(wind_r21), mudelta=mean(delta_r21), .groups="drop") %>%
    ggplot(aes(x=year, y=muWind)) +
    geom_line() + 
    geom_line(aes(y=mur21), lty=2) +
    facet_wrap(~fct_city) + 
    labs(x=NULL, 
         y="Mean maximum wind speed", 
         caption="Solid: Mean based on city and year\nDashed: Mean based on city"
         )

```

The impact is particularly pronounced in Chicago and Las Vegas, with some visual impact also in Houston

The impact for Las Vegas is further explored, including the disconnect in 2017:  
```{r, fig.height=9, fig.width=9}

windDaily_vs_r21 %>%
    filter(year(date)>2010, fct_city=="Las Vegas NV") %>%
    mutate(mon=factor(month.abb[month(date)], levels=month.abb)) %>%
    group_by(fct_city, year, mon) %>%
    summarize(muWind=mean(maxWind), mur21=mean(wind_r21), mudelta=mean(delta_r21), .groups="drop") %>%
    group_by(mon) %>%
    mutate(multe2016=mean(ifelse(year<=2016, muWind, NA), na.rm=TRUE)) %>%
    ungroup() %>%
    ggplot(aes(x=factor(mon), y=muWind)) + 
    geom_line(aes(group=1), lwd=1.5, color="lightblue") + 
    geom_line(aes(y=multe2016, group=1), lty=2) +
    facet_wrap(~year) + 
    labs(title="Las Vegas NV", 
         x=NULL, 
         y="Mean maximum wind speed", 
         caption="Solid: Mean based on month and year\nDashed: Mean by month (2011-2016 avg)"
         )

```

There is likely a significant change in measuring site, methodology, etc. - effective January 2017 - for mean maximum wind speed in Las Vegas

The impact for Chicago is further explored, including the disconnect in 2017:  
```{r, fig.height=9, fig.width=9}

windDaily_vs_r21 %>%
    filter(year(date)>2010, fct_city=="Chicago IL") %>%
    mutate(mon=factor(month.abb[month(date)], levels=month.abb)) %>%
    group_by(fct_city, year, mon) %>%
    summarize(muWind=mean(maxWind), mur21=mean(wind_r21), mudelta=mean(delta_r21), .groups="drop") %>%
    group_by(mon) %>%
    mutate(multe2016=mean(ifelse(year<=2016, muWind, NA), na.rm=TRUE)) %>%
    ungroup() %>%
    ggplot(aes(x=factor(mon), y=muWind)) + 
    geom_line(aes(group=1), lwd=1.5, color="lightblue") + 
    geom_line(aes(y=multe2016, group=1), lty=2) +
    facet_wrap(~year) + 
    labs(title="Chicago IL", 
         x=NULL, 
         y="Mean maximum wind speed", 
         caption="Solid: Mean based on month and year\nDashed: Mean by month (2011-2016 avg)"
         )

```

There is likely a significant change in measuring site, methodology, etc. - effective January or February 2017 - for mean maximum wind speed in Chicago

Differences by month between pre/post-2017 are explored:  
```{r, fig.height=9, fig.width=9}

windDaily_vs_r21 %>%
    filter(year(date)>2010) %>%
    mutate(mon=factor(month.abb[month(date)], levels=month.abb)) %>%
    group_by(fct_city, year, mon) %>%
    summarize(muWind=mean(maxWind), mur21=mean(wind_r21), mudelta=mean(delta_r21), .groups="drop") %>%
    group_by(fct_city, mon) %>%
    mutate(multe2016=mean(ifelse(year<=2016, muWind, NA), na.rm=TRUE), 
           mugt2016=mean(ifelse(year>2016, muWind, NA), na.rm=TRUE)
           ) %>%
    ungroup() %>%
    filter(year %in% c(2016)) %>%
    select(fct_city, mon, multe2016, mugt2016) %>%
    pivot_longer(cols=-c(fct_city, mon)) %>%
    ggplot(aes(x=factor(mon), 
               y=value, 
               group=name, 
               color=c("mugt2016"="2017-after", "multe2016"="2016-before")[name])
           ) + 
    geom_line() + 
    facet_wrap(~fct_city) + 
    scale_color_discrete(NULL) +
    labs(title="Mean maximum wind speed by city and month\n(2011-2016 vs. 2017-2024)", 
         x=NULL, 
         y="Mean maximum wind speed"
         )

```

Standard deviation for pre-2017 is added:  
```{r, fig.height=9, fig.width=9}

windDaily_vs_r21 %>%
    filter(year(date)>2010) %>%
    mutate(mon=factor(month.abb[month(date)], levels=month.abb)) %>%
    group_by(fct_city, year, mon) %>%
    summarize(muWind=mean(maxWind), mur21=mean(wind_r21), mudelta=mean(delta_r21), .groups="drop") %>%
    group_by(fct_city, mon) %>%
    mutate(multe2016=mean(ifelse(year<=2016, muWind, NA), na.rm=TRUE), 
           sdlte2016=sd(ifelse(year<=2016, muWind, NA), na.rm=TRUE), 
           mugt2016=mean(ifelse(year>2016, muWind, NA), na.rm=TRUE)
           ) %>%
    ungroup() %>%
    filter(year %in% c(2016)) %>%
    select(fct_city, mon, multe2016, mugt2016, sdlte2016) %>%
    pivot_longer(cols=-c(fct_city, mon, sdlte2016)) %>%
    ggplot(aes(x=factor(mon), 
               y=value, 
               group=name, 
               color=c("mugt2016"="2017-after", "multe2016"="2016-before")[name])
           ) + 
    geom_line() + 
    geom_ribbon(data=~filter(., name=="multe2016"), 
                aes(ymin=value-sdlte2016, ymax=value+sdlte2016), 
                alpha=0.25, 
                lty=0, 
                fill="red"
                ) +
    facet_wrap(~fct_city) + 
    scale_color_discrete(NULL) +
    labs(title="Mean maximum wind speed by city and month\n(2011-2016 vs. 2017-2024)", 
         x=NULL, 
         y="Mean maximum wind speed", 
         caption="Ribbon for 2016-before is mean +/- 1 sd"
         )

```

The disconnect in Las Vegas is further explored:  
```{r, fig.height=9, fig.width=9}

windDaily_vs_r21 %>%
    filter(year(date)>2010, fct_city=="Las Vegas NV") %>%
    mutate(mon=factor(month.abb[month(date)], levels=month.abb)) %>%
    group_by(fct_city, year, mon) %>%
    summarize(muWind=mean(maxWind), mur21=mean(wind_r21), mudelta=mean(delta_r21), .groups="drop") %>%
    group_by(mon) %>%
    mutate(multe2016=mean(ifelse(year<=2016, muWind, NA), na.rm=TRUE), 
           lbl=ifelse(year<=2016, "2011-2016", "2017-20247")
           ) %>%
    ungroup() %>%
    ggplot(aes(x=factor(year), y=muWind)) + 
    geom_col(aes(fill=lbl), alpha=0.5) +
    geom_line(aes(y=multe2016, group=1), lty=2) + 
    facet_wrap(~mon) + 
    labs(title="Las Vegas NV", 
         x=NULL, 
         y="Mean maximum wind speed", 
         caption="Dotted line is monthly mean pre-2017"
         ) + 
    theme(axis.text.x=element_text(angle=90), legend.position="bottom") + 
    scale_fill_discrete(NULL)

```

The disconnect in Chicago is further explored:  
```{r, fig.height=9, fig.width=9}

windDaily_vs_r21 %>%
    filter(year(date)>2010, fct_city=="Chicago IL") %>%
    mutate(mon=factor(month.abb[month(date)], levels=month.abb)) %>%
    group_by(fct_city, year, mon) %>%
    summarize(muWind=mean(maxWind), mur21=mean(wind_r21), mudelta=mean(delta_r21), .groups="drop") %>%
    group_by(mon) %>%
    mutate(multe2016=mean(ifelse(year<=2016, muWind, NA), na.rm=TRUE), 
           lbl=ifelse(year<=2016, "2011-2016", "2017-20247")
           ) %>%
    ungroup() %>%
    ggplot(aes(x=factor(year), y=muWind)) + 
    geom_col(aes(fill=lbl), alpha=0.5) +
    geom_line(aes(y=multe2016, group=1), lty=2) + 
    facet_wrap(~mon) + 
    labs(title="Chicago IL", 
         x=NULL, 
         y="Mean maximum wind speed", 
         caption="Dotted line is monthly mean pre-2017"
         ) + 
    theme(axis.text.x=element_text(angle=90), legend.position="bottom") + 
    scale_fill_discrete(NULL)

```

The pre/post-2017 jump in mean maximum wind speed is much sharper in Las Vegas than in Chcago

Mean temperature by year is explored:  
```{r, fig.height=9, fig.width=9}

tempDaily_vs_r21 %>%
    filter(year(date)>2010, year(date)<2023) %>%
    group_by(fct_city, year) %>%
    summarize(muTemp=mean(meanTemp), mur21=mean(temp_r21), mudelta=mean(delta_r21), .groups="drop") %>%
    ggplot(aes(x=year, y=muTemp)) +
    geom_line() + 
    geom_line(aes(y=mur21), lty=2) +
    facet_wrap(~fct_city) + 
    labs(x=NULL, 
         y="Mean temperature", 
         caption="Solid: Mean based on city and year\nDashed: Mean based on city"
         )

```

Temperature by year appears much more stable, with no obvious disconnect in 2017

The process is converted to functional form:  
```{r, fig.height=9, fig.width=9}

tmpMetricByYear <- function(df, yearMin=-Inf, yearMax=+Inf, mainVar, dashVar, labTitle) {

    p1 <- df %>%
        filter(year(date)>=yearMin, year(date)<=yearMax) %>%
        group_by(fct_city, year) %>%
        summarize(mv=mean(get(mainVar)), dv=mean(get(dashVar)), .groups="drop") %>%
        ggplot(aes(x=year, y=mv)) +
        geom_line() + 
        geom_line(aes(y=dv), lty=2) +
        facet_wrap(~fct_city) + 
        labs(x=NULL, 
             y=labTitle, 
             caption="Solid: Mean based on city and year\nDashed: Mean based on city"
             )
    p1
    
}

```

The function is tested on temperature:  
```{r, fig.height=9, fig.width=9}

tmpMetricByYear(tempDaily_vs_r21, 
                yearMin=2011, 
                yearMax=2022, 
                mainVar="meanTemp", 
                dashVar="temp_r21", 
                labTitle="Mean Temperature"
                )

```

The function is tested on wind:  
```{r, fig.height=9, fig.width=9}

tmpMetricByYear(windDaily_vs_r21, 
                yearMin=2011, 
                yearMax=2022, 
                mainVar="maxWind", 
                dashVar="wind_r21", 
                labTitle="Mean maximum wind speed"
                )

```

The function is run on dewpoint:  
```{r, fig.height=9, fig.width=9}

tmpMetricByYear(dewPDaily_vs_r21, 
                yearMin=2011, 
                yearMax=2022, 
                mainVar="dewpoint_2m_mean", 
                dashVar="dewpoint_r21", 
                labTitle="Mean dewpoint"
                )

```

The function is run on precipitation:  
```{r, fig.height=9, fig.width=9}

tmpMetricByYear(precipDaily_vs_r21, 
                yearMin=2011, 
                yearMax=2022, 
                mainVar="sumPrecip", 
                dashVar="precip_r21", 
                labTitle="Mean precipitation"
                )

```

The function is run on shortwave radiation:  
```{r, fig.height=9, fig.width=9}

tmpMetricByYear(swrDaily_vs_r21, 
                yearMin=2011, 
                yearMax=2022, 
                mainVar="sumSWR", 
                dashVar="swr_r21", 
                labTitle="Mean shortwave radiation"
                )

```

A function is written to include year and month:  
```{r, fig.height=9, fig.width=9}

tmpMetricByMonthYear <- function(df, yearMin=-Inf, yearMax=+Inf, mainVar, dashVar, labTitle) {

    p1 <- df %>%
        filter(year(date)>=yearMin, year(date)<=yearMax) %>%
        mutate(mon=month(date), mmyy=make_date(year=year, month=mon)) %>%
        group_by(fct_city, year, mon, mmyy) %>%
        summarize(mv=mean(get(mainVar)), .groups="drop") %>%
        group_by(fct_city, mon) %>%
        mutate(dv=mean(mv)) %>%
        ungroup() %>%
        ggplot(aes(x=mmyy, y=mv)) +
        geom_line() + 
        geom_line(aes(y=dv), lty=2, color="red") +
        facet_wrap(~fct_city) + 
        labs(x=NULL, 
             y=labTitle, 
             caption="Black solid: Mean based on city and month-year\nRed dashed: Mean based on city and month"
             )
    p1
    
}

```

